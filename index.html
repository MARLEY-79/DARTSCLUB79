<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ğŸ¯ FlÃ©chettes Club Pro</title>
<meta name="theme-color" content="#e63946">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FlÃ©chettes Club">
<link id="pwa-manifest-link" rel="manifest" href="">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- â•â•â•â•â•â• FIREBASE SDK â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CNF-INSPIRED THEME â€” Exactly matching index.html visual style
   Bebas Neue + Work Sans | Dark sports club aesthetic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Google Fonts already linked via <link> tag â”€â”€ */

:root {
  /* CNF Dark palette */
  --dark:         #0d0f14;
  --dark-light:   #161b26;
  --dark-card:    #1c2333;
  --dark-hover:   #222d40;
  --border:       #252e40;
  --border2:      #2e3a52;

  /* Text */
  --light:        #f0f4fc;
  --text-dim:     #a0aabb;
  --gray:         #606a80;

  /* Primary accent â€” CNF darts red */
  --primary:      #e63946;
  --primary-dim:  rgba(230, 57, 70, 0.12);
  --primary-glow: rgba(230, 57, 70, 0.25);

  /* Status colors */
  --green:        #2dc653;
  --green-bg:     rgba(45, 198, 83, 0.12);
  --red:          #e63946;
  --red-bg:       rgba(230, 57, 70, 0.12);
  --gold:         #f5c518;
  --gold-bg:      rgba(245, 197, 24, 0.15);
  --silver:       #8fa3bd;
  --bronze:       #c47d44;
  --blue:         #457bf7;
  --purple:       #a67cf7;

  /* Aliases for backward compat with existing JS */
  --bg:           var(--dark);
  --surface:      var(--dark-light);
  --surface2:     var(--dark-card);
  --surface3:     var(--dark-hover);
  --text:         var(--light);
  --muted:        var(--gray);
  --accent:       var(--primary);
  --accent2:      #ff6b74;
  --accent-dim:   var(--primary-dim);
  --accent-glow:  var(--primary-glow);
  --shadow:       0 4px 24px rgba(0,0,0,0.5), 0 1px 6px rgba(0,0,0,0.4);
  --shadow-sm:    0 2px 10px rgba(0,0,0,0.35);
  --radius:       10px;
  --radius-sm:    7px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--dark);
  color: var(--light);
  font-family: 'Work Sans', sans-serif;
  min-height: 100vh;
  font-size: 15px;
  line-height: 1.6;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN-NAV  â€” Two-row header, no overflow
   Row 1: Logo + actions
   Row 2: Full nav (all items visible)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header, header.header {
  background: rgba(10, 12, 18, 0.97);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 200;
  box-shadow: 0 2px 20px rgba(0,0,0,0.4);
  height: auto;
  padding: 0;
}

/* Row 1 â€” Logo + right actions */
.nav-container-wrap {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 54px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

/* Row 2 â€” Full nav bar */
.nav-row {
  background: rgba(8, 10, 16, 0.6);
  border-bottom: 1px solid var(--border);
}
.nav-row-inner {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 1.5rem;
  display: flex;
  align-items: stretch;
  gap: 0;
}

/* Logo */
.logo {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  text-decoration: none;
  flex-shrink: 0;
}
.logo-icon {
  width: 36px; height: 36px;
  background: var(--primary);
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  box-shadow: 0 3px 10px rgba(230,57,70,0.35);
  flex-shrink: 0;
  overflow: hidden;
}
/* Club image in logo slot */
.logo-icon img {
  width: 100%; height: 100%;
  object-fit: contain;
  border-radius: 7px;
}

/* â”€â”€ App background image overlay â”€â”€ */
#app-bg-overlay {
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  opacity: 0;
  transition: opacity 0.4s ease;
}
body.has-bg-image {
  background: transparent;
}
body.has-bg-image .app-shell {
  background: transparent;
}
body.has-bg-image header {
  background: rgba(10, 12, 18, 0.92) !important;
  backdrop-filter: blur(16px);
}
body.has-bg-image .content {
  position: relative;
  z-index: 1;
}
/* Cards get a subtle blur glass effect when bg image is active */
body.has-bg-image .card,
body.has-bg-image .pcard,
body.has-bg-image .mcard,
body.has-bg-image .soiree-card,
body.has-bg-image .ranking-table-container {
  backdrop-filter: blur(4px);
  background: rgba(18, 22, 33, 0.82) !important;
}
.logo-text {
  display: flex;
  flex-direction: column;
  line-height: 1;
  gap: 2px;
}
.logo-main {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.25rem;
  letter-spacing: 3px;
  color: var(--light);
  text-transform: uppercase;
}
.logo-sub {
  font-size: 0.55rem;
  font-weight: 600;
  color: var(--primary);
  letter-spacing: 2px;
  text-transform: uppercase;
  opacity: 0.9;
}

/* Nav buttons inside row 2 */
.nav {
  display: flex;
  align-items: stretch;
  gap: 0;
  list-style: none;
  height: 40px;
  flex: 1;
}
.nav-btn {
  display: flex;
  align-items: center;
  gap: 0.28rem;
  padding: 0 0.75rem;
  height: 40px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--gray);
  font-family: 'Work Sans', sans-serif;
  font-size: 0.67rem;
  font-weight: 600;
  letter-spacing: 0.6px;
  cursor: pointer;
  transition: color 0.18s, border-color 0.18s, background 0.18s;
  text-transform: uppercase;
  white-space: nowrap;
  border-radius: 0;
  flex-shrink: 0;
}
.nav-btn i {
  font-size: 0.8rem;
  opacity: 0.8;
  transition: opacity 0.18s;
}
.nav-btn:hover {
  color: var(--light);
  background: rgba(255,255,255,0.04);
}
.nav-btn:hover i { opacity: 1; }
.nav-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  background: rgba(230,57,70,0.06);
}
.nav-btn.active i { opacity: 1; }
.nav-btn .badge {
  display: inline-block;
  background: var(--primary);
  color: #fff;
  border-radius: 3px;
  padding: 1px 4px;
  font-size: 0.55rem;
  font-weight: 800;
}

/* Right header actions â€” row 1 */
.header-right {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  flex-shrink: 0;
}
.season-badge {
  background: var(--primary-dim);
  border: 1px solid rgba(230,57,70,0.35);
  border-radius: 4px;
  padding: 0.25rem 0.8rem;
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.timer-btn {
  background: var(--dark-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 0.35rem 0.8rem;
  font-size: 0.68rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Work Sans', sans-serif;
  color: var(--text-dim);
  transition: all 0.15s;
  display: flex; align-items: center; gap: 0.4rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}
.timer-btn:hover { border-color: var(--primary); color: var(--primary); }
.timer-btn.running { background: var(--primary-dim); border-color: var(--primary); color: var(--primary); }
.theme-toggle, .btn-tv {
  background: var(--dark-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 0.35rem 0.8rem;
  font-size: 0.68rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Work Sans', sans-serif;
  color: var(--text-dim);
  transition: all 0.15s;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  white-space: nowrap;
}
.theme-toggle:hover, .btn-tv:hover { border-color: var(--primary); color: var(--primary); }

/* Session bar â€” live indicator bar (see full definition below) */
.session-stat { color: var(--gray); }
.session-stat-val { color: var(--light); font-weight: 800; }
.session-divider { color: var(--border2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT + LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-shell { display: flex; flex-direction: column; min-height: 100vh; }
.content {
  max-width: 1280px;
  width: 100%;
  margin: 0 auto;
  padding: 2.5rem 2rem;
  flex: 1;
}
.page { display: none; }
.page.active { display: block; animation: fadeIn 0.25s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO SECTION â€” exact match to index.html hero
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cnf-hero {
  background: linear-gradient(160deg, rgba(230,57,70,0.1) 0%, rgba(13,15,20,0) 55%),
              linear-gradient(180deg, var(--dark-light) 0%, var(--dark) 100%);
  border-radius: 14px;
  padding: 3rem 2.5rem 2.5rem;
  margin-bottom: 2.5rem;
  position: relative;
  overflow: hidden;
  border: 1px solid var(--border);
}
.cnf-hero::before {
  content: 'ğŸ¯';
  position: absolute;
  right: -20px; top: -20px;
  font-size: 12rem;
  opacity: 0.04;
  pointer-events: none;
  transform: rotate(12deg);
}
.cnf-hero-eyebrow {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.62rem;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--primary);
  margin-bottom: 0.8rem;
}
/* hero-title â€” Bebas Neue, two lines like index */
.cnf-hero-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 4rem;
  font-weight: 400;
  letter-spacing: 5px;
  line-height: 1.05;
  color: var(--light);
  text-transform: uppercase;
  margin-bottom: 0.8rem;
}
.cnf-hero-title .hero-highlight,
.cnf-hero-title span.accent { color: var(--primary); }
.cnf-hero-subtitle {
  font-size: 0.95rem;
  color: var(--text-dim);
  font-weight: 400;
  margin-bottom: 2rem;
  max-width: 540px;
}
/* hero-stats â€” row of stat-cards */
.cnf-hero-stats {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}
.cnf-stat-card {
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--border2);
  border-top: 3px solid var(--primary);
  border-radius: 10px;
  padding: 1.1rem 1.6rem;
  text-align: center;
  min-width: 110px;
  transition: transform 0.2s, border-color 0.2s;
}
.cnf-stat-card:hover { transform: translateY(-3px); border-top-color: var(--primary); box-shadow: 0 6px 20px rgba(230,57,70,0.15); }
.cnf-stat-number {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.6rem;
  letter-spacing: 2px;
  color: var(--primary);
  line-height: 1;
  display: block;
}
.cnf-stat-label {
  font-size: 0.62rem;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--gray);
  margin-top: 4px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE TITLES + SECTION TITLES (like index.html)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.6rem;
  font-weight: 400;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--light);
  margin-bottom: 0.5rem;
  line-height: 1;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.page-title span.accent, .page-title > span:last-child { color: var(--primary); }
.page-subtitle {
  font-size: 0.88rem;
  color: var(--text-dim);
  font-weight: 400;
  margin-bottom: 2rem;
}
/* section-title â€” h2 with bottom border accent (like index h2.section-title) */
.section-title, h2.section-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.8rem;
  font-weight: 400;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--light);
  margin-bottom: 1.3rem;
  padding-bottom: 0.6rem;
  border-bottom: 2px solid var(--primary);
  display: inline-block;
}
/* section-label â€” small caps divider */
.section-label {
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--gray);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.8rem;
}
.section-label::after { content:''; flex:1; height:1px; background: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS (dark-card bg, subtle border like index)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAT BLOCKS â€” dashboard overview cards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 1rem;
  margin-bottom: 1.8rem;
}
.stat-block {
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-top: 3px solid var(--primary);
  border-radius: 12px;
  padding: 1.4rem 1.5rem;
  text-align: center;
  box-shadow: var(--shadow-sm);
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
  overflow: hidden;
}
.stat-block:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(230,57,70,0.2); }
.stat-label {
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--gray);
  margin-bottom: 0.5rem;
}
.stat-value {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.8rem;
  font-weight: 400;
  color: var(--primary);
  line-height: 1;
  letter-spacing: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASH GRID
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-bottom: 1.8rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PODIUM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.podium {
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 0.8rem;
  padding: 1.5rem 1rem 1rem;
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 12px;
  min-height: 200px;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}
.podium::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at 50% 0%, rgba(230,57,70,0.06), transparent 60%);
  pointer-events: none;
}
.podium-step { display:flex; flex-direction:column; align-items:center; gap:0.4rem; flex:1; max-width:110px; z-index:1; }
.podium-avatar { width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.85rem; font-weight:700; border:2px solid; }
.podium-step.p1 .podium-avatar { background:var(--gold-bg); border-color:var(--gold); color:var(--gold); box-shadow: 0 0 16px rgba(245,197,24,0.3); }
.podium-step.p2 .podium-avatar { background:rgba(143,163,189,0.1); border-color:var(--silver); color:var(--silver); }
.podium-step.p3 .podium-avatar { background:rgba(196,125,68,0.1); border-color:var(--bronze); color:var(--bronze); }
.podium-name { font-size:0.65rem; font-weight:700; text-align:center; color:var(--text-dim); }
.podium-elo { font-size:0.85rem; font-weight:700; }
.podium-step.p1 .podium-elo { color:var(--gold); }
.podium-step.p2 .podium-elo { color:var(--silver); }
.podium-step.p3 .podium-elo { color:var(--bronze); }
.podium-bar { width:100%; border-radius:4px 4px 0 0; display:flex; align-items:center; justify-content:center; }
.podium-step.p1 .podium-bar { height:80px; background:linear-gradient(180deg, rgba(245,197,24,0.22), rgba(245,197,24,0.05)); border:1px solid rgba(245,197,24,0.3); }
.podium-step.p2 .podium-bar { height:56px; background:rgba(143,163,189,0.08); border:1px solid rgba(143,163,189,0.2); }
.podium-step.p3 .podium-bar { height:38px; background:rgba(196,125,68,0.08); border:1px solid rgba(196,125,68,0.2); }
.podium-rank { font-size:1rem; font-weight:700; opacity:0.4; }
.podium-step.p1 .podium-rank { opacity:1; color:var(--gold); font-size:1.4rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECENT MATCHES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.recent-matches { background:var(--dark-light); border:1px solid var(--border); border-radius:12px; padding:1.3rem; box-shadow:var(--shadow-sm); }
.recent-title { font-size:0.6rem; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; color:var(--gray); margin-bottom:0.9rem; }
.recent-match { display:flex; align-items:center; gap:0.8rem; padding:0.6rem 0; border-bottom:1px solid var(--border); font-size:0.82rem; }
.recent-match:last-child { border-bottom:none; }
.rm-score { font-weight:700; font-size:0.9rem; color:var(--primary); min-width:36px; text-align:center; font-family:'DM Mono',monospace; }
.rm-winner { font-weight:700; color:var(--light); }
.rm-loser { color:var(--gray); }
.rm-date { margin-left:auto; font-size:0.62rem; color:var(--gray); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER CARDS â€” matches index top-players-grid style
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.players-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(256px,1fr)); gap:1rem; }
.pcard {
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.3rem;
  position: relative;
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
}
.pcard::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), transparent);
  border-radius: 12px 12px 0 0;
  opacity: 0;
  transition: opacity 0.2s;
}
.pcard:hover { transform:translateY(-4px); box-shadow:0 12px 32px rgba(0,0,0,0.4); border-color:rgba(230,57,70,0.35); }
.pcard:hover::after { opacity: 1; }
.pcard-top { display:flex; align-items:flex-start; gap:0.8rem; margin-bottom:0.9rem; }
.pcard-avatar {
  width:46px; height:46px;
  border-radius:10px;
  background: var(--primary);
  display:flex; align-items:center; justify-content:center;
  font-size:0.95rem; font-weight:800; color:#fff; flex-shrink:0;
  box-shadow: 0 4px 12px rgba(230,57,70,0.25);
}
.pcard-info { flex:1; }
.pcard-pseudo { font-size:0.92rem; font-weight:700; color:var(--light); }
.pcard-name { font-size:0.68rem; color:var(--gray); margin-top:2px; }
.pcard-del { background:none; border:none; color:var(--gray); cursor:pointer; font-size:0.82rem; padding:3px; transition:color 0.15s; flex-shrink:0; }
.pcard-del:hover { color:var(--red); }
.pcard-elo-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.6rem; }
.pcard-elo { font-family:'Bebas Neue',sans-serif; font-size:2.2rem; font-weight:400; color:var(--primary); letter-spacing:2px; }
.pcard-peak { font-size:0.62rem; color:var(--gray); text-align:right; }
.pcard-peak span { color:var(--gold); font-weight:600; }
.pcard-sparkline { margin-bottom:0.6rem; }
.pcard-form { display:flex; gap:3px; margin-bottom:0.7rem; }
.form-dot { width:22px; height:22px; border-radius:5px; display:flex; align-items:center; justify-content:center; font-size:0.52rem; font-weight:700; flex-shrink:0; }
.form-w { background:var(--green-bg); color:var(--green); border:1px solid rgba(45,198,83,0.3); }
.form-l { background:var(--red-bg); color:var(--red); border:1px solid rgba(230,57,70,0.3); }
.form-d { background:var(--dark-card); color:var(--gray); border:1px solid var(--border); }
.pcard-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:0.4rem; }
.pstat { background:var(--dark-card); border-radius:8px; padding:0.4rem; text-align:center; border: 1px solid var(--border); }
.pstat-val { font-size:0.86rem; font-weight:700; color:var(--light); }
.pstat-lbl { font-size:0.56rem; color:var(--gray); letter-spacing:0.5px; text-transform:uppercase; }
.pcard-streak { position:absolute; top:10px; right:32px; font-size:0.6rem; font-weight:700; padding:2px 7px; border-radius:4px; letter-spacing:0.5px; }
.streak-win { background:var(--green-bg); color:var(--green); border:1px solid rgba(45,198,83,0.3); }
.streak-loss { background:var(--red-bg); color:var(--red); border:1px solid rgba(230,57,70,0.3); }
.pcard-trophies { display:flex; gap:3px; flex-wrap:wrap; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid var(--border); }
.trophy-icon { font-size:0.85rem; cursor:default; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS + INPUTS  (clean, dark like index)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-row { display:flex; gap:0.8rem; flex-wrap:wrap; align-items:flex-end; }
.form-field { display:flex; flex-direction:column; gap:0.3rem; }
.form-label { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--gray); }
input, select, textarea {
  background: var(--dark-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--light);
  padding: 0.6rem 0.9rem;
  font-family: 'Work Sans', sans-serif;
  font-size: 0.88rem;
  font-weight: 500;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(230,57,70,0.12);
}
select option { background: var(--dark-card); }
input[type="number"] { text-align:center; font-weight:700; font-size:1rem; font-family:'DM Mono',monospace; }

/* Search input â€” like index.html */
.search-input, .sort-select, .filter-select {
  background: var(--dark-card);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 0.65rem 1rem;
  font-size: 0.88rem;
  color: var(--light);
  transition: border-color 0.2s;
}
.search-input:focus, .sort-select:focus, .filter-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(230,57,70,0.1);
}
.filters {
  display: flex;
  gap: 0.8rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS â€” match index btn-primary
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn { padding:0.6rem 1.4rem; border-radius:8px; border:none; font-family:'Work Sans',sans-serif; font-size:0.74rem; font-weight:700; letter-spacing:1.2px; cursor:pointer; transition:all 0.2s; text-transform:uppercase; white-space:nowrap; }
.btn-primary { background:var(--primary); color:#fff; }
.btn-primary:hover { background:#ff4d5a; transform:translateY(-2px); box-shadow:0 6px 20px rgba(230,57,70,0.35); }
.btn-secondary { background:var(--dark-card); color:var(--text-dim); border:1px solid var(--border); }
.btn-secondary:hover { border-color:var(--primary); color:var(--primary); background:var(--primary-dim); }
.btn-sm { padding:0.4rem 0.9rem; font-size:0.68rem; }
.btn-danger { background:var(--red); color:#fff; }
.btn-danger:hover { background:#ff3333; }
.btn-ghost { background:none; border:1px solid var(--border); color:var(--text-dim); }
.btn-ghost:hover { border-color:var(--primary); color:var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANKING TABLE â€” redesigned premium look
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rank-table, .ranking-table, .rtable {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.84rem;
}
.rank-table th, .rank-table td,
.ranking-table th, .ranking-table td,
.rtable th, .rtable td {
  padding: 0.8rem 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(37,46,64,0.7);
}
.rank-table th, .ranking-table th, .rtable th {
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gray);
  background: rgba(28,35,51,0.9);
  border-bottom: 1px solid var(--border2);
  padding-top: 0.9rem;
  padding-bottom: 0.9rem;
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}
/* Rank number column */
.r-num {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.15rem;
  color: var(--gray);
  width: 42px;
  text-align: center;
  padding-left: 1rem !important;
}
/* ELO bar */
.r-bar-bg {
  height: 4px;
  background: rgba(255,255,255,0.07);
  border-radius: 2px;
  margin-top: 5px;
  overflow: hidden;
}
.r-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #ff6b74);
  border-radius: 2px;
  transition: width 0.5s cubic-bezier(.4,0,.2,1);
}
/* Row hover */
.rank-table tr:hover td, .ranking-table tr:hover td, .rtable tbody tr:hover td {
  background: rgba(230,57,70,0.05) !important;
  cursor: pointer;
}
/* Top 3 accent rows */
.rtable tr.rank-1 td, .rank-table tr.rank-1 td {
  background: linear-gradient(90deg, rgba(245,197,24,0.07) 0%, rgba(245,197,24,0.02) 100%);
}
.rtable tr.rank-2 td, .rank-table tr.rank-2 td {
  background: linear-gradient(90deg, rgba(143,163,189,0.06) 0%, transparent 100%);
}
.rtable tr.rank-3 td, .rank-table tr.rank-3 td {
  background: linear-gradient(90deg, rgba(196,125,68,0.06) 0%, transparent 100%);
}
/* Top 3 left border accent */
.rtable tr.rank-1 td:first-child { border-left: 3px solid var(--gold); }
.rtable tr.rank-2 td:first-child { border-left: 3px solid var(--silver); }
.rtable tr.rank-3 td:first-child { border-left: 3px solid var(--bronze); }
/* rank number colors */
.rtable tr.rank-1 .r-num { color: var(--gold); filter: drop-shadow(0 0 6px rgba(245,197,24,0.4)); }
.rtable tr.rank-2 .r-num { color: var(--silver); }
.rtable tr.rank-3 .r-num { color: var(--bronze); }
/* ELO value */
.r-elo { font-family:'Bebas Neue',sans-serif; font-size:1.15rem; color:var(--primary); letter-spacing:1px; }
.rank-table .r-elo { font-family:'Bebas Neue',sans-serif; font-size:1.2rem; color:var(--primary); letter-spacing:1px; }
.ranking-table-container { border-radius:12px; overflow:hidden; border:1px solid var(--border); background:var(--dark-light); }
/* Sortable header icons */
.sort-icon { font-size:0.6rem; color:var(--accent); margin-left:2px; opacity:0.9; }
.rtable th[onclick]:hover { background: rgba(230,57,70,0.1) !important; color: var(--text-dim); }
.rtable th { transition: background .12s, color .12s; }
/* Rank num compat */
.rank-table .rank-num { font-family:'Bebas Neue',sans-serif; font-size:1.2rem; color:var(--gray); }
.rank-table .rank-1 .rank-num { color:var(--gold); }
.rank-table .rank-2 .rank-num { color:var(--silver); }
.rank-table .rank-3 .rank-num { color:var(--bronze); }
/* Win/Loss indicator dots */
.wl-win { color: var(--green); font-weight: 700; }
.wl-loss { color: var(--red); font-weight: 700; }
/* Ranking page section header */
.rank-section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-bottom: 0.8rem;
  flex-wrap: wrap;
}
.rank-section-head-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.5rem;
  letter-spacing: 2px;
  color: var(--light);
}
/* Top 3 podium cards above table */
.rank-podium-strip {
  display: grid;
  grid-template-columns: 1fr 1.12fr 1fr;
  gap: 0.7rem;
  margin-bottom: 1.4rem;
}
.rank-pod-card {
  background: var(--dark-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.1rem 0.9rem 0.9rem;
  text-align: center;
  position: relative;
  transition: border-color .18s, transform .18s;
  overflow: hidden;
}
.rank-pod-card:hover { transform: translateY(-2px); border-color: rgba(230,57,70,0.3); }
.rank-pod-card.pod-1 { border-color: rgba(245,197,24,0.35); background: linear-gradient(160deg, rgba(245,197,24,0.06) 0%, var(--dark-card) 60%); }
.rank-pod-card.pod-2 { border-color: rgba(143,163,189,0.25); }
.rank-pod-card.pod-3 { border-color: rgba(196,125,68,0.25); }
.rank-pod-medal { font-size: 1.8rem; margin-bottom: 0.4rem; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); }
.rank-pod-card.pod-1 .rank-pod-medal { font-size: 2.2rem; }
.rank-pod-avatar {
  width: 52px; height: 52px;
  border-radius: 12px;
  margin: 0 auto 0.6rem;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; font-weight: 800; color: #0d0f14;
  overflow: hidden;
}
.rank-pod-card.pod-1 .rank-pod-avatar { width: 60px; height: 60px; border-radius: 14px; font-size: 1.4rem; box-shadow: 0 0 18px rgba(245,197,24,0.25); }
.rank-pod-pseudo { font-weight: 800; font-size: 0.88rem; color: var(--light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rank-pod-card.pod-1 .rank-pod-pseudo { font-size: 1rem; }
.rank-pod-elo { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 1px; margin: 2px 0 4px; }
.rank-pod-card.pod-1 .rank-pod-elo { font-size: 1.7rem; color: var(--gold); }
.rank-pod-card.pod-2 .rank-pod-elo { color: var(--silver); }
.rank-pod-card.pod-3 .rank-pod-elo { color: var(--bronze); }
.rank-pod-sub { font-size: 0.62rem; color: var(--muted); }
/* Ligue table reuse */
.ligue-table {
  width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.82rem;
}
.ligue-table th {
  font-size: 0.58rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
  color: var(--gray); background: rgba(28,35,51,0.9); border-bottom: 1px solid var(--border2);
  padding: 0.7rem 0.8rem; text-align: center;
}
.ligue-table th:nth-child(2) { text-align: left; }
.ligue-table td { padding: 0.62rem 0.8rem; border-bottom: 1px solid rgba(37,46,64,0.5); text-align: center; }
.ligue-table td:nth-child(2) { text-align: left; }
.ligue-table tr:hover td { background: rgba(230,57,70,0.05); }
/* Teams table */
.teams-table {
  width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.82rem;
}
.teams-table th {
  font-size: 0.58rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
  color: var(--gray); background: rgba(28,35,51,0.9); border-bottom: 1px solid var(--border2);
  padding: 0.7rem 0.8rem;
}
.teams-table td { padding: 0.65rem 0.8rem; border-bottom: 1px solid rgba(37,46,64,0.5); }
.teams-table tr:hover td { background: rgba(230,57,70,0.05); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER BUTTONS â€” like index.html filter-btn (pill shape)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-btn {
  padding: 0.45rem 1rem;
  background: var(--dark-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--gray);
  font-family: 'Work Sans', sans-serif;
  font-size: 0.72rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: none;
  letter-spacing: 0.3px;
}
.filter-btn:hover { border-color:var(--primary); color:var(--light); }
.filter-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOURNAMENT BRACKET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tournament-card { background:var(--dark-light); border:1px solid var(--border); border-radius:12px; padding:1.4rem; box-shadow:var(--shadow-sm); margin-bottom:0.9rem; transition:border-color 0.2s; }
.tournament-card:hover { border-color:var(--border2); }
.tournament-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.7rem; }
.tournament-name { font-size:1rem; font-weight:700; }
.tournament-status { font-size:0.65rem; font-weight:700; padding:3px 10px; border-radius:4px; letter-spacing:1px; text-transform:uppercase; }
.t-active { background:var(--green-bg); color:var(--green); border:1px solid rgba(45,198,83,0.3); }
.t-finished { background:var(--dark-card); color:var(--gray); border:1px solid var(--border); }
.t-pending { background:var(--gold-bg); color:var(--gold); border:1px solid rgba(245,197,24,0.4); }

.bracket { display:flex; gap:1.5rem; overflow-x:auto; padding:1rem 0; }
.bracket-round { display:flex; flex-direction:column; gap:0.5rem; min-width:160px; }
.bracket-round-title { font-size:0.62rem; font-weight:700; letter-spacing:2px; color:var(--gray); text-align:center; margin-bottom:0.5rem; text-transform:uppercase; }
.bracket-match { background:var(--dark-card); border:1px solid var(--border); border-radius:8px; overflow:hidden; box-shadow:var(--shadow-sm); }
.bracket-player { display:flex; align-items:center; justify-content:space-between; padding:0.45rem 0.8rem; font-size:0.8rem; font-weight:600; transition:background 0.15s; cursor:pointer; }
.bracket-player:first-child { border-bottom:1px solid var(--border); }
.bracket-player:hover { background:var(--dark-hover); }
.bracket-player.winner { background:var(--green-bg); color:var(--green); font-weight:700; }
.bracket-player.bye { opacity:0.35; cursor:default; font-style:italic; }
.bracket-score { font-size:0.85rem; font-weight:700; font-family:'DM Mono',monospace; }

/* round robin */
.rr-table { width:100%; border-collapse:collapse; font-size:0.78rem; }
.rr-table th, .rr-table td { padding:0.45rem 0.6rem; border:1px solid var(--border); text-align:center; }
.rr-table th { background:var(--dark-card); font-weight:700; font-size:0.6rem; letter-spacing:1px; }
.rr-cell { cursor:pointer; transition:background 0.15s; }
.rr-cell:hover { background:var(--dark-hover); }
.rr-w { background:var(--green-bg); color:var(--green); font-weight:700; }
.rr-l { background:var(--red-bg); color:var(--red); }
.rr-d { background:var(--dark-card); color:var(--gray); }
.rr-self { background:var(--dark); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS PAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; margin-bottom:1.8rem; }
.chart-box { background:var(--dark-light); border:1px solid var(--border); border-radius:12px; padding:1.4rem; box-shadow:var(--shadow-sm); }
.chart-title { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--gray); margin-bottom:1rem; }
.heatmap { overflow-x:auto; }
.heatmap-table { border-collapse:collapse; font-size:0.75rem; }
.heatmap-table th, .heatmap-table td { padding:0.4rem 0.6rem; border:1px solid var(--border); text-align:center; white-space:nowrap; }
.heatmap-table th { background:var(--dark-card); font-size:0.6rem; letter-spacing:1px; }
.hm-win { background:rgba(45,198,83,0.25); color:var(--green); font-weight:700; }
.hm-lose { background:rgba(230,57,70,0.2); color:var(--red); font-weight:700; }
.hm-none { background:var(--dark-card); color:var(--gray); }
.hm-self { background:var(--dark); }
.player-detail-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.8rem; margin-bottom:1.2rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACHIEVEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.achievements-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:0.7rem; }
.achievement { background:var(--dark-card); border:1px solid var(--border); border-radius:10px; padding:0.9rem; text-align:center; transition:border-color 0.2s, transform 0.2s; }
.achievement:hover { transform:translateY(-2px); }
.achievement.unlocked { border-color:rgba(245,197,24,0.4); background:rgba(245,197,24,0.06); }
.achievement.locked { opacity:0.3; filter:grayscale(1); }
.achievement-icon { font-size:2rem; margin-bottom:0.4rem; display:block; }
.achievement-name { font-size:0.72rem; font-weight:700; color:var(--light); margin-bottom:0.2rem; }
.achievement-desc { font-size:0.65rem; color:var(--gray); line-height:1.4; }
.achievement-player { font-size:0.62rem; color:var(--gold); font-weight:600; margin-top:0.3rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATCH CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.match-card, .match-card-pro {
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem 1.2rem;
  margin-bottom: 0.6rem;
  box-shadow: var(--shadow-sm);
  transition: border-color 0.2s;
}
.match-card:hover, .match-card-pro:hover { border-color:var(--border2); }
.match-card-pro.match-pending { border-left:3px solid rgba(230,57,70,0.5); }
.fg-vs { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; color:var(--gray); text-align:center; }
.btn-submit { background:var(--primary); color:#fff; border:none; border-radius:8px; padding:0.7rem 1.9rem; font-family:'Work Sans',sans-serif; font-size:0.76rem; font-weight:700; letter-spacing:1px; cursor:pointer; transition:all 0.2s; text-transform:uppercase; }
.btn-submit:hover { background:#ff4d5a; transform:translateY(-1px); box-shadow:0 4px 16px rgba(230,57,70,0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay, .soiree-overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  z-index:500;
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-overlay.active, .soiree-overlay.active { display:flex; }
.modal-box, .soiree-modal {
  background:var(--dark-light);
  border:1px solid var(--border);
  border-radius:14px;
  padding:2rem;
  width:100%;
  max-width:520px;
  box-shadow:0 24px 64px rgba(0,0,0,0.65);
  animation:modalIn 0.22s ease;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.96) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
.modal-title { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; letter-spacing:3px; text-transform:uppercase; margin-bottom:1.4rem; display:flex; justify-content:space-between; align-items:center; }
.modal-close-btn { background:none; border:none; color:var(--gray); cursor:pointer; font-size:1.2rem; transition:color 0.15s; }
.modal-close-btn:hover { color:var(--light); }
.soiree-actions { display:flex; gap:0.6rem; justify-content:center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEASON + PARAM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.season-list { display:flex; flex-direction:column; gap:0.7rem; }
.season-item { background:var(--dark-light); border:1px solid var(--border); border-radius:10px; padding:0.9rem 1.1rem; display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow-sm); }
.season-name { font-size:0.88rem; font-weight:700; }
.season-meta { font-size:0.7rem; color:var(--gray); margin-top:2px; }
.season-current { border-color:rgba(245,197,24,0.4); background:var(--gold-bg); }
.param-section { margin-bottom:2rem; }
.param-section .card { display:flex; flex-direction:column; gap:0.9rem; }
.param-row { display:flex; align-items:center; justify-content:space-between; padding:0.6rem 0; border-bottom:1px solid var(--border); }
.param-row:last-child { border-bottom:none; }
.param-label { font-size:0.8rem; font-weight:600; }
.param-desc { font-size:0.7rem; color:var(--gray); margin-top:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIT LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.audit-list { display:flex; flex-direction:column; gap:0.35rem; max-height:400px; overflow-y:auto; }
.audit-item { display:flex; align-items:center; gap:0.6rem; padding:0.5rem 0.8rem; background:var(--dark-card); border-radius:6px; font-size:0.75rem; border:1px solid var(--border); }
.audit-time { color:var(--gray); font-size:0.62rem; min-width:75px; font-family:'DM Mono',monospace; }
.audit-icon { flex-shrink:0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER WIDGET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-widget { position:fixed; bottom:1.5rem; left:1.5rem; background:var(--dark-light); border:1px solid var(--border); border-radius:12px; padding:0.75rem 1rem; box-shadow:var(--shadow); z-index:300; display:none; align-items:center; gap:0.8rem; min-width:200px; backdrop-filter: blur(8px); }
.timer-widget.active { display:flex; }
.timer-display { font-family:'DM Mono',monospace; font-size:1.5rem; font-weight:500; color:var(--primary); min-width:70px; }
.timer-controls { display:flex; gap:0.4rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Notif styles â€” see full definition below */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confetti-piece { position:fixed; width:6px; height:6px; pointer-events:none; z-index:9999; border-radius:2px; animation:confettiFall 1.5s ease-in forwards; }
@keyframes confettiFall { 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(100vh) rotate(720deg)} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER â€” matches index.html site-footer pattern
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-footer {
  background: var(--dark-light);
  border-top: 1px solid var(--border);
  padding: 2.5rem 0 1rem;
  margin-top: 3rem;
}
.footer-inner {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 2rem;
}
.footer-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 2rem;
  margin-bottom: 2rem;
}
.footer-col h3 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.1rem;
  letter-spacing: 2px;
  color: var(--light);
  text-transform: uppercase;
  margin-bottom: 0.8rem;
  display: flex; align-items: center; gap: 0.5rem;
}
.footer-col p, .footer-col a {
  font-size: 0.82rem;
  color: var(--gray);
  text-decoration: none;
  line-height: 1.8;
}
.footer-col a:hover { color: var(--primary); }
.social-link { display:flex; align-items:center; gap:0.5rem; color:var(--gray); text-decoration:none; font-size:0.82rem; padding:0.3rem 0; transition:color 0.2s; }
.social-link:hover { color:var(--primary); }
.footer-bottom { border-top:1px solid var(--border); padding-top:1rem; text-align:center; font-size:0.75rem; color:var(--gray); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE NAV BOTTOM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Mobile nav styles â€” see full definition below */

/* Mobile more menu styles â€” see full definition below */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TV MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tv-overlay { position:fixed; inset:0; background:var(--dark); z-index:9999; display:none; flex-direction:column; }
.tv-overlay.active { display:flex; }
.tv-header { background:var(--dark-light); border-bottom:2px solid var(--primary); padding:1rem 2rem; display:flex; align-items:center; justify-content:space-between; }
.tv-logo { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:4px; text-transform:uppercase; color:var(--light); }
.tv-season { font-size:0.7rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--gray); margin-top:2px; }
.tv-clock { font-family:'DM Mono',monospace; font-size:1.8rem; color:var(--primary); font-weight:500; }
.tv-body { display:flex; gap:1.5rem; padding:1.5rem; flex:1; overflow:hidden; }
.tv-ranking { flex:1; overflow-y:auto; }
.tv-right { width:300px; display:flex; flex-direction:column; gap:1.5rem; }
.tv-section-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray); margin-bottom:0.7rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; }
.tv-close-btn { position:absolute; top:1rem; right:1rem; background:var(--dark-card); border:1px solid var(--border); border-radius:6px; padding:0.4rem 0.9rem; font-size:0.75rem; font-weight:700; cursor:pointer; font-family:'Work Sans',sans-serif; color:var(--light); text-transform:uppercase; letter-spacing:1px; transition:all 0.15s; }
.tv-close-btn:hover { border-color:var(--primary); color:var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC â€” score counter, training, profile etc.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.add-player-form { display:flex; gap:0.8rem; flex-wrap:wrap; align-items:flex-end; background:var(--dark-light); border:1px solid var(--border); border-radius:12px; padding:1.3rem; margin-bottom:1.5rem; }
.score-counter-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:600; display:none; align-items:center; justify-content:center; }
.score-counter-overlay.active { display:flex; }
.sc-modal { background:var(--dark-light); border:1px solid var(--border); border-radius:16px; width:100%; max-width:800px; max-height:92vh; overflow-y:auto; font-family:'Work Sans',sans-serif; }
.sc-key { background:var(--dark-card); border:1px solid var(--border); border-radius:8px; padding:0.6rem 0.4rem; font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:1px; color:var(--light); cursor:pointer; transition:all 0.1s; text-align:center; }
.sc-key:hover { background:var(--dark-hover); border-color:var(--primary); color:var(--primary); transform:scale(0.97); }
.sc-key.bull { background:var(--primary-dim); border-color:rgba(230,57,70,0.3); color:var(--primary); }
.sc-key.confirm { background:var(--primary); color:#fff; border:none; font-family:'Work Sans',sans-serif; font-size:0.85rem; font-weight:700; }
.sc-key.confirm:hover { background:#ff4d5a; }
.profile-section-title { font-size:0.6rem; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; color:var(--gray); margin-bottom:0.5rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOGGLES / SWITCHES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toggle { appearance:none; width:38px; height:20px; border-radius:20px; background:var(--border2); cursor:pointer; transition:background 0.2s; position:relative; flex-shrink:0; border:none; }
.toggle:checked { background:var(--primary); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:14px; height:14px; border-radius:50%; background:#fff; transition:transform 0.2s; }
.toggle:checked::after { transform:translateX(18px); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width: 1024px) {
  .nav-btn { padding:0 0.5rem; font-size:0.62rem; letter-spacing:0.4px; }
  .dash-grid { grid-template-columns:1fr; }
  .stats-grid { grid-template-columns:1fr; }
  .player-detail-grid { grid-template-columns:1fr 1fr; }
}
@media(max-width: 768px) {
  .mobile-nav { display:block; }
  .nav-row { display:none !important; }
  .content { padding:1rem; padding-bottom:5.5rem; }
  .header { height:auto; }
  .nav-container-wrap { height:52px; }
  .header-right .timer-btn, .header-right .theme-toggle, .header-right .btn-tv { display:none; }
  .header-right .btn.btn-primary { display:none; }
  .cnf-hero-title { font-size:2.6rem; }
  .cnf-hero { padding:1.8rem 1.4rem; }
  .page-title { font-size:1.8rem; }
  .dash-stats { grid-template-columns:repeat(2,1fr); gap:0.7rem; }
  .stat-value { font-size:2rem; }
  .players-grid { grid-template-columns:1fr; }
  .stats-grid { grid-template-columns:1fr; }
  .footer-grid { grid-template-columns:1fr; gap:1.2rem; }
  .dash-grid { grid-template-columns:1fr; }
  .mobile-more-backdrop.open, .mobile-more-menu.open { display:block; }
}
@media(max-width:480px) {
  .cnf-hero-title { font-size:2rem; }
  .mobile-more-grid { grid-template-columns:repeat(3,1fr); }
}

/* â”€â”€ MODAL GENERIC â”€â”€ */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.65); backdrop-filter:blur(4px); z-index:400; display:none; align-items:center; justify-content:center; padding:1rem; }
.modal-overlay.active { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:2rem; width:100%; max-width:520px; max-height:90vh; overflow-y:auto; box-shadow:0 24px 64px rgba(0,0,0,0.55); animation:modalIn 0.22s ease; }
.modal-title { font-family:'Bebas Neue', sans-serif; font-size:1.2rem; font-weight:700; margin-bottom:1.3rem; display:flex; justify-content:space-between; align-items:center; }
.modal-close { background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--muted); }
@keyframes modalIn { from { opacity:0; transform:scale(0.96) translateY(8px); } to { opacity:1; transform:scale(1) translateY(0); } }

/* â”€â”€ ELO INFO SECTION â”€â”€ */
.elo-info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; }
.elo-info-block { }
.elo-info-title { font-size:0.65rem; font-weight:700; letter-spacing:1.5px; color:var(--accent); margin-bottom:0.35rem; }
.elo-info-text { font-size:0.8rem; color:var(--muted); line-height:1.7; }

/* â”€â”€ POOL MANAGEMENT â”€â”€ */
.pool-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:0.9rem; margin-bottom:1rem; }
.pool-card-pro { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.2rem; box-shadow:var(--shadow-sm); transition:border-color 0.2s; }
.pool-card-pro:hover { border-color:var(--border2); }
.pool-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.7rem; padding-bottom:0.7rem; border-bottom:1px solid var(--border); }
.pool-card-name { font-size:0.95rem; font-weight:700; color:var(--accent); font-family:'Bebas Neue', sans-serif; }
.pool-card-count { font-size:0.68rem; color:var(--muted); }
.pool-player-item { padding:0.3rem 0.6rem; background:var(--surface2); border-radius:5px; font-size:0.78rem; font-weight:600; margin-bottom:0.25rem; border-left:3px solid var(--accent); color:var(--text-dim); }
.pool-player-item.qualified { border-left-color:var(--green); background:var(--green-bg); color:var(--green); }
.pool-actions { display:flex; gap:0.5rem; margin-top:0.7rem; }
.pool-progress { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; font-size:0.65rem; color:var(--muted); }
.pool-progress-bar { flex:1; height:3px; background:var(--border); border-radius:3px; overflow:hidden; }
.pool-progress-fill { height:100%; background:var(--accent); border-radius:3px; }

/* Match cards pour poules */
.bracket-section-pro { margin-bottom:1.2rem; }
.bracket-section-title { font-size:0.65rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:0.7rem; display:flex; align-items:center; gap:0.5rem; }
.bracket-section-title::after { content:''; flex:1; height:1px; background:var(--border); }
.match-card-pro { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-sm); padding:0.9rem; margin-bottom:0.6rem; box-shadow:var(--shadow-sm); transition:border-color 0.15s; }
.match-card-pro.match-completed { border-color:rgba(52,212,123,0.3); background:rgba(52,212,123,0.04); }
.match-card-pro.match-pending { border-left:3px solid rgba(230, 57, 70, 0.5); }
.match-round-label { font-size:0.6rem; font-weight:700; letter-spacing:1.5px; color:var(--muted); text-transform:uppercase; margin-bottom:0.5rem; }
.match-round-label.is-final { color:var(--gold); }
.match-players-pro { display:flex; flex-direction:column; gap:0.3rem; margin-bottom:0.6rem; }
.match-player-row { display:flex; align-items:center; justify-content:space-between; padding:0.35rem 0.65rem; background:var(--surface2); border-radius:5px; font-size:0.82rem; font-weight:600; border:1px solid var(--border); }
.match-player-row.winner-row { background:var(--green-bg); color:var(--green); border-color:rgba(52,212,123,0.3); }
.match-player-row.loser-row { opacity:0.45; text-decoration:line-through; }
.match-player-row.tbd-row { color:var(--muted); font-style:italic; }
.match-score-input { width:50px; border:1px solid var(--border); border-radius:5px; padding:0.2rem 0.4rem; text-align:center; font-weight:700; font-size:0.88rem; background:var(--bg); color:var(--text); }
.match-score-input:focus { border-color:var(--accent); outline:none; }
.match-btn-row { display:flex; gap:0.4rem; }
.match-status-badge { font-size:0.6rem; font-weight:700; padding:2px 6px; border-radius:10px; letter-spacing:0.5px; }
.ms-done { background:var(--green-bg); color:var(--green); border:1px solid rgba(52,212,123,0.3); }
.ms-wait { background:var(--gold-bg); color:var(--gold); border:1px solid rgba(230, 57, 70, 0.35); }
.ms-soon { background:var(--surface2); color:var(--muted); border:1px solid var(--border); }

.final-bracket-pro { display:flex; gap:1.2rem; overflow-x:auto; padding-bottom:0.5rem; }
.final-round-pro { display:flex; flex-direction:column; gap:0.5rem; min-width:155px; }
.final-round-title { font-size:0.6rem; font-weight:700; letter-spacing:2px; color:var(--accent); text-align:center; margin-bottom:0.4rem; text-transform:uppercase; }
.final-match-pro { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); overflow:hidden; box-shadow:var(--shadow-sm); margin-bottom:0.4rem; }
.final-match-pro .bracket-player { display:flex; align-items:center; justify-content:space-between; padding:0.42rem 0.65rem; font-size:0.78rem; font-weight:600; cursor:pointer; transition:background 0.15s; }
.final-match-pro .bracket-player:first-child { border-bottom:1px solid var(--border); }
.final-match-pro .bracket-player:hover { background:var(--surface3); }
.final-match-pro .bracket-player.winner { background:var(--green-bg); color:var(--green); }
.final-match-pro .bracket-player.tbd { color:var(--muted); font-style:italic; opacity:0.6; }

/* â”€â”€ FORMAT SELECTOR CARDS â”€â”€ */
.t-format-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:0.6rem; }
.t-format-card {
  padding:0.9rem; border:2px solid var(--border); border-radius:var(--radius);
  cursor:pointer; background:var(--surface); transition:all 0.18s; position:relative;
  text-align:center;
}
.t-format-card:hover { border-color:var(--border2); background:var(--surface2); }
.t-format-card.selected { border-color:var(--accent); background:var(--accent-dim); }
.t-fmt-icon { font-size:1.5rem; margin-bottom:0.4rem; }
.t-fmt-name { font-size:0.78rem; font-weight:700; color:var(--text); margin-bottom:0.3rem; }
.t-fmt-desc { font-size:0.62rem; color:var(--muted); line-height:1.4; }
.t-fmt-badge { position:absolute; top:6px; right:6px; font-size:0.55rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; background:var(--accent); color:#fff; padding:2px 6px; border-radius:10px; }

/* â”€â”€ SCORE MODAL â”€â”€ */
.score-modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:500;
  display:flex; align-items:center; justify-content:center; backdrop-filter:blur(6px);
  opacity:0; pointer-events:none; transition:opacity 0.2s;
}
.score-modal-overlay.active { opacity:1; pointer-events:all; }
.score-modal {
  background:var(--surface); border:1px solid var(--border2); border-radius:16px;
  padding:1.8rem; width:min(400px,92vw); box-shadow:var(--shadow);
  animation: fadeIn 0.18s ease;
}
.score-match-title { font-size:0.65rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:1rem; }
.score-vs-row { display:flex; align-items:center; justify-content:center; gap:1rem; margin-bottom:1.4rem; }
.score-player-col { flex:1; text-align:center; }
.score-player-name { font-size:0.95rem; font-weight:700; margin-bottom:0.8rem; }
.score-input-big {
  width:80px; height:64px; border:2px solid var(--border); border-radius:12px;
  background:var(--surface2); color:var(--text); font-family:'DM Mono',monospace;
  font-size:2rem; font-weight:700; text-align:center; outline:none; transition:border-color 0.15s;
  display:block; margin:0 auto;
}
.score-input-big:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
.score-vs-sep { font-size:1.5rem; font-weight:700; color:var(--muted); flex-shrink:0; }
.score-jeu-info { text-align:center; font-size:0.72rem; color:var(--muted); margin-bottom:1rem; background:var(--surface2); border-radius:7px; padding:0.4rem 0.8rem; }
.score-modal-actions { display:flex; gap:0.6rem; margin-top:0.4rem; }

/* â”€â”€ TOURNOI DETAIL LAYOUT â”€â”€ */
.t-detail-header {
  display:flex; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; gap:0.8rem;
  padding:1rem 1.2rem; background:var(--surface2); border-radius:var(--radius); margin-bottom:1.2rem;
  border:1px solid var(--border);
}
.t-detail-meta { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.4rem; }
.t-meta-chip { font-size:0.65rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; padding:3px 10px; border-radius:20px; background:var(--surface); border:1px solid var(--border); color:var(--muted); }
.t-meta-chip.highlight { background:var(--accent-dim); border-color:rgba(230, 57, 70, 0.3); color:var(--accent); }

/* â”€â”€ POULE STANDINGS TABLE â”€â”€ */
.pool-standings { width:100%; border-collapse:collapse; font-size:0.79rem; margin-bottom:0.8rem; }
.pool-standings th { background:var(--surface2); font-size:0.6rem; letter-spacing:1.5px; font-weight:700; text-transform:uppercase; color:var(--muted); padding:0.5rem 0.7rem; text-align:center; border:1px solid var(--border); }
.pool-standings td { padding:0.45rem 0.7rem; border:1px solid var(--border); text-align:center; }
.pool-standings td:nth-child(2) { text-align:left; font-weight:700; }
.pool-standings tr.q1 td { background:rgba(52,212,123,0.08); }
.pool-standings tr.q2 td { background:rgba(74,158,255,0.06); }
.pool-standings tr:hover td { background:var(--surface2); }
.q-badge { font-size:0.58rem; font-weight:700; padding:1px 6px; border-radius:10px; }
.q-badge.q1 { background:var(--green-bg); color:var(--green); border:1px solid rgba(52,212,123,0.3); }
.q-badge.q2 { background:rgba(74,158,255,0.15); color:var(--blue); border:1px solid rgba(74,158,255,0.3); }
.q-badge.elim { background:var(--red-bg); color:var(--red); border:1px solid rgba(240,83,74,0.3); }

/* â”€â”€ POULE MATCHES LIST â”€â”€ */
.pool-matches-list { display:flex; flex-direction:column; gap:0.45rem; }
.pool-match-row {
  display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.9rem;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  font-size:0.82rem; transition:border-color 0.15s; flex-wrap:wrap;
}
.pool-match-row.done { border-color:rgba(52,212,123,0.3); background:rgba(52,212,123,0.04); }
.pool-match-row.can-play { border-color:rgba(230, 57, 70, 0.35); cursor:pointer; }
.pool-match-row.can-play:hover { background:var(--surface2); }
.pmr-num { font-size:0.6rem; font-weight:700; color:var(--muted); background:var(--surface2); border-radius:4px; padding:2px 5px; min-width:22px; text-align:center; flex-shrink:0; }
.pmr-p1 { flex:1; font-weight:700; min-width:80px; }
.pmr-score { font-family:'DM Mono',monospace; font-weight:800; font-size:1rem; color:var(--accent); min-width:44px; text-align:center; }
.pmr-p2 { flex:1; font-weight:700; min-width:80px; text-align:right; }
.pmr-status { font-size:0.6rem; font-weight:700; padding:2px 8px; border-radius:10px; white-space:nowrap; flex-shrink:0; }
.pmr-done { background:var(--green-bg); color:var(--green); border:1px solid rgba(52,212,123,0.3); }
.pmr-pending { background:var(--accent-dim); color:var(--accent); border:1px solid rgba(230, 57, 70, 0.3); }
.pmr-wait { background:var(--surface2); color:var(--muted); border:1px solid var(--border); }
.pmr-winner { color:var(--green); }
.pmr-loser { color:var(--muted); text-decoration:line-through; opacity:0.55; }

/* â”€â”€ BRACKET VISUEL â”€â”€ */
.bracket-visual { display:flex; gap:0; overflow-x:auto; padding:0.5rem 0 1rem; }
.bracket-col { display:flex; flex-direction:column; min-width:150px; }
.bracket-col-title { font-size:0.58rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--accent); text-align:center; padding:0.4rem; margin-bottom:0.3rem; }
.bracket-spacer { flex:1; }
.bv-match {
  background:var(--surface2); border:1px solid var(--border); border-radius:8px;
  overflow:hidden; margin:3px 8px; box-shadow:var(--shadow-sm);
  transition:border-color 0.15s;
}
.bv-match.can-play { border-color:rgba(230, 57, 70, 0.4); cursor:pointer; }
.bv-match.can-play:hover { border-color:var(--accent); background:var(--surface3); }
.bv-match.done { border-color:rgba(52,212,123,0.3); }
.bv-player { display:flex; align-items:center; justify-content:space-between; padding:0.38rem 0.6rem; font-size:0.76rem; font-weight:600; border-bottom:1px solid var(--border); }
.bv-player:last-child { border-bottom:none; }
.bv-player.winner { background:var(--green-bg); color:var(--green); }
.bv-player.tbd { color:var(--muted); font-style:italic; opacity:0.6; }
.bv-player.bye { opacity:0.35; font-style:italic; }
.bv-score { font-family:'DM Mono',monospace; font-size:0.8rem; font-weight:700; }
.bv-connector { width:16px; display:flex; flex-direction:column; align-items:center; justify-content:center; flex-shrink:0; }
.bv-connector-line { width:2px; background:var(--border); flex:1; }
.bv-connector-h { width:100%; height:2px; background:var(--border); }

/* â”€â”€ RR STANDINGS AMÃ‰LIORÃ‰ â”€â”€ */
.rr-standing-card { display:flex; align-items:center; gap:0.8rem; padding:0.7rem 1rem; background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:0.4rem; }
.rr-rank-num { font-family:'Bebas Neue', sans-serif; font-size:1.3rem; font-weight:800; color:var(--muted); min-width:28px; text-align:center; }
.rr-rank-num.r1 { color:var(--gold); }
.rr-rank-num.r2 { color:var(--silver); }
.rr-rank-num.r3 { color:var(--bronze); }
.rr-player-name { flex:1; font-weight:700; font-size:0.9rem; }
.rr-pts-big { font-family:'DM Mono',monospace; font-size:1.1rem; font-weight:700; color:var(--accent); min-width:36px; text-align:right; }
.rr-mini-stats { display:flex; gap:0.8rem; font-size:0.68rem; color:var(--muted); }
.rr-ms-v { color:var(--green); font-weight:700; }
.rr-ms-d { color:var(--red); font-weight:700; }

/* â”€â”€ TOURNOI LIST AMÃ‰LIORÃ‰E â”€â”€ */
.t-list-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:0.9rem; }
.t-card-new {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.3rem; box-shadow:var(--shadow-sm); cursor:pointer;
  transition:all 0.18s; position:relative; overflow:hidden;
}
.t-card-new::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.t-card-new.active::before { background:linear-gradient(90deg,var(--accent),transparent); }
.t-card-new.finished::before { background:linear-gradient(90deg,var(--green),transparent); }
.t-card-new:hover { border-color:var(--border2); transform:translateY(-2px); box-shadow:var(--shadow); }
.t-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:0.7rem; }
.t-card-name { font-size:1rem; font-weight:700; margin-bottom:3px; }
.t-card-sub { font-size:0.67rem; color:var(--muted); }
.t-card-chips { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:0.8rem; }
.t-chip { font-size:0.6rem; font-weight:700; letter-spacing:0.8px; padding:2px 8px; border-radius:10px; background:var(--surface2); border:1px solid var(--border); color:var(--muted); }
.t-chip.accent { background:var(--accent-dim); border-color:rgba(230, 57, 70, 0.3); color:var(--accent); }
.t-card-progress { display:flex; align-items:center; gap:0.5rem; }
.t-prog-bar { flex:1; height:4px; background:var(--border); border-radius:4px; overflow:hidden; }
.t-prog-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--accent),#ff6b74); transition:width 0.5s; }
.t-card-actions { display:flex; gap:0.5rem; margin-top:0.8rem; padding-top:0.7rem; border-top:1px solid var(--border); }

/* â”€â”€ TIRAGE ALÃ‰ATOIRE â”€â”€ */
.tirage-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 1.5rem;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.tirage-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.9rem 1.3rem;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.tirage-header:hover { background: var(--surface2); }
.tirage-header-left { display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; font-weight: 700; }
.tirage-header-right { display: flex; align-items: center; gap: 0.5rem; }
.tirage-chevron { font-size: 0.75rem; color: var(--muted); transition: transform 0.2s; }
.tirage-panel.open .tirage-chevron { transform: rotate(180deg); }
.tirage-body { 
  max-height: 0;
  overflow: hidden;
  padding: 0 1.3rem;
  border-top: 0 solid var(--border);
  transition: max-height 0.35s ease, padding 0.3s ease;
}
.tirage-panel.open .tirage-body { 
  max-height: 2000px;
  padding: 1.3rem;
  border-top: 1px solid var(--border);
}

/* PrÃ©sence joueurs */
.presence-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.presence-chip {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: var(--surface2);
  cursor: pointer;
  font-size: 0.76rem;
  font-weight: 600;
  transition: all 0.15s;
  user-select: none;
  color: var(--text-dim);
}
.presence-chip:hover { border-color: var(--accent); color: var(--accent); }
.presence-chip.present {
  background: var(--accent-dim);
  border-color: var(--accent);
  color: var(--accent);
}
.presence-chip.present::before { content: 'âœ“ '; font-weight: 700; }

/* Options tirage */
.tirage-options {
  display: flex;
  gap: 0.8rem;
  flex-wrap: wrap;
  align-items: flex-end;
  margin-bottom: 1rem;
  padding: 0.8rem;
  background: var(--bg);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.tirage-opt-field { display: flex; flex-direction: column; gap: 0.2rem; }
.tirage-opt-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 1.8px; text-transform: uppercase; color: var(--muted); }
.tirage-opt-field select, .tirage-opt-field input { min-width: 120px; }

/* Matchs gÃ©nÃ©rÃ©s */
.random-matches-list { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
.rnd-match {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.8rem;
  flex-wrap: wrap;
  box-shadow: var(--shadow-sm);
  transition: border-color 0.15s;
}
.rnd-match.rnd-done { border-color: rgba(52,212,123,0.35); background: rgba(52,212,123,0.04); }
.rnd-match.rnd-active { border-color: var(--accent); }
.rnd-num { font-size: 0.65rem; font-weight: 700; color: var(--muted); min-width: 24px; text-align: center; background: var(--surface2); border-radius: 4px; padding: 2px 4px; }
.rnd-player { font-size: 0.85rem; font-weight: 700; flex: 1; min-width: 90px; }
.rnd-vs { font-size: 0.75rem; color: var(--muted); font-weight: 700; }
.rnd-score-inputs { display: flex; align-items: center; gap: 0.4rem; }
.rnd-score { width: 48px; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.3rem 0.4rem; text-align: center; font-weight: 700; font-size: 1rem; background: var(--surface2); color: var(--text); transition: border-color 0.15s; font-family:'DM Mono',monospace; }
.rnd-score:focus { border-color: var(--accent); outline: none; }
.rnd-dash { font-weight: 700; color: var(--muted); }
.rnd-validate { background: linear-gradient(135deg, #2ab96a, var(--green)); color: #fff; border: none; border-radius: 6px; padding: 0.3rem 0.7rem; font-size: 0.75rem; font-weight: 700; cursor: pointer; font-family: 'Work Sans', sans-serif; transition: all 0.15s; white-space: nowrap; }
.rnd-validate:hover { filter:brightness(1.1); transform:translateY(-1px); }
.rnd-validate:disabled { background: var(--surface2); color: var(--muted); cursor: default; transform:none; }
.rnd-done-badge { font-size: 0.65rem; font-weight: 700; background: var(--green-bg); color: var(--green); border: 1px solid rgba(52,212,123,0.3); border-radius: 10px; padding: 2px 7px; margin-left: auto; white-space: nowrap; }
.rnd-winner-name { font-size: 0.7rem; color: var(--green); font-weight: 700; }
.tirage-actions { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center; margin-top: 1rem; }
.tirage-summary { font-size: 0.75rem; color: var(--muted); margin-left: auto; }

/* â”€â”€ ENTRAÃNEMENT â”€â”€ */
.exercise-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.2rem;
  box-shadow: var(--shadow-sm); transition: all 0.18s;
  position: relative; overflow: hidden;
  cursor: pointer;
}
.exercise-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
}
.exercise-card.cat-precision::before { background: linear-gradient(90deg, var(--blue), transparent); }
.exercise-card.cat-doubles::before  { background: linear-gradient(90deg, var(--green), transparent); }
.exercise-card.cat-triples::before  { background: linear-gradient(90deg, var(--accent), transparent); }
.exercise-card.cat-warmup::before   { background: linear-gradient(90deg, var(--purple), transparent); }
.exercise-card.cat-mental::before   { background: linear-gradient(90deg, var(--red), transparent); }
.exercise-card:hover { border-color: var(--border2); transform: translateY(-2px); box-shadow: var(--shadow); }
.exercise-card.completed { border-color: rgba(52,212,123,0.4); background: rgba(52,212,123,0.04); }
.ex-header { display: flex; align-items: flex-start; gap: 0.8rem; margin-bottom: 0.7rem; }
.ex-icon { font-size: 1.6rem; flex-shrink: 0; }
.ex-title { font-size: 0.9rem; font-weight: 700; color: var(--text); }
.ex-subtitle { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }
.ex-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.7rem; }
.ex-badge { font-size: 0.58rem; font-weight: 700; padding: 2px 7px; border-radius: 10px; letter-spacing: 0.5px; text-transform: uppercase; }
.ex-badge.diff-easy   { background: rgba(52,212,123,0.15); color: var(--green); border: 1px solid rgba(52,212,123,0.3); }
.ex-badge.diff-medium { background: rgba(230, 57, 70, 0.15); color: var(--accent); border: 1px solid rgba(230, 57, 70, 0.3); }
.ex-badge.diff-hard   { background: rgba(240,83,74,0.15); color: var(--red); border: 1px solid rgba(240,83,74,0.3); }
.ex-badge.cat-label   { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
.ex-desc { font-size: 0.76rem; color: var(--text-dim); line-height: 1.6; margin-bottom: 0.8rem; }
.ex-target { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.7rem; background: var(--bg); border-radius: 7px; border: 1px solid var(--border); font-size: 0.73rem; margin-bottom: 0.8rem; }
.ex-target-label { color: var(--muted); }
.ex-target-val { color: var(--accent); font-weight: 700; font-family: 'DM Mono', monospace; margin-left: auto; }
.ex-footer { display: flex; align-items: center; justify-content: space-between; }
.ex-duration { font-size: 0.65rem; color: var(--muted); display: flex; align-items: center; gap: 0.3rem; }
.ex-pr { font-size: 0.68rem; font-weight: 700; color: var(--gold); }

/* Training session modal */
.train-step { margin-bottom: 1.2rem; }
.train-step-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem; }
.train-counter { display: flex; align-items: center; gap: 0.8rem; margin: 0.8rem 0; }
.train-count-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border); background: var(--surface2); color: var(--text); font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; font-family: 'Work Sans', sans-serif; }
.train-count-btn:hover { border-color: var(--accent); color: var(--accent); }
.train-count-val { font-family: 'DM Mono', monospace; font-size: 2rem; font-weight: 700; color: var(--accent); min-width: 60px; text-align: center; }
.train-count-max { font-size: 0.75rem; color: var(--muted); }
.train-score-bar { height: 8px; border-radius: 4px; background: var(--border); overflow: hidden; margin-top: 0.5rem; }
.train-score-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; background: linear-gradient(90deg, var(--green), var(--accent)); }
.train-result { text-align: center; padding: 1.5rem 1rem; }
.train-result-score { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; font-weight: 800; color: var(--accent); }
.train-result-label { font-size: 0.72rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 0.3rem; }
.train-result-medal { font-size: 2rem; margin: 0.5rem 0; }
.train-result-msg { font-size: 0.85rem; color: var(--text-dim); margin: 0.5rem 0 1.2rem; line-height: 1.5; }

/* History sessions */
.train-hist-item {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 0.75rem 1rem;
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 0.4rem; font-size: 0.8rem;
}
.train-hist-ex { flex: 1; font-weight: 600; }
.train-hist-score { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--accent); }
.train-hist-date { font-size: 0.62rem; color: var(--muted); }
.train-hist-medal { font-size: 1rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPTEUR DE POINTS â€” SCORE COUNTER APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Overlay plein Ã©cran */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE COUNTER â€” Full redesign
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sc-overlay {
  position: fixed; inset: 0;
  background: #05070d;
  z-index: 8000;
  display: none;
  flex-direction: column;
  overflow: hidden;
  font-family: 'Work Sans', sans-serif;
}
.sc-overlay.active { display: flex; }

/* â”€â”€ Topbar â”€â”€ */
.sc-topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.55rem 1rem;
  background: rgba(255,255,255,0.025);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  flex-shrink: 0; gap: 0.5rem;
}
.sc-game-name {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.2rem; letter-spacing: 2px;
  color: var(--accent); text-transform: uppercase;
}
.sc-topbar-actions { display: flex; gap: 0.35rem; align-items: center; }
.sc-top-btn {
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.09);
  color: #6b7280; border-radius: 6px; padding: 0.35rem 0.75rem;
  font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.13s;
  font-family: 'Work Sans', sans-serif; text-transform: uppercase; letter-spacing: 0.8px;
}
.sc-top-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.sc-top-btn.danger:hover { border-color: var(--red); color: var(--red); background: var(--red-bg); }
.sc-top-btn.primary { background: var(--accent-dim); border-color: rgba(230, 57, 70, 0.5); color: var(--accent); }
.sc-top-btn.primary:hover { filter: brightness(1.15); }

/* â”€â”€ SETUP SCREEN â”€â”€ */
.sc-setup {
  flex: 1; overflow-y: auto; padding: 1.2rem 1rem;
  display: flex; flex-direction: column; gap: 1.2rem;
}
.sc-setup-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.2rem; color: var(--light);
  text-align: center; letter-spacing: 3px; line-height: 1;
}
.sc-setup-title span { color: var(--accent); }
.sc-game-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 0.55rem;
}
.sc-game-card {
  background: rgba(255,255,255,0.03); border: 1.5px solid rgba(255,255,255,0.07);
  border-radius: 12px; padding: 0.9rem 0.6rem;
  cursor: pointer; transition: all 0.16s; text-align: center;
  position: relative; overflow: hidden;
}
.sc-game-card:hover { border-color: rgba(230,57,70,0.4); background: rgba(230,57,70,0.05); transform: translateY(-1px); }
.sc-game-card.selected {
  border-color: var(--accent); background: var(--accent-dim);
  box-shadow: 0 0 0 1px var(--accent), 0 4px 16px rgba(230,57,70,0.2);
}
.sc-game-icon { font-size: 2rem; margin-bottom: 0.35rem; }
.sc-game-title { font-size: 0.95rem; font-weight: 800; color: var(--light); letter-spacing: 0.3px; }
.sc-game-desc { font-size: 0.72rem; color: #4b5563; margin-top: 3px; line-height: 1.3; }
.sc-setup-section { }
.sc-setup-label {
  font-size: 0.72rem; font-weight: 800; letter-spacing: 2.5px;
  text-transform: uppercase; color: #4b5563;
  margin-bottom: 0.7rem; display: flex; align-items: center; gap: 0.6rem;
}
.sc-setup-label::after { content:''; flex:1; height:1px; background: rgba(255,255,255,0.06); }

/* Players setup */
.sc-players-list { display: flex; flex-direction: column; gap: 0.45rem; }
.sc-player-row {
  display: flex; align-items: center; gap: 0.6rem;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 9px; padding: 0.5rem 0.8rem;
  transition: border-color 0.15s;
}
.sc-player-row:focus-within { border-color: var(--accent); }
.sc-player-num {
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--accent); color: #fff;
  font-size: 0.7rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(230,57,70,0.4);
}
.sc-player-row input {
  flex: 1; background: none; border: none; color: var(--light);
  font-size: 0.92rem; font-weight: 600; outline: none; padding: 0;
  font-family: 'Work Sans', sans-serif;
}
.sc-player-row input::placeholder { color: #374151; }
.sc-remove-player {
  background: none; border: none; color: #374151;
  cursor: pointer; font-size: 1rem; padding: 2px; transition: color 0.15s;
}
.sc-remove-player:hover { color: var(--red); }
.sc-options-grid { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.sc-opt-chip {
  padding: 0.35rem 0.9rem; border: 1.5px solid rgba(255,255,255,0.08);
  border-radius: 20px; background: rgba(255,255,255,0.04);
  font-size: 0.85rem; font-weight: 700; color: #6b7280;
  cursor: pointer; transition: all 0.13s; user-select: none;
}
.sc-opt-chip:hover { border-color: var(--accent); color: var(--accent); }
.sc-opt-chip.selected { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); }

/* â”€â”€ GAME SCREEN â”€â”€ */
.sc-game { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* Players zone â€” redesigned */
.sc-players-zone {
  display: flex; flex-direction: row; flex-shrink: 0;
  background: #07090f;
}
.sc-player-panel {
  flex: 1; min-width: 90px;
  display: flex; flex-direction: column; align-items: center;
  padding: 0.75rem 0.4rem 0.6rem;
  border-right: 1px solid rgba(255,255,255,0.04);
  cursor: pointer; transition: background 0.18s;
  position: relative; overflow: hidden;
}
.sc-player-panel::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--accent); opacity: 0; transition: opacity 0.2s;
}
.sc-player-panel.active-turn::before { opacity: 1; }
.sc-player-panel:last-child { border-right: none; }
.sc-player-panel.active-turn { background: rgba(230, 57, 70, 0.05); }
.sc-player-panel.bust { background: rgba(240,83,74,0.07); }
.sc-player-panel.winner-panel { background: rgba(230, 57, 70, 0.1); }

.sc-pname {
  font-size: 0.78rem; font-weight: 800; letter-spacing: 1.5px;
  color: #4b5563; text-transform: uppercase; margin-bottom: 0.2rem;
  text-align: center; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  width: 100%;
}
.sc-player-panel.active-turn .sc-pname { color: var(--accent); }

.sc-score-main {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 4.2rem; font-weight: 800;
  color: #e5e7eb; line-height: 1;
  transition: color 0.2s, transform 0.15s;
  letter-spacing: -1px;
}
.sc-player-panel.active-turn .sc-score-main { color: #ffffff; }
.sc-player-panel.bust .sc-score-main { color: var(--red); animation: scBust 0.4s ease; }

/* Score preview (remaining after current darts) */
.sc-score-preview {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.3rem; color: rgba(230,57,70,0.6); line-height: 1; letter-spacing: 0;
  transition: all 0.2s;
}

.sc-score-sub {
  font-size: 0.75rem; color: #4b5563; margin-top: 2px;
  font-family: 'DM Mono', monospace; text-align: center;
}
.sc-player-panel.active-turn .sc-score-sub { color: #9ca3af; }
.sc-legs-dots { display: flex; gap: 4px; margin-top: 5px; flex-wrap: wrap; justify-content: center; }
.sc-leg-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #1f2937; border: 1px solid #374151; transition: all 0.25s;
}
.sc-leg-dot.won { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 5px rgba(230,57,70,0.5); }
.sc-darts-thrown { font-size: 0.7rem; color: #4b5563; margin-top: 2px; }

/* Input zone */
.sc-input-zone {
  flex: 1; display: flex; flex-direction: column;
  padding: 0.6rem 0.7rem; gap: 0.5rem; overflow: hidden;
  background: #07090f;
}

/* Dart display â€” redesigned */
.sc-dart-display {
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(255,255,255,0.025); border-radius: 10px;
  padding: 0.55rem 0.9rem; border: 1px solid rgba(255,255,255,0.05);
  flex-shrink: 0;
}
.sc-dart-items-row { display: flex; align-items: center; gap: 0.5rem; }
.sc-dart-item {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  min-width: 48px;
}
.sc-dart-val {
  font-family: 'DM Mono', monospace;
  font-size: 1.5rem; font-weight: 700; color: #6b7280;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 7px; width: 56px; text-align: center;
  padding: 0.22rem 0; transition: all 0.18s;
}
.sc-dart-val.filled {
  border-color: rgba(230,57,70,0.5); color: #ffffff; background: rgba(230,57,70,0.12);
  box-shadow: 0 0 8px rgba(230,57,70,0.15);
}
.sc-dart-val.bust-dart { border-color: rgba(240,83,74,0.5); color: var(--red); background: rgba(240,83,74,0.1); }
.sc-dart-lbl { font-size: 0.62rem; color: #374151; letter-spacing: 1px; text-transform: uppercase; }
.sc-dart-sep { color: #1f2937; font-size: 1rem; }
.sc-dart-total-block { text-align: right; }
.sc-dart-total {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.6rem; font-weight: 700; color: var(--accent); line-height: 1;
}
.sc-dart-total-lbl { font-size: 0.62rem; color: #374151; text-transform: uppercase; letter-spacing: 1px; }

/* Multiplier selector â€” pill redesign */
.sc-multiplier { display: flex; gap: 0.35rem; justify-content: stretch; flex-shrink: 0; }
.sc-mult-btn {
  flex: 1; padding: 0.6rem 0.4rem;
  background: rgba(255,255,255,0.03); border: 1.5px solid rgba(255,255,255,0.07);
  border-radius: 9px; color: #6b7280;
  font-size: 0.88rem; font-weight: 800; cursor: pointer;
  transition: all 0.13s; font-family: 'Work Sans', sans-serif;
  text-align: center; letter-spacing: 0.3px; text-transform: uppercase;
}
.sc-mult-btn:hover { border-color: rgba(255,255,255,0.15); color: #9ca3af; }
.sc-mult-btn.active {
  background: rgba(230,57,70,0.12); border-color: var(--accent);
  color: #ffffff; box-shadow: 0 2px 10px rgba(230,57,70,0.2);
}
.sc-mult-btn.double.active { background: rgba(74,158,255,0.12); border-color: var(--blue); color: var(--blue); box-shadow: 0 2px 10px rgba(74,158,255,0.2); }
.sc-mult-btn.triple.active { background: rgba(240,83,74,0.12); border-color: #ff4500; color: #ff6b35; box-shadow: 0 2px 10px rgba(255,69,0,0.2); }

.sc-keypad {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 0.35rem; flex-shrink: 0;
}
.sc-key {
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 9px; padding: 0;
  font-size: 1.25rem; font-weight: 800; color: #d1d5db;
  cursor: pointer; transition: background 0.1s, transform 0.08s, box-shadow 0.1s;
  text-align: center; font-family: 'DM Mono', monospace;
  user-select: none; -webkit-tap-highlight-color: transparent;
  min-height: 56px; display: flex; align-items: center; justify-content: center;
  line-height: 1;
}
.sc-key:hover { background: rgba(255,255,255,0.07); color: #fff; }
.sc-key:active { transform: scale(0.93); background: rgba(255,255,255,0.1); }
.sc-key.bull {
  background: rgba(230,57,70,0.1); border-color: rgba(230,57,70,0.25); color: var(--accent);
  font-family: 'Work Sans', sans-serif; font-size: 0.88rem; letter-spacing: 0.5px; font-weight: 800;
}
.sc-key.bull:hover { background: rgba(230,57,70,0.18); }
.sc-key.miss {
  background: rgba(240,83,74,0.08); border-color: rgba(240,83,74,0.2); color: #ef4444;
  font-family: 'Work Sans', sans-serif; font-size: 0.85rem; font-weight: 800;
}
.sc-key.miss:hover { background: rgba(240,83,74,0.15); }
.sc-key.confirm {
  background: linear-gradient(145deg, var(--accent), #c0293a);
  color: #fff; border: none;
  font-family: 'Work Sans', sans-serif; font-size: 0.9rem; font-weight: 800;
  letter-spacing: 0.5px; text-transform: uppercase;
  box-shadow: 0 4px 14px rgba(230,57,70,0.35);
}
.sc-key.confirm:hover { filter: brightness(1.12); box-shadow: 0 6px 18px rgba(230,57,70,0.45); }
.sc-key.confirm:active { transform: scale(0.95); }
.sc-key.undo { background: rgba(255,255,255,0.03); color: #6b7280; font-size: 1.3rem; }
.sc-key.span2 { grid-column: span 2; }
.sc-key.span3 { grid-column: span 3; }
.sc-key.span5 { grid-column: span 5; }
.sc-key.section-num { background: rgba(74,158,255,0.08); border-color: rgba(74,158,255,0.2); color: var(--blue); font-size: 1rem; }
.sc-key.closed-num { background: rgba(52,212,123,0.1); border-color: rgba(52,212,123,0.25); color: var(--green); }

/* History strip */
.sc-history-strip {
  display: flex; gap: 0.25rem; overflow-x: auto;
  padding: 0.2rem 0; scrollbar-width: none; flex-shrink: 0;
}
.sc-history-strip::-webkit-scrollbar { display: none; }
.sc-hist-entry {
  flex-shrink: 0;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 5px; padding: 0.22rem 0.6rem;
  font-size: 0.78rem; font-family: 'DM Mono', monospace;
  color: #4b5563; white-space: nowrap;
}
.sc-hist-entry.last { border-color: rgba(230,57,70,0.35); color: var(--accent); background: rgba(230,57,70,0.06); }
.sc-hist-entry.entry-180 { border-color: rgba(245,197,24,0.5); color: var(--gold); background: rgba(245,197,24,0.06); }
.sc-hist-entry.bust { border-color: rgba(240,83,74,0.35); color: #ef4444; background: rgba(240,83,74,0.06); }

/* Checkout hint */
.sc-checkout-hint {
  background: rgba(52,212,123,0.08); border: 1.5px solid rgba(52,212,123,0.3);
  border-radius: 8px; padding: 0.45rem 0.9rem;
  font-size: 0.9rem; font-weight: 700; color: var(--green);
  text-align: center; display: none; flex-shrink: 0;
  letter-spacing: 0.3px; animation: scHintPop 0.2s ease;
}
.sc-checkout-hint.visible { display: block; }
@keyframes scHintPop { from { transform: scaleY(0.8); opacity: 0; } to { transform: scaleY(1); opacity: 1; } }

/* Live stats strip */
.sc-live-stats {
  display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 0.4rem 0.7rem;
  background: rgba(255,255,255,0.02); border-top: 1px solid rgba(255,255,255,0.04);
  font-size: 0.65rem; color: #4b5563;
}
.sc-live-stat { display: flex; align-items: center; gap: 0.25rem; }
.sc-live-stat-val { color: var(--accent); font-family: 'DM Mono', monospace; font-weight: 700; }

/* Bust animation */
@keyframes scBust {
  0%,100% { transform: translateX(0); }
  20%,60% { transform: translateX(-5px); }
  40%,80% { transform: translateX(5px); }
}
.sc-bust-anim { animation: scBust 0.35s ease; }

/* Score pulse animation */
@keyframes scScorePulse {
  0% { transform: scale(1.08); }
  100% { transform: scale(1); }
}
.sc-score-pulse { animation: scScorePulse 0.2s ease; }

/* Winner screen */
.sc-winner-screen {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 2rem;
  background: radial-gradient(ellipse at center 30%, rgba(230,57,70,0.15), transparent 65%);
  overflow-y: auto;
}
.sc-winner-trophy {
  font-size: 5rem; margin-bottom: 0.5rem;
  animation: scTrophyPop 0.5s cubic-bezier(0.34,1.56,0.64,1);
  filter: drop-shadow(0 0 20px rgba(245,197,24,0.5));
}
@keyframes scTrophyPop { from { transform: scale(0) rotate(-15deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }
.sc-winner-name {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 3.6rem; color: #ffffff;
  text-align: center; margin-bottom: 0.2rem; letter-spacing: 2px;
  animation: fadeIn 0.35s ease 0.25s both;
}
.sc-winner-label {
  font-size: 0.8rem; font-weight: 800; letter-spacing: 4px;
  text-transform: uppercase; color: var(--accent);
  animation: fadeIn 0.35s ease 0.4s both;
}
.sc-winner-stats {
  margin-top: 1.2rem; display: flex; gap: 1.2rem; flex-wrap: wrap; justify-content: center;
  animation: fadeIn 0.35s ease 0.55s both;
}
.sc-wstat { text-align: center; min-width: 70px; }
.sc-wstat-val { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: #fff; }
.sc-wstat-lbl { font-size: 0.68rem; color: #4b5563; letter-spacing: 1.5px; text-transform: uppercase; }

/* Recap grid */
.sc-recap-card {
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px; padding: 0.8rem; min-width: 130px;
}
.sc-recap-card.winner-card { border-color: rgba(230,57,70,0.4); background: rgba(230,57,70,0.06); }
.sc-recap-pname { font-weight: 800; font-size: 0.95rem; margin-bottom: 0.5rem; color: #e5e7eb; }
.sc-recap-stat-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.2rem; }
.sc-recap-stat-lbl { color: #6b7280; }
.sc-recap-stat-val { color: #f3f4f6; font-family: 'DM Mono', monospace; font-weight: 700; }

/* Cricket scoreboard */
.sc-cricket-board {
  display: flex; overflow-x: auto;
  background: rgba(255,255,255,0.025); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 10px; overflow: hidden; flex-shrink: 0;
}
.sc-cricket-col { flex: 1; min-width: 65px; display: flex; flex-direction: column; }
.sc-cricket-col.nums-col { min-width: 44px; }
.sc-cricket-header {
  background: rgba(255,255,255,0.04); padding: 0.38rem 0.3rem;
  text-align: center; font-size: 0.6rem; font-weight: 800;
  color: #6b7280; letter-spacing: 1px; text-transform: uppercase;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.sc-cricket-header.active-turn { color: var(--accent); }
.sc-cricket-cell {
  padding: 0.3rem; text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  font-size: 0.9rem; min-height: 34px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'DM Mono', monospace; font-weight: 700;
  transition: background 0.15s; color: #9ca3af;
}
.sc-cricket-cell:last-child { border-bottom: none; }
.sc-cricket-cell.num-label { color: #6b7280; font-size: 0.78rem; }
.sc-cricket-cell.open-num { background: rgba(74,158,255,0.07); color: var(--blue); }
.sc-cricket-cell.closed-num { background: rgba(52,212,123,0.08); color: var(--green); }
.sc-cricket-marks { font-size: 1rem; letter-spacing: -2px; }

/* Score input for other modes */
.sc-score-input-row {
  display: flex; gap: 0.5rem; align-items: center;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 9px; padding: 0.5rem 0.8rem;
}
.sc-score-input-row input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--light); font-family: 'DM Mono', monospace;
  font-size: 1.5rem; font-weight: 700; text-align: center;
}
.sc-score-input-row .sc-input-lbl { font-size: 0.6rem; color: #4b5563; letter-spacing: 1px; }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 480px) {
  .sc-score-main { font-size: 2.2rem; }
  .sc-key { padding: 0.5rem 0.2rem; font-size: 0.9rem; min-height: 40px; }
  .sc-game-grid { grid-template-columns: repeat(3, 1fr); }
}

/* â”€â”€ PRINT â€” masque tout, impression via fenÃªtre dÃ©diÃ©e â”€â”€ */
@media print {
  body > * { display: none !important; }
  .print-frame { display: block !important; }
}
/* â”€â”€ Bouton d'impression unifiÃ© â”€â”€ */
.btn-print {
  display: inline-flex; align-items: center; gap: 0.35rem;
  background: var(--dark-card); border: 1px solid var(--border2); border-radius: 7px;
  padding: 0.38rem 0.85rem; font-family: 'Work Sans', sans-serif;
  font-size: 0.72rem; font-weight: 600; color: var(--text-dim);
  cursor: pointer; letter-spacing: 0.5px; text-transform: uppercase;
  transition: all 0.15s; white-space: nowrap;
}
.btn-print:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-dim); }
.btn-print i { font-size: 0.8rem; }

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:768px) {
  .header { padding:0 0.8rem; height:auto; min-height:52px; flex-wrap:wrap; gap:0.3rem; padding-bottom:0.3rem; }
  .nav-row { display:none !important; }
  .content { padding:1rem; }
  .dash-grid { grid-template-columns:1fr; }
  .stats-grid { grid-template-columns:1fr; }
  .player-detail-grid { grid-template-columns:1fr 1fr; }
  .match-vs-row { grid-template-columns:1fr 1fr; }
  .fg-vs { display:none; }
  .rtable th:nth-child(n+5), .rtable td:nth-child(n+5) { display:none; }
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOUVELLES FONCTIONNALITÃ‰S v5
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ DIVISION BADGES â”€â”€ */
.division-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 0.6rem; font-weight: 700; letter-spacing: 1px;
  padding: 2px 8px; border-radius: 20px; text-transform: uppercase;
}
.div-bronze  { background: rgba(196,125,68,0.15); color: #e09a5a; border: 1px solid rgba(196,125,68,0.35); }
.div-silver  { background: rgba(143,163,189,0.15); color: #a8bfd4; border: 1px solid rgba(143,163,189,0.35); }
.div-gold    { background: rgba(230, 57, 70, 0.15); color: var(--primary); border: 1px solid rgba(230, 57, 70, 0.35); }
.div-elite   { background: linear-gradient(135deg,rgba(167,139,250,0.15),rgba(230, 57, 70, 0.15)); color: #c4a8fa; border: 1px solid rgba(167,139,250,0.4); }
.div-legend  { background: linear-gradient(135deg,rgba(240,83,74,0.15),rgba(230, 57, 70, 0.2)); color: #ffb347; border: 1px solid rgba(240,83,74,0.45); }

/* â”€â”€ MODE TV / LIVE â”€â”€ */
.tv-overlay {
  position: fixed; inset: 0;
  background: #060810;
  z-index: 9000;
  display: none;
  flex-direction: column;
  overflow: hidden;
}
.tv-overlay.active { display: flex; }
.tv-header {
  padding: 1.5rem 3rem;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid rgba(230, 57, 70, 0.2);
  background: rgba(230, 57, 70, 0.04);
  flex-shrink: 0;
}
.tv-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.8rem; font-weight: 800;
  color: var(--accent);
  letter-spacing: 1px;
  text-shadow: 0 0 30px rgba(230, 57, 70, 0.4);
}
.tv-clock {
  font-family: 'DM Mono', monospace;
  font-size: 2.5rem; font-weight: 500;
  color: var(--text-dim);
  letter-spacing: 4px;
}
.tv-season { font-size: 0.8rem; font-weight: 700; letter-spacing: 3px; color: var(--muted); }
.tv-close-btn {
  position: fixed; top: 1.5rem; right: 2rem;
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  border-radius: 8px; padding: 0.5rem 1rem;
  color: var(--muted); cursor: pointer; font-family: 'Work Sans', sans-serif;
  font-size: 0.8rem; font-weight: 600; transition: all 0.2s;
  text-transform: uppercase; letter-spacing: 1px; z-index: 9001;
}
.tv-close-btn:hover { border-color: var(--accent); color: var(--accent); }
.tv-body { flex: 1; display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 0; overflow: hidden; }
.tv-ranking { padding: 2rem 3rem; overflow-y: auto; }
.tv-right { display: flex; flex-direction: column; padding: 2rem 2.5rem 2rem 0; gap: 1.5rem; }
.tv-section-title {
  font-size: 0.65rem; font-weight: 700; letter-spacing: 3px; color: var(--muted);
  text-transform: uppercase; margin-bottom: 1rem;
  display: flex; align-items: center; gap: 0.8rem;
}
.tv-section-title::after { content:''; flex:1; height:1px; background:var(--border); }
.tv-rank-row {
  display: grid; grid-template-columns: 48px 1fr auto auto;
  align-items: center; gap: 1.2rem;
  padding: 0.9rem 1.2rem;
  border-radius: 10px; margin-bottom: 0.5rem;
  transition: background 0.3s, transform 0.3s;
  border: 1px solid transparent;
}
.tv-rank-row.tv-rank-1 { background: linear-gradient(90deg,rgba(230, 57, 70, 0.12),rgba(230, 57, 70, 0.04)); border-color: rgba(230, 57, 70, 0.25); }
.tv-rank-row.tv-rank-2 { background: rgba(143,163,189,0.06); border-color: rgba(143,163,189,0.18); }
.tv-rank-row.tv-rank-3 { background: rgba(196,125,68,0.06); border-color: rgba(196,125,68,0.18); }
.tv-rank-num { font-family: 'DM Mono', monospace; font-size: 1.2rem; font-weight: 500; color: var(--muted); text-align: center; }
.tv-rank-1 .tv-rank-num { color: var(--gold); font-size: 1.4rem; }
.tv-rank-2 .tv-rank-num { color: var(--silver); }
.tv-rank-3 .tv-rank-num { color: var(--bronze); }
.tv-rank-name { font-size: 1.1rem; font-weight: 700; color: var(--text); }
.tv-rank-sub { font-size: 0.7rem; color: var(--muted); margin-top: 1px; }
.tv-rank-elo { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--accent); }
.tv-rank-trend { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
.tv-last-match {
  background: rgba(230, 57, 70, 0.06); border: 1px solid rgba(230, 57, 70, 0.2);
  border-radius: 12px; padding: 1.2rem 1.5rem;
}
.tv-match-players { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin: 0.8rem 0; }
.tv-match-player { text-align: center; flex: 1; }
.tv-match-name { font-size: 1rem; font-weight: 700; color: var(--text); }
.tv-match-elo { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
.tv-match-score {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.5rem; font-weight: 800;
  color: var(--accent);
  text-align: center;
  text-shadow: 0 0 20px rgba(230, 57, 70, 0.3);
}
.tv-winner-banner {
  text-align: center; font-size: 0.72rem; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--gold); margin-top: 0.4rem;
}
.tv-podium { display: flex; align-items: flex-end; justify-content: center; gap: 1.2rem; padding: 0.5rem 0; }
.tv-podium-step { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; flex: 1; max-width: 130px; }
.tv-pod-name { font-size: 0.85rem; font-weight: 700; color: var(--text-dim); text-align: center; }
.tv-pod-elo { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: var(--accent); font-weight: 700; }
.tv-pod-bar { width: 100%; border-radius: 6px 6px 0 0; display: flex; align-items: center; justify-content: center; }
.tv-p1 .tv-pod-bar { height: 80px; background: linear-gradient(180deg,rgba(230, 57, 70, 0.25),rgba(230, 57, 70, 0.08)); border: 1px solid rgba(230, 57, 70, 0.35); }
.tv-p2 .tv-pod-bar { height: 55px; background: rgba(143,163,189,0.1); border: 1px solid rgba(143,163,189,0.25); }
.tv-p3 .tv-pod-bar { height: 38px; background: rgba(196,125,68,0.1); border: 1px solid rgba(196,125,68,0.25); }
.tv-p1 .tv-pod-elo { color: var(--gold); }
.tv-p2 .tv-pod-elo { color: var(--silver); }
.tv-p3 .tv-pod-elo { color: var(--bronze); }
.tv-pulse { animation: tvPulse 2s ease-in-out infinite; }
@keyframes tvPulse { 0%,100%{ opacity:1; } 50%{ opacity:0.6; } }
.live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); animation: livePulse 1.2s ease-in-out infinite; display: inline-block; margin-right: 6px; }
@keyframes livePulse { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.3);opacity:0.7;} }

/* â”€â”€ NOTIFICATIONS AMÃ‰LIORÃ‰ES â”€â”€ */
.notif {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.85rem 1.2rem;
  font-size: 0.8rem; font-weight: 600; color: var(--text);
  box-shadow: 0 8px 32px rgba(0,0,0,0.45), 0 2px 8px rgba(0,0,0,0.3);
  z-index: 9999;
  animation: notifIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
  max-width: 300px;
  display: flex; align-items: center; gap: 0.7rem;
  border-left: 3px solid var(--accent);
}
.notif.notif-success { border-left-color: var(--green); }
.notif.notif-win { border-left-color: var(--gold); }
.notif.notif-error { border-left-color: var(--red); }
.notif-icon { font-size: 1.2rem; flex-shrink: 0; }
.notif-msg { flex: 1; }
.notif-progress {
  position: absolute; bottom: 0; left: 0; height: 2px;
  background: var(--accent); border-radius: 0 0 12px 12px;
  animation: notifProgress 2.8s linear forwards;
}
.notif.notif-success .notif-progress { background: var(--green); }
.notif.notif-win .notif-progress { background: var(--gold); }
.notif.notif-error .notif-progress { background: var(--red); }
@keyframes notifIn { from{opacity:0;transform:translateX(20px) scale(0.9);} to{opacity:1;transform:translateX(0) scale(1);} }
@keyframes notifProgress { from{width:100%;} to{width:0%;} }

/* â”€â”€ HISTORIQUE TIMELINE â”€â”€ */
.hist-timeline { display: flex; flex-direction: column; gap: 0; position: relative; }
.hist-day-group { margin-bottom: 1.5rem; }
.hist-day-label {
  font-size: 0.62rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 0.6rem;
  display: flex; align-items: center; gap: 0.8rem;
}
.hist-day-label::after { content:''; flex:1; height:1px; background:var(--border); }
.hist-match-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 0.85rem 1.1rem;
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 0.4rem; transition: border-color 0.15s;
  position: relative; overflow: hidden;
}
.hist-match-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px; background: var(--border);
  border-radius: 10px 0 0 10px;
}
.hist-match-card.hm-win::before { background: var(--green); }
.hist-match-card.hm-draw::before { background: var(--muted); }
.hist-match-card:hover { border-color: var(--border2); }
.hm-player-a, .hm-player-b { flex: 1; }
.hm-player-a { text-align: right; }
.hm-pname { font-size: 0.86rem; font-weight: 700; color: var(--text); }
.hm-pname.winner { color: var(--accent); }
.hm-pname.loser { color: var(--muted); }
.hm-elo-change { font-size: 0.65rem; font-family: 'DM Mono', monospace; }
.hm-score-box {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 0.4rem 0.9rem;
  font-family: 'DM Mono', monospace; font-size: 1.1rem;
  font-weight: 700; color: var(--accent);
  min-width: 64px; text-align: center;
  flex-shrink: 0;
}
.hm-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.8rem; padding: 4px; margin-left: 0.3rem; transition: color 0.15s; }
.hm-del:hover { color: var(--red); }

/* â”€â”€ TABS HISTORY â”€â”€ */
.hist-tabs { display: flex; gap: 2px; margin-bottom: 1.2rem; background: var(--surface2); border-radius: 10px; padding: 4px; border: 1px solid var(--border); }
.hist-tab { flex: 1; padding: 0.4rem 0.7rem; background: none; border: none; border-radius: 7px; font-family: 'Work Sans', sans-serif; font-size: 0.73rem; font-weight: 600; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s; text-transform: uppercase; color: var(--muted); }
.hist-tab.active { background: var(--surface); color: var(--accent); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

/* â”€â”€ MOBILE BOTTOM NAV â”€â”€ */
.mobile-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(13,17,26,0.97);
  backdrop-filter: blur(16px);
  border-top: 1px solid var(--border);
  padding: 0.4rem 0 max(0.4rem, env(safe-area-inset-bottom));
  z-index: 250;
  box-shadow: 0 -4px 24px rgba(0,0,0,0.4);
}
.mobile-nav-items { display: flex; align-items: center; justify-content: space-around; }
.mnav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 0.3rem 0.7rem; border: none; background: none;
  color: var(--muted); cursor: pointer; transition: all 0.15s;
  border-radius: 8px; min-width: 48px;
}
.mnav-btn.active { color: var(--accent); }
.mnav-icon { font-size: 1.1rem; }
.mnav-label { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
@media(max-width: 768px) {
  .mobile-nav { display: block; }
  .nav { display: none !important; }
  .content { padding: 0.9rem; padding-bottom: 5rem; }
  .header { height: 52px; }
  .header-right .timer-btn { display: none; }
  .header-right .season-badge { font-size: 0.62rem; padding: 0.18rem 0.55rem; }
  .page-title { font-size: 1.15rem; margin-bottom: 1.1rem; }
  .dash-stats { grid-template-columns: repeat(2, 1fr); gap: 0.6rem; }
  .stat-value { font-size: 1.6rem; }
  .players-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .match-vs-row { grid-template-columns: 1fr auto auto auto 1fr; gap: 0.5rem; }
  .tv-body { grid-template-columns: 1fr; }
  .tv-right { display: none; }
}

/* â”€â”€ MOBILE MORE MENU â”€â”€ */
.mobile-more-backdrop {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 240;
}
.mobile-more-backdrop.active { display: block; }
.mobile-more-menu {
  position: fixed; left: 0; right: 0; bottom: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px 18px 0 0;
  padding: 0.6rem 1.2rem 5.5rem;
  z-index: 249;
  transform: translateY(100%);
  transition: transform 0.32s cubic-bezier(0.32, 0.72, 0, 1);
  box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
}
.mobile-more-menu.active { transform: translateY(0); }
.mobile-more-handle {
  width: 36px; height: 4px; border-radius: 4px;
  background: var(--border2); margin: 0 auto 1rem;
}
.mobile-more-title {
  font-size: 0.62rem; font-weight: 700; letter-spacing: 2.5px;
  text-transform: uppercase; color: var(--muted);
  margin-bottom: 1rem;
}
.mobile-more-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 0.7rem;
}
.mobile-more-item {
  display: flex; flex-direction: column; align-items: center;
  gap: 0.5rem; padding: 0.9rem 0.5rem;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer;
  transition: all 0.15s; font-family: 'Work Sans', sans-serif;
}
.mobile-more-item:hover, .mobile-more-item:active {
  border-color: var(--accent); background: var(--accent-dim);
}
.mobile-more-item.active-page {
  border-color: var(--accent); background: var(--accent-dim);
}
.mmore-icon { font-size: 1.4rem; }
.mmore-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-dim); }

/* â”€â”€ STATS AVANCÃ‰ES - Widgets â”€â”€ */
.stat-widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-widget {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.2rem;
  box-shadow: var(--shadow-sm);
}
.sw-title { font-size: 0.62rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }
.sw-player-row {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.5rem 0; border-bottom: 1px solid var(--border);
}
.sw-player-row:last-child { border-bottom: none; }
.sw-rank { font-family: 'DM Mono', monospace; font-size: 0.75rem; font-weight: 500; color: var(--muted); width: 20px; }
.sw-name { flex: 1; font-size: 0.82rem; font-weight: 600; color: var(--text); }
.sw-val { font-family: 'DM Mono', monospace; font-size: 0.88rem; font-weight: 700; }
.streak-bar { flex: 1; display: flex; gap: 2px; }
.streak-seg { height: 6px; border-radius: 3px; flex: 1; background: var(--border); }
.streak-seg.w { background: var(--green); }
.streak-seg.l { background: var(--red); }

/* â”€â”€ SESSION INDICATOR â”€â”€ */
.session-bar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0.4rem 1.8rem; display: flex; align-items: center;
  gap: 1rem; font-size: 0.65rem; font-weight: 600; letter-spacing: 1px;
  text-transform: uppercase; color: var(--muted);
  flex-wrap: wrap;
}
.session-stat { display: flex; align-items: center; gap: 0.3rem; }
.session-stat-val { color: var(--accent); font-family: 'DM Mono', monospace; }
.session-divider { width: 1px; height: 14px; background: var(--border); }

/* â”€â”€ TV MODE BUTTON â”€â”€ */
.btn-tv {
  background: linear-gradient(135deg, rgba(230, 57, 70, 0.15), rgba(230, 57, 70, 0.08));
  border: 1px solid rgba(230, 57, 70, 0.35);
  color: var(--accent);
  border-radius: 7px; padding: 0.3rem 0.75rem;
  font-size: 0.73rem; font-weight: 600; cursor: pointer;
  font-family: 'Work Sans', sans-serif; transition: all 0.15s;
  display: flex; align-items: center; gap: 0.4rem;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.btn-tv:hover { background: rgba(230, 57, 70, 0.2); box-shadow: 0 0 12px rgba(230, 57, 70, 0.15); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   V6 â€” Profil Â· Calendrier Â· Club Â· Sauvegarde
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ PLAYER PROFILE MODAL â”€â”€ */
.profile-modal { max-width: 600px; }
.profile-hero {
  display: flex; align-items: center; gap: 1.5rem;
  padding: 1.5rem; margin: -2rem -2rem 1.5rem;
  background: linear-gradient(135deg, var(--surface2), var(--surface3));
  border-bottom: 1px solid var(--border);
  border-radius: 14px 14px 0 0;
  position: relative; overflow: hidden;
}
.profile-hero::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(ellipse at 80% 50%, var(--player-color, rgba(230, 57, 70, 0.12)), transparent 70%);
  pointer-events: none;
}
.profile-avatar-big {
  width: 72px; height: 72px; border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem; font-weight: 800; flex-shrink: 0;
  position: relative; z-index: 1;
  border: 2px solid rgba(255,255,255,0.1);
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}
.profile-hero-info { flex: 1; position: relative; z-index: 1; }
.profile-pseudo-big { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; font-weight: 800; color: var(--text); }
.profile-name-big { font-size: 0.8rem; color: var(--text-dim); margin-top: 2px; }
.profile-surnom { font-size: 0.75rem; font-style: italic; color: var(--accent); margin-top: 4px; letter-spacing: 0.5px; }
.profile-elo-hero { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; font-weight: 800; color: var(--accent); }
.profile-stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.6rem; margin-bottom: 1.2rem; }
.profile-stat-box {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 0.7rem 0.5rem; text-align: center;
}
.profile-stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--accent); }
.profile-stat-lbl { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 1px; }
.profile-section { margin-bottom: 1.2rem; }
.profile-section-title { font-size: 0.62rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 0.6rem; }
.avatar-color-picker { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.avatar-color-swatch {
  width: 28px; height: 28px; border-radius: 8px; cursor: pointer;
  border: 2px solid transparent; transition: all 0.15s;
  flex-shrink: 0;
}
.avatar-color-swatch.selected { border-color: var(--text); transform: scale(1.15); }
.avatar-emoji-picker { display: flex; gap: 0.4rem; flex-wrap: wrap; }
.avatar-emoji-btn {
  width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.avatar-emoji-btn:hover, .avatar-emoji-btn.selected { border-color: var(--accent); background: var(--accent-dim); }
.profile-bio-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 0.6rem 0.8rem; color: var(--text);
  font-family: 'Work Sans', sans-serif; font-size: 0.85rem; resize: vertical;
  min-height: 60px; max-height: 120px; outline: none;
  transition: border-color 0.15s;
}
.profile-bio-input:focus { border-color: var(--accent); }
.profile-card-preview {
  background: linear-gradient(135deg, #0d1117 0%, #1a2035 100%);
  border: 1px solid rgba(230, 57, 70, 0.2); border-radius: 12px;
  padding: 1.2rem; position: relative; overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.profile-card-preview::before {
  content: ''; position: absolute; top: -30px; right: -30px;
  width: 120px; height: 120px; border-radius: 50%;
  background: radial-gradient(var(--player-color, rgba(230, 57, 70, 0.2)), transparent 70%);
}
.card-export-btn {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff; border: none; border-radius: 7px;
  padding: 0.4rem 1rem; font-size: 0.72rem; font-weight: 700;
  cursor: pointer; font-family: 'Work Sans', sans-serif;
  text-transform: uppercase; letter-spacing: 0.8px; transition: all 0.15s;
}
.card-export-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

/* Player card click area */
.pcard { cursor: pointer; }
.pcard-del { cursor: pointer; z-index: 2; position: relative; }

/* â”€â”€ CALENDRIER â”€â”€ */
.calendar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
@media(max-width:768px) { .calendar-grid { grid-template-columns: 1fr; } }
.soiree-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.2rem;
  box-shadow: var(--shadow-sm); transition: border-color 0.2s, transform 0.2s;
  position: relative; overflow: hidden;
}
.soiree-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
}
.soiree-card.sc-upcoming::before { background: var(--accent); }
.soiree-card.sc-today::before { background: var(--green); }
.soiree-card.sc-past::before { background: var(--muted); }
.soiree-card:hover { border-color: var(--border2); transform: translateY(-1px); }
.sc-date-badge {
  font-family: 'DM Mono', monospace; font-size: 0.72rem; font-weight: 500;
  color: var(--muted); margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem;
}
.sc-date-badge.today { color: var(--green); font-weight: 700; }
.sc-title { font-size: 0.95rem; font-weight: 700; color: var(--text); margin-bottom: 0.4rem; }
.sc-note { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.8rem; font-style: italic; }
.sc-attendees { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.8rem; }
.sc-attendee {
  font-size: 0.68rem; font-weight: 600; padding: 2px 8px; border-radius: 20px;
  background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(230, 57, 70, 0.25);
}
.sc-attendee-count { font-size: 0.68rem; color: var(--muted); align-self: center; }
.sc-actions { display: flex; gap: 0.4rem; }
.add-soiree-form {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.3rem;
  margin-bottom: 1.5rem; box-shadow: var(--shadow-sm);
}
.soiree-attendee-grid { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.6rem; }
.soiree-att-chip {
  padding: 0.25rem 0.65rem; border-radius: 20px; border: 1px solid var(--border);
  background: var(--surface2); cursor: pointer; font-size: 0.72rem; font-weight: 600;
  transition: all 0.15s; color: var(--text-dim);
}
.soiree-att-chip:hover { border-color: var(--accent); color: var(--accent); }
.soiree-att-chip.selected { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
.soiree-att-chip.selected::before { content: 'âœ“ '; }
.cal-empty { text-align: center; padding: 3rem 1rem; }
.cal-empty-icon { font-size: 3rem; margin-bottom: 0.8rem; opacity: 0.3; }
.cal-empty-text { font-size: 0.85rem; color: var(--muted); }
.past-soiree-link { font-size: 0.68rem; color: var(--muted); cursor: pointer; transition: color 0.15s; }
.past-soiree-link:hover { color: var(--accent); }

/* â”€â”€ CLUB SETTINGS â”€â”€ */
.club-color-grid { display: flex; gap: 0.6rem; flex-wrap: wrap; }
.club-color-btn {
  width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
  border: 2px solid transparent; transition: all 0.15s;
}
.bg-theme-btn { transition: border-color 0.15s, transform 0.15s; }
.bg-theme-btn:hover { transform: scale(1.08); border-color: var(--accent) !important; }
.bg-theme-btn.active { border-color: white !important; transform: scale(1.1); box-shadow: 0 0 8px rgba(255,255,255,0.3); }
.club-color-btn.active { border-color: white; transform: scale(1.15); box-shadow: 0 0 8px rgba(255,255,255,0.3); }

/* â”€â”€ Admin quick actions â”€â”€ */
.admin-action-btn {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 0.45rem; padding: 1rem 0.6rem;
  background: var(--dark-card); border: 1px solid var(--border); border-radius: 10px;
  color: var(--light); cursor: pointer; font-family: 'Work Sans', sans-serif;
  font-size: 0.72rem; font-weight: 600; transition: all 0.18s;
  text-align: center; line-height: 1.3;
}
.admin-action-btn:hover { border-color: var(--accent); background: var(--dark-hover); transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.3); }
.admin-action-icon { font-size: 1.5rem; }

/* â”€â”€ Hall of Fame record card â”€â”€ */
.hof-card {
  background: var(--dark-card); border: 1px solid var(--border);
  border-radius: 10px; padding: 0.9rem;
  border-top: 2px solid var(--accent);
  display: flex; flex-direction: column; gap: 0.25rem;
  transition: transform 0.15s, box-shadow 0.15s;
}
.hof-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
.hof-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
.hof-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.15rem; letter-spacing: 1.5px; color: var(--light); }
.hof-value { font-family: 'DM Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--accent); }
.hof-icon { font-size: 1.4rem; }

/* â”€â”€ H2H comparison â”€â”€ */
.h2h-bar-wrap { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0; }
.h2h-bar-label { font-size: 0.7rem; color: var(--muted); min-width: 70px; text-align: right; }
.h2h-bar-label.right { text-align: left; }
.h2h-bar-track { flex: 1; height: 8px; background: var(--dark-hover); border-radius: 4px; overflow: hidden; display: flex; }
.h2h-bar-fill1 { height: 100%; background: var(--accent); border-radius: 4px 0 0 4px; transition: width 0.4s; }
.h2h-bar-fill2 { height: 100%; background: var(--blue); border-radius: 0 4px 4px 0; transition: width 0.4s; }
.h2h-vs-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem; gap: 0.5rem; }
.h2h-player-col { text-align: center; flex: 1; }
.h2h-player-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px; }
.h2h-player-score { font-family: 'DM Mono', monospace; font-size: 2.2rem; font-weight: 800; line-height: 1; }
.h2h-vs-badge { font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; color: var(--muted); padding: 0 0.5rem; }
.club-logo-preview {
  width: 44px; height: 44px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; background: var(--accent-dim);
  border: 1px solid rgba(230, 57, 70, 0.3);
}
.logo-emoji-row { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.5rem; }
.logo-emoji-opt { font-size: 1.3rem; cursor: pointer; padding: 0.3rem; border-radius: 6px; border: 1px solid transparent; transition: all 0.15s; }
.logo-emoji-opt:hover, .logo-emoji-opt.selected { border-color: var(--accent); background: var(--accent-dim); }

/* â”€â”€ SAUVEGARDE AMÃ‰LIORÃ‰E â”€â”€ */
.backup-status {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.8rem 1rem; border-radius: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 0.78rem; margin-bottom: 0.8rem;
}
.backup-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.backup-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
.backup-dot.warn { background: var(--gold); box-shadow: 0 0 6px var(--gold); }
.backup-info { flex: 1; color: var(--text-dim); }
.backup-time { font-family: 'DM Mono', monospace; color: var(--muted); font-size: 0.7rem; }
.qr-code-box {
  background: white; border-radius: 8px; padding: 8px;
  display: inline-block; margin-top: 0.6rem;
}

/* â”€â”€ PLAYER CARD HOVER EFFECT â”€â”€ */
.pcard:hover::after { opacity: 0.08; }

/* â”€â”€ NOTIF UNDO â”€â”€ */
.notif-undo { background: var(--surface2) !important; border-color: var(--border2) !important; }
.notif-undo-btn { background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.25); color:var(--text); border-radius:4px; padding:2px 8px; font-size:0.68rem; cursor:pointer; font-family:'Work Sans', sans-serif; font-weight:700; letter-spacing:0.5px; margin-left:10px; }
.notif-undo-btn:hover { background:rgba(255,255,255,0.2); }


/* â”€â”€ SWIPE TRANSITION â”€â”€ */
.page { transition: opacity 0.18s ease; }

/* â”€â”€ DARK/LIGHT TOGGLE â”€â”€ */
body.light-mode {
  --bg: #f0f2f7; --surface: #ffffff; --surface2: #e8eaf0; --surface3: #dde0ea;
  --border: #d0d4e0; --border2: #bcc1d0; --text: #1a1f2e; --text-dim: #4a5568;
  --muted: #7a8499; background-image: none;
  --dark: #f0f2f7; --dark-light: #ffffff; --dark-card: #e8eaf0; --dark-hover: #dde0ea;
  --light: #1a1f2e; --gray: #7a8499;
}
body.light-mode .header { background: rgba(240,242,247,0.97); }
body.light-mode .card, body.light-mode .modal { background: var(--surface); }
body.light-mode .cnf-hero { background: linear-gradient(160deg, rgba(230,57,70,0.07) 0%, rgba(240,242,247,0) 55%), linear-gradient(180deg, #ffffff 0%, #f0f2f7 100%); }
body.light-mode .cnf-stat-card { background: rgba(0,0,0,0.04); }
body.light-mode .app-footer { background: #e8eaf0; }
body.light-mode .mobile-nav { background: rgba(245,246,250,0.98); border-top-color: rgba(230,57,70,0.25); }
body.light-mode .mobile-more-menu { background: #ffffff; }
body.light-mode input, body.light-mode select, body.light-mode textarea { background: var(--surface2); color: var(--text); border-color: var(--border); }
body.light-mode .notif { background: #ffffff; border-color: var(--border); color: var(--text); }
body.light-mode .tv-overlay { background: #1a1f2e; }
.theme-toggle { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:0.25rem 0.7rem; font-size:0.72rem; font-weight:600; cursor:pointer; color:var(--text-dim); transition:all .15s; display:flex;align-items:center;gap:0.3rem; }
.theme-toggle:hover { border-color:var(--accent); color:var(--accent); }

/* â”€â”€ SEARCH BAR â”€â”€ */
.search-wrap { position:relative; margin-bottom:1rem; }
.search-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:0.5rem 0.9rem 0.5rem 2.2rem; font-size:0.82rem; color:var(--text); font-family:'Work Sans', sans-serif; transition:border-color .15s; }
.search-input:focus { outline:none; border-color:var(--accent); }
.search-icon { position:absolute; left:0.7rem; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.9rem; pointer-events:none; }
.search-clear { position:absolute; right:0.7rem; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--muted); cursor:pointer; font-size:0.9rem; display:none; }

/* â”€â”€ KEYBOARD SHORTCUTS HINT â”€â”€ */
.kbd-hint { font-size:0.6rem; color:var(--muted); background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:1px 5px; font-family:'DM Mono',monospace; }

/* â”€â”€ ACHIEVEMENT UNLOCK ANIMATION â”€â”€ */
@keyframes achUnlock { 0%{transform:scale(0.4) rotate(-20deg);opacity:0} 60%{transform:scale(1.15) rotate(5deg);opacity:1} 100%{transform:scale(1) rotate(0deg);opacity:1} }
.ach-unlock-toast {
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0);
  background:linear-gradient(135deg,#1c2333,#252e40);
  border:2px solid var(--accent); border-radius:16px; padding:2rem 2.5rem;
  text-align:center; z-index:9999; min-width:260px;
  box-shadow:0 20px 60px rgba(0,0,0,0.6), 0 0 40px rgba(230, 57, 70, 0.3);
  animation: achUnlock 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
.ach-unlock-icon { font-size:3.5rem; display:block; margin-bottom:0.5rem; }
.ach-unlock-label { font-size:0.65rem; font-weight:700; letter-spacing:2px; color:var(--accent); text-transform:uppercase; margin-bottom:0.3rem; }
.ach-unlock-name { font-family:'Bebas Neue', sans-serif; font-size:1.4rem; font-weight:700; color:var(--text); }
.ach-unlock-desc { font-size:0.78rem; color:var(--text-dim); margin-top:0.3rem; }

/* â”€â”€ ACHIEVEMENT PROGRESS BAR â”€â”€ */
.ach-progress-wrap { margin-top:0.5rem; }
.ach-progress-bar { height:4px; background:var(--border); border-radius:2px; overflow:hidden; margin-top:2px; }
.ach-progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.6s ease; }
.ach-progress-label { font-size:0.62rem; color:var(--muted); display:flex; justify-content:space-between; }

/* â”€â”€ SCORE COUNTER LIVE STATS â”€â”€ */
.sc-live-stats { display:flex; gap:0.5rem; flex-wrap:wrap; padding:0.5rem 0.8rem; background:var(--surface2); border-top:1px solid var(--border); font-size:0.68rem; color:var(--muted); }
.sc-live-stat { display:flex; align-items:center; gap:0.3rem; }
.sc-live-stat-val { font-weight:700; color:var(--accent); font-family:'DM Mono',monospace; }
.sc-180-badge { background:rgba(230, 57, 70, 0.2); border:1px solid var(--accent); border-radius:4px; padding:0 5px; color:var(--accent); font-weight:700; font-size:0.65rem; animation:pulse180 0.4s ease; }
@keyframes pulse180 { 0%{transform:scale(1.4)} 100%{transform:scale(1)} }

/* â”€â”€ PROFILE TABS â”€â”€ */
.profile-tabs { display:flex; gap:2px; margin-bottom:1.2rem; border-bottom:1px solid var(--border); }
.profile-tab { padding:0.5rem 1rem; font-size:0.75rem; font-weight:600; color:var(--muted); cursor:pointer; border:none; background:none; border-bottom:2px solid transparent; transition:all .15s; font-family:'Work Sans', sans-serif; }
.profile-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.profile-tab-content { display:none; }
.profile-tab-content.active { display:block; animation:fadeIn .18s ease; }

/* â”€â”€ PROGRESS RINGS â”€â”€ */
.progress-ring { transform:rotate(-90deg); }
.progress-ring-bg { fill:none; stroke:var(--border); stroke-width:5; }
.progress-ring-fill { fill:none; stroke:var(--accent); stroke-width:5; stroke-linecap:round; transition:stroke-dashoffset 0.6s ease; }

/* â”€â”€ TRAINING PROGRESS CHART â”€â”€ */
.train-prog-chart { display:flex; align-items:flex-end; gap:3px; height:60px; padding:0 0.2rem; }
.train-prog-bar { flex:1; min-width:8px; background:var(--accent); border-radius:3px 3px 0 0; opacity:0.7; transition:height 0.4s ease; cursor:pointer; }
.train-prog-bar:hover { opacity:1; }

/* â”€â”€ WEEKLY GOAL â”€â”€ */
.weekly-goal-wrap { background:var(--surface2); border-radius:8px; padding:0.8rem 1rem; margin-bottom:0.8rem; }
.weekly-goal-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; font-size:0.78rem; }
.weekly-goal-bar { height:8px; background:var(--border); border-radius:4px; overflow:hidden; }
.weekly-goal-fill { height:100%; border-radius:4px; transition:width 0.5s ease; }

/* â”€â”€ SOIREE MVP â”€â”€ */
.soiree-mvp-badge { display:inline-flex; align-items:center; gap:0.4rem; background:var(--gold-bg); border:1px solid rgba(230, 57, 70, 0.4); border-radius:6px; padding:0.3rem 0.7rem; font-size:0.72rem; font-weight:700; color:var(--accent); }

/* â”€â”€ MATCH SEARCH â”€â”€ */
.match-hist-search { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:0.4rem 0.8rem; font-size:0.8rem; color:var(--text); font-family:'Work Sans', sans-serif; margin-bottom:0.8rem; }
.match-hist-search:focus { outline:none; border-color:var(--accent); }

/* â”€â”€ GAME STATS BREAKDOWN (post-match) â”€â”€ */
.sc-recap-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; margin-top:1rem; width:100%; max-width:380px; }
.sc-recap-card { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:0.7rem; text-align:center; }
.sc-recap-card.winner-card { border-color:rgba(230, 57, 70, 0.4); background:rgba(230, 57, 70, 0.06); }
.sc-recap-pname { font-size:0.7rem; font-weight:700; color:var(--text-dim); margin-bottom:0.4rem; }
.sc-recap-stat-row { display:flex; justify-content:space-between; font-size:0.72rem; margin-top:2px; }
.sc-recap-stat-lbl { color:var(--muted); }
.sc-recap-stat-val { font-weight:700; font-family:'DM Mono',monospace; color:var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORT EXCEL MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.import-dropzone {
  border: 2px dashed var(--border2);
  border-radius: 12px;
  padding: 2.2rem 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  background: var(--dark-card);
  position: relative;
}
.import-dropzone:hover,
.import-dropzone.drag-over {
  border-color: var(--primary);
  background: var(--primary-dim);
}
.import-dropzone input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.import-dropzone-icon { font-size: 2.4rem; margin-bottom: 0.6rem; color: var(--gray); }
.import-dropzone-label { font-size: 0.82rem; font-weight: 600; color: var(--text-dim); margin-bottom: 0.3rem; }
.import-dropzone-hint { font-size: 0.68rem; color: var(--gray); }
.import-format-hint {
  margin-top: 1rem;
  padding: 0.8rem 1rem;
  background: rgba(69,123,247,0.08);
  border: 1px solid rgba(69,123,247,0.2);
  border-radius: 8px;
  font-size: 0.72rem;
  color: var(--blue);
  line-height: 1.6;
}
.import-format-hint strong { color: var(--light); }
.import-preview-table { width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:0.5rem; }
.import-preview-table th {
  background: var(--dark-card); color: var(--gray);
  font-size: 0.62rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  padding: 0.5rem 0.7rem; border-bottom: 1px solid var(--border2); text-align: left;
}
.import-preview-table td { padding: 0.5rem 0.7rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
.import-preview-table tr:last-child td { border-bottom: none; }
.import-preview-table tr.row-duplicate td { opacity: 0.45; }
.import-preview-table tr.row-duplicate .status-badge { background:rgba(96,106,128,0.2); color:var(--gray); border-color:var(--border); }
.import-preview-table tr.row-new .status-badge { background:var(--green-bg); color:var(--green); border-color:rgba(45,198,83,0.3); }
.status-badge {
  display:inline-flex; align-items:center; gap:4px;
  font-size:0.6rem; font-weight:700; letter-spacing:0.5px;
  padding:2px 8px; border-radius:20px; border:1px solid; white-space:nowrap;
}
.import-preview-scroll {
  max-height:300px; overflow-y:auto;
  border:1px solid var(--border); border-radius:8px; background:var(--dark-light);
}
.import-summary { display:flex; gap:0.8rem; flex-wrap:wrap; margin:0.8rem 0 0.2rem; }
.import-summary-chip {
  display:flex; align-items:center; gap:0.4rem;
  font-size:0.72rem; font-weight:700; padding:0.3rem 0.8rem; border-radius:20px; border:1px solid;
}
.chip-new  { background:var(--green-bg); color:var(--green); border-color:rgba(45,198,83,0.3); }
.chip-dup  { background:rgba(96,106,128,0.12); color:var(--gray); border-color:var(--border); }
.chip-total{ background:var(--primary-dim); color:var(--primary); border-color:rgba(230,57,70,0.3); }
.import-col-map {
  display:flex; gap:0.8rem; align-items:center; flex-wrap:wrap;
  margin:0.8rem 0; padding:0.75rem 1rem;
  background:var(--dark-card); border:1px solid var(--border); border-radius:8px; font-size:0.78rem;
}
.import-col-map label { color:var(--text-dim); font-weight:600; white-space:nowrap; }
.import-col-map select { width:auto; padding:0.3rem 0.5rem; font-size:0.75rem; }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN Ã‰TAPE 2 â€” Mot de passe
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.login-step { display: none; }
.login-step.active { display: block; }
.login-back-btn {
  background: none; border: none; color: var(--text-dim);
  font-size: 0.78rem; cursor: pointer; font-family: 'Work Sans', sans-serif;
  display: flex; align-items: center; gap: 0.4rem;
  margin-bottom: 1.2rem; padding: 0;
  transition: color 0.15s;
}
.login-back-btn:hover { color: var(--primary); }
.login-selected-player {
  display: flex; align-items: center; gap: 0.8rem;
  background: var(--dark-card); border: 1px solid var(--border2);
  border-radius: 10px; padding: 0.8rem 1rem;
  margin-bottom: 1.2rem;
}
.login-selected-avatar {
  width: 40px; height: 40px; border-radius: 9px;
  background: var(--primary); color: #fff;
  font-size: 0.9rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.login-pwd-input-wrap {
  position: relative; margin-bottom: 1rem;
}
.login-pwd-input-wrap input {
  padding-right: 2.8rem;
  text-align: center; letter-spacing: 4px; font-size: 1.1rem;
}
.login-pwd-toggle {
  position: absolute; right: 0.8rem; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--gray); cursor: pointer;
  font-size: 0.9rem; padding: 0;
}
.login-pwd-toggle:hover { color: var(--primary); }
.login-no-pwd-hint {
  font-size: 0.72rem; color: var(--text-dim);
  margin-top: 0.6rem; text-align: center;
}
/* Gestion mots de passe dans ParamÃ¨tres */
.pwd-mgmt-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 0.7rem; margin-top: 0.8rem;
}
.pwd-player-card {
  background: var(--dark-card); border: 1px solid var(--border);
  border-radius: 10px; padding: 0.9rem 1rem;
  display: flex; align-items: center; gap: 0.7rem;
}
.pwd-player-info { flex: 1; min-width: 0; }
.pwd-player-pseudo { font-size: 0.82rem; font-weight: 700; color: var(--light); }
.pwd-player-status { font-size: 0.65rem; color: var(--gray); margin-top: 2px; }
.pwd-player-status.set { color: var(--green); }
.pwd-action-btn {
  background: var(--dark-light); border: 1px solid var(--border2);
  border-radius: 7px; padding: 0.3rem 0.6rem;
  font-size: 0.65rem; font-weight: 700; cursor: pointer;
  color: var(--text-dim); font-family: 'Work Sans', sans-serif;
  transition: all 0.15s; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px;
}
.pwd-action-btn:hover { border-color: var(--primary); color: var(--primary); }
.pwd-action-btn.danger:hover { border-color: var(--red); color: var(--red); }

#login-overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(5,7,12,0.97);
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px);
}
.login-box {
  background: var(--dark-light);
  border: 1px solid var(--border2);
  border-radius: 18px;
  padding: 2.5rem 2rem 2rem;
  width: 100%; max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.7);
}
.login-logo { font-size: 3.5rem; margin-bottom: 0.5rem; }
.login-title { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 4px; color: var(--primary); }
.login-sub { font-size: 0.82rem; color: var(--text-dim); margin-bottom: 2rem; }
.login-players-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem;
  max-height: 260px; overflow-y: auto; margin-bottom: 1.2rem;
}
.login-player-btn {
  background: var(--dark-card); border: 2px solid var(--border);
  border-radius: 10px; padding: 0.8rem 0.4rem;
  cursor: pointer; transition: all 0.18s; text-align: center;
  color: var(--light); font-family: 'Work Sans', sans-serif;
}
.login-player-btn:hover, .login-player-btn.selected {
  border-color: var(--primary); background: var(--primary-dim);
  transform: translateY(-2px); box-shadow: 0 4px 14px rgba(230,57,70,0.25);
}
.login-player-avatar {
  width: 42px; height: 42px; border-radius: 9px;
  background: var(--primary); color: #fff;
  font-size: 0.9rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 0.4rem;
}
.login-player-name { font-size: 0.7rem; font-weight: 700; }
.login-empty { color: var(--text-dim); font-size: 0.85rem; padding: 1.5rem; }
#login-confirm-btn { width: 100%; padding: 0.8rem; font-size: 0.88rem; }
.current-user-badge {
  display: flex; align-items: center; gap: 0.4rem;
  background: var(--primary-dim); border: 1px solid rgba(230,57,70,0.35);
  border-radius: 6px; padding: 0.25rem 0.7rem;
  font-size: 0.62rem; font-weight: 700; letter-spacing: 0.5px;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.current-user-badge:hover { background: var(--primary); color: #fff; }
.current-user-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 6px var(--green);
  flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT FLOTTANT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chat-fab {
  position: fixed; bottom: 5.5rem; right: 1.2rem;
  width: 48px; height: 48px; border-radius: 50%;
  background: var(--primary); color: #fff;
  border: none; font-size: 1.2rem; cursor: pointer;
  box-shadow: 0 4px 18px rgba(230,57,70,0.45);
  z-index: 240; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
#chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 24px rgba(230,57,70,0.55); }
#chat-notif-dot {
  position: absolute; top: -2px; right: -2px;
  width: 16px; height: 16px; border-radius: 50%;
  background: var(--gold); color: #000;
  font-size: 0.55rem; font-weight: 900;
  display: none; align-items: center; justify-content: center;
  border: 2px solid var(--dark);
}
#chat-panel {
  position: fixed; bottom: 10rem; right: 1.2rem;
  width: 320px; max-height: 440px;
  background: var(--dark-light); border: 1px solid var(--border2);
  border-radius: 16px; z-index: 239;
  display: none; flex-direction: column;
  box-shadow: 0 12px 40px rgba(0,0,0,0.55);
  overflow: hidden;
}
#chat-panel.open { display: flex; }
.chat-header {
  padding: 0.9rem 1rem 0.7rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: var(--dark-card);
}
.chat-header-title { font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
.chat-header-close { background: none; border: none; color: var(--gray); cursor: pointer; font-size: 1rem; padding: 0 4px; }
.chat-header-close:hover { color: var(--primary); }
#chat-messages {
  flex: 1; overflow-y: auto; padding: 0.8rem;
  display: flex; flex-direction: column; gap: 0.5rem;
  scroll-behavior: smooth;
}
.chat-msg {
  display: flex; gap: 0.5rem; align-items: flex-start;
  animation: fadeIn 0.2s ease;
}
.chat-msg.mine { flex-direction: row-reverse; }
.chat-avatar {
  width: 28px; height: 28px; border-radius: 7px;
  background: var(--primary); color: #fff;
  font-size: 0.6rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.chat-bubble {
  background: var(--dark-card); border: 1px solid var(--border);
  border-radius: 10px; padding: 0.45rem 0.7rem;
  max-width: 200px; font-size: 0.8rem;
}
.chat-msg.mine .chat-bubble { background: var(--primary-dim); border-color: rgba(230,57,70,0.35); }
.chat-name { font-size: 0.6rem; font-weight: 700; color: var(--primary); margin-bottom: 2px; }
.chat-msg.mine .chat-name { text-align: right; }
.chat-time { font-size: 0.55rem; color: var(--gray); margin-top: 2px; }
.chat-msg.mine .chat-time { text-align: right; }
.chat-empty { color: var(--text-dim); font-size: 0.78rem; text-align: center; padding: 1.5rem; }
.chat-input-row {
  padding: 0.7rem;
  border-top: 1px solid var(--border);
  display: flex; gap: 0.5rem; align-items: center;
  background: var(--dark-card);
}
#chat-input {
  flex: 1; background: var(--dark-light);
  border: 1px solid var(--border); border-radius: 8px;
  padding: 0.45rem 0.75rem; font-size: 0.82rem;
  color: var(--light); outline: none;
  font-family: 'Work Sans', sans-serif;
  width: auto;
}
#chat-input:focus { border-color: var(--primary); }
#chat-send-btn {
  background: var(--primary); color: #fff;
  border: none; border-radius: 8px;
  padding: 0.45rem 0.8rem; cursor: pointer;
  font-size: 0.85rem; transition: background 0.15s;
  flex-shrink: 0;
}
#chat-send-btn:hover { background: #ff4d5a; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATION TOAST AMÃ‰LIORÃ‰E
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notif-match {
  background: linear-gradient(135deg, var(--dark-card), var(--dark-light));
  border-left: 3px solid var(--green) !important;
}
.notif-chat {
  background: linear-gradient(135deg, var(--dark-card), var(--dark-light));
  border-left: 3px solid var(--primary) !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA INSTALL BANNER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pwa-install-banner {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: linear-gradient(135deg, var(--dark-card), var(--dark-light));
  border-top: 1px solid var(--border2);
  padding: 0.9rem 1.2rem;
  align-items: center; gap: 0.8rem;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
}
#pwa-install-banner.show { display: flex; }
.pwa-banner-icon { font-size: 1.8rem; flex-shrink: 0; }
.pwa-banner-text { flex: 1; }
.pwa-banner-title { font-size: 0.82rem; font-weight: 700; color: var(--light); }
.pwa-banner-sub { font-size: 0.7rem; color: var(--text-dim); }
.pwa-install-btn { background: var(--primary); color: #fff; border: none; border-radius: 8px; padding: 0.5rem 1.1rem; font-size: 0.75rem; font-weight: 700; cursor: pointer; white-space: nowrap; font-family: 'Work Sans', sans-serif; }
.pwa-dismiss-btn { background: none; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem 0.8rem; font-size: 0.75rem; color: var(--gray); cursor: pointer; white-space: nowrap; font-family: 'Work Sans', sans-serif; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAPPELS SOIRÃ‰E
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.reminder-btn {
  background: none; border: 1px solid var(--border);
  border-radius: 6px; padding: 0.25rem 0.7rem;
  font-size: 0.68rem; color: var(--text-dim); cursor: pointer;
  font-family: 'Work Sans', sans-serif; font-weight: 600;
  transition: all 0.15s; white-space: nowrap;
}
.reminder-btn:hover { border-color: var(--gold); color: var(--gold); }
.reminder-btn.set { border-color: var(--gold); color: var(--gold); background: var(--gold-bg); }

/* â•â•â• NAV GROUPS â•â•â• */
.nav-group{position:relative;display:flex;align-items:stretch}
.nav-group-trigger{gap:0.28rem;cursor:pointer}
.nav-chevron{font-size:0.52rem!important;opacity:0.5;transition:transform 0.2s;margin-left:0.1rem}
.nav-group.open .nav-chevron{transform:rotate(180deg);opacity:1}
.nav-group.open .nav-group-trigger{color:var(--primary);background:rgba(230,57,70,.07);border-bottom-color:var(--primary)}
.nav-dropdown{display:none;position:absolute;top:calc(100% + 1px);left:0;min-width:170px;background:rgba(14,17,26,.98);border:1px solid var(--border);border-top:2px solid var(--primary);border-radius:0 0 10px 10px;box-shadow:0 12px 40px rgba(0,0,0,.55);backdrop-filter:blur(16px);z-index:300;padding:0.35rem 0;animation:dropIn .15s ease}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.nav-group.open .nav-dropdown{display:block}
.nav-drop-item{display:flex;align-items:center;gap:0.55rem;width:100%;padding:0.55rem 1rem;background:none;border:none;color:var(--muted);font-family:'Work Sans',sans-serif;font-size:0.72rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .13s;text-align:left;white-space:nowrap}
.nav-drop-item:hover{color:var(--light);background:rgba(255,255,255,.05)}
.nav-drop-item i{font-size:.75rem;opacity:.7;width:14px}
.nav-drop-item.active{color:var(--primary);background:rgba(230,57,70,.08);border-left:2px solid var(--primary);padding-left:calc(1rem - 2px)}
.nav-group.has-active .nav-group-trigger{color:var(--primary);border-bottom-color:var(--primary);background:rgba(230,57,70,.06)}
/* â•â•â• DIVISION PROGRESS â•â•â• */
.div-progress-wrap{margin-top:0.5rem}
.div-progress-labels{display:flex;justify-content:space-between;font-size:0.58rem;color:var(--muted);margin-bottom:3px}
.div-progress-bar{height:4px;background:var(--dark);border-radius:3px;overflow:hidden}
.div-progress-fill{height:100%;border-radius:3px;transition:width .6s ease}
.div-bronze-fill{background:linear-gradient(90deg,#c47c44,#e09a5a)}
.div-silver-fill{background:linear-gradient(90deg,#8a9bb0,#c0ccd8)}
.div-gold-fill{background:linear-gradient(90deg,#d4a017,#f5c518)}
.div-elite-fill{background:linear-gradient(90deg,#7c3aed,#a67cf7)}
.div-legend-fill{background:linear-gradient(90deg,var(--accent),#ff8c94)}
/* â•â•â• JOUEUR INDIVIDUEL â•â•â• */
.player-full-header{display:flex;align-items:center;gap:1.4rem;padding:1.5rem;border-bottom:1px solid var(--border);position:relative}
.player-full-avatar{width:72px;height:72px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;flex-shrink:0}
.player-full-tabs{display:flex;border-bottom:1px solid var(--border)}
.player-full-tab{flex:1;padding:.6rem .4rem;font-size:.65rem;font-weight:700;letter-spacing:.8px;text-transform:uppercase;background:none;border:none;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;font-family:'Work Sans',sans-serif}
.player-full-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(230,57,70,.05)}
.player-full-body{padding:1rem;max-height:420px;overflow-y:auto}
.pf-stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:.5rem;margin-bottom:1rem}
.pf-stat{background:var(--dark);border:1px solid var(--border);border-radius:10px;padding:.7rem .5rem;text-align:center}
.pf-stat-val{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--accent);line-height:1}
.pf-stat-lbl{font-size:.56rem;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-top:2px}
.pf-h2h-row{display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;border-radius:7px;background:var(--dark);margin-bottom:.3rem;font-size:.75rem}
.pf-match-row{display:flex;align-items:center;justify-content:space-between;padding:.35rem .5rem;border-radius:7px;background:var(--dark);margin-bottom:.25rem;font-size:.72rem;gap:.4rem}
/* â•â•â• SOIRÃ‰E RAPPORT â•â•â• */
.soiree-rapport-kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:.5rem;margin-bottom:.8rem}
.soiree-kpi{background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:.5rem .4rem;text-align:center}
.soiree-kpi-val{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--accent)}
.soiree-kpi-lbl{font-size:.55rem;color:var(--muted);letter-spacing:.8px;text-transform:uppercase}
.soiree-mvp-chip{display:inline-flex;align-items:center;gap:.5rem;background:var(--accent-dim);border:1px solid rgba(230,57,70,.35);border-radius:8px;padding:.35rem .75rem;font-size:.75rem}
/* â•â•â• MULTIJOUEUR â•â•â• */
.sc-multi-badge{display:inline-flex;align-items:center;gap:.3rem;background:rgba(74,158,255,.15);border:1px solid rgba(74,158,255,.4);color:#4a9eff;border-radius:6px;padding:.2rem .55rem;font-size:.62rem;font-weight:700;animation:mlPulse 2s ease infinite}
@keyframes mlPulse{0%,100%{opacity:1}50%{opacity:.6}}
.sc-room-modal{background:var(--dark-card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;max-width:320px;width:90%;text-align:center}
.sc-room-code{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;letter-spacing:.5rem;color:var(--accent);background:var(--dark);border-radius:12px;padding:.5rem 1rem;margin:1rem 0;border:2px solid rgba(230,57,70,.3)}
/* â•â•â• NOTIF PERM â•â•â• */
.notif-perm-bar{display:none;align-items:center;gap:.8rem;background:rgba(74,158,255,.1);border:1px solid rgba(74,158,255,.25);border-radius:9px;padding:.55rem 1rem;margin-bottom:.8rem;font-size:.75rem}
.notif-perm-bar.show{display:flex}
.notif-perm-bar button{padding:.3rem .8rem;background:#4a9eff;color:#fff;border:none;border-radius:6px;font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap}
/* â•â•â• RESPONSIVE TABLETTE â•â•â• */
@media(min-width:769px) and (max-width:1024px){
  .players-grid{grid-template-columns:repeat(2,1fr)!important}
  .dash-stats{grid-template-columns:repeat(3,1fr);gap:.8rem}
  .dash-grid{grid-template-columns:1fr 1fr;gap:1rem}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .nav-row{display:flex!important}
  .mobile-nav{display:none!important}
}
/* â•â•â• RESPONSIVE MOBILE â‰¤768px â•â•â• */
@media(max-width:768px){
  .nav-row{display:none!important}
  .mobile-nav{display:block!important}
  .content{padding:.8rem;padding-bottom:5.5rem}
  .logo-sub{display:none}
  .dash-stats{grid-template-columns:repeat(2,1fr);gap:.5rem}
  .dash-grid{grid-template-columns:1fr}
  .players-grid{grid-template-columns:1fr!important;gap:.6rem}
  .stats-grid{grid-template-columns:1fr!important}
  .param-row{flex-direction:column;align-items:flex-start!important;gap:.6rem}
  table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  input[type=text],input[type=number],input[type=password],select,textarea{font-size:16px!important}
  .sc-topbar{flex-wrap:wrap;gap:.2rem}
  .sc-top-btn{font-size:.6rem!important;padding:.26rem .45rem!important}
  .sc-score-main{font-size:2.8rem!important}
  .sc-key{min-height:50px!important;font-size:1.05rem!important}
}
</style>

</head>
<body>

<div id="app-bg-overlay"></div>
<div class="app-shell">
  <header class="header">
    <div class="nav-container-wrap">
    <!-- ROW 1: Logo + Actions -->
    <div class="logo">
      <div class="logo-icon">ğŸ¯</div>
      <div class="logo-text">
        <span class="logo-main" id="logo-main-text">FlÃ©chettes Club</span>
        <span class="logo-sub">Pro League</span>
      </div>
    </div>
    <div class="header-right">
      <!-- Badge sync Firebase -->
      <div id="fb-sync-badge" style="display:flex;align-items:center;gap:0.35rem;font-size:0.6rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:0.25rem 0.7rem;border-radius:5px;border:1px solid var(--border);color:var(--gray);cursor:default;transition:all 0.3s;white-space:nowrap" title="Statut de synchronisation Firebase"><i class="fas fa-database"></i> Local</div>
      <!-- Badge utilisateur connectÃ© -->
      <div id="current-user-badge" class="current-user-badge" onclick="openLoginModal()" title="Changer de profil" style="display:none">
        <div class="current-user-dot"></div>
        <span id="current-user-name">?</span>
      </div>
      <!-- Bouton deconnexion -->
      <button id="logout-btn" onclick="logoutUser()" title="Se deconnecter" style="display:none;background:none;border:1px solid var(--border);border-radius:6px;padding:0.3rem 0.6rem;color:var(--gray);font-size:0.65rem;font-weight:700;cursor:pointer;letter-spacing:0.5px;text-transform:uppercase;font-family:Work Sans,sans-serif;transition:all 0.15s">
        <i class="fas fa-right-from-bracket"></i> Quitter
      </button>
      <span class="season-badge" id="season-badge">Saison 1</span>
      <button class="timer-btn" id="timer-toggle-btn" onclick="toggleTimerWidget()" title="Minuteur"><i class="fas fa-stopwatch"></i></button>
      <button class="btn-tv" onclick="openTvMode()" title="Mode TV â€” Touche F" aria-label="Mode TV live"><i class="fas fa-tv"></i> Live</button>
      <button class="btn btn-primary btn-sm" onclick="openSoiree()" title="Mode SoirÃ©e">ğŸ¯ SoirÃ©e</button>
      <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn" title="Mode clair/sombre"><i class="fas fa-moon"></i></button>
      <button class="timer-btn" onclick="showPage('parametres', null)" title="ParamÃ¨tres" style="padding:0.3rem 0.6rem" aria-label="ParamÃ¨tres"><i class="fas fa-gear"></i></button>
    </div>
    </div><!-- /nav-container-wrap -->

  <!-- ROW 2: Full navigation -->
  <div class="nav-row">
    <div class="nav-row-inner">
      <nav class="nav">
        <button class="nav-btn active" id="navbtn-dashboard" onclick="showPage('dashboard',this)"><i class="fas fa-house"></i> Accueil</button>
        <button class="nav-btn" id="navbtn-compteur" onclick="openScoreCounter()"><i class="fas fa-bullseye"></i> Compteur</button>
        <div class="nav-group" id="navg-palmares">
          <button class="nav-btn nav-group-trigger" onclick="toggleNavGroup('navg-palmares',event)"><i class="fas fa-trophy"></i> PalmarÃ¨s <i class="fas fa-chevron-down nav-chevron"></i></button>
          <div class="nav-dropdown">
            <button class="nav-drop-item" onclick="navDropGo('classement','navg-palmares')"><i class="fas fa-trophy"></i> Classement</button>
            <button class="nav-drop-item" onclick="navDropGo('joueurs','navg-palmares')"><i class="fas fa-user"></i> Joueurs</button>
            <button class="nav-drop-item" onclick="navDropGo('historique','navg-palmares')"><i class="fas fa-clock-rotate-left"></i> Historique</button>
          </div>
        </div>
        <div class="nav-group" id="navg-competition">
          <button class="nav-btn nav-group-trigger" onclick="toggleNavGroup('navg-competition',event)"><i class="fas fa-gamepad"></i> CompÃ©tition <i class="fas fa-chevron-down nav-chevron"></i></button>
          <div class="nav-dropdown">
            <button class="nav-drop-item" onclick="navDropGo('matchs','navg-competition')"><i class="fas fa-gamepad"></i> Matchs</button>
            <button class="nav-drop-item" onclick="navDropGo('equipes','navg-competition')"><i class="fas fa-users"></i> Ã‰quipes</button>
            <button class="nav-drop-item" onclick="navDropGo('tournois','navg-competition')"><i class="fas fa-sitemap"></i> Tournois</button>
            <button class="nav-drop-item" onclick="navDropGo('ligue','navg-competition')"><i class="fas fa-medal"></i> Ligue</button>
            <button class="nav-drop-item" onclick="navDropGo('entrainement','navg-competition')"><i class="fas fa-dumbbell"></i> EntraÃ®nement</button>
          </div>
        </div>
        <button class="nav-btn" id="navbtn-calendrier" onclick="showPage('calendrier',this)"><i class="fas fa-calendar-days"></i> Calendrier</button>
        <div class="nav-group" id="navg-stats">
          <button class="nav-btn nav-group-trigger" onclick="toggleNavGroup('navg-stats',event)"><i class="fas fa-chart-line"></i> Stats <i class="fas fa-chevron-down nav-chevron"></i></button>
          <div class="nav-dropdown">
            <button class="nav-drop-item" onclick="navDropGo('stats','navg-stats')"><i class="fas fa-chart-line"></i> Statistiques</button>
            <button class="nav-drop-item" onclick="navDropGo('historique','navg-stats')"><i class="fas fa-clock-rotate-left"></i> Historique</button>
          </div>
        </div>
        <button class="nav-btn" id="nav-btn-compte" onclick="showPageCompte(this)" style="display:none;color:var(--accent)"><i class="fas fa-circle-user"></i> Mon Compte</button>
      </nav>
    </div>
  </div>
  </header>

  <div class="session-bar" id="session-bar">
    <span class="live-dot"></span>
    <span class="session-stat">Matchs <span class="session-stat-val" id="sess-matches">0</span></span>
    <span class="session-divider"></span>
    <span class="session-stat">Joueurs <span class="session-stat-val" id="sess-players">0</span></span>
    <span class="session-divider"></span>
    <span class="session-stat">Leader <span class="session-stat-val" id="sess-leader">â€”</span></span>
    <span class="session-divider"></span>
    <span class="session-stat">Top ELO <span class="session-stat-val" id="sess-top-elo">â€”</span></span>
  </div>

  <div class="content">

    <!-- â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â• -->
    <div class="page active" id="page-dashboard">



      <div class="page-title">ğŸ¯ <span>Overview</span></div>
      <div id="dash-onboarding"></div>
      <div class="dash-stats" id="dash-stats"></div>
      <div class="dash-grid">
        <div id="dash-podium"></div>
        <div class="recent-matches" id="dash-recent">
          <div class="recent-title">Derniers Matchs</div>
          <div id="dash-recent-list"></div>
        </div>
      </div>
      <div class="section-label">Joueur en forme ğŸ”¥</div>
      <div id="dash-hot"></div>
      <div id="dash-monthly" style="margin-top:1.4rem"></div>
      <div style="margin-top:1.4rem">
        <div class="section-label">TrophÃ©es RÃ©cents ğŸ†</div>
        <div id="dash-trophies"></div>
      </div>
      <div id="dash-defis-widget"></div>

      <!-- â•â• HALL OF FAME â•â• -->
      <div style="margin-top:1.6rem">
        <div class="section-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>ğŸ… Hall of Fame</span>
          <span style="font-size:0.62rem;color:var(--muted);font-weight:500;letter-spacing:1px">RECORDS DU CLUB</span>
        </div>
        <div id="dash-hall-of-fame" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:0.75rem"></div>
      </div>

      <!-- â•â• ADMIN QUICK PANEL â•â• -->
      <div style="margin-top:1.6rem">
        <div class="section-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>âš¡ Actions rapides</span>
          <button class="btn btn-sm btn-secondary" onclick="requirePassword('ğŸ”’ Admin', () => { var p=document.getElementById('dash-admin-panel'); p.style.display=p.style.display==='grid'?'none':'grid'; })" style="font-size:0.65rem;padding:2px 8px">ğŸ”’ Admin</button>
        </div>
        <div id="dash-admin-panel" style="display:none;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:0.7rem;margin-top:0.8rem">
          <button class="admin-action-btn" onclick="showPage('matchs',null);setTimeout(function(){var el=document.getElementById('match-p1');if(el)el.focus();},200)"><span class="admin-action-icon">ğŸ¯</span><span>Saisir un match</span></button>
          <button class="admin-action-btn" onclick="showPage('joueurs',null);setTimeout(function(){var el=document.getElementById('player-name');if(el)el.focus();},200)"><span class="admin-action-icon">ğŸ‘¤</span><span>Ajouter joueur</span></button>
          <button class="admin-action-btn" onclick="showPage('tournois',null)"><span class="admin-action-icon">ğŸ†</span><span>CrÃ©er tournoi</span></button>
          <button class="admin-action-btn" onclick="openScoreCounter()"><span class="admin-action-icon">ğŸ®</span><span>Compteur score</span></button>
          <button class="admin-action-btn" onclick="requirePassword('ğŸ”’ Sauvegarde', function(){exportJSON();})"><span class="admin-action-icon">ğŸ’¾</span><span>Sauvegarder</span></button>
          <button class="admin-action-btn" onclick="openTvMode()"><span class="admin-action-icon">ğŸ“º</span><span>Mode TV Live</span></button>
          <button class="admin-action-btn" onclick="requirePassword('ğŸ”’ Rapport', function(){generateSessionReport(null);})"><span class="admin-action-icon">ğŸ“‹</span><span>Rapport soirÃ©e</span></button>
          <button class="admin-action-btn" onclick="requirePassword('ğŸ”’ Admin', function(){_doShowPage('parametres',null);})"><span class="admin-action-icon">âš™ï¸</span><span>ParamÃ¨tres</span></button>
        </div>
      </div>

      <!-- â•â• ACTIVITÃ‰ DU CLUB â•â• -->
      <div style="margin-top:1.6rem">
        <div class="section-label">ğŸ“ˆ ActivitÃ© du club <span style="font-size:0.62rem;color:var(--muted);font-weight:400">â€” 12 derniers mois</span></div>
        <div class="card"><canvas id="dash-activity-chart" style="max-height:160px"></canvas></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â• JOUEURS â•â•â•â•â•â• -->
    <div class="page" id="page-joueurs">
      <div class="page-title">ğŸ‘¤ <span>Joueurs</span></div>
      <p class="page-subtitle">Profils et statistiques de tous les membres du club</p>
      <div class="add-player-form">
        <div class="form-field">
          <div class="form-label">Nom complet</div>
          <input type="text" id="player-name" placeholder="Jean Dupont" maxlength="30">
        </div>
        <div class="form-field">
          <div class="form-label">Pseudo</div>
          <input type="text" id="player-pseudo" placeholder="Le Bullseye" maxlength="20">
        </div>
        <button class="btn btn-primary" onclick="addPlayer()">+ Ajouter</button>
        <button class="btn btn-secondary" onclick="openModal('import-excel-modal')" title="Importer depuis un fichier Excel ou CSV" style="display:flex;align-items:center;gap:0.4rem">
          <i class="fas fa-file-excel"></i> Importer Excel
        </button>
      </div>
      <div class="section-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Inscrits</span>
        <button class="btn-print" onclick="printJoueurs()" title="Imprimer la liste des joueurs"><i class="fas fa-print"></i> Imprimer liste</button>
      </div>
      <div class="players-grid" id="players-grid"></div>
    </div>

    <!-- â•â•â•â•â•â• MATCHS â•â•â•â•â•â• -->
    <div class="page" id="page-matchs">
      <div class="page-title" style="justify-content:space-between;flex-wrap:wrap;gap:0.5rem">
        <span>ğŸ“‹ <span>Matchs</span></span>
        <button class="btn btn-secondary btn-sm" onclick="generateSessionReport(null)" style="display:flex;align-items:center;gap:0.4rem"><i class="fas fa-file-alt"></i> Rapport de soirÃ©e</button>
      </div>
      <p class="page-subtitle">Saisie et gestion des rÃ©sultats de matchs</p>

      <!-- â”€â”€ Tirage AlÃ©atoire â”€â”€ -->
      <div class="tirage-panel" id="tirage-panel">
        <div class="tirage-header" onclick="toggleTirage()">
          <div class="tirage-header-left">
            ğŸ² <span>Tirage AlÃ©atoire</span>
            <span id="tirage-present-count" style="font-size:0.68rem;font-weight:600;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1px 7px"></span>
          </div>
          <div class="tirage-header-right">
            <span style="font-size:0.7rem;color:var(--muted)">GÃ©nÃ©rez des matchs depuis les joueurs prÃ©sents</span>
            <span class="tirage-chevron">â–¼</span>
          </div>
        </div>
        <div class="tirage-body">

          <!-- SÃ©lection prÃ©sence -->
          <div class="section-label">Joueurs prÃ©sents</div>
          <div class="presence-grid" id="presence-grid"></div>
          <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
            <button class="btn btn-secondary btn-sm" onclick="selectAllPresence(true)">âœ“ Tous</button>
            <button class="btn btn-secondary btn-sm" onclick="selectAllPresence(false)">âœ• Aucun</button>
            <span id="presence-info" style="font-size:0.72rem;color:var(--muted);margin-left:0.3rem;align-self:center"></span>
          </div>

          <!-- Options -->
          <div class="tirage-options">
            <div class="tirage-opt-field">
              <div class="tirage-opt-label">Mode de tirage</div>
              <select id="tirage-mode">
                <option value="round">ğŸ”„ Chaque joueur joue N fois</option>
                <option value="rr">ğŸ“‹ Tous contre tous</option>
                <option value="random">ğŸ² N matchs au hasard</option>
                <option value="serpentin">ğŸ Serpentin (classement ELO)</option>
              </select>
            </div>
            <div class="tirage-opt-field" id="tirage-n-field">
              <div class="tirage-opt-label" id="tirage-n-label">Matchs par joueur</div>
              <input type="number" id="tirage-n" value="1" min="1" max="20" style="max-width:80px">
            </div>
            <div class="tirage-opt-field">
              <div class="tirage-opt-label">Ã‰viter rematches rÃ©cents</div>
              <select id="tirage-rematch">
                <option value="0">Non</option>
                <option value="1" selected>Oui (1 match)</option>
                <option value="3">Oui (3 matchs)</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="genererTirageAleatoire()" style="align-self:flex-end">ğŸ² GÃ©nÃ©rer</button>
          </div>

          <!-- Liste des matchs gÃ©nÃ©rÃ©s -->
          <div id="tirage-results" style="display:none">
            <div class="section-label">Matchs gÃ©nÃ©rÃ©s</div>
            <div class="random-matches-list" id="random-matches-list"></div>
            <div class="tirage-actions">
              <button class="btn btn-primary btn-sm" onclick="retirage()">ğŸ² Retirer</button>
              <button class="btn btn-success btn-sm" onclick="validerTousMatchs()">âœ“ Valider tous les matchs complÃ©tÃ©s</button>
              <button class="btn btn-secondary btn-sm" onclick="resetTirage()">âœ• Effacer</button>
              <span class="tirage-summary" id="tirage-summary"></span>
            </div>
          </div>

        </div>
      </div>

      <!-- â”€â”€ Saisie manuelle â”€â”€ -->
      <div class="section-label">Saisie manuelle</div>
      <div class="match-form">
        <div class="match-vs-row">
          <div class="form-field">
            <div class="form-label">Joueur 1</div>
            <select id="match-p1" onchange="updateMatchLabels()"><option value="">-- Choisir --</option></select>
          </div>
          <div class="form-field" style="max-width:72px">
            <div class="form-label">Sets J1</div>
            <input type="number" id="match-s1" min="0" max="99" placeholder="0">
          </div>
          <div class="fg-vs">VS</div>
          <div class="form-field" style="max-width:72px">
            <div class="form-label">Sets J2</div>
            <input type="number" id="match-s2" min="0" max="99" placeholder="0">
          </div>
          <div class="form-field">
            <div class="form-label">Joueur 2</div>
            <select id="match-p2" onchange="updateMatchLabels()"><option value="">-- Choisir --</option></select>
          </div>
        </div>
        <div style="margin-bottom:0.8rem">
          <label class="form-label" for="match-format">Format de jeu</label>
          <select id="match-format" style="max-width:160px;width:auto" onchange="updateCheckoutSuggestion()">
            <option value="501">ğŸ¯ 501</option>
            <option value="301">ğŸ¯ 301</option>
            <option value="cricket">ğŸ Cricket</option>
            <option value="sets" selected>ğŸ“‹ Sets libres</option>
          </select>
        </div>
        <!-- STATS AVANCÃ‰ES OPTIONNELLES -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.8rem">
          <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:0.7rem">ğŸ“Š Stats Pro (optionnel)</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.6rem">
            <div>
              <div class="form-label" id="avg1-label">Moy. J1 (3D)</div>
              <input type="number" id="match-avg1" min="0" max="180" step="0.1" placeholder="ex: 54.2" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label" id="avg2-label">Moy. J2 (3D)</div>
              <input type="number" id="match-avg2" min="0" max="180" step="0.1" placeholder="ex: 48.7" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label">Darts J1</div>
              <input type="number" id="match-darts1" min="0" max="999" placeholder="ex: 54" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label">Darts J2</div>
              <input type="number" id="match-darts2" min="0" max="999" placeholder="ex: 61" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label">180s J1</div>
              <input type="number" id="match-180s1" min="0" max="20" placeholder="0" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label">180s J2</div>
              <input type="number" id="match-180s2" min="0" max="20" placeholder="0" style="width:100%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
            </div>
            <div>
              <div class="form-label">Checkout J1</div>
              <div style="display:flex;gap:4px">
                <input type="number" id="match-co1-hit" min="0" max="20" placeholder="R" title="RÃ©ussis" style="width:50%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--green);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
                <input type="number" id="match-co1-att" min="0" max="20" placeholder="T" title="Tentatives" style="width:50%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
              </div>
              <div style="font-size:0.58rem;color:var(--muted);margin-top:2px">RÃ©ussis / Tentatives</div>
            </div>
            <div>
              <div class="form-label">Checkout J2</div>
              <div style="display:flex;gap:4px">
                <input type="number" id="match-co2-hit" min="0" max="20" placeholder="R" title="RÃ©ussis" style="width:50%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--green);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
                <input type="number" id="match-co2-att" min="0" max="20" placeholder="T" title="Tentatives" style="width:50%;padding:0.3rem 0.5rem;font-size:0.82rem;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Work Sans',sans-serif">
              </div>
              <div style="font-size:0.58rem;color:var(--muted);margin-top:2px">RÃ©ussis / Tentatives</div>
            </div>
          </div>
          <!-- Checkout SuggÃ©rÃ© -->
          <div id="checkout-suggestion-box" style="display:none;margin-top:0.7rem;padding:0.5rem 0.7rem;background:var(--accent-dim);border:1px solid rgba(230, 57, 70, 0.35);border-radius:7px;font-size:0.78rem;color:var(--accent)">
            ğŸ¯ <strong>Finish suggÃ©rÃ© :</strong> <span id="checkout-suggestion-text"></span>
          </div>
        </div>
        <button class="btn-submit" onclick="addMatch()">âœ“ Valider le Match</button>
      </div>
      <div class="section-label">Historique</div>
      <div class="filters" id="match-filters"></div>
      <div class="match-list" id="match-list"></div>
    </div>

    <!-- â•â•â•â•â•â• HISTORIQUE â•â•â•â•â•â• -->
    <div class="page" id="page-historique">
      <div class="page-title">ğŸ“‹ <span>Historique</span></div>
      <div class="hist-tabs">
        <button class="hist-tab active" id="htab-all" onclick="setHistTab('all',this)">Tous les matchs</button>
        <button class="hist-tab" id="htab-wins" onclick="setHistTab('wins',this)">Victoires</button>
        <button class="hist-tab" id="htab-close" onclick="setHistTab('close',this)">SerrÃ©s</button>
        <button class="hist-tab" id="htab-perfect" onclick="setHistTab('perfect',this)">Parfaits (3-0)</button>
      </div>
      <div style="display:flex;gap:0.6rem;margin-bottom:1rem;flex-wrap:wrap;align-items:flex-end">
        <div class="form-field" style="min-width:160px">
          <div class="form-label">Filtrer par joueur</div>
          <select id="hist-player-filter" onchange="renderHistorique()">
            <option value="">Tous les joueurs</option>
          </select>
        </div>
        <div class="form-field" style="min-width:130px">
          <div class="form-label">Format</div>
          <select id="hist-format-filter" onchange="renderHistorique()">
            <option value="">Tous</option>
            <option value="501">501</option>
            <option value="301">301</option>
            <option value="cricket">Cricket</option>
            <option value="sets">Sets libres</option>
          </select>
        </div>
        <div style="margin-left:auto;display:flex;gap:0.5rem;align-items:center">
          <div class="search-wrap" style="margin-bottom:0;width:200px">
            <span class="search-icon">ğŸ”</span>
            <input class="search-input" id="hist-search-input" placeholder="Rechercher..." oninput="filterHistSearch(this.value)">
            <button class="search-clear" id="hist-search-clear" onclick="clearHistSearch()">âœ•</button>
          </div>
          <span id="hist-count" style="font-size:0.72rem;color:var(--muted)"></span>
          <button class="btn-print" onclick="printHistorique()" title="Imprimer l'historique filtrÃ©"><i class="fas fa-print"></i> Imprimer</button>
        </div>
      </div>
      <div id="historique-timeline"></div>
    </div>

    <!-- â•â•â•â•â•â• CLASSEMENT â•â•â•â•â•â• -->
    <div class="page" id="page-classement">
      <div class="rank-section-head">
        <div class="rank-section-head-title">ğŸ† Classement</div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
          <button class="btn-print" onclick="printClassement()" title="Imprimer le classement complet"><i class="fas fa-print"></i> Classement</button>
          <button class="btn-print" onclick="printPodium()" title="Imprimer le podium Top 3"><i class="fas fa-medal"></i> Podium</button>
          <button class="btn btn-secondary btn-sm" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
          <button class="btn btn-secondary btn-sm" onclick="exportPDFClassement()"><i class="fas fa-file-pdf"></i> PDF Classement</button>
          <button class="btn btn-secondary btn-sm" onclick="partagerClassement()"><i class="fas fa-link"></i> Partager</button>
          <button class="btn btn-secondary btn-sm" onclick="generateMatchSheet()"><i class="fas fa-file-alt"></i> Feuille</button>
        </div>
      </div>

      <!-- Podium top-3 cards -->
      <div id="rank-podium-strip" class="rank-podium-strip"></div>

      <!-- Main ranking table -->
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:1.4rem;border:1px solid var(--border2)">
        <table class="rtable">
          <thead>
            <tr>
              <th style="text-align:center">#</th>
              <th onclick="setSortRanking('name')" style="cursor:pointer;user-select:none" title="Trier par nom">Joueur <span id="sort-icon-name" class="sort-icon"></span></th>
              <th onclick="setSortRanking('elo')" style="cursor:pointer;user-select:none" title="Trier par ELO">ELO <span id="sort-icon-elo" class="sort-icon">â–¼</span></th>
              <th>Forme</th>
              <th onclick="setSortRanking('matches')" style="cursor:pointer;user-select:none;text-align:center" title="Trier par matchs">J <span id="sort-icon-matches" class="sort-icon"></span></th>
              <th onclick="setSortRanking('wins')" style="cursor:pointer;user-select:none" title="Trier par victoires">V / D <span id="sort-icon-wins" class="sort-icon"></span></th>
              <th onclick="setSortRanking('sets')" style="cursor:pointer;user-select:none" title="Trier par sets">Sets <span id="sort-icon-sets" class="sort-icon"></span></th>
              <th onclick="setSortRanking('avg3d')" style="cursor:pointer;user-select:none" title="Trier par moyenne 3D">âš¡ Moy. <span id="sort-icon-avg3d" class="sort-icon"></span></th>
              <th onclick="setSortRanking('checkout')" style="cursor:pointer;user-select:none" title="Trier par % checkout">ğŸ¯ CO% <span id="sort-icon-checkout" class="sort-icon"></span></th>
              <th onclick="setSortRanking('pct')" style="cursor:pointer;user-select:none" title="Trier par % victoires">% Vic. <span id="sort-icon-pct" class="sort-icon"></span></th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>

      <div class="section-label">Fonctionnement ELO</div>
      <div class="card" style="margin-bottom:1.4rem">
        <div class="elo-info-grid">
          <div class="elo-info-block">
            <div class="elo-info-title">ğŸ“Œ Principe</div>
            <div class="elo-info-text">Chaque joueur commence avec <strong>1000 pts</strong>. Des points sont Ã©changÃ©s aprÃ¨s chaque match selon le rÃ©sultat et l'Ã©cart de niveau.</div>
          </div>
          <div class="elo-info-block">
            <div class="elo-info-title">âš–ï¸ Calcul (K=32)</div>
            <div class="elo-info-text">Battre un joueur plus fort rapporte <strong style="color:var(--green)">plus de points</strong>. Perdre contre plus faible en fait <strong style="color:var(--red)">perdre davantage</strong>.</div>
          </div>
          <div class="elo-info-block">
            <div class="elo-info-title">ğŸ”¢ Formule</div>
            <div class="elo-info-text">E = 1/(1+10^(Î”/400))<br>Nouveau ELO = ELO + 32Ã—(scoreâˆ’E)<br><span style="font-size:0.72rem">1=victoire Â· 0.5=nul Â· 0=dÃ©faite</span></div>
          </div>
          <div class="elo-info-block">
            <div class="elo-info-title">ğŸ“Š Exemple</div>
            <div class="elo-info-text">A(1000) vs B(1000), victoire A :<br><span style="color:var(--green)">A +16 â†’ 1016</span> | <span style="color:var(--red)">B âˆ’16 â†’ 984</span></div>
          </div>
          <div class="elo-info-block">
            <div class="elo-info-title">ğŸ“ˆ Tendance</div>
            <div class="elo-info-text">â–²/â–¼/â€” = Ã©volution sur les <strong>5 derniers matchs</strong>. Indique si un joueur progresse, dÃ©cline ou est stable.</div>
          </div>
          <div class="elo-info-block">
            <div class="elo-info-title">ğŸ† Peak ELO</div>
            <div class="elo-info-text">Score ELO le plus haut jamais atteint par le joueur depuis le dÃ©but de l'historique.</div>
          </div>
        </div>
      </div>

      <div class="section-label">Face Ã  Face &amp; PrÃ©diction</div>
      <div style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap;align-items:flex-end">
        <div class="form-field" style="flex:1;min-width:130px">
          <div class="form-label">Joueur A</div>
          <select id="h2h-p1" onchange="renderH2HPrediction()"><option value="">-- Choisir --</option></select>
        </div>
        <div class="form-field" style="flex:1;min-width:130px">
          <div class="form-label">Joueur B</div>
          <select id="h2h-p2" onchange="renderH2HPrediction()"><option value="">-- Choisir --</option></select>
        </div>
        <button class="btn btn-primary" onclick="renderH2H()">Comparer</button>
      </div>
      <div id="h2h-prediction" style="margin-bottom:0.8rem"></div>
      <div class="h2h-box" id="h2h-box"></div>
    </div>


    <!-- â•â•â•â•â•â• CALENDRIER â•â•â•â•â•â• -->
    <div class="page" id="page-calendrier">
      <div class="page-title" style="justify-content:space-between;flex-wrap:wrap;gap:0.5rem">
        <span>ğŸ“… <span>Calendrier</span></span>
        <button class="btn btn-secondary btn-sm" onclick="requestNotifPermission();scheduleUpcomingNotifs();showNotif('âœ“ Rappels activÃ©s !','success')" id="notif-enable-btn" style="display:flex;align-items:center;gap:0.4rem" title="Activer les rappels de soirÃ©e">
          <i class="fas fa-bell"></i> Activer rappels
        </button>
      </div>

      <!-- Add soirÃ©e form -->
      <div class="add-soiree-form">
        <div class="form-row" style="margin-bottom:0.8rem">
          <div class="form-field" style="flex:2;min-width:140px">
            <div class="form-label">Titre de la soirÃ©e</div>
            <input type="text" id="soiree-cal-title" placeholder="SoirÃ©e du vendredi" maxlength="50">
          </div>
          <div class="form-field" style="min-width:140px">
            <div class="form-label">Date</div>
            <input type="date" id="soiree-cal-date">
          </div>
          <div class="form-field" style="min-width:100px">
            <div class="form-label">Heure</div>
            <input type="time" id="soiree-cal-time" value="20:00">
          </div>
          <div class="form-field" style="flex:2;min-width:140px">
            <div class="form-label">Lieu</div>
            <input type="text" id="soiree-cal-lieu" placeholder="Bar Le Bullseye" maxlength="50">
          </div>
        </div>
        <div class="form-field" style="margin-bottom:0.8rem">
          <div class="form-label">Note / Description</div>
          <input type="text" id="soiree-cal-note" placeholder="Format, rÃ¨gles spÃ©ciales..." maxlength="100">
        </div>
        <div style="margin-bottom:0.8rem">
          <div class="form-label" style="margin-bottom:0.4rem">Joueurs invitÃ©s</div>
          <div class="soiree-attendee-grid" id="soiree-cal-attendees"></div>
        </div>
        <button class="btn btn-primary" onclick="addSoiree()">+ Planifier la soirÃ©e</button>
      </div>

      <div id="cal-upcoming-section">
        <div class="section-label">Ã€ venir</div>
        <div class="calendar-grid" id="cal-upcoming"></div>
      </div>

      <div id="cal-past-section" style="margin-top:1.5rem">
        <div class="section-label">PassÃ©es <span id="cal-past-toggle" class="past-soiree-link" onclick="togglePastSoirees()">(voir)</span></div>
        <div id="cal-past" style="display:none">
          <div class="calendar-grid" id="cal-past-list"></div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â• TOURNOIS â•â•â•â•â•â• -->
    <div class="page" id="page-tournois">
      <div class="page-title">ğŸ† <span>Tournois</span></div>
      <div style="display:flex;gap:0.6rem;margin-bottom:1.4rem;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="openCreateTournoi()">+ CrÃ©er un Tournoi</button>
      </div>
      <div id="tournois-list">
        <div class="empty"><div class="empty-icon">ğŸ†</div><div class="empty-text">Aucun tournoi. CrÃ©ez votre premier tournoi !</div></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â• STATS â•â•â•â•â•â• -->
    <div class="page" id="page-stats">
      <div class="page-title" style="justify-content:space-between;flex-wrap:wrap;gap:0.5rem">
        <span>ğŸ“Š <span>Statistiques</span></span>
        <button class="btn-print" onclick="printStats()" title="Imprimer le rapport statistiques"><i class="fas fa-print"></i> Imprimer stats</button>
      </div>

      <div class="section-label">Performance Joueurs</div>
      <div class="stat-widgets" id="stat-widgets-top"></div>

      <div class="section-label">Ã‰volution ELO</div>
      <div class="card" style="margin-bottom:1.4rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;flex-wrap:wrap;gap:0.6rem">
          <div class="chart-title">Courbe ELO par joueur</div>
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap">
            <div id="elo-chart-legend" style="display:flex;gap:0.6rem;flex-wrap:wrap"></div>
            <div style="display:flex;gap:3px;border:1px solid var(--border);border-radius:7px;overflow:hidden">
              <button class="elo-period-btn active" data-period="all" onclick="setEloPeriod('all',this)" style="padding:3px 10px;font-size:0.63rem;font-weight:700;border:none;cursor:pointer;background:var(--accent);color:#fff;font-family:'Work Sans',sans-serif;letter-spacing:0.5px">Tout</button>
              <button class="elo-period-btn" data-period="season" onclick="setEloPeriod('season',this)" style="padding:3px 10px;font-size:0.63rem;font-weight:700;border:none;cursor:pointer;background:var(--dark-card);color:var(--muted);font-family:'Work Sans',sans-serif;letter-spacing:0.5px">Saison</button>
              <button class="elo-period-btn" data-period="20" onclick="setEloPeriod('20',this)" style="padding:3px 10px;font-size:0.63rem;font-weight:700;border:none;cursor:pointer;background:var(--dark-card);color:var(--muted);font-family:'Work Sans',sans-serif;letter-spacing:0.5px">20 M</button>
              <button class="elo-period-btn" data-period="10" onclick="setEloPeriod('10',this)" style="padding:3px 10px;font-size:0.63rem;font-weight:700;border:none;cursor:pointer;background:var(--dark-card);color:var(--muted);font-family:'Work Sans',sans-serif;letter-spacing:0.5px">10 M</button>
            </div>
          </div>
        </div>
        <canvas id="elo-chart" style="max-height:280px"></canvas>
      </div>

      <div class="stats-grid">
        <div class="card">
          <div class="chart-title">Victoires par joueur</div>
          <canvas id="wins-chart" style="max-height:220px"></canvas>
        </div>
        <div class="card">
          <div class="chart-title">% de victoires</div>
          <canvas id="pct-chart" style="max-height:220px"></canvas>
        </div>
      </div>

      <!-- â•â• H2H COMPARISON â•â• -->
      <div class="section-label">âš”ï¸ Comparaison Face-Ã -Face</div>
      <div class="card" style="margin-bottom:1.4rem">
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:1rem">
          <div class="form-field" style="flex:1;min-width:130px">
            <div class="form-label">Joueur 1</div>
            <select id="h2h-p1" onchange="renderH2HDetail()"><option value="">-- Choisir --</option></select>
          </div>
          <div style="font-size:1.4rem;color:var(--muted);padding-bottom:4px">VS</div>
          <div class="form-field" style="flex:1;min-width:130px">
            <div class="form-label">Joueur 2</div>
            <select id="h2h-p2" onchange="renderH2HDetail()"><option value="">-- Choisir --</option></select>
          </div>
        </div>
        <div id="h2h-detail-result"></div>
      </div>

      <!-- â•â• ACTIVITÃ‰ MENSUELLE â•â• -->
      <div class="section-label">ğŸ“… ActivitÃ© mensuelle</div>
      <div class="card" style="margin-bottom:1.4rem">
        <canvas id="monthly-activity-chart" style="max-height:180px"></canvas>
      </div>

      <div class="section-label">Heatmap des rÃ©sultats</div>
      <div class="card" style="margin-bottom:1.4rem">
        <div class="chart-title" style="margin-bottom:0.7rem">Qui bat qui ? (nombre de victoires)</div>
        <div class="heatmap" id="heatmap"></div>
      </div>

      <div class="section-label">TrophÃ©es & Achievements</div>
      <div class="achievements-grid" id="achievements-grid"></div>

      <div style="margin-top:1.4rem">
        <div class="section-label">Fiche DÃ©taillÃ©e par Joueur</div>
        <div style="display:flex;gap:0.6rem;margin-bottom:1rem;align-items:flex-end">
          <div class="form-field" style="flex:1;max-width:250px">
            <div class="form-label">SÃ©lectionner un joueur</div>
            <select id="stats-player-select" onchange="renderPlayerDetail()"><option value="">-- Choisir --</option></select>
          </div>
        </div>
        <div id="player-detail"></div>
      </div>

      <!-- ğŸ¯ Calculateur de Checkout â†’ voir onglet EntraÃ®nement -->

      <!-- Radar chart -->
      <div style="margin-top:1.4rem">
        <div class="section-label">ğŸ•¸ Radar â€” Profil de joueur</div>
        <div class="card" style="margin-bottom:1.4rem">
          <div style="display:flex;gap:0.6rem;margin-bottom:0.8rem;align-items:flex-end;flex-wrap:wrap">
            <div class="form-field" style="flex:1;max-width:250px">
              <div class="form-label">SÃ©lectionner un joueur</div>
              <select id="radar-player-select" onchange="renderRadarChart()"><option value="">-- Choisir --</option></select>
            </div>
          </div>
          <div class="radar-wrap"><canvas id="radar-chart" style="max-width:340px;max-height:340px"></canvas></div>
        </div>
      </div>
    </div>
    <div class="page" id="page-parametres">
      <div class="page-title">âš™ï¸ <span>ParamÃ¨tres</span></div>

      <!-- â”€â”€ PERSONNALISATION CLUB â”€â”€ -->
      <div class="param-section">
        <div class="section-label">IdentitÃ© du Club</div>
        <div class="card">
          <div class="param-row">
            <div>
              <div class="param-label">Nom du club</div>
              <div class="param-desc">AffichÃ© dans l'en-tÃªte et le mode TV</div>
            </div>
            <input type="text" id="club-name-input" placeholder="FlÃ©chettes Club" style="max-width:180px;width:auto" oninput="previewClubName()" onblur="saveClubName()">
          </div>
          <div class="param-row">
            <div>
              <div class="param-label">Logo / Emoji</div>
              <div class="param-desc">IcÃ´ne dans l'en-tÃªte</div>
            </div>
            <div>
              <div style="display:flex;align-items:center;gap:0.8rem">
                <div class="club-logo-preview" id="club-logo-preview">ğŸ¯</div>
                <div class="logo-emoji-row" id="logo-emoji-row">
                  ğŸ¯ ğŸ¹ ğŸ³ ğŸ² ğŸ† ğŸ¥Š âš¡ ğŸ”¥ ğŸ’ â­ ğŸŒŸ ğŸª
                </div>
              </div>
            </div>
          </div>

          <!-- â”€â”€ Image du club (logo upload) â”€â”€ -->
          <div class="param-row" style="align-items:flex-start;flex-wrap:wrap;gap:0.8rem">
            <div style="min-width:180px">
              <div class="param-label">Image du club</div>
              <div class="param-desc">Logo ou banniÃ¨re â€” remplace l'emoji dans l'en-tÃªte. PNG, JPG, SVG (max 500 Ko)</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.6rem;align-items:flex-start">
              <!-- Preview -->
              <div id="club-img-preview-wrap" style="display:none;align-items:center;gap:0.6rem">
                <div style="width:52px;height:52px;border-radius:10px;overflow:hidden;border:1px solid var(--border);background:var(--dark-card);display:flex;align-items:center;justify-content:center">
                  <img id="club-img-preview" src="" style="width:100%;height:100%;object-fit:contain">
                </div>
                <button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:1px solid rgba(240,83,74,0.3)" onclick="removeClubImage()">âœ• Retirer</button>
              </div>
              <label class="btn btn-secondary btn-sm" style="cursor:pointer;display:flex;align-items:center;gap:0.4rem">
                <i class="fas fa-image"></i> Choisir une image
                <input type="file" accept="image/*" style="display:none" onchange="uploadClubImage(event)">
              </label>
            </div>
          </div>

          <!-- â”€â”€ Image de fond de l'application â”€â”€ -->
          <div class="param-row" style="align-items:flex-start;flex-wrap:wrap;gap:0.8rem">
            <div style="min-width:180px">
              <div class="param-label">Image de fond de l'app</div>
              <div class="param-desc">Fond personnalisÃ© pour toute l'interface. PNG, JPG (max 1 Mo). L'image est assombrie automatiquement.</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.6rem;align-items:flex-start">
              <!-- Preview -->
              <div id="bg-img-preview-wrap" style="display:none;align-items:center;gap:0.6rem">
                <div style="width:90px;height:52px;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:var(--dark-card)">
                  <img id="bg-img-preview" src="" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px">
                  <button class="btn btn-sm btn-secondary" onclick="removeBgImage()">âœ• Retirer</button>
                  <div style="font-size:0.6rem;color:var(--muted)">OpacitÃ© :</div>
                  <input type="range" id="bg-opacity-slider" min="1" max="20" value="8"
                    style="width:80px;accent-color:var(--accent)"
                    oninput="setBgOpacity(this.value)">
                </div>
              </div>
              <label class="btn btn-secondary btn-sm" style="cursor:pointer;display:flex;align-items:center;gap:0.4rem">
                <i class="fas fa-image"></i> Choisir un fond
                <input type="file" accept="image/*" style="display:none" onchange="uploadBgImage(event)">
              </label>
            </div>
          </div>
          <!-- â•â• SECTION COULEURS COMPLÃˆTE â•â• -->
          <div style="border-top:1px solid var(--border);margin-top:0.8rem;padding-top:1rem">
            <div style="font-size:0.68rem;font-weight:700;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:1rem">ğŸ¨ Personnalisation des Couleurs</div>

            <!-- Couleur d'accent -->
            <div style="margin-bottom:1.2rem">
              <div class="param-label" style="margin-bottom:0.3rem">Couleur d'accent <span style="font-size:0.65rem;color:var(--muted);font-weight:400">â€” boutons, titres, badges</span></div>
              <div style="display:flex;flex-wrap:wrap;gap:0.45rem;margin-bottom:0.6rem" id="club-color-grid">
                <!-- Rouges / Corail -->
                <div class="club-color-btn active" style="background:#e63946" data-color="#e63946" onclick="setClubColor('#e63946',this)" title="Rouge CNF"></div>
                <div class="club-color-btn" style="background:#f0534a" data-color="#f0534a" onclick="setClubColor('#f0534a',this)" title="Rouge vif"></div>
                <div class="club-color-btn" style="background:#ff6b6b" data-color="#ff6b6b" onclick="setClubColor('#ff6b6b',this)" title="Saumon"></div>
                <div class="club-color-btn" style="background:#ff4757" data-color="#ff4757" onclick="setClubColor('#ff4757',this)" title="Crimson"></div>
                <div class="club-color-btn" style="background:#c0392b" data-color="#c0392b" onclick="setClubColor('#c0392b',this)" title="Rouge foncÃ©"></div>
                <!-- Oranges -->
                <div class="club-color-btn" style="background:#ff7f50" data-color="#ff7f50" onclick="setClubColor('#ff7f50',this)" title="Corail"></div>
                <div class="club-color-btn" style="background:#ff6348" data-color="#ff6348" onclick="setClubColor('#ff6348',this)" title="Orange brÃ»lÃ©"></div>
                <div class="club-color-btn" style="background:#e67e22" data-color="#e67e22" onclick="setClubColor('#e67e22',this)" title="Orange foncÃ©"></div>
                <!-- Jaunes / Or -->
                <div class="club-color-btn" style="background:#f5c518" data-color="#f5c518" onclick="setClubColor('#f5c518',this)" title="Or"></div>
                <div class="club-color-btn" style="background:#ffd32a" data-color="#ffd32a" onclick="setClubColor('#ffd32a',this)" title="Jaune vif"></div>
                <div class="club-color-btn" style="background:#eccc68" data-color="#eccc68" onclick="setClubColor('#eccc68',this)" title="Sable"></div>
                <!-- Verts -->
                <div class="club-color-btn" style="background:#34d47b" data-color="#34d47b" onclick="setClubColor('#34d47b',this)" title="Vert nÃ©on"></div>
                <div class="club-color-btn" style="background:#2dc653" data-color="#2dc653" onclick="setClubColor('#2dc653',this)" title="Vert"></div>
                <div class="club-color-btn" style="background:#1abc9c" data-color="#1abc9c" onclick="setClubColor('#1abc9c',this)" title="Ã‰meraude"></div>
                <div class="club-color-btn" style="background:#00b894" data-color="#00b894" onclick="setClubColor('#00b894',this)" title="Turquoise"></div>
                <!-- Cyan -->
                <div class="club-color-btn" style="background:#16c9aa" data-color="#16c9aa" onclick="setClubColor('#16c9aa',this)" title="Cyan"></div>
                <div class="club-color-btn" style="background:#00cec9" data-color="#00cec9" onclick="setClubColor('#00cec9',this)" title="Aqua"></div>
                <div class="club-color-btn" style="background:#74b9ff" data-color="#74b9ff" onclick="setClubColor('#74b9ff',this)" title="Bleu clair"></div>
                <!-- Bleus -->
                <div class="club-color-btn" style="background:#4a9eff" data-color="#4a9eff" onclick="setClubColor('#4a9eff',this)" title="Bleu"></div>
                <div class="club-color-btn" style="background:#457bf7" data-color="#457bf7" onclick="setClubColor('#457bf7',this)" title="Bleu vif"></div>
                <div class="club-color-btn" style="background:#2980b9" data-color="#2980b9" onclick="setClubColor('#2980b9',this)" title="Bleu foncÃ©"></div>
                <div class="club-color-btn" style="background:#0984e3" data-color="#0984e3" onclick="setClubColor('#0984e3',this)" title="Bleu roi"></div>
                <!-- Violets -->
                <div class="club-color-btn" style="background:#a67cf7" data-color="#a67cf7" onclick="setClubColor('#a67cf7',this)" title="Violet"></div>
                <div class="club-color-btn" style="background:#6c5ce7" data-color="#6c5ce7" onclick="setClubColor('#6c5ce7',this)" title="Indigo"></div>
                <div class="club-color-btn" style="background:#8e44ad" data-color="#8e44ad" onclick="setClubColor('#8e44ad',this)" title="AmÃ©thyste"></div>
                <div class="club-color-btn" style="background:#fd79a8" data-color="#fd79a8" onclick="setClubColor('#fd79a8',this)" title="Rose vif"></div>
                <div class="club-color-btn" style="background:#f472b6" data-color="#f472b6" onclick="setClubColor('#f472b6',this)" title="Rose"></div>
                <div class="club-color-btn" style="background:#e84393" data-color="#e84393" onclick="setClubColor('#e84393',this)" title="Fuchsia"></div>
                <!-- Blancs / Neutres -->
                <div class="club-color-btn" style="background:#b2bec3" data-color="#b2bec3" onclick="setClubColor('#b2bec3',this)" title="Gris perle"></div>
                <div class="club-color-btn" style="background:#dfe6e9" data-color="#dfe6e9" onclick="setClubColor('#dfe6e9',this)" title="Blanc cassÃ©"></div>
              </div>
              <!-- Couleur libre -->
              <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.4rem">
                <label style="font-size:0.72rem;color:var(--muted)">Couleur libre :</label>
                <input type="color" id="custom-accent-picker" value="#e63946"
                  style="width:36px;height:36px;border-radius:8px;border:2px solid var(--border);background:none;cursor:pointer;padding:2px"
                  oninput="setClubColorCustom(this.value)">
                <span id="custom-accent-hex" style="font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--muted)">#e63946</span>
              </div>
            </div>

            <!-- Couleur de fond -->
            <div style="margin-bottom:1.2rem">
              <div class="param-label" style="margin-bottom:0.3rem">ThÃ¨me de fond <span style="font-size:0.65rem;color:var(--muted);font-weight:400">â€” couleur des cartes et surfaces</span></div>
              <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.6rem" id="bg-theme-grid">
                <div class="bg-theme-btn active" data-bg="#0d0f14" data-surface="#161b26" data-card="#1c2333" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--accent);cursor:pointer;overflow:hidden;display:flex;flex-direction:column;title:'Nuit (dÃ©faut)'">
                  <div style="flex:1;background:#0d0f14"></div><div style="flex:1;background:#161b26"></div><div style="flex:1;background:#1c2333"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#080a0f" data-surface="#0f1318" data-card="#141820" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="Minuit">
                  <div style="flex:1;background:#080a0f"></div><div style="flex:1;background:#0f1318"></div><div style="flex:1;background:#141820"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#0a0a0a" data-surface="#141414" data-card="#1e1e1e" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="Noir pur">
                  <div style="flex:1;background:#0a0a0a"></div><div style="flex:1;background:#141414"></div><div style="flex:1;background:#1e1e1e"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#0d1117" data-surface="#161b22" data-card="#21262d" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="GitHub Dark">
                  <div style="flex:1;background:#0d1117"></div><div style="flex:1;background:#161b22"></div><div style="flex:1;background:#21262d"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#1a1a2e" data-surface="#16213e" data-card="#0f3460" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="Bleu nuit">
                  <div style="flex:1;background:#1a1a2e"></div><div style="flex:1;background:#16213e"></div><div style="flex:1;background:#0f3460"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#0d1b2a" data-surface="#1b263b" data-card="#415a77" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="OcÃ©an">
                  <div style="flex:1;background:#0d1b2a"></div><div style="flex:1;background:#1b263b"></div><div style="flex:1;background:#415a77"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#1a0a2e" data-surface="#2d1b4e" data-card="#3d2060" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="Violet profond">
                  <div style="flex:1;background:#1a0a2e"></div><div style="flex:1;background:#2d1b4e"></div><div style="flex:1;background:#3d2060"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#0a1a0f" data-surface="#122213" data-card="#1e3320" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="ForÃªt">
                  <div style="flex:1;background:#0a1a0f"></div><div style="flex:1;background:#122213"></div><div style="flex:1;background:#1e3320"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#1a0d0d" data-surface="#2a1212" data-card="#3a1a1a" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="Bordeaux">
                  <div style="flex:1;background:#1a0d0d"></div><div style="flex:1;background:#2a1212"></div><div style="flex:1;background:#3a1a1a"></div>
                </div>
                <div class="bg-theme-btn" data-bg="#12100e" data-surface="#1c1a16" data-card="#2a2620" onclick="setBgTheme(this)" style="width:42px;height:42px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;flex-direction:column" title="SÃ©pia sombre">
                  <div style="flex:1;background:#12100e"></div><div style="flex:1;background:#1c1a16"></div><div style="flex:1;background:#2a2620"></div>
                </div>
              </div>
            </div>

            <!-- ThÃ¨mes complets prÃ©dÃ©finis -->
            <div style="margin-bottom:0.6rem">
              <div class="param-label" style="margin-bottom:0.5rem">ThÃ¨mes complets</div>
              <div style="display:flex;flex-wrap:wrap;gap:0.5rem">
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('classic')" style="border-left:3px solid #e63946">ğŸ¯ CNF Classic</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('ice')" style="border-left:3px solid #4a9eff">â„ï¸ Ice Blue</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('forest')" style="border-left:3px solid #34d47b">ğŸŒ¿ Forest</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('gold')" style="border-left:3px solid #f5c518">ğŸ‘‘ Gold Club</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('purple')" style="border-left:3px solid #a67cf7">ğŸ”® Royal Purple</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('fire')" style="border-left:3px solid #ff6348">ğŸ”¥ Fire</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('midnight')" style="border-left:3px solid #6c5ce7">ğŸŒ™ Midnight</button>
                <button class="btn btn-sm btn-secondary" onclick="applyFullTheme('ocean')" style="border-left:3px solid #16c9aa">ğŸŒŠ Ocean</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="param-section">
        <div class="section-label">ğŸ” Mots de passe joueurs</div>
        <div class="card" style="margin-bottom:0.8rem">
          <div class="param-row" style="flex-wrap:wrap;gap:0.5rem">
            <div>
              <div class="param-label">GÃ©rer les accÃ¨s</div>
              <div class="param-desc">DÃ©finissez ou rÃ©initialisez le mot de passe de chaque joueur. Le mot de passe est demandÃ© Ã  chaque connexion.</div>
            </div>
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
              <button class="btn btn-secondary btn-sm" onclick="promptSetOwnPassword()" title="Changer votre propre mot de passe">
                <i class="fas fa-key"></i> Mon mot de passe
              </button>
            </div>
          </div>
        </div>
        <div id="pwd-mgmt-container"></div>
      </div>

      <div class="param-section">
        <div class="section-label">Saisons</div>
        <div class="card" style="margin-bottom:1rem">
          <div class="param-row">
            <div>
              <div class="param-label">Nouvelle Saison</div>
              <div class="param-desc">Archive la saison actuelle et remet les ELO Ã  1000</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="newSeason()">DÃ©marrer</button>
          </div>
        </div>
        <div class="season-list" id="season-list"></div>
      </div>

      <div class="param-section">
        <div class="section-label">Sauvegarde & Transfert</div>
        <div class="card">
          <div id="backup-status-box"></div>
          <div class="param-row">
            <div>
              <div class="param-label">Sauvegarder (JSON)</div>
              <div class="param-desc">TÃ©lÃ©charge toutes les donnÃ©es â€” Ã  conserver prÃ©cieusement</div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="exportJSON()">â¬‡ Sauvegarder</button>
          </div>
          <div class="param-row">
            <div>
              <div class="param-label">Restaurer une sauvegarde</div>
              <div class="param-desc">Importe un fichier JSON prÃ©cÃ©demment tÃ©lÃ©chargÃ©</div>
            </div>
            <label class="btn btn-secondary btn-sm" style="cursor:pointer">ğŸ“ Restaurer<input type="file" accept=".json" style="display:none" onchange="importJSON(event)"></label>
          </div>
          <div class="param-row">
            <div>
              <div class="param-label">Code de transfert</div>
              <div class="param-desc">Copier ce code sur un autre appareil pour transfÃ©rer les donnÃ©es</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="showTransferCode()">ğŸ“‹ GÃ©nÃ©rer</button>
          </div>
          <div id="transfer-code-box" style="display:none;margin-top:0.8rem">
            <div style="font-size:0.68rem;color:var(--muted);margin-bottom:0.4rem">Copiez ce code et collez-le sur l'autre appareil :</div>
            <textarea id="transfer-code-text" style="width:100%;height:80px;font-family:'DM Mono',monospace;font-size:0.65rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.5rem;color:var(--text-dim);resize:none" readonly></textarea>
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
              <button class="btn btn-secondary btn-sm" onclick="copyTransferCode()">ğŸ“‹ Copier</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('transfer-code-box').style.display='none'">âœ• Fermer</button>
            </div>
          </div>
          <div class="param-row" style="margin-top:0.5rem">
            <div>
              <div class="param-label">Coller un code de transfert</div>
              <div class="param-desc">Importer les donnÃ©es depuis un autre appareil</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="showImportCode()">ğŸ“¥ Importer code</button>
          </div>
          <div id="import-code-box" style="display:none;margin-top:0.8rem">
            <textarea id="import-code-text" placeholder="Collez le code ici..." style="width:100%;height:80px;font-family:'DM Mono',monospace;font-size:0.65rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.5rem;color:var(--text);resize:none"></textarea>
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
              <button class="btn btn-primary btn-sm" onclick="importFromCode()">âœ“ Importer</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-code-box').style.display='none'">âœ• Annuler</button>
            </div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-label">Export classement CSV</div>
              <div class="param-desc">Tableau de classement au format tableur</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()">ğŸ“Š CSV</button>
          </div>
          <div class="param-row">
            <div>
              <div class="param-label">Imprimer le classement</div>
              <div class="param-desc">Version imprimable</div>
            </div>
            <button class="btn-print" onclick="printClassement()"><i class="fas fa-print"></i> Imprimer classement</button>
          </div>
        </div>
      </div>

      <div class="param-section">
        <div class="section-label">Journal des Modifications</div>
        <div class="audit-list" id="audit-list"></div>
      </div>

      <div class="param-section">
        <div class="section-label">Danger Zone</div>
        <div class="card">
          <div class="param-row">
            <div>
              <div class="param-label" style="color:var(--red)">RÃ©initialiser toutes les donnÃ©es</div>
              <div class="param-desc">Supprime joueurs, matchs, tournois et trophÃ©es</div>
            </div>
            <button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:1px solid rgba(240,83,74,0.3)" onclick="resetAll()">RÃ©initialiser</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE ENTRAÃNEMENT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-entrainement">
      <div class="page-title">ğŸ’ª <span>EntraÃ®nement</span></div>

      <!-- SÃ©lection joueur & niveau -->
      <div class="card" style="margin-bottom:1.2rem">
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end">
          <div class="form-field" style="flex:1;min-width:160px">
            <div class="form-label">Joueur</div>
            <select id="train-player-select" onchange="renderTrainingPage()">
              <option value="">-- Choisir un joueur --</option>
            </select>
          </div>
          <div class="form-field" style="min-width:160px">
            <div class="form-label">Niveau</div>
            <select id="train-level" onchange="renderTrainingPage()">
              <option value="debutant">ğŸŸ¢ DÃ©butant</option>
              <option value="intermediaire" selected>ğŸŸ¡ IntermÃ©diaire</option>
              <option value="avance">ğŸ”´ AvancÃ©</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="startTrainingSession()">â–¶ DÃ©marrer une session</button>
        </div>
      </div>

      <!-- Statistiques d'entraÃ®nement -->
      <div id="train-weekly-goal" style="margin-bottom:1rem"></div>
      <div id="train-stats-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:0.7rem;margin-bottom:1.2rem"></div>

      <!-- Exercices -->
      <div class="section-label">Exercices recommandÃ©s</div>
      <div id="train-exercises-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:0.9rem;margin-bottom:1.5rem"></div>

      <!-- Historique des sessions -->
      <div class="section-label">Progression par exercice</div>
      <div id="train-progress-chart-wrap" style="margin-bottom:1.5rem"></div>
      <div class="section-label">Historique des sessions</div>
      <div id="train-history-list"></div>

      <!-- â•â• PROGRAMMES MULTI-SEMAINES â•â• -->
      <div style="margin-top:1.8rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem">
          <div class="section-label" style="margin-bottom:0">ğŸ“… Programmes d'entraÃ®nement multi-semaines</div>
        </div>
        <div id="training-programs-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.9rem;margin-bottom:1.2rem"></div>
        <div id="active-program-detail"></div>
      </div>

      <!-- â•â• CALCULATEUR DE CHECKOUT â•â• -->
      <div style="margin-top:1.8rem">
        <div class="section-label">ğŸ¯ Calculateur de Checkout</div>
        <div class="card">
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.8rem">Entrez le score restant pour obtenir le meilleur finish possible (double out)</div>
          <div style="display:flex;gap:0.6rem;align-items:flex-end;flex-wrap:wrap">
            <div>
              <div class="form-label">Score restant (2â€“170)</div>
              <input type="number" id="co-calc-input" min="2" max="170" placeholder="ex: 116"
                style="max-width:120px;font-size:1.2rem;text-align:center;font-family:'DM Mono',monospace;font-weight:700;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.6rem;color:var(--text)"
                oninput="calcCheckout(this.value)">
            </div>
          </div>
          <div id="co-calc-result" style="margin-top:0.8rem;min-height:44px"></div>
          <details style="margin-top:1rem">
            <summary style="cursor:pointer;font-size:0.72rem;font-weight:700;color:var(--accent);letter-spacing:0.5px">ğŸ“‹ Tableau des finishes clÃ©s</summary>
            <div id="co-table-grid" style="margin-top:0.8rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.4rem;font-size:0.72rem"></div>
          </details>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE Ã‰QUIPES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-equipes">
      <div class="page-title">ğŸ‘¥ <span>Mode Ã‰quipes 2v2</span></div>

      <!-- CrÃ©er une Ã©quipe -->
      <div class="card" style="margin-bottom:1.2rem">
        <div class="section-label" style="margin-bottom:0.8rem">CrÃ©er une Ã©quipe</div>
        <div style="display:flex;gap:0.8rem;flex-wrap:wrap;align-items:flex-end">
          <div class="form-field" style="flex:1;min-width:140px">
            <div class="form-label">Nom de l'Ã©quipe</div>
            <input type="text" id="team-name-input" placeholder="Les Bulldogs" maxlength="30">
          </div>
          <div class="form-field" style="min-width:150px">
            <div class="form-label">Joueur 1</div>
            <select id="team-p1-select"><option value="">-- Choisir --</option></select>
          </div>
          <div class="form-field" style="min-width:150px">
            <div class="form-label">Joueur 2</div>
            <select id="team-p2-select"><option value="">-- Choisir --</option></select>
          </div>
          <div class="form-field" style="min-width:60px">
            <div class="form-label">Emoji</div>
            <input type="text" id="team-emoji-input" placeholder="ğŸ¯" maxlength="2" style="max-width:60px;text-align:center;font-size:1.4rem">
          </div>
          <button class="btn btn-primary" onclick="createTeam()">+ CrÃ©er</button>
        </div>
      </div>

      <!-- Classement Ã©quipes -->
      <div class="section-label">Classement Ã‰quipes</div>
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:1.4rem;border:1px solid var(--border2)">
        <table class="rtable teams-table">
          <thead><tr>
            <th style="text-align:center;width:42px">#</th>
            <th>Ã‰quipe</th>
            <th style="text-align:center">Pts</th>
            <th style="text-align:center">J</th>
            <th style="text-align:center;color:var(--green)">V</th>
            <th style="text-align:center;color:var(--red)">D</th>
            <th style="text-align:center">Sets</th>
            <th style="text-align:center">% Vic.</th>
          </tr></thead>
          <tbody id="teams-ranking-body"></tbody>
        </table>
      </div>

      <!-- Enregistrer un match 2v2 -->
      <div class="section-label">Enregistrer un match 2v2</div>
      <div class="card" style="margin-bottom:1.4rem">
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end">
          <div class="form-field" style="flex:1;min-width:150px">
            <div class="form-label">Ã‰quipe A</div>
            <select id="team-match-a"><option value="">-- Choisir --</option></select>
          </div>
          <div class="form-field" style="min-width:80px">
            <div class="form-label">Score A</div>
            <input type="number" id="team-score-a" min="0" max="99" style="text-align:center;font-size:1.3rem;font-family:'DM Mono',monospace;font-weight:700">
          </div>
          <div style="display:flex;align-items:flex-end;padding-bottom:0.5rem;font-size:1.3rem;color:var(--muted)">â€“</div>
          <div class="form-field" style="min-width:80px">
            <div class="form-label">Score B</div>
            <input type="number" id="team-score-b" min="0" max="99" style="text-align:center;font-size:1.3rem;font-family:'DM Mono',monospace;font-weight:700">
          </div>
          <div class="form-field" style="flex:1;min-width:150px">
            <div class="form-label">Ã‰quipe B</div>
            <select id="team-match-b"><option value="">-- Choisir --</option></select>
          </div>
          <div class="form-field" style="min-width:130px">
            <div class="form-label">Date</div>
            <input type="date" id="team-match-date">
          </div>
          <button class="btn btn-primary" onclick="addTeamMatch()">âœ“ Valider</button>
        </div>
      </div>

      <!-- Historique matchs Ã©quipes -->
      <div class="section-label">Historique des matchs</div>
      <div id="team-match-list"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE DÃ‰FIS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-defis">
      <div class="page-title">âš”ï¸ <span>DÃ©fis</span></div>

      <!-- Lancer un dÃ©fi -->
      <div class="card" style="margin-bottom:1.4rem">
        <div class="section-label" style="margin-bottom:0.8rem">Lancer un dÃ©fi</div>
        <div style="display:flex;gap:0.8rem;flex-wrap:wrap;align-items:flex-end">
          <div class="form-field" style="min-width:150px">
            <div class="form-label">De</div>
            <select id="defi-from"><option value="">-- Challengeur --</option></select>
          </div>
          <div style="display:flex;align-items:flex-end;padding-bottom:0.5rem;font-size:1rem;color:var(--accent)">âš”ï¸</div>
          <div class="form-field" style="min-width:150px">
            <div class="form-label">Ã€</div>
            <select id="defi-to"><option value="">-- Adversaire --</option></select>
          </div>
          <div class="form-field" style="min-width:150px">
            <div class="form-label">Jeu</div>
            <select id="defi-game">
              <option value="501">501 Sets</option>
              <option value="301">301 Sets</option>
              <option value="Bobs27">Bob's 27</option>
              <option value="Doubles">Circuit des Doubles</option>
              <option value="Libre">Libre</option>
            </select>
          </div>
          <div class="form-field" style="flex:1;min-width:150px">
            <div class="form-label">Message (opt.)</div>
            <input type="text" id="defi-msg" placeholder="Si t'as le courage..." maxlength="50">
          </div>
          <button class="btn btn-primary" onclick="lancerDefi()">âš”ï¸ DÃ©fier !</button>
        </div>
      </div>

      <!-- DÃ©fis en cours -->
      <div class="section-label">DÃ©fis actifs</div>
      <div id="defis-actifs-list" style="margin-bottom:1.4rem"></div>

      <!-- DÃ©fis terminÃ©s -->
      <div class="section-label">Historique</div>
      <div id="defis-history-list"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE LIGUE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-ligue">
      <div class="page-title">ğŸ… <span>Mode Ligue</span></div>

      <!-- CrÃ©er une ligue -->
      <div id="ligue-create-section">
        <div class="card" style="margin-bottom:1.2rem">
          <div class="section-label" style="margin-bottom:0.8rem">CrÃ©er une ligue</div>
          <div style="display:flex;gap:0.8rem;flex-wrap:wrap;align-items:flex-end">
            <div class="form-field" style="flex:2;min-width:180px">
              <div class="form-label">Nom de la ligue</div>
              <input type="text" id="ligue-name-input" placeholder="Championnat du Club" maxlength="40">
            </div>
            <div class="form-field" style="min-width:130px">
              <div class="form-label">Nb. de journÃ©es</div>
              <input type="number" id="ligue-journees-input" min="1" max="30" value="10">
            </div>
            <div class="form-field" style="min-width:130px">
              <div class="form-label">Joueurs</div>
              <div id="ligue-players-select" style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto;padding:4px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;min-width:200px"></div>
            </div>
            <button class="btn btn-primary" onclick="creerLigue()">ğŸ… CrÃ©er</button>
          </div>
        </div>
      </div>

      <!-- Ligues existantes -->
      <div id="ligue-list-section"></div>
    </div>

  </div><!-- /content -->
</div>

<!-- â•â•â•â•â•â• TRAINING SESSION MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="train-session-modal">
  <div class="modal" style="max-width:560px">
    <div class="modal-title">
      <span id="train-modal-title">Session d'entraÃ®nement</span>
      <button class="modal-close" onclick="closeTrainingSession()">âœ•</button>
    </div>
    <div id="train-modal-body"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• SCORE COUNTER OVERLAY â•â•â•â•â•â• -->
<div class="sc-overlay" id="sc-overlay">

  <!-- TOPBAR -->
  <div class="sc-topbar">
    <div style="display:flex;align-items:center;gap:0.6rem">
      <span style="font-size:1.1rem">ğŸ¯</span>
      <span class="sc-game-name" id="sc-game-name-display">Compteur</span>
    </div>
    <div class="sc-topbar-actions">
      <button class="sc-top-btn" id="sc-undo-btn" onclick="scUndo()" style="display:none">â†© Annuler</button>
      <button class="sc-top-btn" id="sc-voice-btn" onclick="toggleVoiceMode()" title="Mode vocal" style="display:none"><i class="fas fa-microphone-slash"></i> Vocal</button>
      <button class="sc-top-btn" id="sc-multi-btn" onclick="openModal('sc-multi-modal')" title="Multijoueur" style="display:none"><i class="fas fa-wifi"></i> Multi</button>
      <span id="sc-multi-live-badge" class="sc-multi-badge" style="display:none"><i class="fas fa-circle" style="font-size:.5rem"></i> SYNC</span>
      <button class="sc-top-btn danger" onclick="scReset()">â†º Reset</button>
      <button class="sc-top-btn" onclick="scBackToSetup()">âš™ Config</button>
      <button class="sc-top-btn danger" onclick="closeScoreCounter()">âœ• Fermer</button>
    </div>
  </div>

  <!-- SETUP SCREEN -->
  <div class="sc-setup" id="sc-setup-screen">
    <div class="sc-setup-title">Choisissez votre <span>jeu</span></div>

    <!-- Game selector -->
    <div class="sc-setup-section">
      <div class="sc-setup-label">Mode de jeu</div>
      <div class="sc-game-grid" id="sc-game-grid">
        <div class="sc-game-card selected" data-game="501" onclick="scSelectGame('501',this)">
          <div class="sc-game-icon">5ï¸âƒ£</div>
          <div class="sc-game-title">501</div>
          <div class="sc-game-desc">Descendre Ã  0 en double out</div>
        </div>
        <div class="sc-game-card" data-game="301" onclick="scSelectGame('301',this)">
          <div class="sc-game-icon">3ï¸âƒ£</div>
          <div class="sc-game-title">301</div>
          <div class="sc-game-desc">Version courte du 501</div>
        </div>
        <div class="sc-game-card" data-game="701" onclick="scSelectGame('701',this)">
          <div class="sc-game-icon">7ï¸âƒ£</div>
          <div class="sc-game-title">701</div>
          <div class="sc-game-desc">Version longue Ã©quipes</div>
        </div>
        <div class="sc-game-card" data-game="cricket" onclick="scSelectGame('cricket',this)">
          <div class="sc-game-icon">ğŸ</div>
          <div class="sc-game-title">Cricket</div>
          <div class="sc-game-desc">Fermer 15-20 + Bull</div>
        </div>
        <div class="sc-game-card" data-game="countup" onclick="scSelectGame('countup',this)">
          <div class="sc-game-icon">ğŸ“ˆ</div>
          <div class="sc-game-title">Count Up</div>
          <div class="sc-game-desc">Max points en N volÃ©es</div>
        </div>
        <div class="sc-game-card" data-game="atclock" onclick="scSelectGame('atclock',this)">
          <div class="sc-game-icon">ğŸ•</div>
          <div class="sc-game-title">Around the Clock</div>
          <div class="sc-game-desc">1 Ã  20 dans l'ordre</div>
        </div>
        <div class="sc-game-card" data-game="killer" onclick="scSelectGame('killer',this)">
          <div class="sc-game-icon">ğŸ’€</div>
          <div class="sc-game-title">Killer</div>
          <div class="sc-game-desc">3 vies, survivre le plus longtemps</div>
        </div>
        <div class="sc-game-card" data-game="shanghai" onclick="scSelectGame('shanghai',this)">
          <div class="sc-game-icon">ğŸ¥¢</div>
          <div class="sc-game-title">Shanghai</div>
          <div class="sc-game-desc">7 rounds, max points</div>
        </div>
        <div class="sc-game-card" data-game="halfit" onclick="scSelectGame('halfit',this)">
          <div class="sc-game-icon">âœ‚ï¸</div>
          <div class="sc-game-title">Half-It</div>
          <div class="sc-game-desc">RatÃ© = score divisÃ© par 2</div>
        </div>
      </div>
    </div>

    <!-- Game options -->
    <div class="sc-setup-section" id="sc-options-section">
      <div class="sc-setup-label">Options</div>
      <div id="sc-options-content"></div>
    </div>

    <!-- Players -->
    <div class="sc-setup-section">
      <div class="sc-setup-label">Joueurs</div>
      <div class="sc-players-list" id="sc-players-setup"></div>
      <button onclick="scAddPlayer()" style="margin-top:0.5rem;width:100%;padding:0.55rem;background:none;border:1px dashed rgba(255,255,255,0.1);border-radius:9px;color:#4b5563;cursor:pointer;font-size:0.78rem;font-family:'Work Sans',sans-serif;transition:all 0.15s;font-weight:600" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='#4b5563'">
        + Ajouter un joueur
      </button>
    </div>

    <button class="btn btn-primary" style="width:100%;padding:0.9rem;font-size:1rem;font-family:'Bebas Neue',sans-serif;letter-spacing:3px;border-radius:10px;font-weight:400;box-shadow:0 4px 20px rgba(230,57,70,0.35)" onclick="scStartGame()">
      ğŸ¯ &nbsp; LANCER LA PARTIE
    </button>
  </div>

  <!-- GAME SCREEN -->
  <div class="sc-game" id="sc-game-screen" style="display:none">

    <!-- Players scores -->
    <div class="sc-players-zone" id="sc-players-zone"></div>

    <!-- Checkout hint (X01) -->
    <div class="sc-checkout-hint" id="sc-checkout-hint"></div>

    <!-- Cricket scoreboard -->
    <div id="sc-cricket-board-wrap" style="display:none;padding:0.5rem 0.8rem 0;">
      <div class="sc-cricket-board" id="sc-cricket-board"></div>
    </div>

    <!-- Live stats strip -->
    <div class="sc-live-stats" id="sc-live-stats" style="display:none">
      <div class="sc-live-stat">Moy: <span class="sc-live-stat-val" id="sc-ls-avg">â€”</span></div>
      <div class="sc-live-stat">Meilleure volÃ©e: <span class="sc-live-stat-val" id="sc-ls-best">â€”</span></div>
      <div class="sc-live-stat" id="sc-ls-180-wrap" style="display:none">ğŸ¯ <span class="sc-live-stat-val" id="sc-ls-180">0</span> Ã— 180</div>
      <div class="sc-live-stat" id="sc-ls-co-wrap" style="display:none">Checkout: <span class="sc-live-stat-val" id="sc-ls-co">0%</span></div>
    </div>
    <!-- Input zone -->
    <div class="sc-input-zone" id="sc-input-zone">

      <!-- Keyboard hints strip -->
      <div id="sc-keyboard-hints" style="font-size:0.58rem;color:var(--muted);text-align:center;padding:2px 0;letter-spacing:0.5px;display:none">
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">1-20</kbd> FlÃ©chette &nbsp;
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">D</kbd> Double &nbsp;
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">T</kbd> Triple &nbsp;
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">B</kbd> Bull &nbsp;
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">Enter</kbd> Confirmer &nbsp;
        <kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:0.56rem">M</kbd> RatÃ©
      </div>

      <!-- History strip -->
      <div class="sc-history-strip" id="sc-history-strip"></div>

      <!-- X01 dart display -->
      <div class="sc-dart-display" id="sc-dart-display">
        <div class="sc-dart-items-row">
          <div class="sc-dart-item">
            <div class="sc-dart-val" id="sc-dart-1">â€”</div>
            <div class="sc-dart-lbl">FL. 1</div>
          </div>
          <div class="sc-dart-sep">+</div>
          <div class="sc-dart-item">
            <div class="sc-dart-val" id="sc-dart-2">â€”</div>
            <div class="sc-dart-lbl">FL. 2</div>
          </div>
          <div class="sc-dart-sep">+</div>
          <div class="sc-dart-item">
            <div class="sc-dart-val" id="sc-dart-3">â€”</div>
            <div class="sc-dart-lbl">FL. 3</div>
          </div>
        </div>
        <div class="sc-dart-total-block">
          <div class="sc-dart-total" id="sc-dart-total">0</div>
          <div class="sc-dart-total-lbl">pts</div>
        </div>
      </div>

      <!-- Multiplier -->
      <div class="sc-multiplier" id="sc-multiplier">
        <button class="sc-mult-btn active" id="sc-mult-1" onclick="scSetMult(1)">Simple</button>
        <button class="sc-mult-btn double" id="sc-mult-2" onclick="scSetMult(2)">Double Ã—2</button>
        <button class="sc-mult-btn triple" id="sc-mult-3" onclick="scSetMult(3)">Triple Ã—3</button>
      </div>

      <!-- Keypad -->
      <div class="sc-keypad" id="sc-keypad"></div>
    </div>

    <!-- Winner screen -->
    <div class="sc-winner-screen" id="sc-winner-screen" style="display:none">
      <div class="sc-winner-trophy">ğŸ†</div>
      <div class="sc-winner-name" id="sc-winner-name">Champion</div>
      <div class="sc-winner-label">ğŸ¯ VAINQUEUR ğŸ¯</div>
      <div class="sc-winner-stats" id="sc-winner-stats"></div>
      <div class="sc-recap-grid" id="sc-recap-grid" style="display:none"></div>
      <div id="sc-save-panel" style="display:none;margin-top:1.2rem;background:rgba(230, 57, 70, 0.08);border:1px solid rgba(230, 57, 70, 0.3);border-radius:10px;padding:1rem;min-width:260px;max-width:360px;width:100%;text-align:left">
        <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;color:var(--accent);margin-bottom:0.6rem;text-transform:uppercase">ğŸ“Š Enregistrer au classement</div>
        <div id="sc-save-info" style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.8rem;line-height:1.6"></div>
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap">
          <button id="sc-save-btn" class="sc-top-btn primary" onclick="scSaveMatch()" style="flex:1;min-width:130px">âœ“ Enregistrer</button>
          <button class="sc-top-btn" onclick="document.getElementById('sc-save-panel').style.display='none'" style="font-size:0.7rem">Ignorer</button>
        </div>
        <div id="sc-save-ok" style="display:none;margin-top:0.6rem;font-size:0.78rem;color:var(--green);font-weight:600">âœ“ Match enregistrÃ© !</div>
      </div>
      <div style="display:flex;gap:0.8rem;margin-top:1.5rem;flex-wrap:wrap;justify-content:center">
        <button class="sc-top-btn primary" onclick="scPlayAgain()">ğŸ”„ Revanche</button>
        <button class="sc-top-btn" onclick="scBackToSetup()">âš™ Nouveau jeu</button>
        <button class="sc-top-btn danger" onclick="closeScoreCounter()">âœ• Fermer</button>
      </div>
    </div>

  </div>
</div>
<!-- â•â•â•â•â•â• SHARE CLASSEMENT MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="share-classement-modal">
  <div class="modal" style="max-width:500px">
    <div class="modal-title">ğŸ”— Partager le classement <button class="modal-close" onclick="closeModal('share-classement-modal')">âœ•</button></div>
    <div style="font-size:0.78rem;color:var(--muted);margin-bottom:0.8rem">Copiez ce lien pour partager une vue lecture seule du classement. Valide au moment du partage.</div>
    <textarea id="share-url-text" style="width:100%;height:70px;font-size:0.68rem;font-family:'DM Mono',monospace;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.5rem;color:var(--text-dim);resize:none" readonly></textarea>
    <div style="display:flex;gap:0.6rem;margin-top:0.8rem">
      <button class="btn btn-primary" style="flex:1" onclick="copyShareUrl()">ğŸ“‹ Copier le lien</button>
      <button class="btn btn-secondary" onclick="closeModal('share-classement-modal')">Fermer</button>
    </div>
    <div id="share-preview" style="margin-top:1rem;max-height:200px;overflow-y:auto;font-size:0.75rem"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• MATCH SHEET MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="match-sheet-modal">
  <div class="modal" style="max-width:600px">
    <div class="modal-title">ğŸ“„ Feuille de match <button class="modal-close" onclick="closeModal('match-sheet-modal')">âœ•</button></div>
    <div style="display:flex;gap:0.6rem;margin-bottom:1rem;flex-wrap:wrap">
      <div class="form-field" style="flex:1;min-width:150px">
        <div class="form-label">Joueur 1</div>
        <select id="sheet-p1"><option value="">-- Choisir --</option></select>
      </div>
      <div class="form-field" style="flex:1;min-width:150px">
        <div class="form-label">Joueur 2</div>
        <select id="sheet-p2"><option value="">-- Choisir --</option></select>
      </div>
      <div class="form-field" style="min-width:130px">
        <div class="form-label">Format</div>
        <select id="sheet-format">
          <option value="BO3">Best of 3 sets</option>
          <option value="BO5">Best of 5 sets</option>
          <option value="BO7">Best of 7 sets</option>
          <option value="301">301</option>
          <option value="501" selected>501</option>
          <option value="701">701</option>
        </select>
      </div>
      <div class="form-field" style="min-width:120px">
        <div class="form-label">Date</div>
        <input type="date" id="sheet-date">
      </div>
    </div>
    <div style="display:flex;gap:0.6rem;margin-bottom:1rem">
      <button class="btn btn-primary" style="flex:1" onclick="printMatchSheet()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn btn-secondary" onclick="previewMatchSheet()">ğŸ‘ AperÃ§u</button>
    </div>
    <div id="match-sheet-preview"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• DEFI RESULT MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="defi-result-modal">
  <div class="modal" style="max-width:380px">
    <div class="modal-title">ğŸ† RÃ©sultat du dÃ©fi <button class="modal-close" onclick="closeModal('defi-result-modal')">âœ•</button></div>
    <input type="hidden" id="defi-result-id">
    <div id="defi-result-info" style="margin-bottom:1rem;padding:0.8rem;background:var(--surface2);border-radius:8px;font-size:0.82rem"></div>
    <div style="display:flex;gap:0.8rem;margin-bottom:1rem">
      <div class="form-field" style="flex:1">
        <div class="form-label" id="defi-result-p1-label">Joueur 1</div>
        <input type="number" id="defi-result-s1" min="0" max="99" style="text-align:center;font-size:1.3rem;font-family:'DM Mono',monospace;font-weight:700">
      </div>
      <div style="display:flex;align-items:flex-end;padding-bottom:0.5rem;font-size:1.3rem;color:var(--muted)">â€“</div>
      <div class="form-field" style="flex:1">
        <div class="form-label" id="defi-result-p2-label">Joueur 2</div>
        <input type="number" id="defi-result-s2" min="0" max="99" style="text-align:center;font-size:1.3rem;font-family:'DM Mono',monospace;font-weight:700">
      </div>
    </div>
    <div style="display:flex;gap:0.6rem">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('defi-result-modal')">Annuler</button>
      <button class="btn btn-primary" style="flex:1" onclick="validerDefi()">âœ“ Valider</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• KEYBOARD SHORTCUTS HELP MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="keyboard-help-modal">
  <div class="modal" style="max-width:480px">
    <div class="modal-title">âŒ¨ï¸ Raccourcis clavier <button class="modal-close" onclick="closeModal('keyboard-help-modal')">âœ•</button></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;padding:0.5rem 0">
      <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;padding-bottom:0.3rem;border-bottom:1px solid var(--border);grid-column:1/-1">Navigation</div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Accueil</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">1</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Classement</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">2</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Joueurs</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">3</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Matchs</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">4</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Tournois</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">5</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Statistiques</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">6</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Historique</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">7</kbd></div>
      <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;padding:0.6rem 0 0.3rem;border-bottom:1px solid var(--border);grid-column:1/-1">Actions</div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Compteur de score</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">C</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Mode TV</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">F</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Recherche rapide</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">/</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:0.82rem;color:var(--text-dim)">Fermer / Echap</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">Esc</kbd></div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0"><span style="font-size:0.82rem;color:var(--text-dim)">Aide raccourcis</span><kbd style="background:var(--dark-card);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace">?</kbd></div>
    </div>
    <div style="margin-top:1rem;text-align:center">
      <button class="btn btn-secondary" onclick="closeModal('keyboard-help-modal')">Fermer</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="ligue-journee-modal">
  <div class="modal" style="max-width:480px">
    <div class="modal-title">ğŸ“‹ Saisir les rÃ©sultats <button class="modal-close" onclick="closeModal('ligue-journee-modal')">âœ•</button></div>
    <div id="ligue-journee-matches"></div>
    <div style="display:flex;gap:0.6rem;margin-top:1rem">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('ligue-journee-modal')">Fermer</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveLigueJournee()">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• EDIT MATCH MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="edit-match-modal">
  <div class="modal" style="max-width:420px">
    <div class="modal-title">
      âœï¸ Modifier le Match
      <button class="modal-close" onclick="closeModal('edit-match-modal')">âœ•</button>
    </div>
    <input type="hidden" id="edit-match-id">
    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;padding:0.8rem;background:var(--surface2);border-radius:8px">
      <span id="edit-match-p1-name" style="flex:1;text-align:center;font-weight:700;font-size:0.9rem"></span>
      <span style="color:var(--muted)">vs</span>
      <span id="edit-match-p2-name" style="flex:1;text-align:center;font-weight:700;font-size:0.9rem"></span>
    </div>
    <div style="display:flex;gap:0.8rem;margin-bottom:1rem">
      <div class="form-field" style="flex:1">
        <div class="form-label">Score J1</div>
        <input type="number" id="edit-match-s1" min="0" max="99" style="text-align:center;font-size:1.4rem;font-family:'DM Mono',monospace;font-weight:700">
      </div>
      <div style="display:flex;align-items:flex-end;padding-bottom:0.5rem;font-size:1.5rem;color:var(--muted)">â€“</div>
      <div class="form-field" style="flex:1">
        <div class="form-label">Score J2</div>
        <input type="number" id="edit-match-s2" min="0" max="99" style="text-align:center;font-size:1.4rem;font-family:'DM Mono',monospace;font-weight:700">
      </div>
    </div>
    <div style="display:flex;gap:0.8rem;margin-bottom:1rem">
      <div class="form-field" style="flex:1">
        <div class="form-label">Moy. 3D J1 (opt.)</div>
        <input type="number" id="edit-match-avg1" min="0" max="200" step="0.1" placeholder="ex: 45.2">
      </div>
      <div class="form-field" style="flex:1">
        <div class="form-label">Moy. 3D J2 (opt.)</div>
        <input type="number" id="edit-match-avg2" min="0" max="200" step="0.1" placeholder="ex: 38.7">
      </div>
    </div>
    <div class="form-field" style="margin-bottom:1rem">
      <div class="form-label">Date</div>
      <input type="date" id="edit-match-date">
    </div>
    <div style="display:flex;gap:0.6rem">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('edit-match-modal')">Annuler</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveEditMatch()">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<div class="soiree-overlay" id="soiree-overlay">
  <div class="soiree-modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem">
      <div class="soiree-title" style="margin:0">ğŸ¯ Mode SoirÃ©e</div>
      <button class="modal-close" onclick="closeSoiree()">âœ•</button>
    </div>
    <div class="soiree-grid">
      <div>
        <div class="form-label" style="text-align:center;margin-bottom:0.4rem">Joueur 1</div>
        <select id="soiree-p1" class="soiree-select"><option value="">-- Choisir --</option></select>
      </div>
      <div style="text-align:center;display:flex;flex-direction:column;align-items:center;gap:0.5rem">
        <div style="font-family:'Bebas Neue', sans-serif;font-size:0.9rem;color:var(--muted)">VS</div>
        <div style="display:flex;gap:0.5rem;align-items:center">
          <input type="number" class="soiree-score-input" id="soiree-s1" min="0" max="99" placeholder="0" style="width:70px">
          <span style="font-size:1.5rem;color:var(--muted)">â€”</span>
          <input type="number" class="soiree-score-input" id="soiree-s2" min="0" max="99" placeholder="0" style="width:70px">
        </div>
      </div>
      <div>
        <div class="form-label" style="text-align:center;margin-bottom:0.4rem">Joueur 2</div>
        <select id="soiree-p2" class="soiree-select"><option value="">-- Choisir --</option></select>
      </div>
    </div>
    <div id="soiree-preview" style="min-height:24px;text-align:center;font-size:0.78rem;color:var(--muted);margin-bottom:0.8rem"></div>
    <div class="soiree-actions">
      <button class="btn btn-primary" style="width:100%" onclick="addMatchSoiree()">âœ“ Valider et match suivant</button>
    </div>
    <div id="soiree-history" style="margin-top:1rem;max-height:180px;overflow-y:auto"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• TIMER WIDGET â•â•â•â•â•â• -->
<div class="timer-widget" id="timer-widget">
  <div>
    <div style="font-size:0.62rem;color:var(--muted);letter-spacing:1px;margin-bottom:2px">TIMER MATCH</div>
    <div class="timer-display" id="timer-display">00:00</div>
  </div>
  <div class="timer-controls">
    <button class="btn btn-sm btn-primary" id="timer-start-stop" onclick="toggleTimer()">â–¶</button>
    <button class="btn btn-sm btn-secondary" onclick="resetTimer()">â†º</button>
    <button class="btn btn-sm btn-secondary" onclick="toggleTimerWidget()">âœ•</button>
  </div>
</div>

<!-- â•â•â•â•â•â• TOURNOI CREATE MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="create-tournoi-modal">
  <div class="modal" style="max-width:680px">
    <div class="modal-title">
      ğŸ† CrÃ©er un Tournoi
      <button class="modal-close" onclick="closeModal('create-tournoi-modal')">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:1rem">

      <!-- Nom + Date -->
      <div style="display:flex;gap:0.8rem;flex-wrap:wrap">
        <div class="form-field" style="flex:2;min-width:180px">
          <div class="form-label">Nom du tournoi</div>
          <input type="text" id="t-name" placeholder="Grand Prix de FlÃ©chettes">
        </div>
        <div class="form-field" style="min-width:140px">
          <div class="form-label">Date</div>
          <input type="date" id="t-date">
        </div>
        <div class="form-field" style="min-width:130px">
          <div class="form-label">Lieu</div>
          <input type="text" id="t-lieu" placeholder="Bar Le Bullseye">
        </div>
      </div>

      <!-- Format selector visuel -->
      <div class="form-field">
        <div class="form-label">Format du tournoi</div>
        <div class="t-format-cards" id="t-format-cards">
          <div class="t-format-card selected" data-fmt="poules_rr" onclick="selectTFormat(this,'poules_rr')">
            <div class="t-fmt-icon">ğŸ†</div>
            <div class="t-fmt-name">Poules + Tableau</div>
            <div class="t-fmt-desc">Format officiel FFD. Poules Ã  la ronde, puis tableau Ã  Ã©limination directe.</div>
            <div class="t-fmt-badge">RecommandÃ©</div>
          </div>
          <div class="t-format-card" data-fmt="elimination" onclick="selectTFormat(this,'elimination')">
            <div class="t-fmt-icon">âš¡</div>
            <div class="t-fmt-name">Ã‰limination directe</div>
            <div class="t-fmt-desc">Bracket simple. Perdre = Ã©limination. IdÃ©al pour soirÃ©e rapide.</div>
          </div>
          <div class="t-format-card" data-fmt="rr" onclick="selectTFormat(this,'rr')">
            <div class="t-fmt-icon">ğŸ”„</div>
            <div class="t-fmt-name">Tous contre tous</div>
            <div class="t-fmt-desc">Chacun affronte tous les autres. Classement final aux points.</div>
          </div>
        </div>
        <input type="hidden" id="t-format" value="poules_rr">
      </div>

      <!-- Options selon format -->
      <div id="t-options-poules" style="display:flex;gap:0.8rem;flex-wrap:wrap">
        <div class="form-field" style="min-width:130px">
          <div class="form-label">Joueurs par poule</div>
          <select id="t-pool-size">
            <option value="3">3 joueurs</option>
            <option value="4" selected>4 joueurs</option>
            <option value="5">5 joueurs</option>
            <option value="6">6 joueurs</option>
          </select>
        </div>
        <div class="form-field" style="min-width:140px">
          <div class="form-label">QualifiÃ©s / poule</div>
          <select id="t-qualifies">
            <option value="1">1er qualifiÃ©</option>
            <option value="2" selected>1er + 2e qualifiÃ©s</option>
          </select>
        </div>
      </div>

      <!-- Jeu -->
      <div style="display:flex;gap:0.8rem;flex-wrap:wrap">
        <div class="form-field" style="min-width:140px">
          <div class="form-label">Jeu / Discipline</div>
          <select id="t-jeu">
            <option value="501">501 (standard)</option>
            <option value="301">301</option>
            <option value="cricket">Cricket</option>
            <option value="double_out">501 Double Out</option>
            <option value="libre">Sets libres</option>
          </select>
        </div>
        <div class="form-field" style="min-width:130px">
          <div class="form-label">Format de la manche</div>
          <select id="t-legs">
            <option value="BO1">BO1 (1 leg)</option>
            <option value="BO3" selected>BO3 (meilleur des 3)</option>
            <option value="BO5">BO5 (meilleur des 5)</option>
            <option value="BO7">BO7 (meilleur des 7)</option>
          </select>
        </div>
        <div class="form-field" style="min-width:120px">
          <div class="form-label">TÃªtes de sÃ©rie</div>
          <select id="t-seeding">
            <option value="elo">Par ELO</option>
            <option value="random">AlÃ©atoire</option>
          </select>
        </div>
      </div>

      <!-- Participants -->
      <div class="form-field">
        <div class="form-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>Participants</span>
          <span id="t-player-count" style="font-size:0.68rem;color:var(--muted)">0 sÃ©lectionnÃ©(s)</span>
        </div>
        <div id="t-players-checkboxes" style="display:flex;flex-wrap:wrap;gap:0.4rem;padding:0.6rem;background:var(--bg);border-radius:7px;border:1px solid var(--border);max-height:160px;overflow-y:auto"></div>
        <div style="display:flex;gap:0.5rem;margin-top:0.4rem">
          <button class="btn btn-secondary btn-sm" onclick="selectAllTPlayers(true)">âœ“ Tous</button>
          <button class="btn btn-secondary btn-sm" onclick="selectAllTPlayers(false)">âœ• Aucun</button>
        </div>
      </div>

      <div style="display:flex;gap:0.6rem;justify-content:flex-end;padding-top:0.4rem;border-top:1px solid var(--border)">
        <button class="btn btn-secondary" onclick="closeModal('create-tournoi-modal')">Annuler</button>
        <button class="btn btn-primary" onclick="createTournoi()">ğŸ¯ CrÃ©er le tournoi</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• TOURNOI DETAIL MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="tournoi-detail-modal">
  <div class="modal" style="max-width:860px">
    <div class="modal-title">
      <span id="tournoi-detail-title">Tournoi</span>
      <button class="modal-close" onclick="closeModal('tournoi-detail-modal')">âœ•</button>
    </div>
    <div id="tournoi-detail-content"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• POOL DETAIL MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="pool-detail-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-title">
      <span id="pool-detail-title">Poule</span>
      <div style="display:flex;gap:0.5rem;align-items:center">
        <button class="btn btn-secondary btn-sm" id="pool-print-btn" onclick="imprimerPoule()">ğŸ–¨ï¸ Feuilles</button>
        <button class="modal-close" onclick="closeModal('pool-detail-modal')">âœ•</button>
      </div>
    </div>
    <div id="pool-detail-content"></div>
  </div>
</div>




<!-- â•â•â•â•â•â• PLAYER PROFILE MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="profile-modal">
  <div class="modal profile-modal" style="max-width:600px">
    <div class="profile-hero" id="profile-hero">
      <div class="profile-avatar-big" id="profile-avatar-big">AB</div>
      <div class="profile-hero-info">
        <div class="profile-pseudo-big" id="profile-pseudo-big"></div>
        <div class="profile-name-big" id="profile-name-big"></div>
        <div class="profile-surnom" id="profile-surnom-display"></div>
      </div>
      <div style="text-align:right;z-index:1">
        <div class="profile-elo-hero" id="profile-elo-hero"></div>
        <div id="profile-division-hero" style="margin-top:4px"></div>
      </div>
      <button class="modal-close" style="position:absolute;top:1rem;right:1rem;z-index:2" onclick="closeModal('profile-modal')">âœ•</button>
    </div>

    <div class="profile-stats-row" id="profile-stats-row"></div>

    <!-- Profile Tabs -->
    <div class="profile-tabs" style="margin-bottom:0">
      <button class="profile-tab active" onclick="switchProfileTab('stats',this)">ğŸ“Š Stats</button>
      <button class="profile-tab" onclick="switchProfileTab('history',this)">ğŸ“‹ Historique</button>
      <button class="profile-tab" onclick="switchProfileTab('achievements',this)">ğŸ† TrophÃ©es</button>
      <button class="profile-tab" onclick="switchProfileTab('training',this)">ğŸ’ª EntraÃ®n.</button>
    </div>

    <!-- TAB: Stats (existing content) -->
    <div id="profile-tab-stats" class="profile-tab-content active">
    <div style="display:flex;gap:1rem;flex-wrap:wrap">
      <!-- Left: edit -->
      <div style="flex:1;min-width:220px">
        <div class="profile-section">
          <div class="profile-section-title">Surnom</div>
          <input type="text" id="profile-surnom-input" placeholder="Le Sniper, La Machine..." maxlength="30" style="font-size:0.85rem" oninput="previewProfile()">
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Bio / Citation</div>
          <textarea class="profile-bio-input" id="profile-bio-input" placeholder="Une devise, un style de jeu..." maxlength="120" oninput="previewProfile()"></textarea>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Couleur</div>
          <div class="avatar-color-picker" id="avatar-color-picker">
            <div class="avatar-color-swatch selected" style="background:var(--primary)" data-c="var(--primary)" onclick="selectAvatarColor('var(--primary)',this)"></div>
            <div class="avatar-color-swatch" style="background:#4a9eff" data-c="#4a9eff" onclick="selectAvatarColor('#4a9eff',this)"></div>
            <div class="avatar-color-swatch" style="background:#34d47b" data-c="#34d47b" onclick="selectAvatarColor('#34d47b',this)"></div>
            <div class="avatar-color-swatch" style="background:#f0534a" data-c="#f0534a" onclick="selectAvatarColor('#f0534a',this)"></div>
            <div class="avatar-color-swatch" style="background:#a67cf7" data-c="#a67cf7" onclick="selectAvatarColor('#a67cf7',this)"></div>
            <div class="avatar-color-swatch" style="background:#ff7f50" data-c="#ff7f50" onclick="selectAvatarColor('#ff7f50',this)"></div>
            <div class="avatar-color-swatch" style="background:#16c9aa" data-c="#16c9aa" onclick="selectAvatarColor('#16c9aa',this)"></div>
            <div class="avatar-color-swatch" style="background:#f472b6" data-c="#f472b6" onclick="selectAvatarColor('#f472b6',this)"></div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Photo personnalisÃ©e</div>
          <div style="display:flex;align-items:center;gap:0.8rem">
            <div id="profile-photo-preview" style="width:44px;height:44px;border-radius:9px;background:var(--dark-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:var(--muted);overflow:hidden;flex-shrink:0">Aucune</div>
            <div style="flex:1">
              <label style="display:inline-block;background:var(--dark-card);border:1px solid var(--border);border-radius:7px;padding:0.35rem 0.8rem;font-size:0.75rem;cursor:pointer;color:var(--text-dim);transition:border-color .15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                ğŸ“· Choisir une photo
                <input type="file" accept="image/*" style="display:none" onchange="handleProfilePhotoUpload(event)">
              </label>
              <button class="btn btn-sm btn-secondary" style="font-size:0.65rem;margin-left:0.4rem" onclick="clearProfilePhoto()" title="Supprimer la photo">âœ•</button>
            </div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Avatar Emoji</div>
          <div class="avatar-emoji-picker" id="avatar-emoji-picker">
            <button class="avatar-emoji-btn selected" data-e="" onclick="selectAvatarEmoji('',this)">AB</button>
            <button class="avatar-emoji-btn" data-e="ğŸ¯" onclick="selectAvatarEmoji('ğŸ¯',this)">ğŸ¯</button>
            <button class="avatar-emoji-btn" data-e="ğŸ”¥" onclick="selectAvatarEmoji('ğŸ”¥',this)">ğŸ”¥</button>
            <button class="avatar-emoji-btn" data-e="ğŸ‘‘" onclick="selectAvatarEmoji('ğŸ‘‘',this)">ğŸ‘‘</button>
            <button class="avatar-emoji-btn" data-e="ğŸ’€" onclick="selectAvatarEmoji('ğŸ’€',this)">ğŸ’€</button>
            <button class="avatar-emoji-btn" data-e="âš¡" onclick="selectAvatarEmoji('âš¡',this)">âš¡</button>
            <button class="avatar-emoji-btn" data-e="ğŸ‰" onclick="selectAvatarEmoji('ğŸ‰',this)">ğŸ‰</button>
            <button class="avatar-emoji-btn" data-e="ğŸ¦" onclick="selectAvatarEmoji('ğŸ¦',this)">ğŸ¦</button>
            <button class="avatar-emoji-btn" data-e="ğŸ¸" onclick="selectAvatarEmoji('ğŸ¸',this)">ğŸ¸</button>
            <button class="avatar-emoji-btn" data-e="ğŸº" onclick="selectAvatarEmoji('ğŸº',this)">ğŸº</button>
            <button class="avatar-emoji-btn" data-e="ğŸ¤–" onclick="selectAvatarEmoji('ğŸ¤–',this)">ğŸ¤–</button>
          </div>
        </div>
      </div>
      <!-- Right: sparkline + trophies -->
      <div style="flex:1;min-width:200px">
        <div class="profile-section">
          <div class="profile-section-title">Ã‰volution ELO</div>
          <div id="profile-sparkline-big"></div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Forme rÃ©cente</div>
          <div id="profile-form-dots" style="display:flex;gap:3px;flex-wrap:wrap"></div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">TrophÃ©es</div>
          <div id="profile-trophies" style="display:flex;gap:4px;flex-wrap:wrap;font-size:1.2rem"></div>
        </div>
      </div>
    </div>

    </div><!-- /profile-tab-stats -->

    <!-- TAB: History -->
    <div id="profile-tab-history" class="profile-tab-content">
      <div id="profile-match-history" style="max-height:380px;overflow-y:auto"></div>
    </div>

    <!-- TAB: Achievements -->
    <div id="profile-tab-achievements" class="profile-tab-content">
      <div id="profile-achievements-detail"></div>
    </div>

    <!-- TAB: Training -->
    <div id="profile-tab-training" class="profile-tab-content">
      <div id="profile-training-detail"></div>
    </div>

    <div style="display:flex;gap:0.6rem;margin-top:1.2rem;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn btn-primary" onclick="saveProfile()" style="flex:1"><i class="fas fa-floppy-disk"></i> Enregistrer le profil</button>
      <button class="card-export-btn" onclick="exportPlayerCard()"><i class="fas fa-id-card"></i> Carte Joueur</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• MOBILE BOTTOM NAV â•â•â•â•â•â• -->
<nav class="mobile-nav">
  <div class="mobile-nav-items">
    <button class="mnav-btn active" id="mnav-dashboard" onclick="showPage('dashboard',this);setMobileNav('dashboard')">
      <span class="mnav-icon"><i class="fas fa-house"></i></span><span class="mnav-label">Accueil</span>
    </button>
    <button class="mnav-btn" id="mnav-joueurs" onclick="showPage('joueurs',this);setMobileNav('joueurs')">
      <span class="mnav-icon"><i class="fas fa-user"></i></span><span class="mnav-label">Joueurs</span>
    </button>
    <button class="mnav-btn" id="mnav-matchs" onclick="showPage('matchs',this);setMobileNav('matchs')">
      <span class="mnav-icon"><i class="fas fa-bullseye"></i></span><span class="mnav-label">Matchs</span>
    </button>
    <button class="mnav-btn" id="mnav-classement" onclick="showPage('classement',this);setMobileNav('classement')">
      <span class="mnav-icon"><i class="fas fa-trophy"></i></span><span class="mnav-label">Classement</span>
    </button>
    <button class="mnav-btn" id="mnav-stats" onclick="showPage('stats',this);setMobileNav('stats')">
      <span class="mnav-icon"><i class="fas fa-chart-line"></i></span><span class="mnav-label">Stats</span>
    </button>
    <button class="mnav-btn" id="mnav-more" onclick="toggleMobileMore()">
      <span class="mnav-icon"><i class="fas fa-ellipsis"></i></span><span class="mnav-label">Plus</span>
    </button>
  </div>
</nav>

<!-- â•â•â•â•â•â• MOBILE MORE MENU â•â•â•â•â•â• -->
<div class="mobile-more-backdrop" id="mobile-more-backdrop" onclick="closeMobileMore()"></div>
<div class="mobile-more-menu" id="mobile-more-menu">
  <div class="mobile-more-handle"></div>
  <div class="mobile-more-title">Navigation</div>
  <div class="mobile-more-grid">
    <button class="mobile-more-item" id="mnav-calendrier" onclick="showPage('calendrier',null);setMobileNav('calendrier');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-calendar-days"></i></span>
      <span class="mmore-label">Agenda</span>
    </button>
    <button class="mobile-more-item" id="mnav-historique" onclick="showPage('historique',null);setMobileNav('historique');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-list-check"></i></span>
      <span class="mmore-label">Historique</span>
    </button>
    <button class="mobile-more-item" id="mnav-tournois" onclick="showPage('tournois',null);setMobileNav('tournois');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-sitemap"></i></span>
      <span class="mmore-label">Tournois</span>
    </button>
    <button class="mobile-more-item" id="mnav-ligue" onclick="showPage('ligue',null);setMobileNav('ligue');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-medal"></i></span>
      <span class="mmore-label">Ligue</span>
    </button>
    <button class="mobile-more-item" id="mnav-equipes" onclick="showPage('equipes',null);setMobileNav('equipes');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-users"></i></span>
      <span class="mmore-label">Ã‰quipes</span>
    </button>
    <button class="mobile-more-item" id="mnav-defis" onclick="showPage('defis',null);setMobileNav('defis');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-bolt"></i></span>
      <span class="mmore-label">DÃ©fis</span>
    </button>
    <button class="mobile-more-item" id="mnav-parametres" onclick="showPage('parametres',null);setMobileNav('parametres');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-gear"></i></span>
      <span class="mmore-label">ParamÃ¨tres</span>
    </button>
    <button class="mobile-more-item" id="mnav-entrainement" onclick="showPage('entrainement',null);setMobileNav('entrainement');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-dumbbell"></i></span>
      <span class="mmore-label">EntraÃ®n.</span>
    </button>
    <button class="mobile-more-item" onclick="openScoreCounter();closeMobileMore()" style="border-color:rgba(230, 57, 70, 0.4);background:var(--accent-dim)">
      <span class="mmore-icon"><i class="fas fa-bullseye"></i></span>
      <span class="mmore-label" style="color:var(--accent)">Compteur</span>
    </button>
    <button class="mobile-more-item" onclick="toggleTimer();closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-stopwatch"></i></span>
      <span class="mmore-label">Minuteur</span>
    </button>
    <button class="mobile-more-item" onclick="openTvMode();closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-tv"></i></span>
      <span class="mmore-label">Mode TV</span>
    </button>
    <button class="mobile-more-item" onclick="openModal('keyboard-help-modal');closeMobileMore()">
      <span class="mmore-icon"><i class="fas fa-keyboard"></i></span>
      <span class="mmore-label">Raccourcis</span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â• TV MODE OVERLAY â•â•â•â•â•â• -->
<div class="tv-overlay" id="tv-overlay">
  <button class="tv-close-btn" onclick="closeTvMode()">âœ• Quitter</button>
  <div class="tv-header">
    <div>
      <div class="tv-logo" id="tv-logo-text">ğŸ¯ FlÃ©chettes Club</div>
      <div class="tv-season" id="tv-season-name">Saison 1</div>
    </div>
    <div class="tv-clock" id="tv-clock">00:00:00</div>
    <div style="text-align:right">
      <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;font-size:0.75rem;font-weight:700;color:var(--red);letter-spacing:2px;text-transform:uppercase">
        <span class="live-dot"></span> EN DIRECT
      </div>
      <div id="tv-match-count" style="font-size:0.72rem;color:var(--muted);margin-top:3px;letter-spacing:1px"></div>
    </div>
  </div>
  <div class="tv-body">
    <div class="tv-ranking">
      <div class="tv-section-title">Classement GÃ©nÃ©ral</div>
      <div id="tv-ranking-list"></div>
    </div>
    <div class="tv-right">
      <div>
        <div class="tv-section-title">Podium</div>
        <div id="tv-podium"></div>
      </div>
      <div>
        <div class="tv-section-title">Dernier Match</div>
        <div id="tv-last-match"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• SCROLL TO TOP â•â•â•â•â•â• -->
<button id="scroll-top-btn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Retour en haut" style="display:none;position:fixed;bottom:5.5rem;right:1.2rem;width:38px;height:38px;border-radius:50%;background:var(--dark-card);border:1px solid var(--border);color:var(--muted);font-size:1.1rem;cursor:pointer;z-index:230;transition:all .2s;box-shadow:0 2px 10px rgba(0,0,0,0.3)" onmouseenter="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'" onmouseleave="this.style.borderColor='var(--border)';this.style.color='var(--muted)'"><i class="fas fa-chevron-up"></i></button>

<!-- â•â•â•â•â•â• MODAL MOT DE PASSE â•â•â•â•â•â• -->
<div class="modal-overlay" id="password-modal" style="z-index:9999">
  <div class="modal" style="max-width:380px;width:95vw">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-lock" style="color:var(--primary)"></i> <span id="password-modal-title">AccÃ¨s protÃ©gÃ©</span></div>
      <button class="modal-close" onclick="closePasswordModal()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.4rem">
      <p style="color:var(--text-dim);margin-bottom:1rem;font-size:0.9rem">Entrez le mot de passe pour continuer.</p>
      <input type="password" id="password-input" class="form-control"
             placeholder="Mot de passe"
             style="font-size:1.1rem;letter-spacing:4px;text-align:center"
             onkeydown="if(event.key==='Enter') confirmPassword()"
             autocomplete="off">
      <div id="password-error" style="display:none;color:var(--red);font-size:0.82rem;margin-top:0.5rem;text-align:center">
        <i class="fas fa-times-circle"></i> Mot de passe incorrect
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:0.6rem;justify-content:flex-end;padding:1rem 1.4rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="closePasswordModal()">Annuler</button>
      <button class="btn btn-primary" onclick="confirmPassword()"><i class="fas fa-unlock"></i> Valider</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• IMPORT EXCEL MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="import-excel-modal">
  <div class="modal" style="max-width:620px;width:95vw">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-file-excel" style="color:var(--green)"></i> Importer des joueurs depuis Excel</div>
      <button class="modal-close" onclick="closeImportModal()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.2rem">

      <!-- Zone de dÃ©pÃ´t -->
      <div class="import-dropzone" id="import-dropzone"
           ondragover="importDragOver(event)" ondragleave="importDragLeave(event)" ondrop="importDrop(event)">
        <input type="file" accept=".xlsx,.xls,.csv,.ods" id="import-file-input" onchange="importFileChosen(event)">
        <div class="import-dropzone-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <div class="import-dropzone-label">Glissez votre fichier ici ou cliquez pour parcourir</div>
        <div class="import-dropzone-hint">.xlsx Â· .xls Â· .csv Â· .ods</div>
      </div>

      <div class="import-format-hint">
        <strong>Format attendu :</strong> votre fichier doit contenir au moins une colonne <strong>Nom</strong> et/ou <strong>Pseudo</strong> (ou <em>Prenom</em>, <em>Name</em>, <em>Nickname</em>â€¦).
        La premiÃ¨re ligne doit Ãªtre l'en-tÃªte. Les doublons (mÃªme pseudo, insensible Ã  la casse) sont dÃ©tectÃ©s automatiquement et ignorÃ©s â€” les stats des joueurs existants sont prÃ©servÃ©es.
      </div>

      <!-- SÃ©lection des colonnes (visible aprÃ¨s chargement) -->
      <div id="import-col-map-wrap" style="display:none">
        <div class="import-col-map">
          <label><i class="fas fa-user"></i> Colonne "Nom" :</label>
          <select id="import-col-nom" onchange="importPreview()"></select>
          <label style="margin-left:0.5rem"><i class="fas fa-tag"></i> Colonne "Pseudo" :</label>
          <select id="import-col-pseudo" onchange="importPreview()"></select>
        </div>
      </div>

      <!-- RÃ©sumÃ© -->
      <div id="import-summary-wrap" style="display:none">
        <div class="import-summary" id="import-summary"></div>
      </div>

      <!-- Tableau de prÃ©visualisation -->
      <div id="import-preview-wrap" style="display:none">
        <div class="section-label" style="margin:0.6rem 0 0.4rem">AperÃ§u â€” sÃ©lectionnez les joueurs Ã  importer</div>
        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem">
          <button class="btn btn-secondary btn-sm" onclick="importSelectAll(true)">âœ“ Tous les nouveaux</button>
          <button class="btn btn-secondary btn-sm" onclick="importSelectAll(false)">âœ• Aucun</button>
        </div>
        <div class="import-preview-scroll">
          <table class="import-preview-table">
            <thead>
              <tr>
                <th style="width:32px"></th>
                <th>Nom</th>
                <th>Pseudo</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody id="import-preview-tbody"></tbody>
          </table>
        </div>
      </div>

    </div>
    <div class="modal-footer" style="display:flex;gap:0.6rem;justify-content:flex-end;padding:1rem 1.2rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="closeImportModal()">Annuler</button>
      <button class="btn btn-primary" id="import-confirm-btn" onclick="importConfirm()" disabled style="display:flex;align-items:center;gap:0.4rem">
        <i class="fas fa-user-plus"></i> <span id="import-confirm-label">Importer</span>
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• LOGIN MODAL â•â•â•â•â•â• -->
<div id="login-overlay">
  <div class="login-box">
    <div class="login-logo">ğŸ¯</div>
    <div class="login-title">FlÃ©chettes Club</div>

    <!-- Ã‰TAPE 1 : Choisir son profil -->
    <div class="login-step active" id="login-step-1">
      <div class="login-sub">SÃ©lectionnez votre profil</div>
      <div class="login-players-grid" id="login-players-grid">
        <div class="login-empty">Chargement...</div>
      </div>
      <button class="btn btn-primary" id="login-confirm-btn" onclick="goToPasswordStep()" disabled style="width:100%">
        <i class="fas fa-arrow-right"></i> Continuer
      </button>
      <div style="margin-top:0.9rem">
        <button onclick="loginAsGuest()" style="background:none;border:none;color:var(--primary);font-size:0.78rem;cursor:pointer;font-family:'Work Sans',sans-serif;text-decoration:underline;font-weight:600">
          Continuer en tant que visiteur (lecture seule)
        </button>
      </div>
    </div>

    <!-- Ã‰TAPE 2 : Mot de passe -->
    <div class="login-step" id="login-step-2">
      <button class="login-back-btn" onclick="backToPlayerSelect()">
        <i class="fas fa-arrow-left"></i> Changer de profil
      </button>
      <div class="login-selected-player" id="login-selected-player-info">
        <div class="login-selected-avatar" id="login-selected-avatar">??</div>
        <div>
          <div style="font-size:0.88rem;font-weight:700" id="login-selected-name">Joueur</div>
          <div style="font-size:0.68rem;color:var(--text-dim)">Entrez votre mot de passe</div>
        </div>
      </div>
      <div class="login-pwd-input-wrap">
        <input type="password" id="login-pwd-input" class="form-control"
               placeholder="Mot de passe"
               onkeydown="if(event.key==='Enter') confirmLogin()"
               autocomplete="current-password">
        <button class="login-pwd-toggle" onclick="togglePwdVisibility()" type="button">
          <i class="fas fa-eye" id="pwd-eye-icon"></i>
        </button>
      </div>
      <div id="login-pwd-error" style="display:none;color:var(--red);font-size:0.78rem;text-align:center;margin-bottom:0.7rem">
        <i class="fas fa-times-circle"></i> Mot de passe incorrect
      </div>
      <button class="btn btn-primary" onclick="confirmLogin()" style="width:100%">
        <i class="fas fa-right-to-bracket"></i> Connexion
      </button>
      <div class="login-no-pwd-hint" id="login-no-pwd-hint" style="display:none">
        Ce profil n'a pas encore de mot de passe â€”
        <a href="#" onclick="confirmLoginNoPwd()" style="color:var(--primary)">entrer directement</a>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• CHAT FLOTTANT â•â•â•â•â•â• -->
<button id="chat-fab" onclick="toggleChat()" title="Chat du club">
  <i class="fas fa-comments"></i>
  <div id="chat-notif-dot"></div>
</button>

<div id="chat-panel">
  <div class="chat-header">
    <div style="display:flex;align-items:center;gap:0.5rem">
      <i class="fas fa-comments" style="color:var(--primary)"></i>
      <span class="chat-header-title">Chat du club</span>
    </div>
    <button class="chat-header-close" onclick="toggleChat()">âœ•</button>
  </div>
  <div id="chat-messages">
    <div class="chat-empty">Soyez le premier Ã  Ã©crire ğŸ’¬</div>
  </div>
  <div class="chat-input-row">
    <input type="text" id="chat-input" placeholder="Ã‰crire un message..." maxlength="200"
           onkeydown="if(event.key==='Enter') sendChatMessage()">
    <button id="chat-send-btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<!-- â•â•â•â•â•â• PWA INSTALL BANNER â•â•â•â•â•â• -->
<div id="pwa-install-banner">
  <div class="pwa-banner-icon">ğŸ“²</div>
  <div class="pwa-banner-text">
    <div class="pwa-banner-title">Installer l'application</div>
    <div class="pwa-banner-sub">AccÃ©dez au club directement depuis votre Ã©cran d'accueil</div>
  </div>
  <button class="pwa-install-btn" onclick="installPWA()">Installer</button>
  <button class="pwa-dismiss-btn" onclick="dismissPWA()">Plus tard</button>
</div>


<footer class="app-footer">
  <div class="footer-inner">
    <div class="footer-grid">
      <div class="footer-col">
        <h3><i class="fas fa-bullseye"></i> FlÃ©chettes Club Pro</h3>
        <p>Application de gestion de club de flÃ©chettes</p>
        <p style="margin-top:0.5rem;font-size:0.8rem;color:var(--gray)">Suivez les stats, classements et tournois de votre club</p>
      </div>
      <div class="footer-col">
        <h3><i class="fas fa-users"></i> Navigation</h3>
        <p><a href="#" onclick="showPage('dashboard',null)"><i class="fas fa-house"></i> Accueil</a></p>
        <p><a href="#" onclick="showPage('classement',null)"><i class="fas fa-trophy"></i> Classement</a></p>
        <p><a href="#" onclick="showPage('joueurs',null)"><i class="fas fa-user"></i> Joueurs</a></p>
        <p><a href="#" onclick="showPage('tournois',null)"><i class="fas fa-sitemap"></i> Tournois</a></p>
        <p><a href="#" onclick="showPage('stats',null)"><i class="fas fa-chart-line"></i> Statistiques</a></p>
      </div>
      <div class="footer-col">
        <h3><i class="fas fa-trophy"></i> FonctionnalitÃ©s</h3>
        <p><a href="#" onclick="openScoreCounter()"><i class="fas fa-bullseye"></i> Compteur de score</a></p>
        <p><a href="#" onclick="showPage('entrainement',null)"><i class="fas fa-dumbbell"></i> EntraÃ®nement</a></p>
        <p><a href="#" onclick="openTvMode()"><i class="fas fa-tv"></i> Mode TV Live</a></p>
        <p><a href="#" onclick="showPage('calendrier',null)"><i class="fas fa-calendar-days"></i> Calendrier</a></p>
      </div>
    </div>
    <div class="footer-bottom">
      <p><i class="fas fa-copyright"></i> FlÃ©chettes Club Pro â€” Tous droits rÃ©servÃ©s Â· PropulsÃ© par <strong>Claude</strong> <i class="fas fa-heart" style="color:var(--primary)"></i></p>
    </div>
  </div>
</footer>


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” Remplacez par vos propres valeurs
// CrÃ©ez un projet sur https://console.firebase.google.com
// puis copiez la config ici (ParamÃ¨tres â†’ Vos apps â†’ SDK)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyChT6xEFly_hzbqX3FULLL5yqV4Ij3mwcY",
  authDomain:        "darts-club-77ce6.firebaseapp.com",
  databaseURL:       "https://darts-club-77ce6-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "darts-club-77ce6",
  storageBucket:     "darts-club-77ce6.firebasestorage.app",
  messagingSenderId: "371102071387",
  appId:             "1:371102071387:web:eb1adc3cd0be37a866dd7e",
  measurementId:     "G-QWCYRC6HEH"
};

// â”€â”€ ID du club dans Firestore (ne pas modifier sauf si vous gÃ©rez plusieurs clubs) â”€â”€
const FB_CLUB_ID = 'main';

// â”€â”€ Flag activÃ© seulement si la config a Ã©tÃ© remplie â”€â”€
const FIREBASE_ENABLED = FIREBASE_CONFIG.apiKey !== "VOTRE_API_KEY";

let _db = null;
let _fbUnsubscribe = null;
let _savePending = false;
let _saveDebounce = null;
let _ignoreNextSnapshot = 0;     // compteur : chaque write incrÃ©mente, chaque snapshot ignorÃ© dÃ©crÃ©mente
let _localSaveTs = 0;            // timestamp du dernier write local envoyÃ© Ã  Firebase
let _firebaseReady = false;      // true aprÃ¨s le 1er snapshot Firebase reÃ§u
let _loginInitDone = false;      // Ã©vite de lancer initLogin deux fois

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE â€” valeurs initiales depuis localStorage (cache local)
// puis Ã©crasÃ©es par Firebase dÃ¨s la connexion
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let players     = JSON.parse(localStorage.getItem('darts_players')  || '[]');
let matches     = JSON.parse(localStorage.getItem('darts_matches')  || '[]');
let tournois    = JSON.parse(localStorage.getItem('darts_tournois') || '[]');
let seasons     = JSON.parse(localStorage.getItem('darts_seasons')  || '[{"id":1,"name":"Saison 1","start":null,"end":null,"active":true}]');
let auditLog    = JSON.parse(localStorage.getItem('darts_audit')    || '[]');
let soirees     = JSON.parse(localStorage.getItem('darts_soirees')  || '[]');
let clubSettings = JSON.parse(localStorage.getItem('darts_club') || '{"name":"FlÃ©chettes Club","logo":"ğŸ¯","accent":"var(--primary)","dark":true}');
// v2.3 new data
let teams        = JSON.parse(localStorage.getItem('darts_teams')    || '[]');
let teamMatches  = JSON.parse(localStorage.getItem('darts_team_matches') || '[]');
let defis        = JSON.parse(localStorage.getItem('darts_defis')    || '[]');
let ligues       = JSON.parse(localStorage.getItem('darts_ligues')   || '[]');
let trainingPrograms = JSON.parse(localStorage.getItem('darts_train_programs') || '[]');
const ELO_K = 32, ELO_START = 1000;
let matchFilter = null;
let eloChart = null, winsChart = null, pctChart = null;
let _eloVersion = 0;        // incremented on each match add/delete
let _eloCacheVersion = -1;  // version when cache was last computed
let _statsCache = null;
let _eloCached = false;

// Timer state
let timerInterval = null, timerSeconds = 0, timerRunning = false;

function _saveToLocalStorage() {
  try {
    localStorage.setItem('darts_players',  JSON.stringify(players));
    localStorage.setItem('darts_matches',  JSON.stringify(matches));
    localStorage.setItem('darts_tournois', JSON.stringify(tournois));
    localStorage.setItem('darts_seasons',  JSON.stringify(seasons));
    localStorage.setItem('darts_audit',    JSON.stringify(auditLog.slice(0, 200)));
    localStorage.setItem('darts_soirees',  JSON.stringify(soirees));
    localStorage.setItem('darts_club',     JSON.stringify(clubSettings));
    localStorage.setItem('darts_teams',    JSON.stringify(teams));
    localStorage.setItem('darts_team_matches', JSON.stringify(teamMatches));
    localStorage.setItem('darts_defis',    JSON.stringify(defis));
    localStorage.setItem('darts_ligues',   JSON.stringify(ligues));
    localStorage.setItem('darts_train_programs', JSON.stringify(trainingPrograms));
  } catch(e) { /* silencieux */ }
}

function _saveToFirebase() {
  if (!FIREBASE_ENABLED || !_db) return;
  _ignoreNextSnapshot++;           // on attend UN snapshot en retour de notre propre write
  _localSaveTs = Date.now();
  _setSyncStatus('saving');
  const payload = {
    players,
    matches,
    tournois,
    seasons,
    auditLog:  auditLog.slice(0, 200),
    soirees,
    clubSettings,
    teams,
    teamMatches,
    defis,
    ligues,
    trainingPrograms,
    _lastUpdate: new Date().toISOString(),
    _savedBy: _scDeviceId          // identifie l'auteur pour Ã©viter les Ã©crasements croisÃ©s
  };
  _db.collection('clubs').doc(FB_CLUB_ID).set(payload).then(() => {
    _setSyncStatus('ok');
  }).catch(err => {
    _ignoreNextSnapshot = Math.max(0, _ignoreNextSnapshot - 1); // annule le compteur si le write Ã©choue
    console.error('[Firebase] Erreur sauvegarde:', err);
    _setSyncStatus('error');
    showNotif('âš  Erreur de sync Firebase. DonnÃ©es sauvegardÃ©es localement.', 'error');
  });
}

function save() {
  // 1) Sauvegarde locale immÃ©diate (cache offline)
  _saveToLocalStorage();
  updateLastBackup();
  // 2) Sauvegarde Firebase avec debounce (Ã©vite trop d'Ã©critures)
  if (FIREBASE_ENABLED) {
    clearTimeout(_saveDebounce);
    _saveDebounce = setTimeout(_saveToFirebase, 600);
  } else {
    // Mode local uniquement
    try {
      let sz = 0; for(const k of Object.keys(localStorage)) sz += (localStorage.getItem(k)||'').length;
      if (sz > 4000000) showNotif('âš  Stockage presque plein ! Exportez vos donnÃ©es.', 'error');
    } catch(e) {}
  }
}

// â”€â”€ Indicateur visuel de sync â”€â”€
function _setSyncStatus(status) {
  const el = document.getElementById('fb-sync-badge');
  if (!el) return;
  if (status === 'ok') {
    el.innerHTML = '<i class="fas fa-cloud-check"></i> Sync';
    el.style.color = 'var(--green)';
    el.style.borderColor = 'rgba(45,198,83,0.35)';
  } else if (status === 'saving') {
    el.innerHTML = '<i class="fas fa-cloud-arrow-up"></i> Sync...';
    el.style.color = 'var(--gold)';
    el.style.borderColor = 'rgba(245,197,24,0.35)';
  } else if (status === 'error') {
    el.innerHTML = '<i class="fas fa-cloud-slash"></i> Hors ligne';
    el.style.color = 'var(--red)';
    el.style.borderColor = 'rgba(230,57,70,0.35)';
  } else if (status === 'connecting') {
    el.innerHTML = '<i class="fas fa-cloud"></i> Connexion...';
    el.style.color = 'var(--text-dim)';
    el.style.borderColor = 'var(--border)';
  } else if (status === 'disabled') {
    el.innerHTML = '<i class="fas fa-database"></i> Local';
    el.style.color = 'var(--gray)';
    el.style.borderColor = 'var(--border)';
  }
}

// â”€â”€ Applique les donnÃ©es reÃ§ues de Firebase â”€â”€
function _applyFirebaseData(data) {
  if (!data) return;
  players          = Array.isArray(data.players)          ? data.players          : players;
  matches          = Array.isArray(data.matches)          ? data.matches          : matches;
  tournois         = Array.isArray(data.tournois)         ? data.tournois         : tournois;
  seasons          = Array.isArray(data.seasons)          ? data.seasons          : seasons;
  auditLog         = Array.isArray(data.auditLog)         ? data.auditLog         : auditLog;
  soirees          = Array.isArray(data.soirees)          ? data.soirees          : soirees;
  clubSettings     = data.clubSettings                    ? data.clubSettings     : clubSettings;
  teams            = Array.isArray(data.teams)            ? data.teams            : teams;
  teamMatches      = Array.isArray(data.teamMatches)      ? data.teamMatches      : teamMatches;
  defis            = Array.isArray(data.defis)            ? data.defis            : defis;
  ligues           = Array.isArray(data.ligues)           ? data.ligues           : ligues;
  trainingPrograms = Array.isArray(data.trainingPrograms) ? data.trainingPrograms : trainingPrograms;
  // Met Ã  jour le cache local
  _saveToLocalStorage();
}

// â”€â”€ Initialisation Firebase et Ã©coute temps rÃ©el â”€â”€
function initFirebase() {
  if (!FIREBASE_ENABLED) {
    _setSyncStatus('disabled');
    console.log('[Firebase] DÃ©sactivÃ© â€” mode local uniquement.');
    showNotif('ğŸ’¾ Mode local â€” Configurez Firebase pour activer la sync multi-utilisateurs.', 'info');
    // Pas de Firebase : initLogin tout de suite avec les donnÃ©es locales
    if (!_loginInitDone) {
      _loginInitDone = true;
      try { initLogin(); } catch(e) {}
    }
    return;
  }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    _db = firebase.firestore();
    _setSyncStatus('connecting');
    // Ã‰coute en temps rÃ©el du document du club
    _fbUnsubscribe = _db.collection('clubs').doc(FB_CLUB_ID).onSnapshot(
      { includeMetadataChanges: false },
      (doc) => {
        // Ignore nos propres snapshots (compteur dÃ©crÃ©mental)
        if (_ignoreNextSnapshot > 0) {
          _ignoreNextSnapshot--;
          _setSyncStatus('ok');
          // Si c'est bien notre propre snapshot, dÃ©clencher initLogin si nÃ©cessaire
          if (!_firebaseReady) {
            _firebaseReady = true;
            if (!_loginInitDone) { _loginInitDone = true; try { initLogin(); } catch(e) {} }
          }
          return;
        }
        if (doc.exists) {
          const data = doc.data();
          // Ne pas Ã©craser si on a une sauvegarde locale plus rÃ©cente en attente
          const fbTs = data._lastUpdate ? new Date(data._lastUpdate).getTime() : 0;
          if (_saveDebounce && fbTs < _localSaveTs) {
            // Notre write local est plus rÃ©cent â€” on ignore ce snapshot entrant
            _setSyncStatus('ok');
            if (!_firebaseReady) {
              _firebaseReady = true;
              if (!_loginInitDone) { _loginInitDone = true; try { initLogin(); } catch(e) {} }
            }
            return;
          }
          _checkNewMatches(data);
          _applyFirebaseData(data);
          _eloVersion++;
          recomputeElo(true);
          renderAll();
          applyClubSettings();
          updateSeasonBadge();
          _setSyncStatus('ok');
          if (!_firebaseReady) {
            showNotif('ğŸ”„ DonnÃ©es synchronisÃ©es', 'success');
          }
          // â”€â”€ Premier snapshot : lancer initLogin maintenant que les joueurs sont Ã  jour â”€â”€
          if (!_firebaseReady) {
            _firebaseReady = true;
            if (!_loginInitDone) {
              _loginInitDone = true;
              try { initLogin(); } catch(e) { console.error('[initLogin after Firebase]', e); }
            }
          }
        } else {
          // Aucune donnÃ©e dans Firebase â€” on pousse les donnÃ©es locales
          _saveToFirebase();
        }
      },
      (err) => {
        console.error('[Firebase] Erreur Ã©coute:', err);
        _setSyncStatus('error');
        showNotif('âš  Connexion Firebase perdue. Mode local activÃ©.', 'error');
        // Lancer initLogin en fallback si pas encore fait
        if (!_loginInitDone) {
          _loginInitDone = true;
          try { initLogin(); } catch(e) {}
        }
      }
    );
  } catch(e) {
    console.error('[Firebase] Erreur init:', e);
    _setSyncStatus('error');
    showNotif('âš  Erreur Firebase : vÃ©rifiez votre configuration.', 'error');
    if (!_loginInitDone) {
      _loginInitDone = true;
      try { initLogin(); } catch(e2) {}
    }
  }
}

function updateLastBackup() {
  const now = new Date().toLocaleString('fr-FR');
  localStorage.setItem('darts_last_backup', now);
}

function addAudit(icon, msg) {
  auditLog.unshift({ icon, msg, time: new Date().toLocaleString('fr-FR') });
  auditLog = auditLog.slice(0, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTÃˆME DE MOT DE PASSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_PASSWORD = '0311';
let _passwordCallback = null;

function requirePassword(title, callback) {
  _passwordCallback = callback;
  document.getElementById('password-modal-title').textContent = title || 'AccÃ¨s protÃ©gÃ©';
  document.getElementById('password-input').value = '';
  document.getElementById('password-error').style.display = 'none';
  document.getElementById('password-modal').classList.add('active');
  setTimeout(() => document.getElementById('password-input').focus(), 100);
}

function confirmPassword() {
  const val = document.getElementById('password-input').value;
  if (val === APP_PASSWORD) {
    const cb = _passwordCallback;   // sauvegarder avant fermeture
    _passwordCallback = null;
    document.getElementById('password-modal').classList.remove('active');
    if (cb) cb();
  } else {
    document.getElementById('password-error').style.display = 'block';
    document.getElementById('password-input').value = '';
    document.getElementById('password-input').focus();
  }
}

function closePasswordModal() {
  document.getElementById('password-modal').classList.remove('active');
  _passwordCallback = null;
}

// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(page, el) {
  if (page === 'parametres') {
    requirePassword('ğŸ”’ AccÃ¨s ParamÃ¨tres', () => _doShowPage(page, el));
    return;
  }
  _doShowPage(page, el);
}

function _doShowPage(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  setMobileNav(page);
  if (page === 'dashboard')   renderDashboard();
  if (page === 'classement')  { renderRanking(); renderH2HSelects(); }
  if (page === 'matchs')      { renderMatchFilters(); if (document.getElementById('tirage-panel').classList.contains('open')) renderPresenceGrid(); }
  if (page === 'stats')       { renderStats(); renderStatWidgets(); renderRadarPlayerSelect(); }
  if (page === 'tournois')    renderTournois();
  if (page === 'parametres')  renderParametres();
  if (page === 'historique')  renderHistorique();
  if (page === 'calendrier')  renderCalendrier();
  if (page === 'joueurs')     renderPlayers();
  if (page === 'entrainement') renderTrainingPage();
  if (page === 'equipes')     renderEquipes();
  if (page === 'defis')       renderDefis();
  if (page === 'ligue')       renderLigue();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ELO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAdaptiveK(matchCount) {
  if (matchCount < 10) return 40;
  if (matchCount < 30) return 25;
  return 20;
}

function recomputeElo(force) {
  if (!force && _eloCacheVersion === _eloVersion) return; // already up to date
  players.forEach(p => { p.elo = ELO_START; p.eloHistory = [ELO_START]; p.peak = ELO_START; });
  const playerMatchCounts = {};
  players.forEach(p => { playerMatchCounts[p.id] = 0; });
  [...matches].reverse().forEach(m => {
    const p1 = players.find(p => p.id === m.p1);
    const p2 = players.find(p => p.id === m.p2);
    if (!p1 || !p2) return;
    const score = m.winner === m.p1 ? 1 : m.winner === m.p2 ? 0 : 0.5;
    const exp = 1 / (1 + Math.pow(10, (p2.elo - p1.elo) / 400));
    // K-factor adaptatif : Ã©levÃ© pour les nouveaux joueurs, stable pour les vÃ©tÃ©rans
    const k1 = getAdaptiveK(playerMatchCounts[m.p1] || 0);
    const k2 = getAdaptiveK(playerMatchCounts[m.p2] || 0);
    const kAvg = (k1 + k2) / 2;
    // Bonus ELO pour victoire nette (max +15%)
    let scoreBonus = 1;
    if (m.winner && m.s1 !== undefined && m.s2 !== undefined) {
      const total = (m.s1 || 0) + (m.s2 || 0);
      if (total > 0) {
        const margin = Math.abs((m.s1||0) - (m.s2||0)) / total;
        scoreBonus = 1 + margin * 0.15;
      }
    }
    const d = Math.round(kAvg * (score - exp) * scoreBonus);
    m.eloChange1 = d; m.eloChange2 = -d;
    p1.elo += d; p1.eloHistory.push(p1.elo);
    p2.elo -= d; p2.eloHistory.push(p2.elo);
    if (p1.elo > p1.peak) { p1.peak = p1.elo; if (p1._notifyRecord) { p1._newRecord = true; } }
    if (p2.elo > p2.peak) { p2.peak = p2.elo; if (p2._notifyRecord) { p2._newRecord = true; } }
    playerMatchCounts[m.p1] = (playerMatchCounts[m.p1] || 0) + 1;
    playerMatchCounts[m.p2] = (playerMatchCounts[m.p2] || 0) + 1;
  });
  players.forEach(p => {
    const h = p.eloHistory;
    if (h.length < 2) { p.trend = 0; return; }
    const look = Math.min(5, h.length - 1);
    p.trend = h[h.length-1] - h[h.length-1-look];
  });
  _eloCacheVersion = _eloVersion;
  _statsCache = null; // invalidate stats cache too
  if (typeof checkDivisionChanges === 'function') checkDivisionChanges();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getStats() {
  if (_statsCache) return _statsCache;
  const s = {};
  players.forEach(p => s[p.id] = { wins:0, losses:0, draws:0, matches:0, setsWon:0, setsLost:0, totalAvg:0, avgCount:0, checkoutHits:0, checkoutAttempts:0, totalLegs:0, totalDarts:0 });
  matches.forEach(m => {
    if (!s[m.p1]) s[m.p1] = { wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0,totalAvg:0,avgCount:0,checkoutHits:0,checkoutAttempts:0,totalLegs:0,totalDarts:0 };
    if (!s[m.p2]) s[m.p2] = { wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0,totalAvg:0,avgCount:0,checkoutHits:0,checkoutAttempts:0,totalLegs:0,totalDarts:0 };
    s[m.p1].matches++; s[m.p2].matches++;
    s[m.p1].setsWon += m.s1||0; s[m.p1].setsLost += m.s2||0;
    s[m.p2].setsWon += m.s2||0; s[m.p2].setsLost += m.s1||0;
    if (m.winner === m.p1) { s[m.p1].wins++; s[m.p2].losses++; }
    else if (m.winner === m.p2) { s[m.p2].wins++; s[m.p1].losses++; }
    else { s[m.p1].draws++; s[m.p2].draws++; }
    // Stats avancÃ©es
    if (m.avg1 && m.avg1 > 0) { s[m.p1].totalAvg += m.avg1; s[m.p1].avgCount++; }
    if (m.avg2 && m.avg2 > 0) { s[m.p2].totalAvg += m.avg2; s[m.p2].avgCount++; }
    if (m.checkout1) { s[m.p1].checkoutHits++; s[m.p1].checkoutAttempts++; }
    if (m.checkoutAttempts1) s[m.p1].checkoutAttempts += (m.checkoutAttempts1 - (m.checkout1?1:0));
    if (m.checkout2) { s[m.p2].checkoutHits++; s[m.p2].checkoutAttempts++; }
    if (m.checkoutAttempts2) s[m.p2].checkoutAttempts += (m.checkoutAttempts2 - (m.checkout2?1:0));
    if (m.darts1 && m.s1 > 0) { s[m.p1].totalDarts += m.darts1; s[m.p1].totalLegs += m.s1; }
    if (m.darts2 && m.s2 > 0) { s[m.p2].totalDarts += m.darts2; s[m.p2].totalLegs += m.s2; }
  });
  // Calculer les moyennes finales
  players.forEach(p => {
    const st = s[p.id];
    if (!st) return;
    st.avg3d = st.avgCount > 0 ? Math.round(st.totalAvg / st.avgCount * 10) / 10 : 0;
    st.checkoutPct = st.checkoutAttempts > 0 ? Math.round(st.checkoutHits / st.checkoutAttempts * 100) : 0;
    st.dpl = st.totalLegs > 0 ? Math.round(st.totalDarts / st.totalLegs * 10) / 10 : 0;
  });
  _statsCache = s;
  return s;
}

function getRecentForm(pid, n=5) {
  return matches.filter(m => m.p1===pid||m.p2===pid).slice(0,n)
    .map(m => !m.winner ? 'D' : m.winner===pid ? 'W' : 'L');
}

function getStreak(pid) {
  const pm = matches.filter(m => m.p1===pid||m.p2===pid);
  if (!pm.length) return null;
  const first = pm[0].winner===pid ? 'W' : pm[0].winner===null ? 'D' : 'L';
  if (first==='D') return null;
  let count = 0;
  for (const m of pm) {
    const r = m.winner===pid ? 'W' : m.winner===null ? 'D' : 'L';
    if (r===first) count++; else break;
  }
  return count >= 2 ? { type:first, count } : null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACHIEVEMENTS = [
  { id:'first_match',   icon:'ğŸ¯', name:'Premier Match',    desc:'Jouer son 1er match',         check: (p,s) => s.matches >= 1 },
  { id:'first_win',     icon:'ğŸ¥Š', name:'PremiÃ¨re Victoire',desc:'Remporter son 1er match',     check: (p,s) => s.wins >= 1 },
  { id:'streak3',       icon:'ğŸ”¥', name:'En Feu',           desc:'3 victoires consÃ©cutives',    check: (p,s) => { const str=getStreak(p.id); return str && str.type==='W' && str.count>=3; } },
  { id:'streak5',       icon:'âš¡', name:'InarrÃªtable',      desc:'5 victoires consÃ©cutives',    check: (p,s) => { const str=getStreak(p.id); return str && str.type==='W' && str.count>=5; } },
  { id:'streak10',      icon:'ğŸŒªï¸', name:'Tornade',          desc:'10 victoires consÃ©cutives',   check: (p,s) => { const str=getStreak(p.id); return str && str.type==='W' && str.count>=10; } },
  { id:'ten_matches',   icon:'ğŸ…', name:'VÃ©tÃ©ran',          desc:'10 matchs jouÃ©s',             check: (p,s) => s.matches >= 10 },
  { id:'twenty_matches',icon:'â­', name:'Pilier du Club',   desc:'20 matchs jouÃ©s',             check: (p,s) => s.matches >= 20 },
  { id:'fifty_matches', icon:'ğŸ’', name:'LÃ©gende du Club',  desc:'50 matchs jouÃ©s',             check: (p,s) => s.matches >= 50 },
  { id:'elo1200',       icon:'ğŸ“ˆ', name:'En Progression',   desc:'Atteindre 1200 ELO',          check: (p,s) => p.elo >= 1200 },
  { id:'elo1500',       icon:'ğŸ’«', name:'Expert',           desc:'Atteindre 1500 ELO',          check: (p,s) => p.elo >= 1500 },
  { id:'elo1800',       icon:'ğŸŒŸ', name:'Ã‰lite',            desc:'Atteindre 1800 ELO',          check: (p,s) => p.elo >= 1800 },
  { id:'pct80',         icon:'ğŸ–ï¸', name:'Dominateur',       desc:'80%+ de victoires (min 5)',   check: (p,s) => s.matches>=5 && (s.wins/s.matches)>=0.8 },
  { id:'pct100',        icon:'ğŸ‘‘', name:'Invincible',       desc:'100% victoires (min 5)',      check: (p,s) => s.matches>=5 && s.losses===0 && s.draws===0 },
  { id:'top1',          icon:'ğŸ†', name:'NÂ°1 du Club',      desc:'Atteindre la 1Ã¨re place ELO', check: (p,s) => { const sorted=[...players].sort((a,b)=>b.elo-a.elo); return sorted[0]&&sorted[0].id===p.id&&s.matches>=1; } },
  { id:'peak1300',      icon:'ğŸš€', name:'Record Personnel', desc:'Peak ELO > 1300',             check: (p,s) => (p.peak||p.elo) >= 1300 },
  { id:'first_180',     icon:'ğŸ’¯', name:'Premier 180',      desc:'Marquer 180 au compteur',     check: (p,s) => (p.total180s||0) >= 1 },
  { id:'five_180s',     icon:'ğŸ°', name:'Machine Ã  180',    desc:'5 fois 180 au compteur',      check: (p,s) => (p.total180s||0) >= 5 },
  { id:'checkout_king', icon:'ğŸ¯', name:'Roi du Checkout',  desc:'10 checkouts rÃ©ussis au compteur', check: (p,s) => (p.totalCheckouts||0) >= 10 },
  { id:'checkout_pro',  icon:'ğŸ°', name:'Finisher',          desc:'40%+ checkout sur 5 matchs+',   check: (p,s) => s.checkoutAttempts>=5 && s.checkoutPct>=40 },
  { id:'avg50',         icon:'ğŸ“Š', name:'RÃ©gulier',          desc:'Moy. 3D 50+ sur 3 matchs+',    check: (p,s) => s.avg3d>=50 && s.avgCount>=3 },
  { id:'avg70',         icon:'âš¡', name:'Machine Ã  Dards',   desc:'Moy. 3D 70+ sur 3 matchs+',    check: (p,s) => s.avg3d>=70 && s.avgCount>=3 },
  { id:'bobs27_master', icon:'ğŸ’¥', name:"Bob's 27 Master",   desc:"Score 80+ au Bob's 27",         check: (p,s) => { const bs = (trainingSessions||[]).filter(ts=>ts.playerId==p.id&&ts.exerciseId==='bobs27'); return bs.some(ts=>ts.score>=80); } },
  { id:'perfect_week',  icon:'ğŸ“…', name:'Semaine Parfaite', desc:'5 matchs en une semaine',     check: (p,s) => { const now=new Date(); const ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); const wm=matches.filter(m=>(m.p1===p.id||m.p2===p.id)&&new Date(m.date.split('/').reverse().join('-'))>=ws); return wm.length>=5; } },
  { id:'comeback',      icon:'ğŸ”„', name:'Grand Retour',     desc:'Gagner aprÃ¨s 3 dÃ©faites de suite', check: (p,s) => { const form=getRecentForm(p.id,4); return form.length>=4 && form[0]==='W' && form[1]==='L' && form[2]==='L' && form[3]==='L'; } },
];

function checkAchievements() {
  const stats = getStats();
  recomputeElo();
  players.forEach(p => {
    if (!p.achievements) p.achievements = [];
    ACHIEVEMENTS.forEach(ach => {
      const s = stats[p.id] || { wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0 };
      if (!p.achievements.includes(ach.id) && ach.check(p, s)) {
        p.achievements.push(ach.id);
        showNotif('ğŸ† ' + p.pseudo + ' a dÃ©bloquÃ© : ' + ach.icon + ' ' + ach.name);
        showAchievementUnlock(ach.icon, ach.name, ach.desc);
        addAudit('ğŸ†', p.pseudo + ' a dÃ©bloquÃ© "' + ach.name + '"');
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPARKLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sparkline(history, w=90, h=26, col) {
  if (!history || history.length < 2) return `<svg width="${w}" height="${h}"></svg>`;
  const min = Math.min(...history), max = Math.max(...history);
  const range = max - min || 1;
  const pts = history.map((v,i) => {
    const x = (i/(history.length-1))*w;
    const y = h - ((v-min)/range)*(h-4) - 2;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  const last = history[history.length-1], first = history[0];
  const color = col || (last >= first ? '#34d47b' : '#f0534a');
  return `<svg width="${w}" height="${h}" style="display:block;overflow:visible">
    <defs><linearGradient id="sg${w}c${history.length}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    <polygon points="0,${h} ${pts} ${w},${h}" fill="url(#sg${w}c${history.length})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}

function trendBadge(trend) {
  if (trend > 8)  return `<span class="trend-badge t-up">â–² +${trend}</span>`;
  if (trend < -8) return `<span class="trend-badge t-dn">â–¼ ${trend}</span>`;
  return `<span class="trend-badge t-nc">â€” Stable</span>`;
}

function formDots(form) {
  return form.map(r => {
    if (r==='W') return `<span class="form-dot form-w" role="img" aria-label="Victoire" title="Victoire">V</span>`;
    if (r==='L') return `<span class="form-dot form-l" role="img" aria-label="DÃ©faite" title="DÃ©faite">D</span>`;
    return `<span class="form-dot form-d" role="img" aria-label="Nul" title="Nul">N</span>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getInitials(name) { return name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2); }
function playerAvatar(p, size=44, radius=9) {
  const color = p.avatarColor || 'var(--accent)';
  if (p.avatarPhoto) {
    return `<div style="width:${size}px;height:${size}px;border-radius:${radius}px;overflow:hidden;flex-shrink:0"><img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover"></div>`;
  }
  return `<div style="width:${size}px;height:${size}px;background:linear-gradient(135deg,${color},${color}99);border-radius:${radius}px;display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*0.4)}px;font-weight:700;color:#0d0f14;flex-shrink:0">${p.avatarEmoji||getInitials(p.name)}</div>`;
}
function pName(id) { const p = players.find(p=>p.id===id); return p ? p.pseudo : '?'; }
function pById(id) { return players.find(p=>p.id===id); }
const COLORS = ['var(--primary)','#4a9eff','#34d47b','#a67cf7','#f0534a','#16c9aa','#ff6b74','#ff7f50'];
function pColor(i) { return COLORS[i % COLORS.length]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  recomputeElo();
  const stats = getStats();
  const totalSets = matches.reduce((a,m) => a+m.s1+m.s2, 0);
  const activeSeason = seasons.find(s=>s.active);

  // Onboarding wizard â€” shown when no players yet
  const onboardingEl = document.getElementById('dash-onboarding');
  if (onboardingEl) {
    if (!players.length) {
      onboardingEl.style.display = 'block';
      onboardingEl.innerHTML = `
        <div style="background:linear-gradient(135deg,rgba(230,57,70,0.08),rgba(230,57,70,0.02));border:1px solid rgba(230,57,70,0.25);border-radius:14px;padding:2.5rem 2rem;text-align:center;margin-bottom:2rem">
          <div style="font-size:3.5rem;margin-bottom:1rem">ğŸ¯</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;color:var(--light);margin-bottom:0.5rem">BIENVENUE !</div>
          <div style="font-size:0.9rem;color:var(--text-dim);margin-bottom:2rem;max-width:460px;margin-left:auto;margin-right:auto">Votre club est prÃªt. Suivez ces 3 Ã©tapes pour commencer :</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;max-width:600px;margin:0 auto 2rem">
            <div style="background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;cursor:pointer;transition:all .18s" onclick="showPage('joueurs',null)" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
              <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ‘¤</div>
              <div style="font-size:0.75rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-bottom:0.3rem">Ã‰tape 1</div>
              <div style="font-size:0.82rem;font-weight:600;color:var(--light)">Ajouter des joueurs</div>
            </div>
            <div style="background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;cursor:pointer;transition:all .18s" onclick="showPage('matchs',null)" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
              <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ¯</div>
              <div style="font-size:0.75rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-bottom:0.3rem">Ã‰tape 2</div>
              <div style="font-size:0.82rem;font-weight:600;color:var(--light)">Saisir des matchs</div>
            </div>
            <div style="background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;cursor:pointer;transition:all .18s" onclick="showPage('classement',null)" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
              <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ†</div>
              <div style="font-size:0.75rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-bottom:0.3rem">Ã‰tape 3</div>
              <div style="font-size:0.82rem;font-weight:600;color:var(--light)">Voir le classement</div>
            </div>
          </div>
          <button class="btn btn-primary" style="font-size:0.9rem;padding:0.7rem 2rem" onclick="showPage('joueurs',null)">â• Ajouter le premier joueur</button>
        </div>`;
    } else {
      onboardingEl.style.display = 'none';
    }
  }

  const counterMatches = matches.filter(m => m.source === 'compteur').length;
  const total180s = players.reduce((a,p) => a + (p.total180s||0), 0);
  // Meilleure moyenne 3D du club
  const bestAvg3d = players.reduce((best, p) => {
    const ps = stats[p.id]; 
    return ps && ps.avg3d > best ? ps.avg3d : best;
  }, 0);
  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-block"><div class="stat-label">Joueurs</div><div class="stat-value">${players.length}</div></div>
    <div class="stat-block"><div class="stat-label">Matchs jouÃ©s</div><div class="stat-value">${matches.length}</div></div>
    <div class="stat-block"><div class="stat-label">Via compteur</div><div class="stat-value">${counterMatches}</div></div>
    <div class="stat-block"><div class="stat-label">Meilleur ELO</div><div class="stat-value" style="font-size:1.5rem">${players.length ? Math.max(...players.map(p=>p.elo)) : 'â€”'}</div></div>
    <div class="stat-block"><div class="stat-label">Total 180s</div><div class="stat-value">${total180s}</div></div>
    ${bestAvg3d > 0 ? `<div class="stat-block" title="Meilleure moyenne 3 flÃ©chettes du club"><div class="stat-label">âš¡ Top Moy.3D</div><div class="stat-value" style="color:var(--purple)">${bestAvg3d}</div></div>` : `<div class="stat-block"><div class="stat-label">Tournois</div><div class="stat-value">${tournois.length}</div></div>`}`;

  const sorted = [...players].sort((a,b)=>b.elo-a.elo);
  const podiumEl = document.getElementById('dash-podium');
  if (!sorted.length) {
    podiumEl.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ†</div><div class="empty-text">Pas encore de classement</div></div>`;
  } else {
    const order = sorted.length>=3 ? [sorted[1],sorted[0],sorted[2]] : sorted.length===2 ? [sorted[1],sorted[0]] : [sorted[0]];
    const cls   = sorted.length>=3 ? ['p2','p1','p3'] : sorted.length===2 ? ['p2','p1'] : ['p1'];
    podiumEl.innerHTML = `<div class="podium">` + order.map((p,i) => `
      <div class="podium-step ${cls[i]}">
        <div class="podium-avatar">${getInitials(p.name)}</div>
        <div class="podium-name">${p.pseudo}</div>
        <div class="podium-elo">${p.elo}</div>
        <div class="podium-bar"><span class="podium-rank">${['2','1','3'][i]}</span></div>
      </div>`).join('') + `</div>`;
  }

  const recent = matches.slice(0,5);
  document.getElementById('dash-recent-list').innerHTML = !recent.length
    ? `<div style="color:var(--muted);font-size:0.78rem;padding:0.5rem 0">Aucun match</div>`
    : recent.map(m => `
      <div class="recent-match">
        <span class="${m.winner===m.p1?'rm-winner':'rm-loser'}">${pName(m.p1)}</span>
        <span class="rm-score">${m.s1}â€“${m.s2}</span>
        <span class="${m.winner===m.p2?'rm-winner':'rm-loser'}">${pName(m.p2)}</span>
        <span class="rm-date">${m.date}</span>
      </div>`).join('');

  const hotEl = document.getElementById('dash-hot');
  if (!players.length) { hotEl.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”¥</div><div class="empty-text">Jouez des matchs pour voir qui est en forme</div></div>`; }
  else {
    const hot = [...players].filter(p=>(stats[p.id]||{}).matches>=1).sort((a,b)=>b.trend-a.trend)[0];
    const cold = [...players].filter(p=>(stats[p.id]||{}).matches>=3).sort((a,b)=>a.trend-b.trend)[0];
    
    let hotHtml = '';
    if (hot) {
      const hotStreak = getStreak(hot.id);
      const hotAlert = hotStreak && hotStreak.type === 'W' && hotStreak.count >= 5 
        ? `<span style="background:var(--green-bg);color:var(--green);border:1px solid rgba(52,212,123,0.3);border-radius:20px;padding:2px 8px;font-size:0.65rem;font-weight:700">ğŸ”¥ ${hotStreak.count} victoires consÃ©cutives</span>`
        : hotStreak && hotStreak.type === 'L' && hotStreak.count >= 3
        ? `<span style="background:var(--red-bg);color:var(--red);border:1px solid rgba(240,83,74,0.3);border-radius:20px;padding:2px 8px;font-size:0.65rem;font-weight:700">ğŸ’€ ${hotStreak.count} dÃ©faites consÃ©cutives</span>`
        : '';
      hotHtml = `
        <div class="card" style="display:flex;align-items:center;gap:1.1rem;flex-wrap:wrap">
          <div style="width:44px;height:44px;background:linear-gradient(135deg,${hot.avatarColor||'var(--accent)'},${hot.avatarColor||'var(--accent)'}99);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:#0d0f14;flex-shrink:0">${hot.avatarEmoji||getInitials(hot.name)}</div>
          <div style="flex:1">
            <div style="font-size:0.9rem;font-weight:700;margin-bottom:2px">${hot.pseudo} <span style="font-size:0.75rem;color:var(--muted);font-weight:400">${hot.name}</span> ${hotAlert}</div>
            <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap">
              <span style="font-family:'Bebas Neue', sans-serif;font-size:1.25rem;color:var(--accent)">${hot.elo}</span>
              ${trendBadge(hot.trend)}
              <span style="font-size:0.72rem;color:var(--muted)">sur les 5 derniers matchs</span>
            </div>
          </div>
          <div style="display:flex;gap:3px">${formDots(getRecentForm(hot.id,5))}</div>
          <div>${sparkline(hot.eloHistory,110,32)}</div>
        </div>`;
    }
    
    // Alerte joueur en difficultÃ©
    let coldHtml = '';
    if (cold && cold !== hot) {
      const coldStreak = getStreak(cold.id);
      if (coldStreak && coldStreak.type === 'L' && coldStreak.count >= 3) {
        coldHtml = `
          <div class="card" style="display:flex;align-items:center;gap:1rem;margin-top:0.6rem;border-color:rgba(240,83,74,0.3);background:rgba(240,83,74,0.04)">
            <div style="font-size:1.5rem">ğŸ’€</div>
            <div style="flex:1">
              <div style="font-size:0.85rem;font-weight:700;color:var(--red)">Alerte : ${cold.pseudo} en difficultÃ©</div>
              <div style="font-size:0.72rem;color:var(--muted)">${coldStreak.count} dÃ©faites consÃ©cutives â€” Peut-Ãªtre besoin d'une session d'entraÃ®nement ?</div>
            </div>
            <div style="display:flex;gap:3px">${formDots(getRecentForm(cold.id,5))}</div>
          </div>`;
      }
    }
    
    hotEl.innerHTML = hotHtml + coldHtml;
    if (!hotHtml && !coldHtml) hotEl.innerHTML = `<div style="color:var(--muted);font-size:0.82rem">Pas assez de donnÃ©es</div>`;
  }

  // Recent trophies
  const recentAch = [];
  players.forEach(p => {
    (p.achievements||[]).forEach(aid => {
      const a = ACHIEVEMENTS.find(x=>x.id===aid);
      if (a) recentAch.push({ player:p.pseudo, a });
    });
  });
  const trophiesEl = document.getElementById('dash-trophies');
  if (!recentAch.length) {
    trophiesEl.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ…</div><div class="empty-text">Jouez pour dÃ©bloquer des trophÃ©es !</div></div>`;
  } else {
    trophiesEl.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:0.6rem">` +
      recentAch.slice(0,8).map(({player,a}) => `
        <div title="${a.desc} â€” ${player}" style="background:var(--surface);border:1px solid #f0d060;border-radius:8px;padding:0.5rem 0.8rem;display:flex;align-items:center;gap:0.5rem;box-shadow:var(--shadow-sm)">
          <span style="font-size:1.1rem">${a.icon}</span>
          <div><div style="font-size:0.72rem;font-weight:700">${a.name}</div><div style="font-size:0.6rem;color:var(--muted)">${player}</div></div>
        </div>`).join('') + `</div>`;
  }

  // RÃ©sumÃ© mensuel automatique
  const monthlyEl = document.getElementById('dash-monthly');
  if (monthlyEl && matches.length > 0) {
    const now = new Date();
    const thisMonth = now.getMonth(), thisYear = now.getFullYear();
    const monthNames = ['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
    const monthMatches = matches.filter(m => {
      const parts = m.date.split('/');
      if (parts.length < 3) return false;
      const d = new Date(parts[2], parts[1]-1, parts[0]);
      return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
    });
    if (monthMatches.length > 0) {
      const monthStats = {};
      players.forEach(p => monthStats[p.id] = { wins:0, losses:0, matches:0 });
      monthMatches.forEach(m => {
        if (!monthStats[m.p1]) monthStats[m.p1] = { wins:0, losses:0, matches:0 };
        if (!monthStats[m.p2]) monthStats[m.p2] = { wins:0, losses:0, matches:0 };
        monthStats[m.p1].matches++; monthStats[m.p2].matches++;
        if (m.winner === m.p1) { monthStats[m.p1].wins++; monthStats[m.p2].losses++; }
        else if (m.winner === m.p2) { monthStats[m.p2].wins++; monthStats[m.p1].losses++; }
      });
      const topPlayer = players.filter(p=>monthStats[p.id]?.matches>0)
        .sort((a,b) => (monthStats[b.id]?.wins||0) - (monthStats[a.id]?.wins||0))[0];
      monthlyEl.innerHTML = `
        <div class="section-label">ğŸ“… Bilan du mois â€” ${monthNames[thisMonth]} ${thisYear}</div>
        <div style="display:flex;gap:0.8rem;flex-wrap:wrap">
          <div class="cnf-stat-card" style="flex:1;min-width:100px;border-top-color:var(--blue)">
            <span class="cnf-stat-number" style="color:var(--blue)">${monthMatches.length}</span>
            <div class="cnf-stat-label">Matchs ce mois</div>
          </div>
          ${topPlayer ? `<div class="cnf-stat-card" style="flex:2;min-width:160px;border-top-color:var(--gold)">
            <span class="cnf-stat-number" style="color:var(--gold);font-size:1.6rem">${topPlayer.pseudo}</span>
            <div class="cnf-stat-label">ğŸ… Meilleur du mois (${monthStats[topPlayer.id]?.wins||0} victoires)</div>
          </div>` : ''}
          <div class="cnf-stat-card" style="flex:1;min-width:100px;border-top-color:var(--green)">
            <span class="cnf-stat-number" style="color:var(--green)">${players.filter(p=>monthStats[p.id]?.matches>0).length}</span>
            <div class="cnf-stat-label">Joueurs actifs</div>
          </div>
        </div>`;
    } else {
      monthlyEl.innerHTML = '';
    }
  }

  // DÃ©fis en attente sur le dashboard
  const pendingDefis = defis.filter(d=>d.status==='pending'||d.status==='accepted');
  const defisDashEl = document.getElementById('dash-defis-widget');
  if (defisDashEl) {
    if (pendingDefis.length) {
      defisDashEl.innerHTML = `<div style="margin-top:1.2rem">
        <div class="section-label" style="margin-bottom:0.5rem">âš”ï¸ DÃ©fis actifs <span style="background:var(--red);color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;margin-left:4px">${pendingDefis.length}</span></div>
        ${pendingDefis.slice(0,2).map(d=>{
          const fp=players.find(p=>p.id===d.from), tp=players.find(p=>p.id===d.to);
          return `<div class="defi-card ${d.status}" style="margin-bottom:0.5rem">
            <div class="defi-icon">âš”ï¸</div>
            <div class="defi-info"><div class="defi-title" style="font-size:0.8rem">${fp?.pseudo||'?'} vs ${tp?.pseudo||'?'}</div><div class="defi-meta">${d.game}</div></div>
            <button class="btn btn-sm btn-primary" onclick="showPage('defis',null)">Voir â†’</button>
          </div>`;
        }).join('')}
      </div>`;
    } else {
      defisDashEl.innerHTML = '';
    }
  }

  // Hall of Fame + Activity
  renderHallOfFame();
  renderDashActivityChart();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOUEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPlayer() {
  const name = document.getElementById('player-name').value.trim();
  const pseudo = document.getElementById('player-pseudo').value.trim();
  if (!name) { showNotif('âš  Entrez un nom.'); return; }
  requirePassword('ğŸ”’ Ajouter un joueur', () => _doAddPlayer(name, pseudo));
}
function _doAddPlayer(name, pseudo) {
  const pseudoFinal = pseudo || name;
  if (players.find(p => p.pseudo.toLowerCase() === pseudoFinal.toLowerCase())) {
    showNotif('âš  Ce pseudo existe dÃ©jÃ .'); return;
  }
  const p = { id:Date.now(), name, pseudo:pseudoFinal, elo:ELO_START, eloHistory:[ELO_START], peak:ELO_START, trend:0, achievements:[] };
  players.push(p);
  save();
  renderPlayers(); renderSelects();
  document.getElementById('player-name').value = '';
  document.getElementById('player-pseudo').value = '';
  addAudit('ğŸ‘¤', `Joueur ajoutÃ© : ${p.pseudo}`);
  showNotif('âœ“ ' + p.pseudo + ' ajoutÃ© !');
}

function deletePlayer(id) {
  if (!confirm('Supprimer ce joueur et tous ses matchs ?')) return;
  requirePassword('ğŸ”’ Supprimer un joueur', () => _doDeletePlayer(id));
}
function _doDeletePlayer(id) {
  const p = pById(id);
  const savedMatches = matches.filter(m=>m.p1===id||m.p2===id).map(m=>({...m}));
  const savedPlayer = p ? {...p} : null;
  players = players.filter(p=>p.id!==id);
  matches = matches.filter(m=>m.p1!==id&&m.p2!==id);
  addAudit('ğŸ—‘ï¸', `Joueur supprimÃ© : ${p ? p.pseudo : id}`);
  recomputeElo(); save(); renderAll();
  let undone = false;
  showNotifUndo(`Joueur ${p?p.pseudo:''} supprimÃ©`, () => {
    if (!undone) { undone=true; if(savedPlayer) players.push(savedPlayer); savedMatches.forEach(m=>matches.unshift(m)); recomputeElo(); save(); renderAll(); showNotif('âœ“ AnnulÃ©', 'success'); }
  });
}

function renderPlayers() {
  recomputeElo();
  const grid = document.getElementById('players-grid');
  const stats = getStats();
  if (!players.length) {
    grid.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ¯</div><div class="empty-text">Ajoutez votre premier joueur !</div></div>`;
    return;
  }
  grid.innerHTML = players.map(p => {
    const s = stats[p.id] || { wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0 };
    const form = getRecentForm(p.id, 5);
    const streak = getStreak(p.id);
    const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
    const trophies = (p.achievements||[]).map(aid => {
      const a = ACHIEVEMENTS.find(x=>x.id===aid);
      return a ? `<span class="trophy-icon" title="${a.name} : ${a.desc}">${a.icon}</span>` : '';
    }).join('');
    return `
      <div class="pcard" onclick="openProfile(${p.id},event)">
        ${streak ? `<span class="pcard-streak ${streak.type==='W'?'streak-win':'streak-loss'}">${streak.type==='W'?'ğŸ”¥':'ğŸ’€'} ${streak.count}</span>` : ''}
        <div class="pcard-top">
          <div class="pcard-avatar" style="background:linear-gradient(135deg,${p.avatarColor||'var(--accent)'},${p.avatarColor||'var(--accent)'}99);color:#0d0f14;overflow:hidden">${p.avatarPhoto ? `<img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover">` : (p.avatarEmoji||getInitials(p.name))}</div>
          <div class="pcard-info">
            <div class="pcard-pseudo">${p.pseudo} ${divisionBadge(p.elo)}</div>
            <div class="pcard-name">${p.name}${p.surnom?' Â· <em style="color:var(--accent);font-style:italic">'+p.surnom+'</em>':''}</div>
          </div>
          <button class="pcard-del" onclick="event.stopPropagation();deletePlayer(${p.id})">âœ•</button>
        </div>
        <div class="pcard-elo-row">
          <div class="pcard-elo">${p.elo} ${trendBadge(p.trend)}</div>
          <div class="pcard-peak"><div>PEAK</div><div><span>${p.peak||p.elo}</span></div></div>
        </div>
        ${divisionProgressBar(p.elo||1000)}
        <div class="pcard-sparkline">${sparkline(p.eloHistory,210,28)}</div>
        <div class="pcard-form">${form.length ? formDots(form) : `<span style="font-size:0.72rem;color:var(--muted)">Pas encore jouÃ©</span>`}</div>
        <div class="pcard-stats">
          <div class="pstat"><div class="pstat-val">${s.matches}</div><div class="pstat-lbl">Matchs</div></div>
          <div class="pstat"><div class="pstat-val" style="color:var(--green)">${s.wins}V</div><div class="pstat-lbl">Victoires</div></div>
          <div class="pstat"><div class="pstat-val" style="color:var(--accent)">${pct}%</div><div class="pstat-lbl">% Vic.</div></div>
        </div>
        ${trophies ? `<div class="pcard-trophies">${trophies}</div>` : ''}
        ${renderPlayerGoalProgress(p)}
        <div style="display:flex;gap:0.4rem;margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border)" onclick="event.stopPropagation()">
          <button class="btn btn-sm btn-secondary" style="flex:1;font-size:0.6rem" onclick="event.stopPropagation();openPlayerFull(${p.id})">ğŸ‘¤ Fiche</button>
          <button class="btn btn-sm btn-secondary" style="flex:1;font-size:0.6rem" onclick="openPlayerGoalsModal(${p.id})" title="Objectifs personnels">ğŸ¯ Objectifs</button>
          <button class="btn btn-sm btn-secondary" style="flex:1;font-size:0.6rem" onclick="renderDoubleStatsModal(${p.id})" title="Statistiques checkouts">ğŸ“Š Checkouts</button>
        </div>
      </div>`;
  }).join('');
}

function renderSelects() {
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  ['match-p1','match-p2','soiree-p1','soiree-p2','stats-player-select'].forEach(id => {
    const el = document.getElementById(id); if (el) el.innerHTML = opts;
  });
}

function renderRadarPlayerSelect() {
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  const el = document.getElementById('radar-player-select');
  if (el) el.innerHTML = opts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATCHS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMatch(p1Override, p2Override, s1Override, s2Override) {
  const p1 = p1Override || parseInt(document.getElementById('match-p1').value);
  const p2 = p2Override || parseInt(document.getElementById('match-p2').value);
  const s1 = s1Override !== undefined ? s1Override : (parseInt(document.getElementById('match-s1').value)||0);
  const s2 = s2Override !== undefined ? s2Override : (parseInt(document.getElementById('match-s2').value)||0);
  if (!p1||!p2) { showNotif('âš  SÃ©lectionnez les deux joueurs.'); return false; }
  if (p1===p2)  { showNotif('âš  Choisissez deux joueurs diffÃ©rents.'); return false; }
  if (s1 < 0 || s2 < 0) { showNotif('âš  Les scores ne peuvent pas Ãªtre nÃ©gatifs.'); return false; }
  const fmt = !p1Override && document.getElementById('match-format') ? document.getElementById('match-format').value : 'sets';
  const winner = s1>s2 ? p1 : s2>s1 ? p2 : null;
  // Stats avancÃ©es (saisie manuelle seulement)
  let advStats = {};
  if (!p1Override) {
    const avg1 = parseFloat(document.getElementById('match-avg1')?.value) || 0;
    const avg2 = parseFloat(document.getElementById('match-avg2')?.value) || 0;
    const darts1 = parseInt(document.getElementById('match-darts1')?.value) || 0;
    const darts2 = parseInt(document.getElementById('match-darts2')?.value) || 0;
    const s180_1 = parseInt(document.getElementById('match-180s1')?.value) || 0;
    const s180_2 = parseInt(document.getElementById('match-180s2')?.value) || 0;
    const coHit1 = parseInt(document.getElementById('match-co1-hit')?.value) || 0;
    const coAtt1 = parseInt(document.getElementById('match-co1-att')?.value) || 0;
    const coHit2 = parseInt(document.getElementById('match-co2-hit')?.value) || 0;
    const coAtt2 = parseInt(document.getElementById('match-co2-att')?.value) || 0;
    if (avg1 > 0) advStats.avg1 = avg1;
    if (avg2 > 0) advStats.avg2 = avg2;
    if (darts1 > 0) advStats.darts1 = darts1;
    if (darts2 > 0) advStats.darts2 = darts2;
    if (s180_1 > 0) advStats.m180s1 = s180_1;
    if (s180_2 > 0) advStats.m180s2 = s180_2;
    if (coHit1 > 0 || coAtt1 > 0) { advStats.checkout1 = coHit1; advStats.checkoutAttempts1 = coAtt1 || coHit1; }
    if (coHit2 > 0 || coAtt2 > 0) { advStats.checkout2 = coHit2; advStats.checkoutAttempts2 = coAtt2 || coHit2; }
    // Mettre Ã  jour les stats globales du joueur (180s depuis match manuel)
    if (s180_1 > 0) { const pp1 = pById(p1); if (pp1) pp1.total180s = (pp1.total180s||0) + s180_1; }
    if (s180_2 > 0) { const pp2 = pById(p2); if (pp2) pp2.total180s = (pp2.total180s||0) + s180_2; }
  }
  matches.unshift({ id:Date.now(), p1, p2, s1, s2, winner, format:fmt, date:new Date().toLocaleDateString('fr-FR'), eloChange1:0, eloChange2:0, ...advStats });
  _eloVersion++;
  // Flag players to detect new records during recompute
  const pp1 = pById(p1), pp2 = pById(p2);
  const prevPeak1 = pp1?.peak || 0, prevPeak2 = pp2?.peak || 0;
  if (pp1) pp1._notifyRecord = true;
  if (pp2) pp2._notifyRecord = true;
  recomputeElo();
  // Check for new ELO records
  if (pp1?._newRecord) { pp1._newRecord = false; showNotif(`ğŸš€ Nouveau record ELO pour ${pp1.pseudo} ! (${pp1.peak})`,'success'); confetti(); }
  if (pp2?._newRecord) { pp2._newRecord = false; setTimeout(()=>{ showNotif(`ğŸš€ Nouveau record ELO pour ${pp2.pseudo} ! (${pp2.peak})`,'success'); if(!pp1?._newRecord) confetti(); }, 300); }
  if (pp1) pp1._notifyRecord = false;
  if (pp2) pp2._notifyRecord = false;
  checkAchievements();
  checkAndUpdateDivisions();
  save(); renderAll();
  if (!p1Override) {
    document.getElementById('match-s1').value = '';
    document.getElementById('match-s2').value = '';
    document.getElementById('match-p1').value = '';
    document.getElementById('match-p2').value = '';
    // Vider les champs stats avancÃ©es
    ['match-avg1','match-avg2','match-darts1','match-darts2','match-180s1','match-180s2','match-co1-hit','match-co1-att','match-co2-hit','match-co2-att'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    const csBox = document.getElementById('checkout-suggestion-box');
    if (csBox) csBox.style.display = 'none';
  }
  const wName = winner ? pName(winner) : null;
  addAudit('ğŸ¯', `Match : ${pName(p1)} ${s1}â€“${s2} ${pName(p2)}${wName?' (ğŸ† '+wName+')':' (Ã‰galitÃ©)'}`);
  if (winner) { showNotif(`ğŸ† Victoire de ${pName(winner)} !`); confetti(); }
  else showNotif('âœ“ Match enregistrÃ© â€” Ã‰galitÃ© !');
  // Auto-refresh TV mode if open
  if (document.getElementById('tv-overlay')?.classList.contains('active')) renderTvMode();
  return true;
}

function deleteMatch(id) {
  const m = matches.find(x=>x.id===id);
  if (!m) return;
  const idx = matches.indexOf(m);
  matches.splice(idx, 1);
  _eloVersion++;
  addAudit('ğŸ—‘ï¸', `Match supprimÃ© : ${pName(m.p1)} vs ${pName(m.p2)}`);
  recomputeElo(); save(); renderAll();
  let undone = false;
  showNotifUndo(`Match ${pName(m.p1)} ${m.s1}-${m.s2} ${pName(m.p2)} supprimÃ©`, () => {
    if (!undone) { undone=true; matches.splice(Math.min(idx, matches.length), 0, m); recomputeElo(); save(); renderAll(); showNotif('âœ“ AnnulÃ©', 'success'); }
  });
}

// IntÃ©grer un match de tournoi dans le classement gÃ©nÃ©ral
function addTournamentMatchToRanking(p1id, p2id, s1, s2, tournamentName, tournamentDate) {
  if (!p1id || !p2id) return;
  // Avoid double-adding (check if same tournament match already exists)
  const exists = matches.some(m => m.source === 'tournoi' && m.p1 === p1id && m.p2 === p2id
    && m.s1 === s1 && m.s2 === s2 && m.tournamentName === tournamentName);
  if (exists) return;
  const id = Date.now() + Math.random();
  const m = {
    id, p1: p1id, p2: p2id, s1, s2,
    winner: s1 > s2 ? p1id : s2 > s1 ? p2id : null,
    date: tournamentDate || new Date().toISOString().slice(0,10),
    format: 'sets', source: 'tournoi', tournamentName,
    eloChange1: 0, eloChange2: 0
  };
  matches.push(m);
  recomputeElo();
}

function editMatch(id) {
  const m = matches.find(x=>x.id===id);
  if (!m) return;
  const modal = document.getElementById('edit-match-modal');
  document.getElementById('edit-match-id').value = id;
  document.getElementById('edit-match-s1').value = m.s1;
  document.getElementById('edit-match-s2').value = m.s2;
  document.getElementById('edit-match-date').value = m.date || '';
  document.getElementById('edit-match-avg1').value = m.avg1 || '';
  document.getElementById('edit-match-avg2').value = m.avg2 || '';
  document.getElementById('edit-match-p1-name').textContent = pName(m.p1);
  document.getElementById('edit-match-p2-name').textContent = pName(m.p2);
  modal.classList.add('active');
}

function saveEditMatch() {
  const id = parseInt(document.getElementById('edit-match-id').value);
  const m = matches.find(x=>x.id===id);
  if (!m) return;
  const s1 = parseInt(document.getElementById('edit-match-s1').value);
  const s2 = parseInt(document.getElementById('edit-match-s2').value);
  const date = document.getElementById('edit-match-date').value;
  const avg1 = parseFloat(document.getElementById('edit-match-avg1').value) || null;
  const avg2 = parseFloat(document.getElementById('edit-match-avg2').value) || null;
  if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0) { showNotif('âš  Scores invalides'); return; }
  m.s1 = s1; m.s2 = s2;
  if (date) m.date = date;
  if (avg1) m.avg1 = avg1; if (avg2) m.avg2 = avg2;
  // Recalculate winner
  if (s1 > s2) m.winner = m.p1; else if (s2 > s1) m.winner = m.p2; else m.winner = null;
  addAudit('âœï¸', `Match modifiÃ© : ${pName(m.p1)} ${s1}-${s2} ${pName(m.p2)}`);
  recomputeElo(); save(); renderAll();
  closeModal('edit-match-modal');
  showNotif('âœ“ Match modifiÃ©', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHECKOUT SUGGESTIONS PROFESSIONNELLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHECKOUT_TABLE = {
  170:'T20 T20 Bull', 167:'T20 T19 Bull', 164:'T20 T18 Bull', 161:'T20 T17 Bull',
  160:'T20 T20 D20', 158:'T20 T20 D19', 157:'T20 T19 D20', 156:'T20 T20 D18',
  155:'T20 T19 D19', 154:'T20 T18 D20', 153:'T20 T19 D18', 152:'T20 T20 D16',
  151:'T20 T17 D20', 150:'T20 T18 D18', 149:'T20 T19 D16', 148:'T20 T20 D14',
  147:'T20 T17 D18', 146:'T20 T18 D16', 145:'T20 T15 D20', 144:'T20 T20 D12',
  143:'T20 T17 D16', 142:'T20 T14 D20', 141:'T20 T15 D18', 140:'T20 T20 D10',
  139:'T20 T13 D20', 138:'T20 T14 D18', 137:'T20 T15 D16', 136:'T20 T20 D8',
  135:'T20 T15 D15', 134:'T20 T14 D16', 133:'T20 T11 D20', 132:'T20 T16 D12',
  131:'T20 T13 D16', 130:'T20 T18 D8', 129:'T19 T16 D12', 128:'T18 T14 D16',
  127:'T20 T17 D8', 126:'T19 T19 D6', 125:'T20 T15 D10', 124:'T20 T16 D8',
  123:'T19 T16 D9', 122:'T18 T18 D7', 121:'T20 T11 D14', 120:'T20 S20 D20',
  119:'T19 T10 D16', 118:'T20 S18 D20', 117:'T20 S17 D20', 116:'T20 T16 D4',
  115:'T20 S15 D20', 114:'T20 S14 D20', 113:'T20 S13 D20', 112:'T20 S12 D20',
  111:'T20 S11 D20', 110:'T20 S10 D20', 109:'T20 S9 D20',  108:'T20 S8 D20',
  107:'T19 S10 D20', 106:'T20 S6 D20',  105:'T20 S5 D20',  104:'T20 S4 D20',
  103:'T20 S3 D20',  102:'T20 S2 D20',  101:'T17 T10 D10', 100:'T20 D20',
  99: 'T19 T10 D6',  98: 'T20 D19',     97: 'T19 D20',     96: 'T20 D18',
  95: 'T19 D19',     94: 'T18 D20',     93: 'T19 D18',     92: 'T20 D16',
  91: 'T17 D20',     90: 'T18 D18',     89: 'T19 D16',     88: 'T20 D14',
  87: 'T17 D18',     86: 'T18 D16',     85: 'T15 D20',     84: 'T20 D12',
  83: 'T17 D16',     82: 'T14 D20',     81: 'T19 D12',     80: 'T20 D10',
  79: 'T13 D20',     78: 'T18 D12',     77: 'T15 D16',     76: 'T20 D8',
  75: 'T15 D15',     74: 'T14 D16',     73: 'T19 D8',       72: 'T16 D12',
  71: 'T13 D16',     70: 'T10 D20',     69: 'T15 D12',     68: 'T20 D4',
  67: 'T17 D8',      66: 'T10 D18',     65: 'T15 D10',     64: 'T16 D8',
  63: 'T13 D12',     62: 'T10 D16',     61: 'T15 D8',      60: 'S20 D20',
  59: 'S19 D20',     58: 'S18 D20',     57: 'S17 D20',     56: 'S16 D20',
  55: 'S15 D20',     54: 'S14 D20',     53: 'S13 D20',     52: 'S12 D20',
  51: 'S11 D20',     50: 'Bull',        40: 'D20',          36: 'D18',
  32: 'D16',         28: 'D14',         24: 'D12',          20: 'D10',
  16: 'D8',          12: 'D6',          8: 'D4',            4: 'D2',
  2:  'D1'
};

function getCheckoutSuggestion(score) {
  if (score < 2 || score > 170) return null;
  if (CHECKOUT_TABLE[score]) return CHECKOUT_TABLE[score];
  // Calcul dynamique pour les scores non couverts
  if (score <= 40 && score % 2 === 0) return `D${score/2}`;
  return null;
}

function updateCheckoutSuggestion() {
  const fmt = document.getElementById('match-format')?.value;
  if (fmt !== '501' && fmt !== '301') { 
    const b = document.getElementById('checkout-suggestion-box'); 
    if (b) b.style.display = 'none'; return; 
  }
  // On ne peut pas savoir le score restant dans la saisie manuelle (pas de score live)
  // Afficher juste un rappel des checkouts importants si le score total suggÃ¨re une fin proche
  const s1 = parseInt(document.getElementById('match-s1')?.value) || 0;
  const s2 = parseInt(document.getElementById('match-s2')?.value) || 0;
  const box = document.getElementById('checkout-suggestion-box');
  if (!box) return;
  if (s1 > 0 || s2 > 0) {
    box.style.display = 'block';
    document.getElementById('checkout-suggestion-text').innerHTML = 
      'T20+T20+Bull=<strong>170</strong> Â· T20+T19+Bull=<strong>167</strong> Â· T20+T20+D20=<strong>160</strong> Â· T20+D20=<strong>100</strong> Â· D20=<strong>40</strong>';
  } else {
    box.style.display = 'none';
  }
}

function updateMatchLabels() {
  const p1id = parseInt(document.getElementById('match-p1')?.value);
  const p2id = parseInt(document.getElementById('match-p2')?.value);
  const p1 = pById(p1id), p2 = pById(p2id);
  const l1 = document.getElementById('avg1-label');
  const l2 = document.getElementById('avg2-label');
  if (l1) l1.textContent = p1 ? `Moy. ${p1.pseudo} (3D)` : 'Moy. J1 (3D)';
  if (l2) l2.textContent = p2 ? `Moy. ${p2.pseudo} (3D)` : 'Moy. J2 (3D)';
}
function renderMatchFilters() {
  const el = document.getElementById('match-filters');
  if (!players.length) { el.innerHTML=''; return; }
  const btns = `<button class="filter-btn ${matchFilter===null?'active':''}" onclick="setMatchFilter(null,this)">Tous</button>`
    + players.map(p=>`<button class="filter-btn ${matchFilter===p.id?'active':''}" onclick="setMatchFilter(${p.id},this)">${p.pseudo}</button>`).join('');
  el.innerHTML = btns;
}
function setMatchFilter(id, el) {
  matchFilter = id;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderMatches();
}

function calcCheckout(val) {
  const score = parseInt(val);
  const el = document.getElementById('co-calc-result');
  if (!el) return;
  if (!score || score < 2 || score > 170) {
    el.innerHTML = '<span style="font-size:0.78rem;color:var(--muted)">Entrez un score entre 2 et 170</span>';
    return;
  }
  const suggestion = getCheckoutSuggestion(score);
  if (suggestion) {
    const darts = suggestion.split(' ');
    const dartHtml = darts.map(d => {
      const col = d.startsWith('T') ? 'var(--red)' : d.startsWith('D') ? 'var(--green)' : d === 'Bull' ? 'var(--accent)' : 'var(--text-dim)';
      return `<span style="background:${col}22;border:1px solid ${col}55;color:${col};border-radius:6px;padding:0.3rem 0.6rem;font-family:'DM Mono',monospace;font-weight:700;font-size:0.9rem">${d}</span>`;
    }).join('<span style="color:var(--muted);margin:0 4px;font-size:1rem">â†’</span>');
    el.innerHTML = `<div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">${dartHtml}</div><div style="font-size:0.65rem;color:var(--muted);margin-top:6px">${darts.length} flÃ©chette${darts.length>1?'s':''} nÃ©cessaire${darts.length>1?'s':''}</div>`;
  } else {
    el.innerHTML = `<span style="font-size:0.78rem;color:var(--red)">âŒ Ce score ne peut pas Ãªtre terminÃ© directement (impair ou > 170)</span>`;
  }
}

function renderMatches() {
  const list = document.getElementById('match-list');
  const filtered = matchFilter ? matches.filter(m=>m.p1===matchFilter||m.p2===matchFilter) : matches;
  if (!filtered.length) { list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Aucun match.</div></div>`; return; }
  list.innerHTML = filtered.map(m => {
    const e1=m.eloChange1||0, e2=m.eloChange2||0;
    const wn = m.winner ? pName(m.winner) : null;
    const avgBadge = (m.avg1 || m.avg2) ? `<span class="mc-badge" style="background:rgba(166,124,247,0.12);color:var(--purple);border:1px solid rgba(166,124,247,0.3);font-size:0.6rem">ğŸ“Š ${m.avg1||'?'} / ${m.avg2||'?'}</span>` : '';
    const dartsBadge = m.darts1 ? `<span class="mc-badge" style="background:rgba(74,158,255,0.1);color:var(--blue);border:1px solid rgba(74,158,255,0.3);font-size:0.6rem">ğŸ¯ ${m.darts1||'?'}/${m.darts2||'?'} darts</span>` : '';
    const co1 = m.checkoutAttempts1 > 0 ? Math.round((m.checkout1||0)/m.checkoutAttempts1*100)+'%' : null;
    const co2 = m.checkoutAttempts2 > 0 ? Math.round((m.checkout2||0)/m.checkoutAttempts2*100)+'%' : null;
    const coBadge = (co1||co2) ? `<span class="mc-badge" style="background:rgba(52,212,123,0.1);color:var(--green);border:1px solid rgba(52,212,123,0.3);font-size:0.6rem">ğŸ¯ CO: ${co1||'?'} / ${co2||'?'}</span>` : '';
    return `<div class="mcard">
      <div class="mcard-top">
        <span class="mc-date">${m.date}</span>
        <div class="mc-players">
          <span class="${m.winner===m.p1?'mc-winner':'mc-loser'}">${pName(m.p1)}</span>
          <span style="color:var(--border)"> vs </span>
          <span class="${m.winner===m.p2?'mc-winner':'mc-loser'}">${pName(m.p2)}</span>
        </div>
        <div class="mc-score">${m.s1}â€“${m.s2}</div>
        ${wn ? `<span class="mc-badge" style="background:var(--gold-bg);color:var(--accent);border:1px solid rgba(230, 57, 70, 0.35)">ğŸ† ${wn}</span>`:`<span class="mc-badge" style="background:var(--surface2);color:var(--muted);border:1px solid var(--border)">Ã‰galitÃ©</span>`}
        <span class="mc-elo ${e1>=0?'elo-p':'elo-n'}">${pName(m.p1)} ${e1>=0?'+':''}${e1}</span>
        <span class="mc-elo ${e2>=0?'elo-p':'elo-n'}">${pName(m.p2)} ${e2>=0?'+':''}${e2}</span>
        ${m.format&&m.format!=='sets'?`<span class="mc-badge" style="background:rgba(74,158,255,0.12);color:var(--blue);border:1px solid rgba(74,158,255,0.3);font-size:0.6rem">${m.format.toUpperCase()}</span>`:''}
        ${m.source==='compteur'?`<span class="mc-badge" style="background:rgba(166,124,247,0.12);color:var(--purple);border:1px solid rgba(166,124,247,0.3);font-size:0.6rem">ğŸ¯ ${m.game||'Compteur'}</span>`:''}
        ${avgBadge}${dartsBadge}${coBadge}
        ${m.tags&&m.tags.length ? m.tags.map(t=>{const h=MATCH_HIGHLIGHTS.find(x=>x.id===t);return h?`<span class="mc-badge" style="background:rgba(245,197,24,0.1);color:var(--gold);border:1px solid rgba(245,197,24,0.3);font-size:0.6rem">${h.icon} ${h.label}</span>`:''}).join('') : ''}
        ${m.comment ? `<span class="mc-badge" style="background:var(--dark-card);color:var(--muted);border:1px solid var(--border);font-size:0.6rem;font-style:italic">ğŸ’¬ ${m.comment.slice(0,30)}${m.comment.length>30?'...':''}</span>` : ''}
        <button class="mc-del" aria-label="Highlights" onclick="openMatchHighlightModal(${m.id})" style="margin-right:2px;background:rgba(245,197,24,0.1);border-color:rgba(245,197,24,0.3);color:var(--gold)" title="Ajouter highlights/commentaire">â­</button>
        <button class="mc-del" aria-label="Modifier ce match" onclick="editMatch(${m.id})" style="margin-right:2px;background:rgba(74,158,255,0.1);border-color:rgba(74,158,255,0.3);color:var(--blue)">âœï¸</button>
        <button class="mc-del" aria-label="Supprimer ce match" onclick="deleteMatch(${m.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _rankSort = { col: 'elo', dir: -1 }; // -1 = desc, 1 = asc

function setSortRanking(col) {
  if (_rankSort.col === col) _rankSort.dir *= -1;
  else { _rankSort.col = col; _rankSort.dir = -1; }
  // Update icons
  ['name','elo','matches','sets','wins','avg3d','checkout','pct'].forEach(c => {
    const el = document.getElementById('sort-icon-' + c);
    if (el) el.textContent = _rankSort.col === c ? (_rankSort.dir === -1 ? 'â–¼' : 'â–²') : '';
  });
  renderRanking();
}

function renderRanking() {
  recomputeElo();
  const tbody = document.getElementById('ranking-body');
  const stats = getStats();
  if (!players.length) { tbody.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ†</div><div class="empty-text">Pas encore de classement</div></div></td></tr>`; return; }

  const sortedByElo = [...players].sort((a,b)=>b.elo-a.elo);

  // â”€â”€ Podium strip top-3 â”€â”€
  const podEl = document.getElementById('rank-podium-strip');
  if (podEl && sortedByElo.length >= 1) {
    const order = sortedByElo.length >= 3
      ? [sortedByElo[1], sortedByElo[0], sortedByElo[2]]
      : sortedByElo.length === 2
      ? [sortedByElo[1], sortedByElo[0]]
      : [sortedByElo[0]];
    const cls   = ['pod-2','pod-1','pod-3'];
    const medals= ['ğŸ¥ˆ','ğŸ¥‡','ğŸ¥‰'];
    const s     = getStats();
    podEl.style.gridTemplateColumns = sortedByElo.length >= 3 ? '1fr 1.12fr 1fr' : sortedByElo.length === 2 ? '1fr 1.12fr' : '1fr';
    podEl.innerHTML = order.map((p, i) => {
      const idx = order.length === 3 ? i : (i === 0 ? 2 : 0);
      const podCls = order.length >= 3 ? cls[i] : (order.length === 2 ? ['pod-2','pod-1'][i] : 'pod-1');
      const medal  = order.length >= 3 ? medals[i] : (order.length === 2 ? ['ğŸ¥ˆ','ğŸ¥‡'][i] : 'ğŸ¥‡');
      const ps = s[p.id]||{wins:0,losses:0,matches:0};
      const pct = ps.matches ? Math.round(ps.wins/ps.matches*100) : 0;
      const color = p.avatarColor || 'var(--accent)';
      const avatarContent = p.avatarPhoto
        ? `<img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover">`
        : (p.avatarEmoji || getInitials(p.name));
      const eloRank = sortedByElo.indexOf(p) + 1;
      return `<div class="rank-pod-card ${podCls}" onclick="openProfile(${p.id},event)">
        <div class="rank-pod-medal">${medal}</div>
        <div class="rank-pod-avatar" style="background:linear-gradient(135deg,${color},${color}99)">${avatarContent}</div>
        <div class="rank-pod-pseudo" title="${p.name}">${p.pseudo}</div>
        <div class="rank-pod-elo">${p.elo}</div>
        <div class="rank-pod-sub">${divisionBadge(p.elo)}</div>
        <div class="rank-pod-sub" style="margin-top:4px">${formDots(getRecentForm(p.id,5))}</div>
        <div class="rank-pod-sub" style="margin-top:3px">${ps.wins}V Â· ${ps.losses}D Â· ${pct}%</div>
      </div>`;
    }).join('');
    podEl.style.display = 'grid';
  } else if (podEl) {
    podEl.style.display = 'none';
  }

  // â”€â”€ Sort â”€â”€
  const sorted = [...players].sort((a, b) => {
    const sa = stats[a.id]||{wins:0,losses:0,matches:0,setsWon:0,setsLost:0,avg3d:0,checkoutPct:0};
    const sb = stats[b.id]||{wins:0,losses:0,matches:0,setsWon:0,setsLost:0,avg3d:0,checkoutPct:0};
    const pctA = sa.matches ? sa.wins/sa.matches : 0;
    const pctB = sb.matches ? sb.wins/sb.matches : 0;
    let va, vb;
    switch(_rankSort.col) {
      case 'name':    va=a.pseudo.toLowerCase(); vb=b.pseudo.toLowerCase(); return _rankSort.dir*(va<vb?-1:1);
      case 'elo':     va=a.elo; vb=b.elo; break;
      case 'matches': va=sa.matches; vb=sb.matches; break;
      case 'sets':    va=sa.setsWon-sa.setsLost; vb=sb.setsWon-sb.setsLost; break;
      case 'wins':    va=sa.wins; vb=sb.wins; break;
      case 'avg3d':   va=sa.avg3d; vb=sb.avg3d; break;
      case 'checkout':va=sa.checkoutPct; vb=sb.checkoutPct; break;
      case 'pct':     va=pctA; vb=pctB; break;
      default:        va=a.elo; vb=b.elo;
    }
    return _rankSort.dir*(vb-va);
  });

  const maxElo = sortedByElo[0].elo;
  const minElo = sortedByElo[sortedByElo.length-1].elo;

  tbody.innerHTML = sorted.map((p) => {
    const s = stats[p.id]||{wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0,avg3d:0,checkoutPct:0,dpl:0};
    const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
    const eloRank = sortedByElo.indexOf(p);
    const rc = eloRank===0?'rank-1':eloRank===1?'rank-2':eloRank===2?'rank-3':'';
    const eloBar = maxElo>minElo ? Math.round((p.elo-minElo)/(maxElo-minElo)*100) : 100;
    const color = p.avatarColor || 'var(--accent)';
    const avatarMini = p.avatarPhoto
      ? `<div style="width:32px;height:32px;border-radius:7px;overflow:hidden;flex-shrink:0"><img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover"></div>`
      : `<div style="width:32px;height:32px;border-radius:7px;background:linear-gradient(135deg,${color},${color}88);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:800;color:#0d0f14;flex-shrink:0">${p.avatarEmoji||getInitials(p.name)}</div>`;
    const setsDiff = s.setsWon - s.setsLost;
    return `<tr class="${rc}" onclick="openProfile(${p.id},event)" style="cursor:pointer">
      <td class="r-num">${eloRank===0?'ğŸ¥‡':eloRank===1?'ğŸ¥ˆ':eloRank===2?'ğŸ¥‰':`<span style="color:var(--gray)">${eloRank+1}</span>`}</td>
      <td>
        <div style="display:flex;align-items:center;gap:0.6rem">
          ${avatarMini}
          <div>
            <div style="font-size:0.85rem;font-weight:700;line-height:1.2">${p.pseudo} ${divisionBadge(p.elo)}</div>
            <div style="font-size:0.63rem;color:var(--muted)">${p.name}${p.surnom ? ` Â· <em>"${p.surnom}"</em>` : ''}</div>
          </div>
        </div>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:5px">
          <span class="r-elo">${p.elo}</span>${trendBadge(p.trend)}
        </div>
        <div class="r-bar-bg"><div class="r-bar" style="width:${eloBar}%"></div></div>
      </td>
      <td><div style="display:flex;gap:2px;flex-wrap:nowrap">${formDots(getRecentForm(p.id,5))}</div></td>
      <td style="font-weight:700;text-align:center;color:var(--light)">${s.matches}</td>
      <td>
        <span class="wl-win">${s.wins}V</span>
        <span style="color:var(--border2);margin:0 2px">/</span>
        <span class="wl-loss">${s.losses}D</span>
      </td>
      <td>
        <span style="color:${setsDiff>0?'var(--green)':setsDiff<0?'var(--red)':'var(--muted)'}">
          ${setsDiff>0?'+':''}${setsDiff}
        </span>
        <span style="font-size:0.65rem;color:var(--muted);margin-left:3px">(${s.setsWon}:${s.setsLost})</span>
      </td>
      <td>${s.avg3d > 0 ? `<span style="font-family:'DM Mono',monospace;font-weight:700;color:var(--purple)">${s.avg3d}</span>` : '<span style="color:var(--muted);font-size:0.72rem">â€”</span>'}</td>
      <td>${s.checkoutPct > 0 ? `<span style="font-family:'DM Mono',monospace;font-weight:700;color:var(--green)">${s.checkoutPct}%</span>` : '<span style="color:var(--muted);font-size:0.72rem">â€”</span>'}</td>
      <td>
        <div style="display:flex;align-items:center;gap:5px">
          <div class="r-bar-bg" style="width:48px"><div class="r-bar" style="width:${pct}%;background:var(--green)"></div></div>
          <span style="font-size:0.72rem;color:var(--muted);min-width:26px">${pct}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderH2HSelects() {
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  ['h2h-p1','h2h-p2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=opts; });
}
function renderH2H() {
  const id1=parseInt(document.getElementById('h2h-p1').value);
  const id2=parseInt(document.getElementById('h2h-p2').value);
  const box=document.getElementById('h2h-box');
  if (!id1||!id2||id1===id2) { showNotif('âš  Choisissez 2 joueurs diffÃ©rents.'); return; }
  const p1=pById(id1), p2=pById(id2); if (!p1||!p2) return;
  const h2h = matches.filter(m=>(m.p1===id1&&m.p2===id2)||(m.p1===id2&&m.p2===id1));
  const w1=h2h.filter(m=>m.winner===id1).length, w2=h2h.filter(m=>m.winner===id2).length;
  const draws=h2h.filter(m=>!m.winner).length, total=h2h.length;
  const sets1=h2h.reduce((a,m)=>a+(m.p1===id1?m.s1:m.s2),0);
  const sets2=h2h.reduce((a,m)=>a+(m.p1===id2?m.s1:m.s2),0);
  const bar=(v1,v2)=>{const t=v1+v2||1;return`<div class="h2h-prog"><div class="h2h-prog-l" style="width:${v1/t*100}%"></div><div style="flex:1"></div><div class="h2h-prog-r" style="width:${v2/t*100}%"></div></div>`;};
  box.classList.add('visible');
  box.innerHTML = `
    <div class="h2h-names">
      <div class="h2h-player">
        <div class="h2h-avatar" style="background:linear-gradient(135deg,${p1.avatarColor||'var(--accent)'},${p1.avatarColor||'var(--accent)'}99);color:#0d0f14">${p1.avatarEmoji||getInitials(p1.name)}</div>
        <div class="h2h-pseudo">${p1.pseudo}</div>
        <div style="font-family:'Bebas Neue', sans-serif;font-size:0.95rem;color:var(--accent)">${p1.elo}</div>
      </div>
      <div class="h2h-vs">VS</div>
      <div class="h2h-player">
        <div class="h2h-avatar" style="background:linear-gradient(135deg,${p2.avatarColor||'var(--silver)'},${p2.avatarColor||'var(--silver)'}99);color:#0d0f14">${p2.avatarEmoji||getInitials(p2.name)}</div>
        <div class="h2h-pseudo">${p2.pseudo}</div>
        <div style="font-family:'Bebas Neue', sans-serif;font-size:0.95rem;color:var(--silver)">${p2.elo}</div>
      </div>
    </div>
    <div class="h2h-bars">
      <div class="h2h-bar-row"><div class="h2h-val-l">${w1}</div><div class="h2h-stat-lbl">Victoires</div><div class="h2h-val-r">${w2}</div></div>
      ${bar(w1,w2)}
      <div class="h2h-bar-row"><div class="h2h-val-l">${sets1}</div><div class="h2h-stat-lbl">Sets remportÃ©s</div><div class="h2h-val-r">${sets2}</div></div>
      ${bar(sets1,sets2)}
    </div>
    <div style="margin-top:0.8rem;text-align:center;font-size:0.72rem;color:var(--muted)">${total} match${total>1?'s':''} jouÃ©s Â· ${draws} nul${draws>1?'s':''}</div>
    ${total===0?`<div style="text-align:center;margin-top:0.4rem;font-size:0.8rem;color:var(--muted)">Ces joueurs ne se sont jamais affrontÃ©s.</div>`:''}
    ${h2h.length ? `<div style="margin-top:0.9rem;border-top:1px solid var(--border);padding-top:0.8rem">
      ${h2h.slice(0,5).map(m=>`<div class="recent-match"><span class="${m.winner===id1?'rm-winner':'rm-loser'}">${pName(m.p1)}</span><span class="rm-score">${m.s1}â€“${m.s2}</span><span class="${m.winner===id2?'rm-winner':'rm-loser'}">${pName(m.p2)}</span><span class="rm-date">${m.date}</span></div>`).join('')}
    </div>` : ''}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  recomputeElo();
  const stats = getStats();
  renderEloChart();
  renderWinsChart(stats);
  renderHeatmap();
  renderAchievementsGrid(stats);
  renderSelects();
  populateH2HSelects();
  renderMonthlyActivityChart();
  // Populate checkout table
  const coGrid = document.getElementById('co-table-grid');
  if (coGrid && !coGrid.innerHTML) {
    const keyScores = [170,167,160,158,156,152,148,144,140,136,132,130,121,120,110,100,96,91,81,72,62,50,40,32];
    coGrid.innerHTML = keyScores.map(s => {
      const fin = getCheckoutSuggestion(s);
      return fin ? `<div style="display:flex;justify-content:space-between;padding:0.35rem 0.5rem;background:var(--surface2);border-radius:5px;border:1px solid var(--border)"><span style="color:var(--accent);font-family:'DM Mono',monospace;font-weight:700">${s}</span><span style="color:var(--text-dim)">${fin}</span></div>` : '';
    }).join('');
  }
}

function renderEloChart() {
  const ctx = document.getElementById('elo-chart');
  if (!ctx) return;
  if (eloChart) { eloChart.destroy(); eloChart=null; }
  if (!players.length) { ctx.parentElement.innerHTML += `<div class="empty" style="padding:1rem"><div class="empty-icon">ğŸ“ˆ</div><div class="empty-text">Ajoutez des joueurs et des matchs</div></div>`; return; }

  const maxLen = Math.max(...players.map(p=>p.eloHistory.length));
  const datasets = players.map((p,i) => ({
    label: p.pseudo,
    data: p.eloHistory,
    borderColor: pColor(i),
    backgroundColor: pColor(i)+'22',
    borderWidth: 2.5,
    pointRadius: p.eloHistory.length < 20 ? 4 : 2,
    pointHoverRadius: 7,
    tension: 0.35,
    fill: false,
  }));
  eloChart = new Chart(ctx, {
    type:'line',
    data:{ labels: Array.from({length:maxLen},(_,i)=>i===0?'DÃ©part':`M${i}`), datasets },
    options:{
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:false },
        tooltip:{
          backgroundColor:'rgba(13,15,20,0.95)',
          titleColor:'#f0f4fc',
          bodyColor:'#a0aabb',
          borderColor:'#252e40',
          borderWidth:1,
          padding:10,
          callbacks:{
            label: function(ctx) {
              const elo = ctx.raw;
              const prev = ctx.dataIndex > 0 ? ctx.dataset.data[ctx.dataIndex-1] : elo;
              const diff = elo - prev;
              const arrow = diff > 0 ? 'â–²' : diff < 0 ? 'â–¼' : 'â€”';
              return ` ${ctx.dataset.label}: ${elo} ${diff !== 0 ? arrow+' '+(diff>0?'+':'')+diff : ''}`;
            }
          }
        }
      },
      scales:{
        y:{
          grid:{color:'#252e40'},
          ticks:{font:{family:'Work Sans',size:11},color:'#606a80'},
          title:{ display:true, text:'ELO', color:'#606a80', font:{size:10} }
        },
        x:{
          grid:{display:false},
          ticks:{font:{family:'Work Sans',size:10},color:'#606a80', maxTicksLimit:10}
        }
      }
    }
  });

  // Interactive legend â€” click to toggle player
  const legendEl = document.getElementById('elo-chart-legend');
  legendEl.innerHTML = players.map((p,i)=>`
    <span onclick="toggleEloLine(${i})" id="elo-legend-${i}" style="display:flex;align-items:center;gap:4px;font-size:0.7rem;font-weight:600;cursor:pointer;padding:3px 6px;border-radius:5px;transition:opacity .15s" title="Cliquez pour masquer/afficher">
      <span style="width:12px;height:3px;background:${pColor(i)};display:inline-block;border-radius:2px"></span>${p.pseudo}
    </span>`).join('');
}

function toggleEloLine(idx) {
  if (!eloChart) return;
  const meta = eloChart.getDatasetMeta(idx);
  meta.hidden = !meta.hidden;
  eloChart.update();
  const el = document.getElementById('elo-legend-' + idx);
  if (el) el.style.opacity = meta.hidden ? '0.3' : '1';
}

function renderWinsChart(stats) {
  const wCtx = document.getElementById('wins-chart');
  const pCtx = document.getElementById('pct-chart');
  if (!wCtx||!pCtx) return;
  if (winsChart) { winsChart.destroy(); winsChart=null; }
  if (pctChart)  { pctChart.destroy();  pctChart=null; }
  if (!players.length) return;
  const sorted = [...players].sort((a,b)=>b.elo-a.elo);
  const labels = sorted.map(p=>p.pseudo);
  const wins   = sorted.map(p=>(stats[p.id]||{}).wins||0);
  const losses = sorted.map(p=>(stats[p.id]||{}).losses||0);
  const pcts   = sorted.map(p=>{ const s=stats[p.id]||{matches:0,wins:0}; return s.matches ? Math.round(s.wins/s.matches*100):0; });

  winsChart = new Chart(wCtx, {
    type:'bar',
    data:{ labels, datasets:[
      { label:'Victoires', data:wins, backgroundColor:'rgba(52,212,123,0.3)', borderColor:'#34d47b', borderWidth:1 },
      { label:'DÃ©faites', data:losses, backgroundColor:'rgba(240,83,74,0.25)', borderColor:'#f0534a', borderWidth:1 }
    ]},
    options:{ responsive:true, plugins:{legend:{position:'bottom',labels:{font:{family:'Work Sans',size:11},color:'#606a80'}}}, scales:{ y:{grid:{color:'#252e40'}}, x:{grid:{display:false}} } }
  });
  pctChart = new Chart(pCtx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data:pcts, backgroundColor:sorted.map((_,i)=>pColor(i)), borderWidth:2, borderColor:'#131720' }]},
    options:{ responsive:true, plugins:{ legend:{position:'bottom',labels:{font:{family:'Work Sans',size:11},color:'#606a80'}} } }
  });
}

function renderHeatmap() {
  const el = document.getElementById('heatmap');
  if (!el) return;
  if (!players.length) { el.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Pas assez de donnÃ©es</div></div>`; return; }
  const sorted = [...players].sort((a,b)=>b.elo-a.elo);
  let html = `<table class="heatmap-table"><thead><tr><th>â†“ vs â†’</th>${sorted.map(p=>`<th>${p.pseudo}</th>`).join('')}</tr></thead><tbody>`;
  sorted.forEach(p1 => {
    html += `<tr><th>${p1.pseudo}</th>`;
    sorted.forEach(p2 => {
      if (p1.id===p2.id) { html+=`<td class="hm-self">â€”</td>`; return; }
      const h2h = matches.filter(m=>(m.p1===p1.id&&m.p2===p2.id)||(m.p1===p2.id&&m.p2===p1.id));
      const wins = h2h.filter(m=>m.winner===p1.id).length;
      const total = h2h.length;
      if (!total) { html+=`<td class="hm-none">0</td>`; return; }
      const cls = wins > total/2 ? 'hm-win' : wins < total/2 ? 'hm-lose' : 'hm-none';
      html+=`<td class="${cls}" title="${p1.pseudo} vs ${p2.pseudo}: ${wins}/${total}">${wins}/${total}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
}

function renderAchievementsGrid(stats) {
  const el = document.getElementById('achievements-grid');
  if (!el) return;
  recomputeElo();
  el.innerHTML = ACHIEVEMENTS.map(ach => {
    const unlocked = players.filter(p=>(p.achievements||[]).includes(ach.id));
    const isUnlocked = unlocked.length > 0;
    return `<div class="achievement ${isUnlocked?'unlocked':'locked'}">
      <span class="achievement-icon">${ach.icon}</span>
      <div class="achievement-name">${ach.name}</div>
      <div class="achievement-desc">${ach.desc}</div>
      ${isUnlocked ? `<div class="achievement-player">ğŸ… ${unlocked.map(p=>p.pseudo).join(', ')}</div>` : ''}
    </div>`;
  }).join('');
}

function renderPlayerDetail() {
  const pid = parseInt(document.getElementById('stats-player-select').value);
  const el = document.getElementById('player-detail');
  if (!pid) { el.innerHTML=''; return; }
  const p = pById(pid);
  if (!p) return;
  recomputeElo();
  const stats = getStats();
  const s = stats[pid] || { wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0 };
  const pct = s.matches ? Math.round(s.wins/s.matches*100):0;
  const form = getRecentForm(pid,10);
  const h2hData = players.filter(op=>op.id!==pid).map(op => {
    const ms = matches.filter(m=>(m.p1===pid&&m.p2===op.id)||(m.p1===op.id&&m.p2===pid));
    const w=ms.filter(m=>m.winner===pid).length, l=ms.filter(m=>m.winner===op.id).length;
    return { name:op.pseudo, played:ms.length, w, l };
  }).filter(x=>x.played>0).sort((a,b)=>b.played-a.played);

  el.innerHTML = `
    <div class="card">
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.2rem">
        <div style="width:52px;height:52px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:white">${getInitials(p.name)}</div>
        <div>
          <div style="font-size:1.05rem;font-weight:700">${p.pseudo}</div>
          <div style="font-size:0.75rem;color:var(--muted)">${p.name}</div>
        </div>
        <div style="margin-left:auto;font-family:'Bebas Neue', sans-serif;font-size:1.8rem;font-weight:700;color:var(--accent)">${p.elo}</div>
      </div>
      <div class="player-detail-grid">
        <div class="stat-block"><div class="stat-label">Matchs</div><div class="stat-value">${s.matches}</div></div>
        <div class="stat-block"><div class="stat-label">Victoires</div><div class="stat-value" style="color:var(--green)">${s.wins}</div></div>
        <div class="stat-block"><div class="stat-label">DÃ©faites</div><div class="stat-value" style="color:var(--red)">${s.losses}</div></div>
        <div class="stat-block"><div class="stat-label">Nuls</div><div class="stat-value" style="color:var(--muted)">${s.draws}</div></div>
        <div class="stat-block"><div class="stat-label">% Victoires</div><div class="stat-value">${pct}%</div></div>
        <div class="stat-block"><div class="stat-label">Peak ELO</div><div class="stat-value" style="color:var(--gold);font-size:1.4rem">${p.peak||p.elo}</div></div>
        ${s.avg3d > 0 ? `<div class="stat-block" title="Moyenne 3 flÃ©chettes â€” stat clÃ© des pros"><div class="stat-label">âš¡ Moy. 3D</div><div class="stat-value" style="color:var(--purple)">${s.avg3d}</div></div>` : ''}
        ${s.checkoutPct > 0 ? `<div class="stat-block" title="% de checkouts rÃ©ussis (finishes en double out)"><div class="stat-label">ğŸ¯ % Checkout</div><div class="stat-value" style="color:var(--green)">${s.checkoutPct}%</div></div>` : ''}
        ${s.dpl > 0 ? `<div class="stat-block" title="Dards par leg (flÃ©chettes moyennes pour fermer un leg)"><div class="stat-label">ğŸ² Dards/leg</div><div class="stat-value" style="color:var(--blue)">${s.dpl}</div></div>` : ''}
        ${p.total180s ? `<div class="stat-block"><div class="stat-label">Ã— 180</div><div class="stat-value" style="color:var(--accent)">${p.total180s}</div></div>` : ''}
        ${p.bestVisit ? `<div class="stat-block"><div class="stat-label">Meilleure volÃ©e</div><div class="stat-value" style="color:var(--blue)">${p.bestVisit}</div></div>` : ''}
        ${p.totalCheckouts ? `<div class="stat-block"><div class="stat-label">Checkouts (compteur)</div><div class="stat-value" style="color:var(--green)">${p.totalCheckouts}</div></div>` : ''}
      </div>
      <div style="margin-bottom:0.8rem">
        <div class="section-label" style="margin-bottom:0.5rem">Ã‰volution ELO</div>
        ${sparkline(p.eloHistory,400,50)}
      </div>
      <div style="margin-bottom:0.8rem">
        <div class="section-label" style="margin-bottom:0.5rem">Forme rÃ©cente (10 matchs)</div>
        <div style="display:flex;gap:3px">${form.length ? formDots(form) : '<span style="font-size:0.75rem;color:var(--muted)">Pas encore jouÃ©</span>'}</div>
      </div>
      ${h2hData.length ? `
      <div>
        <div class="section-label" style="margin-bottom:0.5rem">Bilan contre chaque adversaire</div>
        <div style="display:flex;flex-direction:column;gap:0.3rem">
          ${h2hData.map(x=>`
            <div style="display:flex;align-items:center;gap:0.7rem;font-size:0.8rem;padding:0.35rem 0.6rem;background:var(--surface2);border-radius:6px">
              <span style="flex:1;font-weight:600">${x.name}</span>
              <span style="color:var(--green);font-weight:700">${x.w}V</span>
              <span style="color:var(--muted)">/</span>
              <span style="color:var(--red);font-weight:700">${x.l}D</span>
              <span style="color:var(--muted);font-size:0.68rem">${x.played} matchs</span>
            </div>`).join('')}
        </div>
      </div>` : ''}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOURNOIS â€” SYSTÃˆME COMPLET (Format FFD France)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _scoreModalCtx = null; // contexte du modal de saisie de score

// â”€â”€ HELPERS FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectTFormat(el, fmt) {
  document.querySelectorAll('.t-format-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('t-format').value = fmt;
  document.getElementById('t-options-poules').style.display = (fmt === 'poules_rr') ? 'flex' : 'none';
}

function selectAllTPlayers(val) {
  document.querySelectorAll('#t-players-checkboxes input[type=checkbox]').forEach(cb => cb.checked = val);
  updateTPlayerCount();
}

function updateTPlayerCount() {
  const n = document.querySelectorAll('#t-players-checkboxes input:checked').length;
  const el = document.getElementById('t-player-count');
  if (el) el.textContent = `${n} sÃ©lectionnÃ©(s)`;
}

function onFormatChange() {} // compat ancienne version

function openCreateTournoi() {
  const checks = document.getElementById('t-players-checkboxes');
  checks.innerHTML = players.map(p => `<label class="presence-chip" style="gap:4px;font-size:0.78rem" onclick="updateTPlayerCount()">
    <input type="checkbox" value="${p.id}" style="width:auto;padding:0;margin:0;flex-shrink:0"> ${p.pseudo}
  </label>`).join('');
  // Reset format
  document.querySelectorAll('.t-format-card').forEach(c => c.classList.remove('selected'));
  const first = document.querySelector('.t-format-card[data-fmt="poules_rr"]');
  if (first) first.classList.add('selected');
  document.getElementById('t-format').value = 'poules_rr';
  document.getElementById('t-options-poules').style.display = 'flex';
  // Date par dÃ©faut
  const dateEl = document.getElementById('t-date');
  if (dateEl && !dateEl.value) dateEl.valueAsDate = new Date();
  updateTPlayerCount();
  openModal('create-tournoi-modal');
}

// â”€â”€ CRÃ‰ATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createTournoi() {
  const name = document.getElementById('t-name').value.trim();
  if (!name) { showNotif('âš  Entrez un nom de tournoi.'); return; }
  const format = document.getElementById('t-format').value;
  const selected = [...document.querySelectorAll('#t-players-checkboxes input:checked')].map(x => parseInt(x.value));
  if (selected.length < 2) { showNotif('âš  SÃ©lectionnez au moins 2 joueurs.'); return; }
  const jeu = document.getElementById('t-jeu').value;
  const legs = document.getElementById('t-legs').value;
  const seeding = document.getElementById('t-seeding').value;
  const date = document.getElementById('t-date').value;
  const lieu = document.getElementById('t-lieu').value.trim();

  // Trier joueurs selon seeding
  let seeded = [...selected];
  if (seeding === 'elo') seeded.sort((a,b) => (pById(b)?.elo||1000) - (pById(a)?.elo||1000));
  else seeded.sort(() => Math.random() - 0.5);

  let t;
  if (format === 'poules_rr') {
    const poolSize = parseInt(document.getElementById('t-pool-size').value) || 4;
    const qualPerPool = parseInt(document.getElementById('t-qualifies').value) || 2;
    if (selected.length < 3) { showNotif('âš  Minimum 3 joueurs.'); return; }
    t = createPoules(name, seeded, poolSize, qualPerPool, jeu, legs);
  } else if (format === 'elimination') {
    t = createElimination(name, seeded, jeu, legs);
  } else {
    t = createRoundRobin(name, seeded, jeu, legs);
  }
  t.date = date; t.lieu = lieu; t.seeding = seeding;
  tournois.unshift(t);
  addAudit('ğŸ†', `Tournoi crÃ©Ã© : ${name} (${format}, ${selected.length} joueurs)`);
  save();
  closeModal('create-tournoi-modal');
  document.getElementById('t-name').value = '';
  renderTournois();
  showNotif('âœ“ Tournoi crÃ©Ã© !', 'success');
}

// â”€â”€ FORMAT POULES + TABLEAU (Style FFD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createPoules(name, playerIds, poolSize, qualPerPool, jeu, legs) {
  // RÃ©partition seeding "serpentin" : 1-2-3-4-4-3-2-1...
  const n = playerIds.length;
  const nbPoules = Math.max(1, Math.ceil(n / poolSize));
  const poules = Array.from({length: nbPoules}, (_, i) => ({
    nom: `Poule ${String.fromCharCode(65 + i)}`,
    joueurs: [],
    matches: []
  }));
  // RÃ©partition serpentine
  playerIds.forEach((pid, i) => {
    const row = Math.floor(i / nbPoules);
    const col = row % 2 === 0 ? i % nbPoules : nbPoules - 1 - (i % nbPoules);
    poules[col].joueurs.push(pid);
  });
  // GÃ©nÃ©rer les matchs Round Robin pour chaque poule
  poules.forEach(p => { p.matches = genMatchsPouleRR(p.joueurs); });
  return {
    id: Date.now(), name, format: 'poules_rr', playerIds,
    poules, poolSize, qualPerPool: qualPerPool || 2,
    jeu: jeu || '501', legs: legs || 'BO3',
    tableauFinal: null, status: 'active',
    created: new Date().toLocaleDateString('fr-FR')
  };
}

function genMatchsPouleRR(joueurs) {
  const matches = [];
  let num = 1;
  for (let i = 0; i < joueurs.length; i++) {
    for (let j = i + 1; j < joueurs.length; j++) {
      matches.push({
        id: `M${num++}`, joueur1: joueurs[i], joueur2: joueurs[j],
        score1: 0, score2: 0, gagnant: null, completed: false
      });
    }
  }
  return matches;
}

// Classement d'une poule (style FFD : victoire=2pts, dÃ©faite=1pt, sets/legs en dÃ©part.)
function classementPoule(poule) {
  const stats = {};
  poule.joueurs.forEach(pid => stats[pid] = { pid, pts: 0, v: 0, d: 0, legs_p: 0, legs_c: 0, diff: 0 });
  poule.matches.forEach(m => {
    if (!m.completed) return;
    const s1 = m.score1 || 0, s2 = m.score2 || 0;
    if (!stats[m.joueur1]) stats[m.joueur1] = { pid: m.joueur1, pts: 0, v: 0, d: 0, legs_p: 0, legs_c: 0, diff: 0 };
    if (!stats[m.joueur2]) stats[m.joueur2] = { pid: m.joueur2, pts: 0, v: 0, d: 0, legs_p: 0, legs_c: 0, diff: 0 };
    stats[m.joueur1].legs_p += s1; stats[m.joueur1].legs_c += s2;
    stats[m.joueur2].legs_p += s2; stats[m.joueur2].legs_c += s1;
    stats[m.joueur1].diff += (s1 - s2); stats[m.joueur2].diff += (s2 - s1);
    if (m.gagnant === m.joueur1) {
      stats[m.joueur1].pts += 2; stats[m.joueur1].v++;
      stats[m.joueur2].pts += 1; stats[m.joueur2].d++;
    } else if (m.gagnant === m.joueur2) {
      stats[m.joueur2].pts += 2; stats[m.joueur2].v++;
      stats[m.joueur1].pts += 1; stats[m.joueur1].d++;
    }
  });
  return Object.values(stats).sort((a, b) => b.pts - a.pts || b.diff - a.diff || b.legs_p - a.legs_p);
}

// â”€â”€ RENDER TOURNOIS (liste) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTournois() {
  const el = document.getElementById('tournois-list');
  if (!tournois.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ†</div><div class="empty-text">Aucun tournoi. CrÃ©ez votre premier tournoi !</div></div>`;
    return;
  }
  el.innerHTML = `<div class="t-list-grid">` + tournois.map(t => {
    const { done, total } = getTournoiProgress(t);
    const pct = total ? Math.round(done/total*100) : 0;
    const fmtLabel = { poules_rr:'Poules + Tableau', poules:'Poules + Tableau', elimination:'Ã‰limination', rr:'Round Robin' }[t.format] || t.format;
    const jeuLabel = t.jeu ? ` Â· ${t.jeu}` : '';
    const legsLabel = t.legs ? ` Â· ${t.legs}` : '';
    const winner = t.status === 'finished' ? getTournoiWinner(t) : null;
    return `<div class="t-card-new ${t.status}" onclick="openTournoiDetail(${t.id})">
      <div class="t-card-top">
        <div>
          <div class="t-card-name">${t.name}</div>
          <div class="t-card-sub">${t.date||t.created}${t.lieu ? ' Â· ' + t.lieu : ''}</div>
        </div>
        <span class="tournament-status ${t.status==='active'?'t-active':t.status==='finished'?'t-finished':'t-pending'}">
          ${t.status==='active'?'En cours':t.status==='finished'?'TerminÃ©':'En attente'}
        </span>
      </div>
      <div class="t-card-chips">
        <span class="t-chip accent">${fmtLabel}</span>
        <span class="t-chip">${t.playerIds.length} joueurs</span>
        ${t.jeu ? `<span class="t-chip">${t.jeu}</span>` : ''}
        ${t.legs ? `<span class="t-chip">${t.legs}</span>` : ''}
      </div>
      ${winner ? `<div style="font-size:0.78rem;font-weight:700;color:var(--gold);margin-bottom:0.6rem">ğŸ† Vainqueur : ${winner}</div>` : ''}
      <div class="t-card-progress">
        <div class="t-prog-bar"><div class="t-prog-fill" style="width:${pct}%"></div></div>
        <span style="font-size:0.65rem;color:var(--muted);white-space:nowrap">${done}/${total} matchs</span>
      </div>
      <div class="t-card-actions" onclick="event.stopPropagation()">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="openTournoiDetail(${t.id})">ğŸ“‹ GÃ©rer</button>
        <button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:1px solid rgba(240,83,74,0.3)" onclick="deleteTournoi(${t.id})">âœ•</button>
      </div>
    </div>`;
  }).join('') + `</div>`;
}

function getTournoiProgress(t) {
  let done = 0, total = 0;
  if (t.format === 'poules_rr' || t.format === 'poules') {
    (t.poules||[]).forEach(p => p.matches.forEach(m => { if (!m.isBye) { total++; if (m.completed) done++; } }));
    if (t.tableauFinal) (t.tableauFinal.rounds||[]).forEach(r => r.forEach(m => { if (!m.isBye) { total++; if (m.completed) done++; } }));
  } else if (t.format === 'elimination') {
    done = (t.rounds||[]).flat().filter(m=>m.winner!==null).length;
    total = (t.rounds||[]).flat().length;
  } else {
    done = (t.matches||[]).filter(m=>m.winner!==null||m.s1!==null).length;
    total = (t.matches||[]).length;
  }
  return { done, total };
}

function getTournoiWinner(t) {
  if (t.format === 'elimination') {
    const lastRound = (t.rounds||[]).slice(-1)[0];
    const finale = lastRound && lastRound[0];
    if (finale && finale.winner) return pName(finale.winner);
  } else if (t.format === 'poules_rr' || t.format === 'poules') {
    if (t.tableauFinal) {
      const lastRound = (t.tableauFinal.rounds||[]).slice(-1)[0];
      const finale = lastRound && lastRound[0];
      if (finale && finale.gagnant) return pName(finale.gagnant);
    }
  } else if (t.format === 'rr') {
    const ps = (t.playerIds||[]).map(pById).filter(Boolean);
    const stand = {};
    ps.forEach(p => stand[p.id] = { pts:0,won:0 });
    (t.matches||[]).forEach(m => { if (m.winner) { stand[m.winner].pts+=3; stand[m.winner].won++; } else if (m.s1!==null) { stand[m.p1]&&(stand[m.p1].pts++); stand[m.p2]&&(stand[m.p2].pts++); } });
    const sorted = ps.sort((a,b)=>(stand[b.id]?.pts||0)-(stand[a.id]?.pts||0));
    if (sorted[0]) return sorted[0].pseudo;
  }
  return null;
}

// â”€â”€ DETAIL TOURNOI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openTournoiDetail(id) {
  const t = tournois.find(x => x.id === id); if (!t) return;
  document.getElementById('tournoi-detail-title').textContent = t.name;
  const el = document.getElementById('tournoi-detail-content');
  if (t.format === 'poules_rr' || t.format === 'poules') renderPoulesDetail(t, el);
  else if (t.format === 'elimination') renderElimination(t, el);
  else renderRoundRobinDetail(t, el);
  openModal('tournoi-detail-modal');
}

// â”€â”€ RENDER POULES DETAIL (nouveau) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPoulesDetail(t, el) {
  const jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  const qualPerPool = t.qualPerPool || 2;

  // Header info
  let html = `<div class="t-detail-header">
    <div>
      <div style="font-size:1rem;font-weight:700;margin-bottom:0.3rem">${t.name}</div>
      <div class="t-detail-meta">
        <span class="t-meta-chip highlight">${t.playerIds.length} joueurs</span>
        <span class="t-meta-chip highlight">${t.jeu||'501'} Â· ${t.legs||'BO3'}</span>
        <span class="t-meta-chip">${(t.poules||[]).length} poule(s)</span>
        <span class="t-meta-chip">Top ${qualPerPool} qualifiÃ©s/poule</span>
        ${t.date ? `<span class="t-meta-chip">ğŸ“… ${t.date}</span>` : ''}
        ${t.lieu ? `<span class="t-meta-chip">ğŸ“ ${t.lieu}</span>` : ''}
      </div>
    </div>
  </div>`;

  // Tabs phase
  html += `<div style="display:flex;gap:2px;margin-bottom:1rem;border-bottom:1px solid var(--border);padding-bottom:0">
    <button class="hist-tab active" id="ptab-poules" onclick="setPoulesTab('poules',this,${t.id})">Phase de Poules</button>
    <button class="hist-tab" id="ptab-final" onclick="setPoulesTab('final',this,${t.id})">Tableau Final</button>
  </div>`;

  html += `<div id="poules-phase-${t.id}">` + renderPoulesPhase(t, qualPerPool) + `</div>`;
  html += `<div id="final-phase-${t.id}" style="display:none">` + renderFinalPhase(t) + `</div>`;

  el.innerHTML = html;
}

function setPoulesTab(tab, btn, tid) {
  document.querySelectorAll('.hist-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`poules-phase-${tid}`).style.display = tab === 'poules' ? 'block' : 'none';
  document.getElementById(`final-phase-${tid}`).style.display = tab === 'final' ? 'block' : 'none';
}

function renderPoulesPhase(t, qualPerPool) {
  const poules = t.poules || [];
  let html = `<div class="pool-grid">`;
  poules.forEach((poule, pIdx) => {
    const classement = classementPoule(poule);
    const totalM = poule.matches.length, doneM = poule.matches.filter(m=>m.completed).length;
    html += `<div class="pool-card-pro">
      <div class="pool-card-header">
        <div class="pool-card-name">${poule.nom}</div>
        <div class="pool-card-count">${poule.joueurs.length} joueurs Â· ${doneM}/${totalM} matchs</div>
      </div>`;

    // Classement de la poule
    html += `<table class="pool-standings"><thead><tr><th>#</th><th style="text-align:left">Joueur</th><th title="Points">Pts</th><th title="Victoires">V</th><th title="DÃ©faites">D</th><th title="Legs Pour/Contre">Legs</th></tr></thead><tbody>`;
    classement.forEach((s, rank) => {
      const p = pById(s.pid);
      const qClass = rank < qualPerPool ? (rank === 0 ? 'q1' : 'q2') : '';
      const qBadge = rank < qualPerPool
        ? `<span class="q-badge ${rank===0?'q1':'q2'}">${rank===0?'ğŸ¥‡ 1er':'ğŸ¥ˆ 2e'}</span>`
        : `<span class="q-badge elim">âœ•</span>`;
      html += `<tr class="${qClass}"><td>${rank+1}</td><td>${p?p.pseudo:s.pid} ${qBadge}</td><td style="font-weight:700;color:var(--accent)">${s.pts}</td><td style="color:var(--green)">${s.v}</td><td style="color:var(--red)">${s.d}</td><td style="font-family:'DM Mono',monospace;font-size:0.72rem">${s.legs_p}/${s.legs_c}</td></tr>`;
    });
    html += `</tbody></table>`;

    // Matchs de la poule
    html += `<div style="margin-top:0.8rem"><div class="pool-matches-list">`;
    poule.matches.forEach((m, mIdx) => {
      const p1 = pById(m.joueur1), p2 = pById(m.joueur2);
      const canPlay = !m.completed;
      html += `<div class="pool-match-row ${m.completed?'done':canPlay?'can-play':''}" ${canPlay?`onclick="openScoreModal('poule',${t.id},${pIdx},${mIdx})"`:''}>
        <span class="pmr-num">${m.id||mIdx+1}</span>
        <span class="pmr-p1 ${m.gagnant===m.joueur1?'pmr-winner':m.completed?'pmr-loser':''}">${p1?p1.pseudo:'?'}</span>
        <span class="pmr-score">${m.completed?`${m.score1} â€“ ${m.score2}`:'vs'}</span>
        <span class="pmr-p2 ${m.gagnant===m.joueur2?'pmr-winner':m.completed?'pmr-loser':''}">${p2?p2.pseudo:'?'}</span>
        ${m.completed
          ? `<span class="pmr-status pmr-done">âœ“</span><button class="btn-icon" onclick="event.stopPropagation();annulerMatchPouleRR(${t.id},${pIdx},${mIdx})" title="Annuler">â†º</button>`
          : `<span class="pmr-status pmr-pending">Ã€ jouer</span>`}
      </div>`;
    });
    html += `</div></div>`;

    html += `<div class="pool-actions" style="margin-top:0.8rem">
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="imprimerPouleRR(${t.id},${pIdx})">ğŸ–¨ï¸ Feuilles</button>
    </div>`;
    html += `</div>`;
  });
  html += `</div>`;

  // Bouton gÃ©nÃ©rer tableau final
  const qualifies = getQualifiesPoules(t);
  const totalQual = qualifies.length;
  const totalExpected = (t.poules||[]).length * (t.qualPerPool||2);
  html += `<div style="margin-top:1rem;padding:1rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
    <div>
      <div style="font-size:0.85rem;font-weight:700;margin-bottom:2px">Tableau Final</div>
      <div style="font-size:0.72rem;color:var(--muted)">${totalQual}/${totalExpected} qualifiÃ©(s) Â· ${t.legs||'BO3'} Â· ${t.jeu||'501'}</div>
    </div>
    ${!t.tableauFinal
      ? `<button class="btn btn-primary btn-sm" onclick="genererTableauFinalPoules(${t.id})" ${totalQual<2?'disabled':''}>ğŸ¯ GÃ©nÃ©rer le Tableau Final</button>`
      : `<button class="btn btn-secondary btn-sm" onclick="setPoulesTab('final',document.getElementById('ptab-final'),${t.id});document.getElementById('ptab-final').click()">ğŸ“‹ Voir le Tableau Final â†’</button>`}
  </div>`;
  return html;
}

function renderFinalPhase(t) {
  if (!t.tableauFinal) {
    return `<div class="empty"><div class="empty-icon">â³</div><div class="empty-text">Le tableau final n'a pas encore Ã©tÃ© gÃ©nÃ©rÃ©.<br>ComplÃ©tez les poules d'abord.</div></div>`;
  }
  return renderBracketVisuel(t, t.tableauFinal.rounds);
}

function renderBracketVisuel(t, rounds) {
  if (!rounds || !rounds.length) return '';
  const roundNames = ['1/32','1/16','HuitiÃ¨mes','Quarts','Demies','Finale'];

  let html = `<div class="bracket-visual">`;
  rounds.forEach((round, rIdx) => {
    const rem = rounds.length - rIdx;
    const rName = rIdx === rounds.length - 1 ? 'FINALE' : rem === 2 ? 'DEMI-FINALES' : rem === 3 ? 'QUARTS' : rem === 4 ? 'HUITIÃˆMES' : `TOUR ${rIdx+1}`;
    html += `<div class="bracket-col"><div class="bracket-col-title">${rName}</div>`;
    round.forEach((m, mIdx) => {
      if (m.isBye) return;
      const p1 = m.joueur1 ? pById(m.joueur1) : null;
      const p2 = m.joueur2 ? pById(m.joueur2) : null;
      const canPlay = m.joueur1 && m.joueur2 && !m.completed;
      html += `<div class="bv-match ${m.completed?'done':canPlay?'can-play':''}" ${canPlay?`onclick="openScoreModal('final',${t.id},${rIdx},${mIdx})"`:''}>
        <div class="bv-player ${m.gagnant===m.joueur1?'winner':!m.joueur1?'tbd':''}">${p1?p1.pseudo:'TBD'}<span class="bv-score">${m.completed?m.score1:''}</span></div>
        <div class="bv-player ${m.gagnant===m.joueur2?'winner':!m.joueur2?'tbd':''}">${p2?p2.pseudo:'TBD'}<span class="bv-score">${m.completed?m.score2:''}</span></div>
      </div>`;
    });
    html += `</div>`;
  });
  html += `</div><p style="font-size:0.7rem;color:var(--muted);margin-top:0.5rem">Cliquez sur un match disponible pour saisir le score.</p>`;
  return html;
}

// â”€â”€ MODAL SAISIE SCORE UNIVERSEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openScoreModal(type, ...args) {
  _scoreModalCtx = { type, args };
  let p1name = '?', p2name = '?', title = 'Saisir le score';
  let jeuInfo = '';

  if (type === 'poule') {
    const [tid, pIdx, mIdx] = args;
    const t = tournois.find(x=>x.id===tid);
    if (!t) return;
    const m = t.poules[pIdx].matches[mIdx];
    p1name = pById(m.joueur1)?.pseudo || '?';
    p2name = pById(m.joueur2)?.pseudo || '?';
    title = `${t.poules[pIdx].nom} Â· Match ${m.id||mIdx+1}`;
    jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  } else if (type === 'final') {
    const [tid, rIdx, mIdx] = args;
    const t = tournois.find(x=>x.id===tid);
    if (!t || !t.tableauFinal) return;
    const m = t.tableauFinal.rounds[rIdx][mIdx];
    p1name = pById(m.joueur1)?.pseudo || 'TBD';
    p2name = pById(m.joueur2)?.pseudo || 'TBD';
    const rem = t.tableauFinal.rounds.length - rIdx;
    title = rIdx === t.tableauFinal.rounds.length - 1 ? 'ğŸ† FINALE' : rem===2?'DEMI-FINALE':rem===3?'QUART DE FINALE':`TOUR ${rIdx+1}`;
    jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  } else if (type === 'elim') {
    const [tid, ri, mi] = args;
    const t = tournois.find(x=>x.id===tid);
    if (!t) return;
    const m = t.rounds[ri][mi];
    p1name = m.p1 ? pName(m.p1) : 'BYE';
    p2name = m.p2 ? pName(m.p2) : 'BYE';
    title = ri === t.rounds.length-1 ? 'ğŸ† FINALE' : `Tour ${ri+1}`;
    jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  } else if (type === 'rr') {
    const [tid, mIdx, p1id, p2id] = args;
    p1name = pName(p1id); p2name = pName(p2id);
    const t = tournois.find(x=>x.id===tid);
    title = 'Round Robin';
    jeuInfo = `${t?.jeu||'501'} Â· ${t?.legs||'BO3'}`;
  }

  // Obtenir le max de legs selon format
  const legsMap = { BO1:1, BO3:2, BO5:3, BO7:4 };
  let maxLegs = 2;
  if (type === 'poule' || type === 'final') {
    const t = tournois.find(x=>x.id===args[0]);
    maxLegs = legsMap[t?.legs||'BO3'] || 2;
  } else if (type === 'elim' || type === 'rr') {
    const t = tournois.find(x=>x.id===args[0]);
    maxLegs = legsMap[t?.legs||'BO3'] || 2;
  }

  let modal = document.getElementById('score-modal-overlay');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'score-modal-overlay';
    modal.className = 'score-modal-overlay';
    modal.innerHTML = `<div class="score-modal" onclick="event.stopPropagation()">
      <div class="score-match-title" id="sm-title"></div>
      <div class="score-jeu-info" id="sm-jeu"></div>
      <div class="score-vs-row">
        <div class="score-player-col">
          <div class="score-player-name" id="sm-p1"></div>
          <input class="score-input-big" type="number" id="sm-s1" min="0" max="9" value="0" oninput="validateScoreInput(this,${maxLegs})">
        </div>
        <div class="score-vs-sep">â€”</div>
        <div class="score-player-col">
          <div class="score-player-name" id="sm-p2"></div>
          <input class="score-input-big" type="number" id="sm-s2" min="0" max="9" value="0" oninput="validateScoreInput(this,${maxLegs})">
        </div>
      </div>
      <div class="score-modal-actions">
        <button class="btn btn-secondary" style="flex:1" onclick="closeScoreModal()">Annuler</button>
        <button class="btn btn-primary" style="flex:2" onclick="validerScoreModal()">âœ“ Valider le score</button>
      </div>
    </div>`;
    modal.addEventListener('click', closeScoreModal);
    document.body.appendChild(modal);
  }

  document.getElementById('sm-title').textContent = title;
  document.getElementById('sm-jeu').textContent = jeuInfo;
  document.getElementById('sm-p1').textContent = p1name;
  document.getElementById('sm-p2').textContent = p2name;
  document.getElementById('sm-s1').value = 0;
  document.getElementById('sm-s2').value = 0;
  document.getElementById('sm-s1').max = maxLegs;
  document.getElementById('sm-s2').max = maxLegs;

  modal.classList.add('active');
  setTimeout(() => document.getElementById('sm-s1').focus(), 100);
}

function validateScoreInput(el, max) {
  const v = parseInt(el.value) || 0;
  if (v > max) el.value = max;
  if (v < 0) el.value = 0;
}

function closeScoreModal() {
  const m = document.getElementById('score-modal-overlay');
  if (m) m.classList.remove('active');
  _scoreModalCtx = null;
}

function validerScoreModal() {
  if (!_scoreModalCtx) return;
  const n1 = parseInt(document.getElementById('sm-s1').value) || 0;
  const n2 = parseInt(document.getElementById('sm-s2').value) || 0;
  if (n1 === n2) { showNotif('âš  Les scores doivent Ãªtre diffÃ©rents.'); return; }

  const { type, args } = _scoreModalCtx;
  closeScoreModal();

  if (type === 'poule') {
    const [tid, pIdx, mIdx] = args;
    const t = tournois.find(x=>x.id===tid); if (!t) return;
    const m = t.poules[pIdx].matches[mIdx];
    m.score1 = n1; m.score2 = n2; m.completed = true;
    m.gagnant = n1 > n2 ? m.joueur1 : m.joueur2;
    addAudit('ğŸ¯', `[${t.poules[pIdx].nom}] ${pById(m.joueur1)?.pseudo} ${n1}â€“${n2} ${pById(m.joueur2)?.pseudo}`);
    // IntÃ©grer au classement
    addTournamentMatchToRanking(m.joueur1, m.joueur2, n1, n2, t.name, t.date);
    save(); showNotif(`âœ“ ${pById(m.gagnant)?.pseudo} gagne !`, 'success');
    openTournoiDetail(tid); renderTournois();

  } else if (type === 'final') {
    const [tid, rIdx, mIdx] = args;
    const t = tournois.find(x=>x.id===tid); if (!t || !t.tableauFinal) return;
    const m = t.tableauFinal.rounds[rIdx][mIdx];
    m.score1 = n1; m.score2 = n2; m.completed = true;
    m.gagnant = n1 > n2 ? m.joueur1 : m.joueur2;
    // IntÃ©grer au classement
    addTournamentMatchToRanking(m.joueur1, m.joueur2, n1, n2, t.name, t.date);
    if (rIdx + 1 < t.tableauFinal.rounds.length) {
      const next = t.tableauFinal.rounds[rIdx+1][Math.floor(mIdx/2)];
      if (mIdx%2===0) next.joueur1 = m.gagnant; else next.joueur2 = m.gagnant;
    } else {
      t.status = 'finished';
      const winner = pById(m.gagnant);
      if (winner) { showNotif(`ğŸ† Vainqueur : ${winner.pseudo} !`, 'win'); confetti(); }
    }
    addAudit('ğŸ†', `Tableau final "${t.name}" : ${pById(m.gagnant)?.pseudo} avance`);
    save(); openTournoiDetail(tid); renderTournois();

  } else if (type === 'elim') {
    const [tid, ri, mi] = args;
    setElimWinnerScore(tid, ri, mi, n1, n2);

  } else if (type === 'rr') {
    const [tid, mIdx, p1id, p2id] = args;
    const t = tournois.find(x=>x.id===tid); if (!t) return;
    const m = t.matches[mIdx];
    m.s1 = m.p1===p1id ? n1 : n2;
    m.s2 = m.p1===p1id ? n2 : n1;
    m.winner = n1>n2 ? p1id : p2id;
    if (t.matches.every(x=>x.s1!==null)) t.status = 'finished';
    save(); openTournoiDetail(tid); renderTournois();
  }
}

// â”€â”€ POULES RR HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function annulerMatchPouleRR(tId, pIdx, mIdx) {
  if (!confirm('Annuler ce rÃ©sultat ?')) return;
  const t = tournois.find(x=>x.id===tId); if (!t) return;
  const m = t.poules[pIdx].matches[mIdx];
  m.completed = false; m.gagnant = null; m.score1 = 0; m.score2 = 0;
  save(); openTournoiDetail(tId); renderTournois();
}

function getQualifiesPoules(t) {
  const q = [];
  const qualPerPool = t.qualPerPool || 2;
  (t.poules || []).forEach((poule, pIdx) => {
    const classement = classementPoule(poule);
    const doneAll = poule.matches.every(m => m.completed);
    for (let i = 0; i < Math.min(qualPerPool, classement.length); i++) {
      q.push({ pid: classement[i].pid, poule: pIdx, position: i + 1, pts: classement[i].pts, qualified: doneAll || i < 1 });
    }
  });
  return q;
}

function genererTableauFinalPoules(tournoiId) {
  const t = tournois.find(x=>x.id===tournoiId); if (!t) return;
  const qualifies = getQualifiesPoules(t);
  if (qualifies.length < 2) { showNotif('âš  Pas assez de qualifiÃ©s.'); return; }

  // TÃªtes de sÃ©rie : 1ers par pts puis 2Ã¨mes etc.
  const premiers = qualifies.filter(q => q.position === 1);
  const deuxiemes = qualifies.filter(q => q.position === 2);
  const seeded = [...premiers, ...deuxiemes].map(q => ({ pid: q.pid }));

  const size = Math.pow(2, Math.ceil(Math.log2(seeded.length)));
  while (seeded.length < size) seeded.push(null);

  const totalRounds = Math.log2(size);
  const rounds = [];
  let currentSlots = seeded;

  for (let r = 0; r < totalRounds; r++) {
    const roundMatches = [];
    const nextSlots = [];
    for (let i = 0; i < currentSlots.length; i += 2) {
      const s1 = currentSlots[i], s2 = currentSlots[i+1];
      const isBye = !s1 || !s2;
      const byeWinner = isBye ? (s1?s1.pid:s2?s2.pid:null) : null;
      roundMatches.push({ joueur1:s1?s1.pid:null, joueur2:s2?s2.pid:null, score1:0, score2:0, gagnant:byeWinner, completed:isBye, isBye });
      nextSlots.push(byeWinner ? {pid:byeWinner} : null);
    }
    rounds.push(roundMatches);
    currentSlots = nextSlots;
  }

  t.tableauFinal = { rounds };
  addAudit('ğŸ†', `Tableau final gÃ©nÃ©rÃ© pour "${t.name}" (${qualifies.length} qualifiÃ©s)`);
  save(); openTournoiDetail(tournoiId); renderTournois();
  showNotif('âœ“ Tableau final gÃ©nÃ©rÃ© !', 'success');
}

function imprimerPouleRR(tId, pIdx) {
  const t = tournois.find(x=>x.id===tId); if (!t) return;
  const poule = t.poules[pIdx];
  const classement = classementPoule(poule);
  const pw = window.open('', '', 'width=800,height=900');
  pw.document.write(`<!DOCTYPE html><html><head><title>Feuille ${poule.nom}</title>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;color:#000}
    h1{font-size:1.2rem;margin-bottom:4px}
    .sub{font-size:0.85rem;color:#555;margin-bottom:16px}
    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    th,td{border:1px solid #000;padding:6px 10px;text-align:center}
    th{background:#eee;font-weight:bold;font-size:0.8rem}
    td:nth-child(2){text-align:left}
    .match-row{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #ccc;border-radius:4px;margin-bottom:8px}
    .mp{flex:1;font-weight:bold}
    .mscore{border:1px solid #000;width:40px;height:30px;display:inline-block;border-radius:3px;text-align:center}
    @media print{body{padding:10px}}
  </style></head><body>
  <h1>ğŸ¯ ${t.name} â€” ${poule.nom}</h1>
  <div class="sub">${t.jeu||'501'} Â· ${t.legs||'BO3'} Â· ${t.date||''} Â· ${t.lieu||''}</div>
  <h3>Classement</h3>
  <table><thead><tr><th>#</th><th>Joueur</th><th>Pts</th><th>V</th><th>D</th><th>Legs P/C</th></tr></thead>
  <tbody>${classement.map((s,i)=>`<tr><td>${i+1}</td><td>${pById(s.pid)?.pseudo||s.pid}</td><td><b>${s.pts}</b></td><td>${s.v}</td><td>${s.d}</td><td>${s.legs_p}/${s.legs_c}</td></tr>`).join('')}</tbody></table>
  <h3>Matchs</h3>
  ${poule.matches.map((m,i)=>{const p1=pById(m.joueur1),p2=pById(m.joueur2);
    return `<div class="match-row"><span style="font-size:0.7rem;color:#888;min-width:20px">${m.id||i+1}</span>
    <span class="mp">${p1?p1.pseudo:m.joueur1}</span>
    ${m.completed?`<b>${m.score1}</b> â€“ <b>${m.score2}</b>`:`<div class="mscore"></div> â€“ <div class="mscore"></div>`}
    <span class="mp" style="text-align:right">${p2?p2.pseudo:m.joueur2}</span>
    </div>`;}).join('')}
  <div style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <div>Arbitre : ___________________<br><br>Signature : ___________________</div>
    <div>Date : ___________________<br><br>Table NÂ° : ___________________</div>
  </div>
  </body></html>`);
  pw.document.close();
  setTimeout(() => pw.print(), 300);
}

// â”€â”€ Ã‰LIMINATION DIRECTE (mise Ã  jour) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createElimination(name, playerIds, jeu, legs) {
  const shuffled = [...playerIds];
  const size = Math.pow(2, Math.ceil(Math.log2(shuffled.length)));
  while (shuffled.length < size) shuffled.push(null);
  const rounds = [];
  let current = shuffled;
  while (current.length > 1) {
    const pairs = [];
    for (let i=0; i<current.length; i+=2) pairs.push({p1:current[i],p2:current[i+1],s1:null,s2:null,winner:null});
    rounds.push(pairs);
    current = new Array(pairs.length).fill(null);
  }
  return { id:Date.now(), name, format:'elimination', playerIds, rounds, status:'active', jeu:jeu||'501', legs:legs||'BO3', created:new Date().toLocaleDateString('fr-FR') };
}

function renderElimination(t, el) {
  const jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  let html = `<div class="t-detail-header"><div>
    <div style="font-size:1rem;font-weight:700;margin-bottom:0.3rem">${t.name}</div>
    <div class="t-detail-meta">
      <span class="t-meta-chip highlight">${t.playerIds.length} joueurs</span>
      <span class="t-meta-chip highlight">${jeuInfo}</span>
      ${t.date?`<span class="t-meta-chip">ğŸ“… ${t.date}</span>`:''}
    </div>
  </div></div>`;

  // Afficher le vainqueur si fini
  const lastRound = (t.rounds||[]).slice(-1)[0];
  const finale = lastRound && lastRound[0];
  if (finale && finale.winner) {
    html += `<div style="text-align:center;padding:1.2rem;background:var(--gold-bg);border:1px solid rgba(230, 57, 70, 0.3);border-radius:var(--radius);margin-bottom:1rem">
      <div style="font-size:2rem">ğŸ†</div>
      <div style="font-family:'Bebas Neue', sans-serif;font-size:1.3rem;font-weight:700;color:var(--gold)">${pName(finale.winner)}</div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:4px">Vainqueur du tournoi</div>
    </div>`;
  }

  html += renderBracketVisuel(t, (t.rounds||[]).map(round => round.map(m => ({
    joueur1: m.p1, joueur2: m.p2, score1: m.s1, score2: m.s2,
    gagnant: m.winner, completed: m.winner !== null
  }))));
  el.innerHTML = html;

  // Re-bind clics sur les matchs du bracket pour Ã©limination
  document.querySelectorAll('.bv-match.can-play').forEach((div, globalIdx) => {
    // On recalcule rIdx et mIdx
  });
  // Rendre le bracket avec les bons events
  html = `<div class="t-detail-header"><div>
    <div style="font-size:1rem;font-weight:700;margin-bottom:0.3rem">${t.name}</div>
    <div class="t-detail-meta">
      <span class="t-meta-chip highlight">${t.playerIds.length} joueurs</span>
      <span class="t-meta-chip highlight">${jeuInfo}</span>
    </div>
  </div></div>`;
  if (finale && finale.winner) {
    html += `<div style="text-align:center;padding:1.2rem;background:var(--gold-bg);border:1px solid rgba(230, 57, 70, 0.3);border-radius:var(--radius);margin-bottom:1rem">
      <div style="font-size:2rem">ğŸ†</div>
      <div style="font-family:'Bebas Neue', sans-serif;font-size:1.3rem;font-weight:700;color:var(--gold)">${pName(finale.winner)}</div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:4px">Vainqueur du tournoi</div>
    </div>`;
  }
  const rounds = t.rounds || [];
  html += `<div class="bracket-visual">`;
  rounds.forEach((round, rIdx) => {
    const rem = rounds.length - rIdx;
    const rName = rIdx === rounds.length-1 ? 'FINALE' : rem===2?'DEMI-FINALES':rem===3?'QUARTS':rem===4?'HUITIÃˆMES':`TOUR ${rIdx+1}`;
    html += `<div class="bracket-col"><div class="bracket-col-title">${rName}</div>`;
    round.forEach((m, mIdx) => {
      const p1n = m.p1 ? pName(m.p1) : 'BYE';
      const p2n = m.p2 ? pName(m.p2) : 'BYE';
      const canPlay = m.p1 && m.p2 && m.winner === null;
      html += `<div class="bv-match ${m.winner?'done':canPlay?'can-play':''}" ${canPlay?`onclick="openScoreModal('elim',${t.id},${rIdx},${mIdx})"`:''}>
        <div class="bv-player ${m.winner===m.p1&&m.p1?'winner':!m.p1?'bye':''}">${p1n}<span class="bv-score">${m.s1!==null?m.s1:''}</span></div>
        <div class="bv-player ${m.winner===m.p2&&m.p2?'winner':!m.p2?'bye':''}">${p2n}<span class="bv-score">${m.s2!==null?m.s2:''}</span></div>
      </div>`;
    });
    html += `</div>`;
  });
  html += `</div><p style="font-size:0.7rem;color:var(--muted);margin-top:0.5rem">Cliquez sur un match disponible pour saisir le score.</p>`;
  el.innerHTML = html;
}

function setElimWinnerScore(tid, ri, mi, n1, n2) {
  const t = tournois.find(x=>x.id===tid); if (!t||!t.rounds) return;
  const m = t.rounds[ri][mi];
  m.s1 = n1; m.s2 = n2;
  m.winner = n1>n2 ? m.p1 : m.p2;
  if (ri+1 < t.rounds.length) {
    const slot = Math.floor(mi/2);
    if (mi%2===0) t.rounds[ri+1][slot].p1 = m.winner;
    else t.rounds[ri+1][slot].p2 = m.winner;
  } else {
    t.status = 'finished';
    showNotif(`ğŸ† Vainqueur : ${pName(m.winner)} !`, 'win');
    confetti();
  }
  addAudit('ğŸ†', `Tournoi "${t.name}" : ${pName(m.winner)} avance`);
  save(); openTournoiDetail(tid); renderTournois();
}

// compat ancienne version
function setElimWinner(tid,ri,mi,pid) {
  const t=tournois.find(x=>x.id===tid); if(!t||!t.rounds)return;
  const match=t.rounds[ri][mi]; match.winner=pid; match.s1=null; match.s2=null;
  if(ri+1<t.rounds.length){const slot=Math.floor(mi/2);if(mi%2===0)t.rounds[ri+1][slot].p1=pid;else t.rounds[ri+1][slot].p2=pid;}
  if(t.rounds.every(r=>r.every(m=>m.winner!==null||!m.p1||!m.p2))){t.status='finished';confetti();}
  save(); openTournoiDetail(tid); renderTournois();
}

// â”€â”€ ROUND ROBIN AMÃ‰LIORÃ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createRoundRobin(name, playerIds, jeu, legs) {
  const m2=[];
  for(let i=0;i<playerIds.length;i++) for(let j=i+1;j<playerIds.length;j++) m2.push({p1:playerIds[i],p2:playerIds[j],s1:null,s2:null,winner:null});
  return {id:Date.now(),name,format:'rr',playerIds,matches:m2,status:'active',jeu:jeu||'501',legs:legs||'BO3',created:new Date().toLocaleDateString('fr-FR')};
}

function renderRoundRobinDetail(t, el) {
  const ps = t.playerIds.map(pById).filter(Boolean);
  const stand = {};
  ps.forEach(p => stand[p.id] = {pts:0,played:0,won:0,lost:0,legs_p:0,legs_c:0});
  (t.matches||[]).forEach(m => {
    if (m.winner) {
      stand[m.winner].pts+=2; stand[m.winner].won++; stand[m.winner].played++;
      const opp = m.p1===m.winner?m.p2:m.p1;
      stand[opp]&&(stand[opp].pts+=1,stand[opp].lost++,stand[opp].played++);
    }
    if (m.s1!==null) {
      stand[m.p1]&&(stand[m.p1].legs_p+=m.s1,stand[m.p1].legs_c+=m.s2);
      stand[m.p2]&&(stand[m.p2].legs_p+=m.s2,stand[m.p2].legs_c+=m.s1);
    }
  });
  const sorted = [...ps].sort((a,b)=>(stand[b.id].pts-stand[a.id].pts)||(stand[b.id].legs_p-stand[b.id].legs_c)-(stand[a.id].legs_p-stand[a.id].legs_c));
  const jeuInfo = `${t.jeu||'501'} Â· ${t.legs||'BO3'}`;
  const winner = t.status==='finished' && sorted[0];

  let html = `<div class="t-detail-header"><div>
    <div style="font-size:1rem;font-weight:700;margin-bottom:0.3rem">${t.name}</div>
    <div class="t-detail-meta">
      <span class="t-meta-chip highlight">${ps.length} joueurs</span>
      <span class="t-meta-chip highlight">${jeuInfo}</span>
    </div>
  </div></div>`;

  if (winner) {
    html += `<div style="text-align:center;padding:1rem;background:var(--gold-bg);border:1px solid rgba(230, 57, 70, 0.3);border-radius:var(--radius);margin-bottom:1rem">
      ğŸ† <strong style="color:var(--gold)">${winner.pseudo}</strong> est en tÃªte !
    </div>`;
  }

  // Classement
  html += `<div class="section-label">Classement</div>`;
  sorted.forEach((p, i) => {
    const s = stand[p.id];
    html += `<div class="rr-standing-card">
      <div class="rr-rank-num ${i===0?'r1':i===1?'r2':i===2?'r3':''}">${i+1}</div>
      <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,${p.avatarColor||'var(--accent)'},${p.avatarColor||'#c9293a'}88);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;color:#0d0f14;flex-shrink:0">${p.avatarEmoji||getInitials(p.name)}</div>
      <div class="rr-player-name">${p.pseudo}</div>
      <div class="rr-mini-stats">
        <span class="rr-ms-v">${s.won}V</span>
        <span class="rr-ms-d">${s.lost}D</span>
        <span>${s.legs_p}/${s.legs_c} legs</span>
      </div>
      <div class="rr-pts-big">${s.pts} <span style="font-size:0.65rem;color:var(--muted)">pts</span></div>
    </div>`;
  });

  // Matchs Ã  jouer
  html += `<div class="section-label" style="margin-top:1rem">RÃ©sultats</div>`;
  html += `<div class="pool-matches-list">`;
  (t.matches||[]).forEach((m, mIdx) => {
    const p1 = pById(m.p1), p2 = pById(m.p2);
    const done = m.s1 !== null;
    html += `<div class="pool-match-row ${done?'done':'can-play'}" ${!done?`onclick="openScoreModal('rr',${t.id},${mIdx},${m.p1},${m.p2})"`:''}>
      <span class="pmr-p1 ${m.winner===m.p1?'pmr-winner':done?'pmr-loser':''}">${p1?p1.pseudo:'?'}</span>
      <span class="pmr-score">${done?`${m.s1} â€“ ${m.s2}`:'vs'}</span>
      <span class="pmr-p2 ${m.winner===m.p2?'pmr-winner':done?'pmr-loser':''}">${p2?p2.pseudo:'?'}</span>
      ${done?`<span class="pmr-status pmr-done">âœ“</span>`:`<span class="pmr-status pmr-pending">Ã€ jouer</span>`}
    </div>`;
  });
  html += `</div>`;
  el.innerHTML = html;
}

function setRRResult(tid,matchIdx,p1id,p2id) {
  openScoreModal('rr', tid, matchIdx, p1id, p2id);
}

function deleteTournoi(id) {
  const t = tournois.find(x => x.id === id);
  if (!t) return;
  const { done } = getTournoiProgress(t);
  const warn = done > 0 ? `\nâš ï¸ ${done} match(s) jouÃ©(s) seront perdus.` : '';
  if (!confirm(`Supprimer le tournoi "${t.name}" ?${warn}\nCette action est irrÃ©versible.`)) return;
  tournois = tournois.filter(x => x.id !== id);
  addAudit('ğŸ—‘ï¸', `Tournoi supprimÃ© : ${t.name}`);
  save(); renderTournois();
  showNotif('âœ“ Tournoi supprimÃ©', 'success');
}

// â”€â”€ COMPAT FONCTIONS ANCIENNES (poules double-Ã©lim) â”€â”€
function ouvrirPoule(tournoiId, pouleIndex) { openTournoiDetail(tournoiId); }
function refreshPoolModal(tournoiId, pouleIndex) {}
function renderMatchPoule(m, tId, pIdx, mIdx) { return ''; }
function updateScorePoule() {}
function validerMatchPoule(tId, pIdx, mIdx) {}
function annulerMatchPoule() {}
function imprimerPoule() {}
function imprimerPouleIdx(tId, pIdx) { imprimerPouleRR(tId, pIdx); }
function imprimerMatchPoule() {}
function renderPoulesDetail_old() {}
function renderTableauFinalPoules(t) { return renderFinalPhase(t); }
function genererTableauFinalPoules_old() {}
function setFinalMatchScore() {}
function getRoundNameFinal(r,t){return '';}
function trouverProchainMatchWinner(){return null;}
function trouverProchainMatchLoser(){return null;}
function verifierFinalePoule(){}
function genererMatchsPoule(j){return genMatchsPouleRR(j);}

// TIRAGE ALÃ‰ATOIRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let presentPlayers = new Set();   // IDs des joueurs prÃ©sents
let tirageMatchs = [];             // Matchs gÃ©nÃ©rÃ©s [{p1,p2,s1,s2,done}]

function toggleTirage() {
  const panel = document.getElementById('tirage-panel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) renderPresenceGrid();
}

// â”€â”€ Grille prÃ©sence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPresenceGrid() {
  const grid = document.getElementById('presence-grid');
  if (!players.length) {
    grid.innerHTML = `<span style="font-size:0.78rem;color:var(--muted)">Aucun joueur enregistrÃ©.</span>`;
    updatePresenceInfo();
    return;
  }
  // Trier par ELO dÃ©croissant
  const sorted = [...players].sort((a,b) => b.elo - a.elo);
  grid.innerHTML = sorted.map(p => `
    <div class="presence-chip ${presentPlayers.has(p.id) ? 'present' : ''}"
         id="chip-${p.id}" onclick="togglePresence(${p.id})">
      ${p.pseudo}
      <span style="font-size:0.6rem;opacity:0.7">${p.elo}</span>
    </div>`).join('');
  updatePresenceInfo();
}

function togglePresence(id) {
  if (presentPlayers.has(id)) presentPlayers.delete(id);
  else presentPlayers.add(id);
  const chip = document.getElementById(`chip-${id}`);
  if (chip) chip.classList.toggle('present', presentPlayers.has(id));
  updatePresenceInfo();
}

function selectAllPresence(val) {
  if (val) players.forEach(p => presentPlayers.add(p.id));
  else presentPlayers.clear();
  renderPresenceGrid();
}

function updatePresenceInfo() {
  const n = presentPlayers.size;
  const el = document.getElementById('tirage-present-count');
  const info = document.getElementById('presence-info');
  if (el) el.textContent = n > 0 ? `${n} prÃ©sent${n>1?'s':''}` : '';
  if (info) info.textContent = n >= 2
    ? `${n} joueurs Â· ${Math.floor(n/2)} match${Math.floor(n/2)>1?'s':''}  possibles par round`
    : n === 1 ? 'âš  Il faut au moins 2 joueurs' : '';
  // Changer le label en fonction du mode
  updateTirageMode();
}

function updateTirageMode() {
  const mode = document.getElementById('tirage-mode')?.value;
  const nField = document.getElementById('tirage-n-field');
  const nLabel = document.getElementById('tirage-n-label');
  const nInput = document.getElementById('tirage-n');
  if (!nField) return;
  if (mode === 'rr') {
    nField.style.display = 'none';
  } else if (mode === 'random') {
    nField.style.display = 'block';
    if (nLabel) nLabel.textContent = 'Nombre de matchs';
    if (nInput) { nInput.min = 1; nInput.value = Math.max(1, parseInt(nInput.value)||3); }
  } else if (mode === 'serpentin') {
    nField.style.display = 'none';
  } else {
    nField.style.display = 'block';
    if (nLabel) nLabel.textContent = 'Matchs par joueur';
    if (nInput) { nInput.min = 1; nInput.value = Math.max(1, parseInt(nInput.value)||1); }
  }
}

// updateTirageMode est appelÃ© via onchange="updateTirageMode()" dans le HTML

// â”€â”€ GÃ©nÃ©ration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function genererTirageAleatoire() {
  if (presentPlayers.size < 2) { showNotif('âš  SÃ©lectionnez au moins 2 joueurs prÃ©sents.'); return; }
  const mode = document.getElementById('tirage-mode').value;
  const n = parseInt(document.getElementById('tirage-n').value) || 1;
  const rematchDepth = parseInt(document.getElementById('tirage-rematch').value) || 0;
  const ids = [...presentPlayers];

  let pairs = [];
  if (mode === 'rr') {
    pairs = genRoundRobin(ids);
  } else if (mode === 'random') {
    pairs = genRandom(ids, n, rematchDepth);
  } else if (mode === 'serpentin') {
    pairs = genSerpentin(ids);
  } else {
    pairs = genRoundMode(ids, n, rematchDepth);
  }

  if (!pairs.length) { showNotif('âš  Impossible de gÃ©nÃ©rer des matchs (vÃ©rifiez les contraintes).'); return; }

  tirageMatchs = pairs.map((p, i) => ({ id: i, p1: p[0], p2: p[1], s1: '', s2: '', done: false }));
  renderTirageResults();
  showNotif(`âœ“ ${tirageMatchs.length} match${tirageMatchs.length>1?'s':''} gÃ©nÃ©rÃ©${tirageMatchs.length>1?'s':''}  !`);
}

// Round robin : tous contre tous
function genRoundRobin(ids) {
  const pairs = [];
  for (let i = 0; i < ids.length; i++)
    for (let j = i+1; j < ids.length; j++)
      pairs.push([ids[i], ids[j]]);
  return shuffle(pairs);
}

// N matchs par joueur (round), sans rematch rÃ©cent
function genRoundMode(ids, matchesPerPlayer, rematchDepth) {
  const played = new Map(); // id â†’ nb matchs jouÃ©s dans ce tirage
  ids.forEach(id => played.set(id, 0));

  // RÃ©cents = derniers matchs de chaque paire
  const recentPairs = new Set();
  if (rematchDepth > 0) {
    const recent = matches.slice(0, rematchDepth * ids.length);
    recent.forEach(m => { recentPairs.add(`${Math.min(m.p1,m.p2)}-${Math.max(m.p1,m.p2)}`); });
  }

  const pairs = [];
  const target = matchesPerPlayer;
  let maxIterations = ids.length * target * 10;

  while ([...played.values()].some(v => v < target) && maxIterations-- > 0) {
    // Candidats = joueurs avec moins de target matchs jouÃ©s
    const candidates = ids.filter(id => played.get(id) < target);
    if (candidates.length < 2) break;

    // Trouver une paire valide
    const shuffled = shuffle([...candidates]);
    let found = false;
    for (let i = 0; i < shuffled.length && !found; i++) {
      for (let j = i+1; j < shuffled.length && !found; j++) {
        const a = shuffled[i], b = shuffled[j];
        const key = `${Math.min(a,b)}-${Math.max(a,b)}`;
        const alreadyIn = pairs.some(p => (p[0]===a&&p[1]===b)||(p[0]===b&&p[1]===a));
        if (!alreadyIn && !recentPairs.has(key)) {
          pairs.push([a, b]);
          played.set(a, played.get(a)+1);
          played.set(b, played.get(b)+1);
          found = true;
        }
      }
    }
    // Si pas trouvÃ© sans contrainte rematch, relÃ¢cher
    if (!found) {
      for (let i = 0; i < shuffled.length && !found; i++) {
        for (let j = i+1; j < shuffled.length && !found; j++) {
          const a = shuffled[i], b = shuffled[j];
          const alreadyIn = pairs.some(p => (p[0]===a&&p[1]===b)||(p[0]===b&&p[1]===a));
          if (!alreadyIn) {
            pairs.push([a, b]);
            played.set(a, played.get(a)+1);
            played.set(b, played.get(b)+1);
            found = true;
          }
        }
      }
    }
    if (!found) break;
  }
  return pairs;
}

// N matchs totaux au hasard
function genRandom(ids, total, rematchDepth) {
  const recentPairs = new Set();
  if (rematchDepth > 0) {
    const recent = matches.slice(0, rematchDepth * ids.length);
    recent.forEach(m => recentPairs.add(`${Math.min(m.p1,m.p2)}-${Math.max(m.p1,m.p2)}`));
  }
  // Toutes les paires possibles
  let pool = [];
  for (let i = 0; i < ids.length; i++)
    for (let j = i+1; j < ids.length; j++)
      pool.push([ids[i], ids[j]]);
  pool = shuffle(pool);

  // PrioritÃ© aux paires non rÃ©centes
  const nonRecent = pool.filter(p => !recentPairs.has(`${Math.min(p[0],p[1])}-${Math.max(p[0],p[1])}`));
  const recent2 = pool.filter(p => recentPairs.has(`${Math.min(p[0],p[1])}-${Math.max(p[0],p[1])}`));
  const ordered = [...nonRecent, ...recent2];

  // Tirer avec Ã©quilibre (chaque joueur joue le plus uniformÃ©ment possible)
  const played = new Map(ids.map(id => [id, 0]));
  const result = [];
  for (let iter = 0; result.length < total && iter < total * 20; iter++) {
    // Choisir la paire qui Ã©quilibre le mieux le nombre de matchs
    const available = ordered.filter(p => !result.some(r => (r[0]===p[0]&&r[1]===p[1])||(r[0]===p[1]&&r[1]===p[0])));
    if (!available.length) break;
    // Score = min des nb jouÃ©s (favoriser les moins jouÃ©s)
    available.sort((a,b) => (played.get(a[0])+played.get(a[1])) - (played.get(b[0])+played.get(b[1])));
    const pick = available[0];
    result.push(pick);
    played.set(pick[0], played.get(pick[0])+1);
    played.set(pick[1], played.get(pick[1])+1);
  }
  return result;
}

// Serpentin ELO : 1er vs 2e, 3e vs 4e... puis 2e vs 3e, etc.
function genSerpentin(ids) {
  // Trier par ELO
  const sorted = ids.map(id => pById(id)).filter(Boolean).sort((a,b) => b.elo - a.elo).map(p => p.id);
  const pairs = [];
  // Round 1 : 1vs2, 3vs4, 5vs6...
  for (let i = 0; i < sorted.length-1; i += 2)
    pairs.push([sorted[i], sorted[i+1]]);
  // Round 2 : 2vs3, 4vs5... (si assez de joueurs)
  if (sorted.length >= 4) {
    for (let i = 1; i < sorted.length-1; i += 2)
      pairs.push([sorted[i], sorted[i+1]]);
  }
  return pairs;
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// â”€â”€ Rendu des matchs gÃ©nÃ©rÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTirageResults() {
  const container = document.getElementById('tirage-results');
  const list = document.getElementById('random-matches-list');
  if (!tirageMatchs.length) { container.style.display = 'none'; return; }
  container.style.display = 'block';

  list.innerHTML = tirageMatchs.map((m, i) => {
    const p1 = pById(m.p1), p2 = pById(m.p2);
    return `<div class="rnd-match ${m.done?'rnd-done':''}" id="rnd-match-${i}">
      <span class="rnd-num">${i+1}</span>
      <span class="rnd-player">${p1 ? p1.pseudo : '?'}</span>
      <span class="rnd-vs">VS</span>
      <span class="rnd-player">${p2 ? p2.pseudo : '?'}</span>
      ${m.done
        ? `<span class="rnd-done-badge">ğŸ† ${m.s1 > m.s2 ? (p1?p1.pseudo:'J1') : m.s2 > m.s1 ? (p2?p2.pseudo:'J2') : 'Ã‰galitÃ©'} Â· ${m.s1}â€“${m.s2}</span>`
        : `<div class="rnd-score-inputs">
            <input type="number" class="rnd-score" id="rnd-s1-${i}" value="${m.s1}" min="0" placeholder="0" oninput="onRndScoreChange(${i})">
            <span class="rnd-dash">â€“</span>
            <input type="number" class="rnd-score" id="rnd-s2-${i}" value="${m.s2}" min="0" placeholder="0" oninput="onRndScoreChange(${i})">
          </div>
          <button class="rnd-validate" id="rnd-btn-${i}" onclick="validerRndMatch(${i})">âœ“</button>`
      }
    </div>`;
  }).join('');

  updateTirageSummary();
}

function onRndScoreChange(i) {
  const s1 = document.getElementById(`rnd-s1-${i}`)?.value;
  const s2 = document.getElementById(`rnd-s2-${i}`)?.value;
  tirageMatchs[i].s1 = s1;
  tirageMatchs[i].s2 = s2;
  // Mettre en surbrillance si les deux remplis
  const row = document.getElementById(`rnd-match-${i}`);
  if (row) row.classList.toggle('rnd-active', s1 !== '' && s2 !== '' && !tirageMatchs[i].done);
  updateTirageSummary();
}

function validerRndMatch(i) {
  const m = tirageMatchs[i];
  const s1 = parseInt(document.getElementById(`rnd-s1-${i}`)?.value);
  const s2 = parseInt(document.getElementById(`rnd-s2-${i}`)?.value);
  if (isNaN(s1) || isNaN(s2)) { showNotif('âš  Entrez les deux scores.'); return; }
  m.s1 = s1; m.s2 = s2; m.done = true;
  // Enregistrer le match
  const ok = addMatch(m.p1, m.p2, s1, s2);
  if (ok) renderTirageResults();
}

function validerTousMatchs() {
  let count = 0;
  tirageMatchs.forEach((m, i) => {
    if (m.done) return;
    const s1 = parseInt(document.getElementById(`rnd-s1-${i}`)?.value);
    const s2 = parseInt(document.getElementById(`rnd-s2-${i}`)?.value);
    if (!isNaN(s1) && !isNaN(s2)) {
      m.s1 = s1; m.s2 = s2; m.done = true;
      addMatch(m.p1, m.p2, s1, s2);
      count++;
    }
  });
  if (count > 0) { renderTirageResults(); showNotif(`âœ“ ${count} match${count>1?'s':''} validÃ©${count>1?'s':''}  !`); }
  else showNotif('âš  Aucun score Ã  valider.');
}

function updateTirageSummary() {
  const done = tirageMatchs.filter(m => m.done).length;
  const total = tirageMatchs.length;
  const ready = tirageMatchs.filter((m,i) => !m.done && document.getElementById(`rnd-s1-${i}`)?.value !== '' && document.getElementById(`rnd-s2-${i}`)?.value !== '').length;
  const el = document.getElementById('tirage-summary');
  if (el) el.textContent = `${done}/${total} validÃ©${done>1?'s':''} ${ready>0?`Â· ${ready} prÃªt${ready>1?'s':''} Ã  valider`:''}`;
}

function retirage() {
  tirageMatchs = [];
  genererTirageAleatoire();
}

function resetTirage() {
  tirageMatchs = [];
  document.getElementById('tirage-results').style.display = 'none';
  showNotif('âœ“ Tirage effacÃ©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE SOIRÃ‰E
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSoiree() {
  renderSelects();
  document.getElementById('soiree-overlay').classList.add('active');
  ['soiree-s1','soiree-s2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('soiree-history').innerHTML='';
  document.getElementById('soiree-preview').textContent='';
}
function closeSoiree() { document.getElementById('soiree-overlay').classList.remove('active'); }

function addMatchSoiree() {
  const p1=parseInt(document.getElementById('soiree-p1').value);
  const p2=parseInt(document.getElementById('soiree-p2').value);
  const s1=parseInt(document.getElementById('soiree-s1').value)||0;
  const s2=parseInt(document.getElementById('soiree-s2').value)||0;
  if (!p1||!p2) { showNotif('âš  SÃ©lectionnez les deux joueurs.'); return; }
  if (p1===p2) { showNotif('âš  Joueurs diffÃ©rents.'); return; }
  const winner = s1>s2?p1:s2>s1?p2:null;
  matches.unshift({ id:Date.now(), p1, p2, s1, s2, winner, date:new Date().toLocaleDateString('fr-FR'), eloChange1:0, eloChange2:0 });
  _eloVersion++;
  recomputeElo(); checkAchievements(); save(); renderAll();
  addAudit('ğŸ¯', `[SoirÃ©e] Match : ${pName(p1)} ${s1}â€“${s2} ${pName(p2)}`);
  // Add to soiree history
  const hist = document.getElementById('soiree-history');
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;align-items:center;gap:0.6rem;padding:0.35rem 0.5rem;background:var(--surface2);border-radius:6px;margin-bottom:0.3rem;font-size:0.78rem';
  row.innerHTML = `<span style="font-weight:700">${pName(p1)}</span><span style="color:var(--accent);font-weight:700">${s1}â€“${s2}</span><span style="font-weight:700">${pName(p2)}</span>${winner?`<span style="color:var(--green);font-weight:700;margin-left:auto">ğŸ† ${pName(winner)}</span>`:``}`;
  hist.prepend(row);
  // Reset scores only
  document.getElementById('soiree-s1').value='';
  document.getElementById('soiree-s2').value='';
  document.getElementById('soiree-s1').focus();
  if (winner) { showNotif(`ğŸ† ${pName(winner)} !`); confetti(); }
  else showNotif('âœ“ Match enregistrÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTimerWidget() {
  const w = document.getElementById('timer-widget');
  w.classList.toggle('active');
}
function toggleTimer() {
  if (timerRunning) {
    clearInterval(timerInterval);
    timerRunning = false;
    document.getElementById('timer-start-stop').textContent = 'â–¶';
    document.getElementById('timer-toggle-btn').classList.remove('running');
  } else {
    timerInterval = setInterval(() => {
      timerSeconds++;
      updateTimerDisplay();
    }, 1000);
    timerRunning = true;
    document.getElementById('timer-start-stop').textContent = 'â¸';
    document.getElementById('timer-toggle-btn').classList.add('running');
  }
}
function resetTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  timerSeconds = 0;
  updateTimerDisplay();
  document.getElementById('timer-start-stop').textContent = 'â–¶';
  document.getElementById('timer-toggle-btn').classList.remove('running');
}
function updateTimerDisplay() {
  const m = Math.floor(timerSeconds/60).toString().padStart(2,'0');
  const s = (timerSeconds%60).toString().padStart(2,'0');
  document.getElementById('timer-display').textContent = `${m}:${s}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEASONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newSeason() {
  if (!confirm('DÃ©marrer une nouvelle saison ? Les ELO seront remis Ã  1000 et l\'historique archivÃ©.')) return;
  const current = seasons.find(s=>s.active);
  if (current) { current.active=false; current.end=new Date().toLocaleDateString('fr-FR'); current.matchCount=matches.length; current.playerCount=players.length; }
  const newS = { id:Date.now(), name:`Saison ${seasons.length+1}`, start:new Date().toLocaleDateString('fr-FR'), end:null, active:true };
  seasons.push(newS);
  // Reset ELO
  players.forEach(p=>{ p.elo=ELO_START; p.eloHistory=[ELO_START]; p.peak=ELO_START; p.trend=0; });
  matches = [];
  addAudit('ğŸ”„', `Nouvelle saison dÃ©marrÃ©e : ${newS.name}`);
  save(); renderAll(); renderParametres();
  updateSeasonBadge();
  showNotif('âœ“ Nouvelle saison dÃ©marrÃ©e !');
}

function updateSeasonBadge() {
  const s = seasons.find(x=>x.active);
  if (s) document.getElementById('season-badge').textContent = s.name;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b)=>b.elo-a.elo);
  const rows = [['#','Pseudo','Nom','ELO','Peak','Matchs','Victoires','Defaites','Nuls','% Victoires','Sets Gagnes','Sets Perdus']];
  sorted.forEach((p,i) => {
    const s = stats[p.id]||{wins:0,losses:0,draws:0,matches:0,setsWon:0,setsLost:0};
    const pct = s.matches ? Math.round(s.wins/s.matches*100):0;
    rows.push([i+1,p.pseudo,p.name,p.elo,p.peak||p.elo,s.matches,s.wins,s.losses,s.draws,pct+'%',s.setsWon,s.setsLost]);
  });
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`flechettes-classement.csv`;
  a.click(); URL.revokeObjectURL(url);
  showNotif('âœ“ CSV exportÃ© !');
}

// exportPDF â€” dÃ©fini plus bas (appelle printClassement)

function resetAll() {
  if (!confirm('âš  RÃ©initialiser TOUTES les donnÃ©es ? Cette action est irrÃ©versible.')) return;
  if (!confirm('DerniÃ¨re confirmation : supprimer tout ?')) return;
  players=[]; matches=[]; tournois=[]; auditLog=[];
  seasons=[{id:1,name:'Saison 1',start:null,end:null,active:true}];
  save(); renderAll(); renderParametres(); updateSeasonBadge();
  showNotif('âœ“ DonnÃ©es rÃ©initialisÃ©es.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParametres() {
  initClubSettings();
  renderBackupStatus();
  renderPasswordManagement();
  // Seasons
  const el = document.getElementById('season-list');
  if (el) {
    el.innerHTML = [...seasons].reverse().map(s => `
      <div class="season-item ${s.active?'season-current':''}">
        <div>
          <div class="season-name">${s.name} ${s.active?'<span style="font-size:0.62rem;background:var(--green-bg);color:var(--green);border:1px solid rgba(52,212,123,0.3);border-radius:10px;padding:1px 6px">Active</span>':''}</div>
          <div class="season-meta">${s.start?'DÃ©but: '+s.start:'Pas encore commencÃ©e'}${s.end?' Â· Fin: '+s.end:''} ${s.matchCount!==undefined?' Â· '+s.matchCount+' matchs':''}</div>
        </div>
      </div>`).join('');
  }
  // Audit
  const al = document.getElementById('audit-list');
  if (al) {
    al.innerHTML = !auditLog.length
      ? `<div class="empty" style="padding:1rem"><div class="empty-text">Aucune modification enregistrÃ©e</div></div>`
      : auditLog.map(e=>`<div class="audit-item"><span class="audit-time">${e.time}</span><span class="audit-icon">${e.icon}</span><span>${e.msg}</span></div>`).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('active'); }));
document.getElementById('soiree-overlay').addEventListener('click', e => { if(e.target===document.getElementById('soiree-overlay')) closeSoiree(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS & CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confetti() {
  const colors=['var(--primary)','#ff6b74','#4a9eff','#34d47b','#a67cf7','#f0534a'];
  for (let i=0;i<35;i++) setTimeout(()=>{
    const el=document.createElement('div');
    el.className='confetti-piece';
    el.style.left=Math.random()*100+'vw';
    el.style.top='-10px';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.transform=`rotate(${Math.random()*360}deg)`;
    el.style.animationDuration=(0.8+Math.random()*0.8)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1600);
  },i*25);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  recomputeElo();
  renderPlayers();
  renderSelects();
  renderMatches();
  renderMatchFilters();
  renderDashboard();
  updateSessionBar();
  updateHistPlayerFilter();
  renderHistorique();
  const _ap = document.querySelector('.page.active')?.id;
  if (_ap === 'page-classement') renderRanking();
  if (_ap === 'page-stats') { renderStats(); renderStatWidgets(); }
  if (_ap === 'page-calendrier') renderCalendrier();
  if (document.getElementById('tv-overlay')?.classList.contains('active')) renderTvMode();
  var tp = document.getElementById('tirage-panel');
  if (tp && tp.classList.contains('open')) renderPresenceGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIVISION SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDivision(elo) {
  if (elo >= 1400) return { name:'LÃ©gende', cls:'div-legend', icon:'ğŸ‘‘', min:1400, next:null };
  if (elo >= 1300) return { name:'Elite',   cls:'div-elite',  icon:'ğŸ’', min:1300, next:1400 };
  if (elo >= 1200) return { name:'Or',      cls:'div-gold',   icon:'ğŸ¥‡', min:1200, next:1300 };
  if (elo >= 1100) return { name:'Argent',  cls:'div-silver', icon:'ğŸ¥ˆ', min:1100, next:1200 };
  return              { name:'Bronze',  cls:'div-bronze', icon:'ğŸ¥‰', min:1000, next:1100 };
}
function divisionProgressBar(elo) {
  const d = getDivision(elo);
  if (!d.next) return '<div class="div-progress-wrap"><div class="div-progress-labels"><span>'+d.icon+' '+d.name+'</span><span style="color:var(--gold)">MAX ğŸ‘‘</span></div><div class="div-progress-bar"><div class="div-progress-fill '+d.cls+'-fill" style="width:100%"></div></div></div>';
  const pct = Math.min(100, Math.round((elo - d.min) / (d.next - d.min) * 100));
  const next = getDivision(d.next);
  return '<div class="div-progress-wrap"><div class="div-progress-labels"><span>'+d.icon+' '+d.name+'</span><span>'+next.icon+' '+next.name+' ('+d.next+')</span></div><div class="div-progress-bar"><div class="div-progress-fill '+d.cls+'-fill" style="width:'+pct+'%"></div></div></div>';
}
function divisionBadge(elo) {
  const d = getDivision(elo);
  return `<span class="division-badge ${d.cls}">${d.icon} ${d.name}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS AMÃ‰LIORÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNotif(msg, type) {
  document.querySelectorAll('.notif:not(.notif-undo)').forEach(n => n.remove());
  const el = document.createElement('div');
  let icon = 'âœ“', cls = '';
  if (type === 'win' || msg.includes('ğŸ†') || msg.includes('Victoire')) { icon = 'ğŸ†'; cls = 'notif-win'; }
  else if (type === 'error' || msg.includes('âš ') || msg.includes('âš ï¸')) { icon = 'âš ï¸'; cls = 'notif-error'; }
  else if (msg.includes('âœ“') || type === 'success') { icon = 'âœ“'; cls = 'notif-success'; }
  el.className = `notif ${cls}`;
  el.style.position = 'relative'; el.style.overflow = 'hidden';
  el.innerHTML = `<span class="notif-icon">${icon}</span><span class="notif-msg">${msg.replace(/^[âœ“âš ï¸ğŸ†âœ•ğŸ—‘ï¸]\s*/,'')}</span><div class="notif-progress"></div>`;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(20px)'; el.style.transition = 'all 0.3s ease'; setTimeout(() => el.remove(), 300); }, 2800);
}

function showNotifUndo(msg, onUndo) {
  document.querySelectorAll('.notif-undo').forEach(n => n.remove());
  const el = document.createElement('div');
  el.className = 'notif notif-undo';
  el.style.position = 'relative'; el.style.overflow = 'hidden';
  el.innerHTML = `<span class="notif-icon">ğŸ—‘ï¸</span><span class="notif-msg">${msg}</span><button class="notif-undo-btn" onclick="this.closest('.notif-undo')._undoFn()">ANNULER</button><div class="notif-progress"></div>`;
  const timer = setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(20px)'; el.style.transition='all 0.3s'; setTimeout(()=>el.remove(),300); }, 5000);
  el._undoFn = () => { clearTimeout(timer); onUndo(); el.remove(); };
  document.body.appendChild(el);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSessionBar() {
  const ms = document.getElementById('sess-matches');
  const ps = document.getElementById('sess-players');
  const ld = document.getElementById('sess-leader');
  const te = document.getElementById('sess-top-elo');
  if (ms) ms.textContent = matches.length;
  if (ps) ps.textContent = players.length;
  if (players.length && ld) {
    const top = [...players].sort((a,b) => b.elo - a.elo)[0];
    ld.textContent = top.pseudo;
    if (te) te.textContent = top.elo;
  } else {
    if (ld) ld.textContent = 'â€”';
    if (te) te.textContent = 'â€”';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMobileNav(page) {
  // Remove active from bottom nav buttons
  document.querySelectorAll('.mnav-btn').forEach(b => b.classList.remove('active'));
  // Remove active from more menu items
  document.querySelectorAll('.mobile-more-item').forEach(b => b.classList.remove('active-page'));

  const morePages = ['calendrier','historique','tournois','parametres','entrainement'];
  const btn = document.getElementById('mnav-' + page);
  if (btn) {
    btn.classList.add('active');
  }
  // If the active page is in the "more" menu, also highlight the "more" button
  if (morePages.includes(page)) {
    const moreBtn = document.getElementById('mnav-more');
    if (moreBtn) moreBtn.classList.add('active');
    // Also mark the specific item in the more menu
    const moreItem = document.getElementById('mnav-' + page);
    if (moreItem) moreItem.classList.add('active-page');
  }
}

function toggleMobileMore() {
  const menu = document.getElementById('mobile-more-menu');
  const backdrop = document.getElementById('mobile-more-backdrop');
  const isOpen = menu.classList.contains('active');
  if (isOpen) {
    closeMobileMore();
  } else {
    menu.classList.add('active');
    backdrop.classList.add('active');
    document.getElementById('mnav-more').classList.add('active');
  }
}

function closeMobileMore() {
  document.getElementById('mobile-more-menu').classList.remove('active');
  document.getElementById('mobile-more-backdrop').classList.remove('active');
  // Don't remove active from more btn if a more-page is currently active
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TV MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tvClockInterval = null;

function openTvMode() {
  document.getElementById('tv-overlay')?.classList.add('active');
  document.body.style.overflow = 'hidden';
  renderTvMode();
  // Clock
  tvClockInterval = setInterval(() => {
    const now = new Date();
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    const s = String(now.getSeconds()).padStart(2,'0');
    const el = document.getElementById('tv-clock');
    if (el) el.textContent = `${h}:${m}:${s}`;
  }, 1000);
  // Update clock immediately
  const now = new Date();
  document.getElementById('tv-clock').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  // Season name
  const s = seasons.find(x => x.active);
  if (s) document.getElementById('tv-season-name').textContent = s.name;
  document.getElementById('tv-match-count').textContent = `${matches.length} match${matches.length !== 1 ? 's' : ''} jouÃ©s`;
}

function closeTvMode() {
  document.getElementById('tv-overlay')?.classList.remove('active');
  document.body.style.overflow = '';
  if (tvClockInterval) { clearInterval(tvClockInterval); tvClockInterval = null; }
}

function renderTvMode() {
  if (!document.getElementById('tv-overlay')?.classList.contains('active')) return;
  recomputeElo();
  const sorted = [...players].sort((a,b) => b.elo - a.elo);
  const stats = getStats();

  // Ranking list
  const list = document.getElementById('tv-ranking-list');
  if (!sorted.length) {
    list.innerHTML = `<div style="color:var(--muted);font-size:1rem;text-align:center;padding:2rem">Aucun joueur enregistrÃ©</div>`;
  } else {
    list.innerHTML = sorted.map((p, i) => {
      const s = stats[p.id] || { wins:0, losses:0, draws:0, matches:0 };
      const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
      const div = getDivision(p.elo);
      const rankCls = i===0?'tv-rank-1':i===1?'tv-rank-2':i===2?'tv-rank-3':'';
      return `<div class="tv-rank-row ${rankCls}">
        <div class="tv-rank-num">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</div>
        <div>
          <div class="tv-rank-name">${p.pseudo} <span style="font-size:0.65rem;font-weight:400;opacity:0.7">${divisionBadge(p.elo)}</span></div>
          <div class="tv-rank-sub">${s.matches}M Â· ${pct}% vic Â· ${formDots(getRecentForm(p.id,5))}</div>
        </div>
        <div class="tv-rank-elo">${p.elo}</div>
        <div class="tv-rank-trend">${trendBadge(p.trend)}${sparkline(p.eloHistory,80,24)}</div>
      </div>`;
    }).join('');
  }

  // Podium
  const pod = document.getElementById('tv-podium');
  if (sorted.length >= 3) {
    const order = [sorted[1], sorted[0], sorted[2]];
    const clss = ['tv-p2','tv-p1','tv-p3'];
    pod.innerHTML = `<div class="tv-podium">${order.map((p,i) => `
      <div class="tv-podium-step ${clss[i]}">
        <div class="tv-pod-name">${p.pseudo}</div>
        <div class="tv-pod-elo">${p.elo}</div>
        <div class="tv-pod-bar"></div>
      </div>`).join('')}</div>`;
  } else { pod.innerHTML = `<div style="color:var(--muted);font-size:0.85rem">Pas assez de joueurs</div>`; }

  // Last match
  const lm = document.getElementById('tv-last-match');
  if (!matches.length) {
    lm.innerHTML = `<div style="color:var(--muted);font-size:0.85rem;text-align:center;padding:1rem">Aucun match jouÃ©</div>`;
  } else {
    const m = matches[0];
    const p1 = pById(m.p1), p2 = pById(m.p2);
    const wId = m.winner;
    lm.innerHTML = `<div class="tv-last-match">
      <div style="font-size:0.62rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:0.4rem">${m.date}</div>
      <div class="tv-match-players">
        <div class="tv-match-player" style="${wId===m.p1?'opacity:1':'opacity:0.5'}">
          <div class="tv-match-name" style="${wId===m.p1?'color:var(--accent)':'color:var(--text-dim)'}">${p1?p1.pseudo:'?'}</div>
          <div class="tv-match-elo">${p1 ? divisionBadge(p1.elo) : ''}</div>
        </div>
        <div class="tv-match-score">${m.s1} â€” ${m.s2}</div>
        <div class="tv-match-player" style="${wId===m.p2?'opacity:1':'opacity:0.5'}">
          <div class="tv-match-name" style="${wId===m.p2?'color:var(--accent)':'color:var(--text-dim)'}">${p2?p2.pseudo:'?'}</div>
          <div class="tv-match-elo">${p2 ? divisionBadge(p2.elo) : ''}</div>
        </div>
      </div>
      ${wId ? `<div class="tv-winner-banner">ğŸ† ${pName(wId)} remporte la partie</div>` : '<div class="tv-winner-banner" style="color:var(--muted)">Ã‰galitÃ©</div>'}
    </div>`;
  }
}

// Auto-refresh TV when matches change
const _origAddMatch = typeof addMatch !== 'undefined' ? null : null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIQUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let histTab = 'all';

function setHistTab(tab, el) {
  histTab = tab;
  document.querySelectorAll('.hist-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderHistorique();
}

function renderHistorique(searchVal) {
  const container = document.getElementById('historique-timeline');
  if (!container) return;

  const filterPlayer = parseInt(document.getElementById('hist-player-filter')?.value) || null;
  const filterFormat = document.getElementById('hist-format-filter')?.value || null;
  const searchTerm = searchVal !== undefined ? searchVal.toLowerCase()
    : (document.getElementById('hist-search-input') ? document.getElementById('hist-search-input').value.toLowerCase() : '');

  let filtered = [...matches];
  if (filterPlayer) filtered = filtered.filter(m => m.p1 === filterPlayer || m.p2 === filterPlayer);
  if (filterFormat) filtered = filtered.filter(m => (m.format||'sets') === filterFormat);
  if (searchTerm) {
    filtered = filtered.filter(function(m) {
      return pName(m.p1).toLowerCase().includes(searchTerm)
        || pName(m.p2).toLowerCase().includes(searchTerm)
        || (m.s1+'-'+m.s2).includes(searchTerm)
        || (m.game||'').toLowerCase().includes(searchTerm)
        || (m.comment||'').toLowerCase().includes(searchTerm)
        || (m.tags||[]).some(t=>t.toLowerCase().includes(searchTerm));
    });
  }
  if (histTab === 'wins') {
    const pid = filterPlayer;
    if (pid) filtered = filtered.filter(m => m.winner === pid);
    else filtered = filtered.filter(m => m.winner);
  } else if (histTab === 'close') {
    filtered = filtered.filter(m => Math.abs((m.s1||0)-(m.s2||0)) <= 1 && m.s1+m.s2 >= 2);
  } else if (histTab === 'perfect') {
    filtered = filtered.filter(m => (m.s1 >= 3 && m.s2 === 0) || (m.s2 >= 3 && m.s1 === 0));
  }

  const countEl = document.getElementById('hist-count');
  if (countEl) countEl.textContent = `${filtered.length} match${filtered.length !== 1 ? 's' : ''}`;

  if (!filtered.length) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Aucun match trouvÃ©</div></div>`;
    return;
  }

  // Group by date
  const byDate = {};
  filtered.forEach(m => {
    const d = m.date || 'Date inconnue';
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(m);
  });

  container.innerHTML = Object.entries(byDate).map(([date, dayMatches]) => {
    return `<div class="hist-day-group">
      <div class="hist-day-label">${date} <span style="color:var(--accent);font-weight:700">${dayMatches.length} match${dayMatches.length > 1 ? 's' : ''}</span></div>
      ${dayMatches.map(m => {
        const p1 = pById(m.p1), p2 = pById(m.p2);
        const fp = filterPlayer;
        const isWin = m.winner === fp || (fp && m.winner === fp);
        const isDraw = !m.winner;
        const e1 = m.eloChange1 || 0, e2 = m.eloChange2 || 0;
        let cardCls = isDraw ? 'hm-draw' : (m.winner ? 'hm-win' : '');
        return `<div class="hist-match-card ${cardCls}">
          <div class="hm-player-a">
            <div class="hm-pname ${m.winner===m.p1?'winner':m.winner===m.p2?'loser':''}">${p1?p1.pseudo:'?'}</div>
            <div class="hm-elo-change" style="color:${e1>=0?'var(--green)':'var(--red)'}">${e1>=0?'+':''}${e1} ELO</div>
          </div>
          <div class="hm-score-box">${m.s1} â€” ${m.s2}</div>
          <div class="hm-player-b">
            <div class="hm-pname ${m.winner===m.p2?'winner':m.winner===m.p1?'loser':''}">${p2?p2.pseudo:'?'}</div>
            <div class="hm-elo-change" style="color:${e2>=0?'var(--green)':'var(--red)'}">${e2>=0?'+':''}${e2} ELO</div>
          </div>
          ${m.winner ? `<div style="font-size:0.7rem;font-weight:700;color:var(--accent);flex-shrink:0">ğŸ†</div>` : `<div style="font-size:0.7rem;color:var(--muted);flex-shrink:0">â€”</div>`}
          ${m.tags&&m.tags.length ? `<div style="display:flex;gap:3px;flex-shrink:0">${m.tags.map(t=>{const h=MATCH_HIGHLIGHTS.find(x=>x.id===t);return h?`<span title="${h.label}" style="font-size:0.85rem">${h.icon}</span>`:''}).join('')}</div>` : ''}
          <button class="hm-del" onclick="openMatchHighlightModal(${m.id})" style="background:rgba(245,197,24,0.1);border-color:rgba(245,197,24,0.3);color:var(--gold)" title="Highlights">â­</button>
          <button class="hm-del" onclick="deleteMatch(${m.id})">âœ•</button>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
}

function updateHistPlayerFilter() {
  const sel = document.getElementById('hist-player-filter');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">Tous les joueurs</option>' + players.map(p => `<option value="${p.id}">${p.pseudo}</option>`).join('');
  sel.value = cur;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS WIDGETS AVANCÃ‰S
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStatWidgets() {
  const el = document.getElementById('stat-widgets-top');
  if (!el) return;
  const stats = getStats();
  const sorted = [...players].sort((a,b) => b.elo - a.elo);
  if (!sorted.length) { el.innerHTML = ''; return; }

  // 1. Classement division
  const divWidget = `<div class="stat-widget">
    <div class="sw-title">Divisions</div>
    ${sorted.slice(0,5).map((p,i) => {
      const div = getDivision(p.elo);
      return `<div class="sw-player-row">
        <span class="sw-rank">${i+1}</span>
        <span class="sw-name">${p.pseudo}</span>
        <span>${divisionBadge(p.elo)}</span>
        <span class="sw-val" style="color:var(--accent)">${p.elo}</span>
      </div>`;
    }).join('')}
  </div>`;

  // 2. Meilleures sÃ©ries
  const streakWidget = `<div class="stat-widget">
    <div class="sw-title">Forme RÃ©cente (10 matchs)</div>
    ${sorted.slice(0,5).map(p => {
      const form = getRecentForm(p.id, 10);
      const wins = form.filter(r => r==='W').length;
      return `<div class="sw-player-row">
        <span class="sw-rank" style="width:auto;font-size:0.75rem;font-weight:700;color:var(--text-dim)">${p.pseudo}</span>
        <div class="streak-bar">${form.map(r => `<div class="streak-seg ${r==='W'?'w':r==='L'?'l':''}"></div>`).join('')}</div>
        <span class="sw-val" style="color:${wins>=7?'var(--green)':wins>=4?'var(--accent)':'var(--red)'}">${wins}/${form.length}</span>
      </div>`;
    }).join('')}
  </div>`;

  // 3. ActivitÃ©
  const actSorted = [...players].sort((a,b) => (stats[b.id]?.matches||0) - (stats[a.id]?.matches||0));
  const maxM = (stats[actSorted[0]?.id]?.matches||1);
  const actWidget = `<div class="stat-widget">
    <div class="sw-title">ActivitÃ© (matchs jouÃ©s)</div>
    ${actSorted.slice(0,5).map((p,i) => {
      const m = stats[p.id]?.matches || 0;
      return `<div class="sw-player-row">
        <span class="sw-rank">${i+1}</span>
        <span class="sw-name">${p.pseudo}</span>
        <div style="flex:1;background:var(--border);border-radius:3px;height:5px;overflow:hidden"><div style="height:100%;width:${maxM?m/maxM*100:0}%;background:var(--blue);border-radius:3px"></div></div>
        <span class="sw-val" style="color:var(--blue)">${m}</span>
      </div>`;
    }).join('')}
  </div>`;

  // 4. Peak ELO
  const peakSorted = [...players].sort((a,b) => (b.peak||b.elo) - (a.peak||a.elo));
  const peakWidget = `<div class="stat-widget">
    <div class="sw-title">Records ELO (Peak)</div>
    ${peakSorted.slice(0,5).map((p,i) => {
      return `<div class="sw-player-row">
        <span class="sw-rank">${i+1}</span>
        <span class="sw-name">${p.pseudo}</span>
        ${sparkline(p.eloHistory, 70, 20)}
        <span class="sw-val" style="color:var(--gold)">${p.peak||p.elo}</span>
      </div>`;
    }).join('')}
  </div>`;

  el.innerHTML = divWidget + streakWidget + actWidget + peakWidget;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLUB SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATAR_COLORS = ['var(--primary)','#4a9eff','#34d47b','#f0534a','#a67cf7','#ff7f50','#16c9aa','#f472b6'];

function applyClubSettings() {
  const s = clubSettings;

  // â”€â”€ Nom dans l'en-tÃªte â”€â”€
  const lt = document.querySelector('.logo-text');
  if (lt) lt.textContent = s.name || 'FlÃ©chettes Club';

  // â”€â”€ Logo : image custom OU emoji â”€â”€
  const li = document.querySelector('.logo-icon');
  if (li) {
    if (s.clubImage) {
      // Remplace le contenu par une image
      li.innerHTML = `<img src="${s.clubImage}" style="width:100%;height:100%;object-fit:contain;border-radius:7px" alt="Logo">`;
    } else {
      li.innerHTML = s.logo || 'ğŸ¯';
    }
  }

  // â”€â”€ Couleur d'accent â”€â”€
  if (s.accent) {
    const r = document.documentElement;
    r.style.setProperty('--accent', s.accent);
    r.style.setProperty('--accent2', s.accent + 'dd');
    const hex = s.accent.replace('#','');
    const rr = parseInt(hex.slice(0,2),16)||230, gg = parseInt(hex.slice(2,4),16)||57, bb = parseInt(hex.slice(4,6),16)||70;
    r.style.setProperty('--accent-dim',  `rgba(${rr},${gg},${bb},0.12)`);
    r.style.setProperty('--accent-glow', `rgba(${rr},${gg},${bb},0.25)`);
    r.style.setProperty('--gold',        s.accent);
    r.style.setProperty('--gold-bg',     `rgba(${rr},${gg},${bb},0.15)`);
  }

  // â”€â”€ TV logo â”€â”€
  const tvl = document.getElementById('tv-logo-text');
  if (tvl) tvl.textContent = (s.logo || 'ğŸ¯') + ' ' + (s.name || 'FlÃ©chettes Club');

  // â”€â”€ Image de fond â”€â”€
  applyBgImage();

  // â”€â”€ ThÃ¨me de fond (couleurs surfaces) â”€â”€
  if (s.bgTheme) {
    const r = document.documentElement;
    r.style.setProperty('--dark',       s.bgTheme.bg);
    r.style.setProperty('--dark-light', s.bgTheme.surface);
    r.style.setProperty('--dark-card',  s.bgTheme.card);
    r.style.setProperty('--dark-hover', s.bgTheme.card);
    r.style.setProperty('--bg',         s.bgTheme.bg);
    r.style.setProperty('--surface',    s.bgTheme.surface);
    r.style.setProperty('--surface2',   s.bgTheme.card);
    r.style.setProperty('--surface3',   s.bgTheme.card);
    // Mark active bg btn
    document.querySelectorAll('.bg-theme-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.bg === s.bgTheme.bg);
    });
  }
}

function setClubColor(color, btn) {
  document.querySelectorAll('.club-color-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  clubSettings.accent = color;
  // Sync custom picker
  const picker = document.getElementById('custom-accent-picker');
  const hexLabel = document.getElementById('custom-accent-hex');
  if (picker && color.startsWith('#')) { picker.value = color; }
  if (hexLabel) hexLabel.textContent = color;
  save();
  applyClubSettings();
  showNotif('âœ“ Couleur mise Ã  jour !', 'success');
}

function setClubColorCustom(color) {
  document.querySelectorAll('.club-color-btn').forEach(b => b.classList.remove('active'));
  const hexLabel = document.getElementById('custom-accent-hex');
  if (hexLabel) hexLabel.textContent = color;
  clubSettings.accent = color;
  save();
  applyClubSettings();
}

function setBgTheme(btn) {
  document.querySelectorAll('.bg-theme-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const bg      = btn.dataset.bg;
  const surface = btn.dataset.surface;
  const card    = btn.dataset.card;
  const r = document.documentElement;
  r.style.setProperty('--dark',       bg);
  r.style.setProperty('--dark-light', surface);
  r.style.setProperty('--dark-card',  card);
  r.style.setProperty('--dark-hover', card + 'cc');
  r.style.setProperty('--bg',         bg);
  r.style.setProperty('--surface',    surface);
  r.style.setProperty('--surface2',   card);
  r.style.setProperty('--surface3',   card + 'cc');
  clubSettings.bgTheme = { bg, surface, card };
  save();
  showNotif('âœ“ Fond mis Ã  jour !', 'success');
}

function applyFullTheme(name) {
  const themes = {
    classic:  { accent:'#e63946', bg:'#0d0f14', surface:'#161b26', card:'#1c2333' },
    ice:      { accent:'#4a9eff', bg:'#0d1117', surface:'#0e1c2e', card:'#132030' },
    forest:   { accent:'#34d47b', bg:'#0a1a0f', surface:'#122213', card:'#1e3320' },
    gold:     { accent:'#f5c518', bg:'#12100e', surface:'#1c1a16', card:'#2a2620' },
    purple:   { accent:'#a67cf7', bg:'#1a0a2e', surface:'#2d1b4e', card:'#3d2060' },
    fire:     { accent:'#ff6348', bg:'#1a0d0d', surface:'#2a1212', card:'#3a1a1a' },
    midnight: { accent:'#6c5ce7', bg:'#080a0f', surface:'#0f1318', card:'#141820' },
    ocean:    { accent:'#16c9aa', bg:'#0d1b2a', surface:'#1b263b', card:'#415a77' },
  };
  const t = themes[name]; if (!t) return;
  // Apply accent
  document.querySelectorAll('.club-color-btn').forEach(b => b.classList.remove('active'));
  const matchBtn = document.querySelector(`.club-color-btn[data-color="${t.accent}"]`);
  if (matchBtn) matchBtn.classList.add('active');
  clubSettings.accent = t.accent;
  // Apply bg
  const r = document.documentElement;
  r.style.setProperty('--dark',       t.bg);
  r.style.setProperty('--dark-light', t.surface);
  r.style.setProperty('--dark-card',  t.card);
  r.style.setProperty('--dark-hover', t.card);
  r.style.setProperty('--bg',         t.bg);
  r.style.setProperty('--surface',    t.surface);
  r.style.setProperty('--surface2',   t.card);
  r.style.setProperty('--surface3',   t.card);
  // Mark bg btn
  document.querySelectorAll('.bg-theme-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.bg === t.bg);
  });
  // Picker sync
  const picker = document.getElementById('custom-accent-picker');
  if (picker) picker.value = t.accent;
  const hexLabel = document.getElementById('custom-accent-hex');
  if (hexLabel) hexLabel.textContent = t.accent;
  clubSettings.bgTheme = { bg: t.bg, surface: t.surface, card: t.card };
  save();
  applyClubSettings();
  showNotif('âœ“ ThÃ¨me appliquÃ© !', 'success');
}

function previewClubName() {
  const val = document.getElementById('club-name-input')?.value;
  if (val) { const lt = document.querySelector('.logo-text'); if (lt) lt.textContent = val; }
}
function saveClubName() {
  const val = document.getElementById('club-name-input')?.value.trim();
  if (val) { clubSettings.name = val; save(); showNotif('âœ“ Nom du club mis Ã  jour !', 'success'); }
}

function initClubSettings() {
  const ni = document.getElementById('club-name-input');
  if (ni) ni.value = clubSettings.name || 'FlÃ©chettes Club';

  const lp = document.getElementById('club-logo-preview');
  if (lp) lp.textContent = clubSettings.logo || 'ğŸ¯';

  // Highlight current color
  document.querySelectorAll('.club-color-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.color === clubSettings.accent);
  });
  // Sync custom picker
  const picker = document.getElementById('custom-accent-picker');
  if (picker && clubSettings.accent && clubSettings.accent.startsWith('#')) picker.value = clubSettings.accent;
  const hexLabel = document.getElementById('custom-accent-hex');
  if (hexLabel && clubSettings.accent) hexLabel.textContent = clubSettings.accent;

  // Build logo emoji picker
  const row = document.getElementById('logo-emoji-row');
  if (row) {
    const emojis = ['ğŸ¯','ğŸ¹','ğŸ³','ğŸ²','ğŸ†','ğŸ¥Š','âš¡','ğŸ”¥','ğŸ’','â­','ğŸŒŸ','ğŸª'];
    row.innerHTML = emojis.map(e => `<span class="logo-emoji-opt ${e===clubSettings.logo?'selected':''}" onclick="setClubLogo('${e}',this)">${e}</span>`).join('');
  }

  // Restore club image preview
  const clubImgWrap = document.getElementById('club-img-preview-wrap');
  const clubImgEl   = document.getElementById('club-img-preview');
  if (clubSettings.clubImage) {
    if (clubImgEl)  clubImgEl.src = clubSettings.clubImage;
    if (clubImgWrap) clubImgWrap.style.display = 'flex';
  } else {
    if (clubImgWrap) clubImgWrap.style.display = 'none';
  }

  // Restore background image preview
  const bgImgWrap = document.getElementById('bg-img-preview-wrap');
  const bgImgEl   = document.getElementById('bg-img-preview');
  const bgSlider  = document.getElementById('bg-opacity-slider');
  if (clubSettings.bgImage) {
    if (bgImgEl)   bgImgEl.src = clubSettings.bgImage;
    if (bgImgWrap) bgImgWrap.style.display = 'flex';
    if (bgSlider)  bgSlider.value = clubSettings.bgOpacity != null ? clubSettings.bgOpacity : 8;
  } else {
    if (bgImgWrap) bgImgWrap.style.display = 'none';
  }

  applyClubSettings();
}

function setClubLogo(emoji, el) {
  document.querySelectorAll('.logo-emoji-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  clubSettings.logo = emoji;
  const lp = document.getElementById('club-logo-preview');
  if (lp) lp.textContent = emoji;
  save(); applyClubSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _editingPlayerId = null;

function openProfile(pid, event) {
  if (event) { event.stopPropagation(); }
  const p = pById(pid);
  if (!p) return;
  _editingPlayerId = pid;
  const stats = getStats();
  const s = stats[pid] || {wins:0,losses:0,draws:0,matches:0};
  const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
  const color = p.avatarColor || clubSettings.accent || 'var(--primary)';
  const emoji = p.avatarEmoji || '';
  const initials = getInitials(p.name);

  // Hero
  const hero = document.getElementById('profile-hero');
  hero.style.setProperty('--player-color', color + '30');
  const av = document.getElementById('profile-avatar-big');
  if (p.avatarPhoto) {
    av.style.padding = '0';
    av.innerHTML = `<img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit">`;
  } else {
    av.style.background = `linear-gradient(135deg, ${color}, ${color}99)`;
    av.style.color = '#0d0f14';
    av.innerHTML = '';
    av.textContent = emoji || initials;
  }
  // Show photo preview
  const photoPreview = document.getElementById('profile-photo-preview');
  if (photoPreview) {
    if (p.avatarPhoto) {
      photoPreview.innerHTML = `<img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`;
    } else {
      photoPreview.innerHTML = 'Aucune';
    }
  }

  document.getElementById('profile-pseudo-big').textContent = p.pseudo;
  document.getElementById('profile-name-big').textContent = p.name;
  document.getElementById('profile-surnom-display').textContent = p.surnom ? `"${p.surnom}"` : '';
  document.getElementById('profile-elo-hero').textContent = p.elo;
  document.getElementById('profile-division-hero').innerHTML = divisionBadge(p.elo);

  // Stats
  document.getElementById('profile-stats-row').innerHTML = [
    {val: s.matches, lbl: 'Matchs'},
    {val: s.wins, lbl: 'Victoires'},
    {val: pct+'%', lbl: '% Victoires'},
    {val: p.peak||p.elo, lbl: 'Peak ELO'},
    ...(s.avg3d > 0 ? [{val: s.avg3d, lbl: 'âš¡ Moy. 3D'}] : []),
    ...(s.checkoutPct > 0 ? [{val: s.checkoutPct+'%', lbl: 'ğŸ¯ CO%'}] : []),
    ...(s.dpl > 0 ? [{val: s.dpl, lbl: 'ğŸ² Darts/leg'}] : []),
  ].map(({val,lbl}) => `<div class="profile-stat-box"><div class="profile-stat-val">${val}</div><div class="profile-stat-lbl">${lbl}</div></div>`).join('');

  // Inputs
  document.getElementById('profile-surnom-input').value = p.surnom || '';
  document.getElementById('profile-bio-input').value = p.bio || '';

  // Color swatches
  document.querySelectorAll('.avatar-color-swatch').forEach(sw => {
    sw.classList.toggle('selected', sw.dataset.c === color);
  });

  // Emoji buttons - show initials in first button
  const emojiPicker = document.getElementById('avatar-emoji-picker');
  const firstBtn = emojiPicker.querySelector('[data-e=""]');
  if (firstBtn) firstBtn.textContent = initials;
  document.querySelectorAll('.avatar-emoji-btn').forEach(b => {
    b.classList.toggle('selected', b.dataset.e === (p.avatarEmoji||''));
  });

  // Sparkline
  document.getElementById('profile-sparkline-big').innerHTML = sparkline(p.eloHistory, 200, 60);

  // Form dots
  document.getElementById('profile-form-dots').innerHTML = formDots(getRecentForm(pid, 10));

  // Trophies
  const tr = (p.achievements||[]).map(aid => {
    const a = ACHIEVEMENTS.find(x=>x.id===aid);
    return a ? `<span title="${a.name}: ${a.desc}">${a.icon}</span>` : '';
  }).join('');
  document.getElementById('profile-trophies').innerHTML = tr || `<span style="font-size:0.75rem;color:var(--muted)">Aucun trophÃ©e pour l'instant</span>`;

  // Load default tab content (stats tab is default, already populated)
  // Reset to stats tab
  document.querySelectorAll('.profile-tab').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('.profile-tab-content').forEach(function(c){ c.classList.remove('active'); });
  var firstTab = document.querySelector('.profile-tab');
  var firstContent = document.getElementById('profile-tab-stats');
  if (firstTab) firstTab.classList.add('active');
  if (firstContent) firstContent.classList.add('active');

  // Enrich stats tab with additional info
  var statsTab = document.getElementById('profile-tab-stats');
  if (statsTab) {
    // Add best visit and 180s if available
    var extraStats = '';
    if (p.total180s || p.totalCheckouts || p.bestVisit) {
      var pff = "font-family:'Bebas Neue', sans-serif";
      extraStats = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.6rem;margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid var(--border)">'
        + (p.total180s ? '<div style="text-align:center"><div style="font-size:1.3rem;font-weight:700;color:var(--accent);' + pff + '">' + p.total180s + '</div><div style="font-size:0.65rem;color:var(--muted)">Ã— 180</div></div>' : '')
        + (p.totalCheckouts ? '<div style="text-align:center"><div style="font-size:1.3rem;font-weight:700;color:var(--green);' + pff + '">' + p.totalCheckouts + '</div><div style="font-size:0.65rem;color:var(--muted)">Checkouts</div></div>' : '')
        + (p.bestVisit ? '<div style="text-align:center"><div style="font-size:1.3rem;font-weight:700;color:var(--blue);' + pff + '">' + p.bestVisit + '</div><div style="font-size:0.65rem;color:var(--muted)">Meilleure volÃ©e</div></div>' : '')
        + '</div>';
    }
    if (extraStats) {
      var existingExtra = statsTab.querySelector('.profile-extra-stats');
      if (!existingExtra) {
        var extraDiv = document.createElement('div');
        extraDiv.className = 'profile-extra-stats';
        extraDiv.innerHTML = extraStats;
        var formSection = statsTab.querySelector('.profile-section');
        if (formSection) statsTab.insertBefore(extraDiv, formSection);
      }
    }
  }

  openModal('profile-modal');
}

function selectAvatarColor(color, btn) {
  document.querySelectorAll('.avatar-color-swatch').forEach(s => s.classList.remove('selected'));
  btn.classList.add('selected');
  // Live preview
  const p = pById(_editingPlayerId);
  const av = document.getElementById('profile-avatar-big');
  av.style.background = `linear-gradient(135deg, ${color}, ${color}99)`;
  const hero = document.getElementById('profile-hero');
  hero.style.setProperty('--player-color', color + '30');
}

function selectAvatarEmoji(emoji, btn) {
  document.querySelectorAll('.avatar-emoji-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  const p = pById(_editingPlayerId);
  const av = document.getElementById('profile-avatar-big');
  av.textContent = emoji || getInitials(p?.name||'');
}

function previewProfile() {
  const surnom = document.getElementById('profile-surnom-input')?.value;
  const sd = document.getElementById('profile-surnom-display');
  if (sd) sd.textContent = surnom ? `"${surnom}"` : '';
}

function handleProfilePhotoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 500000) { showNotif('âš  Photo trop lourde (max 500 KB)', 'error'); return; }
  const reader = new FileReader();
  reader.onload = function(ev) {
    const dataUrl = ev.target.result;
    // Preview
    const preview = document.getElementById('profile-photo-preview');
    if (preview) { preview.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`; }
    // Store on player object
    const p = pById(_editingPlayerId);
    if (p) {
      p._pendingPhoto = dataUrl;
      // Also update big avatar preview
      const av = document.getElementById('profile-avatar-big');
      if (av) {
        av.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit">`;
        av.style.padding = '0';
      }
    }
  };
  reader.readAsDataURL(file);
}

function clearProfilePhoto() {
  const p = pById(_editingPlayerId);
  if (p) { p._pendingPhoto = null; p.avatarPhoto = null; }
  const preview = document.getElementById('profile-photo-preview');
  if (preview) preview.innerHTML = 'Aucune';
  // Restore initials avatar
  previewProfile();
}

function saveProfile() {
  requirePassword('ğŸ”’ Modifier un joueur', () => _doSaveProfile());
}
function _doSaveProfile() {
  const p = pById(_editingPlayerId);
  if (!p) return;
  p.surnom = document.getElementById('profile-surnom-input').value.trim();
  p.bio = document.getElementById('profile-bio-input').value.trim();
  // Color
  const colorSel = document.querySelector('.avatar-color-swatch.selected');
  if (colorSel) p.avatarColor = colorSel.dataset.c;
  // Emoji
  const emojiSel = document.querySelector('.avatar-emoji-btn.selected');
  if (emojiSel) p.avatarEmoji = emojiSel.dataset.e;
  // Photo
  if (p._pendingPhoto !== undefined) {
    p.avatarPhoto = p._pendingPhoto;
    delete p._pendingPhoto;
  }
  save(); renderPlayers();
  closeModal('profile-modal');
  showNotif('âœ“ Profil mis Ã  jour !', 'success');
}

function exportPlayerCard() {
  const p = pById(_editingPlayerId);
  if (!p) return;
  const stats = getStats();
  const s = stats[p.id] || {wins:0,losses:0,draws:0,matches:0};
  const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
  const color = p.avatarColor || clubSettings.accent || 'var(--primary)';
  const div = getDivision(p.elo);
  const initials = p.avatarEmoji || getInitials(p.name);

  const win = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;600;700&family=DM+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#111; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  .card {
    width: 340px; height: 520px; border-radius: 20px;
    background: linear-gradient(145deg, #0d1117 0%, #1a2035 60%, #0d1117 100%);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 28px; position: relative; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.05);
    font-family: 'Work Sans', sans-serif; color: white;
    display: flex; flex-direction: column;
  }
  .glow { position:absolute; top:-60px; right:-60px; width:200px; height:200px; border-radius:50%;
    background: radial-gradient(${color}44, transparent 70%); pointer-events:none; }
  .glow2 { position:absolute; bottom:-40px; left:-40px; width:150px; height:150px; border-radius:50%;
    background: radial-gradient(${color}22, transparent 70%); pointer-events:none; }
  .club-name { font-size:10px; letter-spacing:3px; text-transform:uppercase; color:rgba(255,255,255,0.35); margin-bottom:20px; }
  .avatar { width:70px; height:70px; border-radius:16px; background:linear-gradient(135deg,${color},${color}88);
    display:flex; align-items:center; justify-content:center; font-size:1.8rem; font-weight:800;
    color:#0d0f14; margin-bottom:14px; border:2px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 20px ${color}44; }
  .pseudo { font-family:'Bebas Neue', sans-serif; font-size:24px; font-weight:800; margin-bottom:3px; }
  .fullname { font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:6px; }
  .surnom { font-size:12px; font-style:italic; color:${color}; margin-bottom:16px; }
  .elo-row { display:flex; align-items:baseline; gap:10px; margin-bottom:6px; }
  .elo-num { font-family:'Bebas Neue', sans-serif; font-size:42px; font-weight:800; color:${color};
    line-height:1; text-shadow: 0 0 30px ${color}66; }
  .elo-label { font-size:11px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.35); }
  .div-badge { display:inline-block; font-size:11px; font-weight:700; padding:3px 10px; border-radius:20px;
    background:${color}22; color:${color}; border:1px solid ${color}44; letter-spacing:1px; text-transform:uppercase; margin-bottom:20px; }
  .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:auto; }
  .stat { background:rgba(255,255,255,0.05); border-radius:10px; padding:10px 8px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
  .stat-val { font-family:'DM Mono',monospace; font-size:18px; font-weight:500; color:${color}; }
  .stat-lbl { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.35); margin-top:3px; }
  .season-badge { position:absolute; top:20px; right:20px; font-size:10px; font-weight:700;
    letter-spacing:1.5px; color:rgba(255,255,255,0.25); text-transform:uppercase; }
  .bio { font-size:11px; color:rgba(255,255,255,0.4); font-style:italic; margin-bottom:14px; line-height:1.5; }
  
/* â”€â”€ Ã‰QUIPES â”€â”€ */
.team-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;transition:all .15s; }
.team-card:hover { border-color:var(--border2); }
.team-name { font-weight:700;font-size:0.95rem;margin-bottom:0.3rem; }
.team-badge { display:inline-flex;align-items:center;gap:4px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 8px;font-size:0.68rem;color:var(--muted); }
.team-stat { font-family:'DM Mono',monospace;font-weight:700; }
.team-standings-table { width:100%;border-collapse:collapse; }
.team-standings-table th { text-align:left;font-size:0.6rem;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--muted);padding:0.5rem 0.8rem;border-bottom:1px solid var(--border);background:var(--surface2); }
.team-standings-table td { padding:0.7rem 0.8rem;border-bottom:1px solid var(--border);vertical-align:middle; }
.team-standings-table tr:last-child td { border-bottom:none; }
.team-standings-table tbody tr:hover td { background:var(--surface2); }

/* â”€â”€ DÃ‰FIS â”€â”€ */
.defi-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:0.9rem 1rem;display:flex;align-items:center;gap:0.8rem;transition:border .15s; }
.defi-card.pending { border-color:rgba(230, 57, 70, 0.35); }
.defi-card.accepted { border-color:rgba(52,212,123,0.35); }
.defi-card.refused { border-color:rgba(240,83,74,0.25);opacity:.6; }
.defi-card.done { border-color:rgba(74,158,255,0.25);opacity:.7; }
.defi-icon { font-size:1.4rem;flex-shrink:0; }
.defi-info { flex:1;min-width:0; }
.defi-title { font-weight:700;font-size:0.85rem; }
.defi-meta { font-size:0.68rem;color:var(--muted);margin-top:2px; }
.defi-actions { display:flex;gap:0.4rem;flex-shrink:0; }
.defi-badge { display:inline-block;padding:2px 8px;border-radius:20px;font-size:0.62rem;font-weight:700;letter-spacing:.8px; }
.defi-badge.pending { background:var(--gold-bg);color:var(--accent); }
.defi-badge.accepted { background:var(--green-bg);color:var(--green); }
.defi-badge.done { background:rgba(74,158,255,.12);color:var(--blue); }
.defi-badge.refused { background:var(--red-bg);color:var(--red); }

/* â”€â”€ PROGRAMME ENTRAÃNEMENT â”€â”€ */
.prog-card { background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:all .18s;position:relative; }
.prog-card:hover { border-color:var(--accent);box-shadow:0 4px 24px rgba(230, 57, 70, 0.12),var(--shadow-glow);transform:translateY(-1px); }
.prog-card.active-prog { border-color:var(--accent);background:linear-gradient(135deg,rgba(230, 57, 70, 0.06),rgba(230, 57, 70, 0.02)); }
.prog-card.active-prog::before { content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--green)); }
.prog-header { padding:1.1rem 1.1rem 0.9rem;display:flex;align-items:flex-start;gap:0.8rem; }
.prog-icon-wrap { width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0; }
.prog-icon-wrap.lv-debutant { background:rgba(52,212,123,0.12);border:1px solid rgba(52,212,123,0.25); }
.prog-icon-wrap.lv-intermediaire { background:rgba(230, 57, 70, 0.12);border:1px solid rgba(230, 57, 70, 0.25); }
.prog-icon-wrap.lv-avance { background:rgba(240,83,74,0.12);border:1px solid rgba(240,83,74,0.25); }
.prog-title { font-weight:800;font-size:0.92rem;line-height:1.2; }
.prog-subtitle { font-size:0.68rem;color:var(--muted);margin-top:3px; }
.prog-active-badge { display:inline-block;padding:2px 8px;border-radius:20px;font-size:0.6rem;font-weight:700;letter-spacing:1px;background:var(--gold-bg);color:var(--accent);border:1px solid rgba(230, 57, 70, 0.3);margin-top:4px; }
.prog-body { padding:0 1.1rem 1.1rem; }
.prog-dots-row { display:flex;align-items:center;gap:3px;flex-wrap:wrap;margin-bottom:0.5rem; }
.prog-dot { width:11px;height:11px;border-radius:50%;flex-shrink:0;transition:all .15s; }
.prog-dot.done  { background:var(--green);box-shadow:0 0 4px rgba(52,212,123,0.4); }
.prog-dot.today { background:var(--accent);box-shadow:0 0 6px rgba(230, 57, 70, 0.5);transform:scale(1.2); }
.prog-dot.active-day { background:var(--surface3);border:1.5px solid var(--accent); }
.prog-dot.rest  { background:transparent;border:1px dashed var(--border); }
.prog-dot.pending { background:var(--surface3);border:1px solid var(--border); }
.prog-progress { height:5px;background:var(--surface3);border-radius:3px;margin:0.6rem 0 0.3rem;overflow:hidden; }
.prog-progress-fill { height:100%;border-radius:3px;transition:width .4s;background:linear-gradient(90deg,var(--accent),var(--green)); }
.prog-week-label { font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted); }
/* Detail view */
.prog-detail-card { background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:1.2rem; }
.prog-detail-header { padding:1rem 1.2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,rgba(230, 57, 70, 0.06),transparent); }
.prog-week-section { padding:0.8rem 1.2rem;border-bottom:1px solid var(--border); }
.prog-week-section:last-child { border-bottom:none; }
.prog-week-title { font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:0.6rem;display:flex;align-items:center;gap:6px; }
.prog-week-done-tag { background:var(--green-bg);color:var(--green);border:1px solid rgba(52,212,123,.3);border-radius:20px;padding:1px 8px;font-size:0.58rem; }
.prog-day-row { display:flex;align-items:center;gap:0.6rem;padding:5px 4px;border-radius:8px;cursor:pointer;transition:background .12s; }
.prog-day-row:hover:not(.prog-day-row-rest) { background:var(--surface2); }
.prog-day-row-rest { cursor:default;opacity:0.55; }
.prog-day-circle { width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.62rem;font-weight:700;flex-shrink:0;border:2px solid transparent;transition:all .15s; }
.prog-day-circle.done { background:var(--green-bg);border-color:rgba(52,212,123,.5);color:var(--green); }
.prog-day-circle.pending { background:var(--surface2);border-color:var(--border);color:var(--muted); }
.prog-day-circle.rest { background:transparent;border:1.5px dashed var(--border);color:var(--border); }
.prog-day-label { flex:1;font-size:0.78rem;font-weight:500; }
.prog-day-label.done-text { color:var(--text-dim);text-decoration:line-through;text-decoration-color:var(--green); }
.prog-day-check { width:18px;height:18px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700; }
.prog-day-check.done { background:var(--green-bg);color:var(--green); }

/* â”€â”€ LIGUE â”€â”€ */
.ligue-standings { width:100%;border-collapse:collapse; }
.ligue-standings th { text-align:left;font-size:0.6rem;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--muted);padding:0.5rem 0.8rem;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap; }
.ligue-standings td { padding:0.65rem 0.8rem;border-bottom:1px solid var(--border);font-size:0.8rem;vertical-align:middle; }
.ligue-standings tr:last-child td { border-bottom:none; }
.ligue-standings tbody tr:hover td { background:var(--surface2); }
.promo-zone { background:rgba(52,212,123,0.05);border-left:3px solid var(--green); }
.releg-zone { background:rgba(240,83,74,0.05);border-left:3px solid var(--red); }
.journee-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:0.8rem 1rem;margin-bottom:0.6rem; }
.journee-title { font-weight:700;font-size:0.85rem;margin-bottom:0.5rem;display:flex;align-items:center;justify-content:space-between; }
.journee-match { display:flex;align-items:center;gap:0.5rem;padding:3px 0;font-size:0.78rem; }
.journee-player { flex:1;text-align:right; }
.journee-score { font-family:'DM Mono',monospace;font-weight:700;padding:2px 8px;background:var(--surface2);border-radius:5px;font-size:0.82rem;min-width:50px;text-align:center; }

/* â”€â”€ RADAR CHART â”€â”€ */
.radar-wrap { display:flex;justify-content:center;align-items:center;padding:0.5rem; }

/* â”€â”€ FEUILLE DE MATCH â”€â”€ */
@media print {
  .match-sheet-print * { font-family:Arial,sans-serif !important; }
}
</style>
  </head><body>
  <div class="card">
    <div class="glow"></div><div class="glow2"></div>
    <div class="season-badge">${seasons.find(x=>x.active)?.name||'Saison 1'}</div>
    <div class="club-name">${clubSettings.name||'FlÃ©chettes Club'} Â· Carte Joueur</div>
    <div class="avatar">${initials}</div>
    <div class="pseudo">${p.pseudo}</div>
    <div class="fullname">${p.name}</div>
    ${p.surnom ? `<div class="surnom">"${p.surnom}"</div>` : '<div style="height:20px"></div>'}
    ${p.bio ? `<div class="bio">${p.bio}</div>` : ''}
    <div class="elo-row">
      <div class="elo-num">${p.elo}</div>
      <div class="elo-label">ELO</div>
    </div>
    <div class="div-badge">${div.icon} ${div.name}</div>
    <div class="stats-row">
      <div class="stat"><div class="stat-val">${s.matches}</div><div class="stat-lbl">Matchs</div></div>
      <div class="stat"><div class="stat-val">${s.wins}</div><div class="stat-lbl">Victoires</div></div>
      <div class="stat"><div class="stat-val">${pct}%</div><div class="stat-lbl">% Vic.</div></div>
    </div>
  </div>
  <script>
  setTimeout(() => {
    const hint = document.createElement('div');
    hint.style.cssText = 'position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.1);color:white;padding:0.5rem 1rem;border-radius:8px;font-family:sans-serif;font-size:12px;backdrop-filter:blur(8px)';
    hint.textContent = 'ğŸ“¸ Faites une capture d\\'Ã©cran pour enregistrer la carte';
    document.body.appendChild(hint);
  }, 500);
  <\/script>
  </body></html>`;
  const w = window.open('','','width=500,height=700');
  w.document.write(win);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDRIER / SOIRÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let showPastSoirees = false;

function addSoiree() {
  const title = document.getElementById('soiree-cal-title').value.trim();
  const date  = document.getElementById('soiree-cal-date').value;
  const time  = document.getElementById('soiree-cal-time').value;
  const lieu  = document.getElementById('soiree-cal-lieu').value.trim();
  const note  = document.getElementById('soiree-cal-note').value.trim();
  if (!title || !date) { showNotif('âš  Titre et date requis.'); return; }
  const attendees = [...document.querySelectorAll('.soiree-att-chip.selected')].map(c => parseInt(c.dataset.pid));
  soirees.push({ id: Date.now(), title, date, time, lieu, note, attendees, created: new Date().toLocaleDateString('fr-FR') });
  soirees.sort((a,b) => new Date(a.date) - new Date(b.date));
  save(); renderCalendrier();
  document.getElementById('soiree-cal-title').value = '';
  document.getElementById('soiree-cal-date').value = '';
  document.getElementById('soiree-cal-note').value = '';
  document.getElementById('soiree-cal-lieu').value = '';
  document.querySelectorAll('.soiree-att-chip').forEach(c => c.classList.remove('selected'));
  showNotif('âœ“ SoirÃ©e planifiÃ©e !', 'success');
  addAudit('ğŸ“…', `SoirÃ©e planifiÃ©e : ${title} le ${date}`);
}

function deleteSoiree(id) {
  if (!confirm('Supprimer cette soirÃ©e ?')) return;
  soirees = soirees.filter(s => s.id !== id);
  save(); renderCalendrier();
}

function togglePastSoirees() {
  showPastSoirees = !showPastSoirees;
  document.getElementById('cal-past').style.display = showPastSoirees ? 'block' : 'none';
  document.getElementById('cal-past-toggle').textContent = showPastSoirees ? '(masquer)' : '(voir)';
  if (showPastSoirees) renderCalendrier();
}

function renderCalendrier() {
  const today = new Date(); today.setHours(0,0,0,0);
  const upcoming = soirees.filter(s => new Date(s.date) >= today);
  const past = soirees.filter(s => new Date(s.date) < today).reverse();

  const upEl = document.getElementById('cal-upcoming');
  const paEl = document.getElementById('cal-past-list');

  function soireeCard(s) {
    const d = new Date(s.date);
    const isToday = d.toDateString() === today.toDateString();
    const isPast = d < today;
    const cls = isToday ? 'sc-today' : isPast ? 'sc-past' : 'sc-upcoming';
    const dateStr = d.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    const atts = s.attendees || [];
    const attNames = atts.map(id => { const p = pById(id); return p ? p.pseudo : ''; }).filter(Boolean);
    return `<div class="soiree-card ${cls}">
      <div class="sc-date-badge ${isToday?'today':''}">${dateStr}${s.time?' \u00e0 '+s.time:''}${s.lieu?' - '+s.lieu:''}</div>
      <div class="sc-title">${s.title}</div>
      ${s.note ? `<div class="sc-note">${s.note}</div>` : ''}
      <div class="sc-attendees">
        ${attNames.slice(0,6).map(n => `<span class="sc-attendee">${n}</span>`).join('')}
        ${attNames.length > 6 ? `<span class="sc-attendee-count">+${attNames.length-6}</span>` : ''}
        ${!attNames.length ? `<span style="font-size:0.7rem;color:var(--muted)">Aucun joueur invitÃ©</span>` : ''}
      </div>
      <div class="sc-actions">
        ${!isPast ? `<button class="btn btn-primary btn-sm" onclick="startSoireeFromCal(${s.id})">ğŸ¯ DÃ©marrer</button>` : ''}
        <button class="btn btn-secondary btn-sm" onclick="editSoireeAttendees(${s.id})">ğŸ‘¥ Participants</button>
        ${!isPast && atts.length >= 2 ? `<button class="btn btn-secondary btn-sm" onclick="generateAutoPlanning(${s.id})">ğŸ“‹ Planning auto</button>` : ''}
        ${isPast ? `<button class="btn btn-secondary btn-sm" onclick="openSoireeRapport(${s.id})">ğŸ“Š Rapport</button>` : ''}
        ${!isPast ? `<button class="reminder-btn ${isReminderSet(s.id)?'set':''}" id="reminder-btn-${s.id}" onclick="toggleReminder(${s.id})" title="Rappel notifications"><i class="fas fa-bell"></i> ${isReminderSet(s.id)?'Rappel activÃ©':'Rappel'}</button>` : ''}
        <button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:1px solid rgba(240,83,74,0.3);margin-left:auto" onclick="deleteSoiree(${s.id})">âœ•</button>
      </div>
    </div>`;
  }

  if (upEl) {
    if (!upcoming.length) {
      upEl.innerHTML = `<div class="cal-empty" style="grid-column:1/-1"><div class="cal-empty-icon">ğŸ“…</div><div class="cal-empty-text">Aucune soirÃ©e planifiÃ©e. CrÃ©ez la prochaine !</div></div>`;
    } else {
      upEl.innerHTML = upcoming.map(soireeCard).join('');
    }
  }

  if (paEl && showPastSoirees) {
    if (!past.length) {
      paEl.innerHTML = `<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0">Aucune soirÃ©e passÃ©e</div>`;
    } else {
      paEl.innerHTML = past.map(soireeCard).join('');
    }
  }

  // Update past section label
  const pts = document.getElementById('cal-past-toggle');
  if (pts && past.length === 0) { pts.style.display = 'none'; }

  // Attendee chips for add form
  renderSoireeAttendeeChips();
}

function renderSoireeAttendeeChips() {
  const grid = document.getElementById('soiree-cal-attendees');
  if (!grid) return;
  grid.innerHTML = players.map(p => `<span class="soiree-att-chip" data-pid="${p.id}" onclick="this.classList.toggle('selected')">${p.pseudo}</span>`).join('');
}

function startSoireeFromCal(soireeId) {
  const s = soirees.find(x => x.id === soireeId);
  if (!s) return;
  // Pre-fill mode soirÃ©e or just navigate to matchs
  showNotif(`ğŸ¯ SoirÃ©e "${s.title}" dÃ©marrÃ©e !`, 'win');
  showPage('matchs', document.querySelector('.nav-btn[onclick*="matchs"]') || document.querySelector('.mnav-btn'));
}

function editSoireeAttendees(soireeId) {
  const s = soirees.find(x => x.id === soireeId);
  if (!s) return;
  // Build modal dynamically
  let modal = document.getElementById('edit-attendees-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'edit-attendees-modal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `<div class="modal" style="max-width:420px">
      <div class="modal-title">ğŸ‘¥ Participants <button class="modal-close" onclick="closeModal('edit-attendees-modal')">âœ•</button></div>
      <div id="edit-attendees-title" style="font-size:0.8rem;color:var(--muted);margin-bottom:0.8rem"></div>
      <div id="edit-attendees-chips" style="display:flex;flex-wrap:wrap;gap:0.4rem;padding:0.8rem;background:var(--surface2);border-radius:8px;border:1px solid var(--border);min-height:60px;margin-bottom:1rem"></div>
      <div style="display:flex;gap:0.6rem">
        <button class="btn btn-secondary" style="flex:1" onclick="closeModal('edit-attendees-modal')">Annuler</button>
        <button class="btn btn-primary" style="flex:1" id="edit-attendees-save-btn">âœ“ Enregistrer</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
  }
  document.getElementById('edit-attendees-title').textContent = `SoirÃ©e : ${s.title}`;
  const chips = document.getElementById('edit-attendees-chips');
  chips.innerHTML = players.map(p => {
    const sel = (s.attendees||[]).includes(p.id);
    return `<span class="presence-chip${sel?' selected':''}" data-pid="${p.id}" 
      style="cursor:pointer;padding:0.3rem 0.8rem;border-radius:20px;font-size:0.75rem;font-weight:600;border:1px solid ${sel?'var(--accent)':'var(--border)'};background:${sel?'var(--accent-dim)':'var(--surface)'};color:${sel?'var(--accent)':'var(--muted)'};transition:all .15s"
      onclick="this.classList.toggle('selected');this.style.background=this.classList.contains('selected')?'var(--accent-dim)':'var(--surface)';this.style.borderColor=this.classList.contains('selected')?'var(--accent)':'var(--border)';this.style.color=this.classList.contains('selected')?'var(--accent)':'var(--muted)'">${p.pseudo}</span>`;
  }).join('');
  document.getElementById('edit-attendees-save-btn').onclick = function() {
    s.attendees = [...chips.querySelectorAll('.selected')].map(c => parseInt(c.dataset.pid));
    save(); renderCalendrier(); closeModal('edit-attendees-modal');
    showNotif(`âœ“ ${s.attendees.length} participant(s) enregistrÃ©s`, 'success');
  };
  openModal('edit-attendees-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAUVEGARDE / TRANSFERT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBackupStatus() {
  const box = document.getElementById('backup-status-box');
  if (!box) return;
  const last = localStorage.getItem('darts_last_backup');
  const hasData = players.length > 0 || matches.length > 0;
  const warn = !last && hasData;
  // Calculate storage size
  let sz = 0;
  for (const k of Object.keys(localStorage)) sz += (localStorage.getItem(k)||'').length;
  const szKB = (sz / 1024).toFixed(1);
  const szPct = Math.min(100, Math.round(sz / 50000)); // 5MB limit estimate
  const szColor = sz > 4000000 ? 'var(--red)' : sz > 2000000 ? 'var(--gold)' : 'var(--green)';
  box.innerHTML = `<div class="backup-status">
    <div class="backup-dot ${warn?'warn':'ok'}"></div>
    <div class="backup-info">
      ${hasData ? `${players.length} joueur(s) Â· ${matches.length} match(s) Â· ${tournois.length} tournoi(s)` : 'Aucune donnÃ©e enregistrÃ©e'}
    </div>
    <div class="backup-time">${last ? 'DerniÃ¨re sauvegarde : ' + last : 'Jamais sauvegardÃ©'}</div>
  </div>
  <div style="margin:0.6rem 0 1rem;background:var(--dark-card);border:1px solid var(--border);border-radius:8px;padding:0.7rem 1rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem">
      <span style="font-size:0.72rem;color:var(--muted)">Stockage local utilisÃ©</span>
      <span style="font-size:0.75rem;font-family:'DM Mono',monospace;color:${szColor}">${szKB} KB</span>
    </div>
    <div style="height:6px;background:var(--dark-hover);border-radius:3px;overflow:hidden">
      <div style="height:100%;width:${szPct}%;background:${szColor};border-radius:3px;transition:width .4s"></div>
    </div>
    <div style="font-size:0.65rem;color:var(--muted);margin-top:0.3rem">Limite estimÃ©e ~5 MB Â· Exportez si > 4 MB</div>
  </div>
  ${warn ? `<div style="padding:0.6rem 1rem;background:rgba(230, 57, 70, 0.1);border:1px solid rgba(230, 57, 70, 0.25);border-radius:8px;font-size:0.75rem;color:var(--accent);margin-bottom:0.8rem">âš ï¸ Pensez Ã  sauvegarder vos donnÃ©es ! Elles sont stockÃ©es uniquement sur ce navigateur.</div>` : ''}`;
}

function showTransferCode() {
  const data = { players, matches, tournois, seasons, auditLog, soirees, clubSettings, teams, teamMatches, defis, ligues, trainingPrograms, exported: new Date().toISOString() };
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  document.getElementById('transfer-code-text').value = encoded;
  document.getElementById('transfer-code-box').style.display = 'block';
  document.getElementById('import-code-box').style.display = 'none';
}

function copyTransferCode() {
  const ta = document.getElementById('transfer-code-text');
  ta.select();
  document.execCommand('copy');
  showNotif('âœ“ Code copiÃ© dans le presse-papier !', 'success');
}

function showImportCode() {
  document.getElementById('import-code-box').style.display = 'block';
  document.getElementById('transfer-code-box').style.display = 'none';
  document.getElementById('import-code-text').focus();
}

function importFromCode() {
  const code = document.getElementById('import-code-text').value.trim();
  if (!code) { showNotif('âš  Entrez un code.'); return; }
  try {
    const data = JSON.parse(decodeURIComponent(escape(atob(code))));
    if (!confirm('Importer ces donnÃ©es ? L\'Ã©tat actuel sera remplacÃ©.')) return;
    if (data.players)      players      = data.players;
    if (data.matches)      matches      = data.matches;
    if (data.tournois)     tournois     = data.tournois;
    if (data.seasons)      seasons      = data.seasons;
    if (data.auditLog)     auditLog     = data.auditLog;
    if (data.soirees)      soirees      = data.soirees;
    if (data.clubSettings) { clubSettings = data.clubSettings; applyClubSettings(); }
    recomputeElo(); save(); renderAll(); renderParametres(); updateSeasonBadge();
    document.getElementById('import-code-box').style.display = 'none';
    showNotif('âœ“ DonnÃ©es importÃ©es avec succÃ¨s !', 'success');
  } catch(e) {
    showNotif('âš  Code invalide ou corrompu.'); 
  }
}

// Export JSON complet (avec soirees & clubSettings)
function exportJSON() {
  const data = { players, matches, tournois, seasons, auditLog, soirees, clubSettings, exported: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download = `flechettes-backup-${new Date().toLocaleDateString('fr-FR').replace(/\//g,'-')}.json`;
  a.click(); URL.revokeObjectURL(url);
  addAudit('ğŸ’¾', 'Export JSON effectuÃ©');
  updateLastBackup();
  showNotif('âœ“ DonnÃ©es sauvegardÃ©es !', 'success');
}

// Import JSON complet (avec soirees & clubSettings)
function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!confirm('Importer ces donnÃ©es ? L\'Ã©tat actuel sera remplacÃ©.')) return;
      if (data.players)      players      = data.players;
      if (data.matches)      matches      = data.matches;
      if (data.tournois)     tournois     = data.tournois;
      if (data.seasons)      seasons      = data.seasons;
      if (data.auditLog)     auditLog     = data.auditLog;
      if (data.soirees)      soirees      = data.soirees;
      if (data.clubSettings) { clubSettings = data.clubSettings; applyClubSettings(); }
      if (data.teams)         teams         = data.teams;
      if (data.teamMatches)   teamMatches   = data.teamMatches;
      if (data.defis)         defis         = data.defis;
      if (data.ligues)        ligues        = data.ligues;
      if (data.trainingPrograms) trainingPrograms = data.trainingPrograms;
      addAudit('ğŸ“', 'Import JSON effectuÃ©');
      recomputeElo(); save(); renderAll(); renderParametres(); updateSeasonBadge();
      showNotif('âœ“ DonnÃ©es restaurÃ©es !', 'success');
    } catch(err) { showNotif('âš  Fichier invalide.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰QUIPES 2v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderEquipes() {
  renderTeamSelects();
  renderTeamsRanking();
  renderTeamMatches();
}

function renderTeamSelects() {
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  ['team-p1-select','team-p2-select'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
  const tOpts = '<option value="">-- Choisir Ã©quipe --</option>' + teams.map(t=>`<option value="${t.id}">${t.emoji||'ğŸ‘¥'} ${t.name}</option>`).join('');
  ['team-match-a','team-match-b'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=tOpts;});
  const dateEl = document.getElementById('team-match-date');
  if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().slice(0,10);
}

function createTeam() {
  const name = document.getElementById('team-name-input')?.value?.trim();
  const p1 = parseInt(document.getElementById('team-p1-select')?.value);
  const p2 = parseInt(document.getElementById('team-p2-select')?.value);
  const emoji = document.getElementById('team-emoji-input')?.value || 'ğŸ‘¥';
  if (!name || !p1 || !p2) { showNotif('âš  Remplis tous les champs'); return; }
  if (p1 === p2) { showNotif('âš  Les joueurs doivent Ãªtre diffÃ©rents'); return; }
  if (teams.find(t => (t.p1===p1&&t.p2===p2)||(t.p1===p2&&t.p2===p1))) { showNotif('âš  Cette Ã©quipe existe dÃ©jÃ '); return; }
  const team = { id: Date.now(), name, p1, p2, emoji, created: new Date().toISOString().slice(0,10) };
  teams.push(team);
  document.getElementById('team-name-input').value = '';
  document.getElementById('team-emoji-input').value = '';
  save(); renderEquipes();
  showNotif(`âœ“ Ã‰quipe ${emoji} ${name} crÃ©Ã©e !`, 'success');
}

function addTeamMatch() {
  const tidA = parseInt(document.getElementById('team-match-a')?.value);
  const tidB = parseInt(document.getElementById('team-match-b')?.value);
  const sA = parseInt(document.getElementById('team-score-a')?.value);
  const sB = parseInt(document.getElementById('team-score-b')?.value);
  const date = document.getElementById('team-match-date')?.value || new Date().toISOString().slice(0,10);
  if (!tidA || !tidB || isNaN(sA) || isNaN(sB)) { showNotif('âš  Remplis tous les champs'); return; }
  if (tidA === tidB) { showNotif('âš  Deux Ã©quipes diffÃ©rentes !'); return; }
  const winner = sA > sB ? tidA : sB > sA ? tidB : null;
  const m = { id: Date.now(), teamA: tidA, teamB: tidB, sA, sB, winner, date };
  teamMatches.push(m);
  save(); renderTeamsRanking(); renderTeamMatches();
  showNotif('âœ“ Match enregistrÃ© !', 'success');
}

function getTeamStats() {
  const s = {};
  teams.forEach(t => s[t.id] = { wins:0, losses:0, draws:0, matches:0, sFor:0, sAg:0 });
  teamMatches.forEach(m => {
    if (!s[m.teamA]) s[m.teamA] = { wins:0, losses:0, draws:0, matches:0, sFor:0, sAg:0 };
    if (!s[m.teamB]) s[m.teamB] = { wins:0, losses:0, draws:0, matches:0, sFor:0, sAg:0 };
    s[m.teamA].matches++; s[m.teamB].matches++;
    s[m.teamA].sFor += m.sA; s[m.teamA].sAg += m.sB;
    s[m.teamB].sFor += m.sB; s[m.teamB].sAg += m.sA;
    if (m.winner===m.teamA) { s[m.teamA].wins++; s[m.teamB].losses++; }
    else if (m.winner===m.teamB) { s[m.teamB].wins++; s[m.teamA].losses++; }
    else { s[m.teamA].draws++; s[m.teamB].draws++; }
  });
  return s;
}

function renderTeamsRanking() {
  const tbody = document.getElementById('teams-ranking-body');
  if (!tbody) return;
  if (!teams.length) { tbody.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:2rem">Aucune Ã©quipe â€” crÃ©ez la premiÃ¨re !</td></tr>'; return; }
  const stats = getTeamStats();
  const sorted = [...teams].sort((a,b) => {
    const sa=stats[a.id]||{wins:0,draws:0,matches:0}, sb=stats[b.id]||{wins:0,draws:0,matches:0};
    const pa=sa.wins*3+sa.draws, pb=sb.wins*3+sb.draws;
    return pb-pa;
  });
  tbody.innerHTML = sorted.map((t,i) => {
    const s = stats[t.id]||{wins:0,losses:0,draws:0,matches:0,sFor:0,sAg:0};
    const pts = s.wins*3+s.draws;
    const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
    const p1 = players.find(p=>p.id===t.p1), p2 = players.find(p=>p.id===t.p2);
    const setsDiff = s.sFor - s.sAg;
    const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':null;
    const rowCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
    return `<tr class="${rowCls}">
      <td class="r-num" style="text-align:center">${medal || `<span style="color:var(--gray)">${i+1}</span>`}</td>
      <td>
        <div style="font-weight:700;font-size:0.88rem">${t.emoji||'ğŸ‘¥'} ${t.name}</div>
        <div style="font-size:0.63rem;color:var(--muted)">${p1?.pseudo||'?'} + ${p2?.pseudo||'?'}</div>
      </td>
      <td style="text-align:center">
        <span style="font-family:'Bebas Neue',monospace;font-weight:800;color:var(--accent);font-size:1.15rem">${pts}</span>
        <div style="font-size:0.58rem;color:var(--muted);letter-spacing:1px">PTS</div>
      </td>
      <td style="text-align:center;font-weight:600">${s.matches}</td>
      <td style="text-align:center;color:var(--green);font-weight:700">${s.wins}</td>
      <td style="text-align:center;color:var(--red)">${s.losses}</td>
      <td style="text-align:center;font-size:0.78rem">
        <span style="color:${setsDiff>0?'var(--green)':setsDiff<0?'var(--red)':'var(--muted)'}">
          ${setsDiff>0?'+':''}${setsDiff}
        </span>
        <span style="color:var(--muted);font-size:0.63rem"> (${s.sFor}:${s.sAg})</span>
      </td>
      <td style="text-align:center">
        <div style="display:flex;align-items:center;gap:4px;justify-content:center">
          <div class="r-bar-bg" style="width:40px"><div class="r-bar" style="width:${pct}%;background:var(--green)"></div></div>
          <span style="font-size:0.7rem;color:var(--muted)">${pct}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderTeamMatches() {
  const list = document.getElementById('team-match-list');
  if (!list) return;
  if (!teamMatches.length) { list.innerHTML='<div style="text-align:center;color:var(--muted);padding:1.5rem">Aucun match â€” enregistrez le premier !</div>'; return; }
  const teamById = id => teams.find(t=>t.id===id);
  list.innerHTML = [...teamMatches].reverse().slice(0,20).map(m => {
    const tA=teamById(m.teamA), tB=teamById(m.teamB);
    const wBadge = m.winner ? `<span style="font-size:0.65rem;background:var(--gold-bg);color:var(--accent);border:1px solid rgba(230, 57, 70, .3);border-radius:5px;padding:1px 6px">ğŸ† ${teamById(m.winner)?.name||'?'}</span>` : '';
    return `<div class="mcard" style="margin-bottom:0.6rem">
      <div class="mcard-top">
        <span class="mc-date">${m.date}</span>
        <div class="mc-players">
          <span class="${m.winner===m.teamA?'mc-winner':'mc-loser'}">${tA?.emoji||'ğŸ‘¥'} ${tA?.name||'?'}</span>
          <span style="color:var(--border)"> vs </span>
          <span class="${m.winner===m.teamB?'mc-winner':'mc-loser'}">${tB?.emoji||'ğŸ‘¥'} ${tB?.name||'?'}</span>
        </div>
        <div class="mc-score">${m.sA}â€“${m.sB}</div>
        ${wBadge}
        <button class="mc-del" onclick="deleteTeamMatch(${m.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function deleteTeamMatch(id) {
  teamMatches = teamMatches.filter(m=>m.id!==id);
  save(); renderTeamMatches(); renderTeamsRanking();
  showNotif('âœ“ Match supprimÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTÃˆME DE DÃ‰FIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderDefis() {
  renderDefiSelects();
  renderDefisLists();
}

function renderDefiSelects() {
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  ['defi-from','defi-to'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
}

function lancerDefi() {
  const from = parseInt(document.getElementById('defi-from')?.value);
  const to   = parseInt(document.getElementById('defi-to')?.value);
  const game = document.getElementById('defi-game')?.value || '501';
  const msg  = document.getElementById('defi-msg')?.value?.trim() || '';
  if (!from || !to) { showNotif('âš  Choisis les deux joueurs'); return; }
  if (from === to)  { showNotif('âš  Tu ne peux pas te dÃ©fier toi-mÃªme !'); return; }
  const defi = { id: Date.now(), from, to, game, msg, status: 'pending', date: new Date().toISOString().slice(0,10), result: null };
  defis.push(defi);
  document.getElementById('defi-msg').value = '';
  save(); renderDefisLists();
  const fp=players.find(p=>p.id===from), tp=players.find(p=>p.id===to);
  showNotif(`âš”ï¸ ${fp?.pseudo} dÃ©fie ${tp?.pseudo} en ${game} !`, 'success');
}

function accepterDefi(id) {
  const d = defis.find(x=>x.id===id); if (!d) return;
  d.status = 'accepted'; save(); renderDefisLists();
  showNotif('âœ“ DÃ©fi acceptÃ© !', 'success');
}

function refuserDefi(id) {
  const d = defis.find(x=>x.id===id); if (!d) return;
  if (!confirm('Refuser ce dÃ©fi ?')) return;
  d.status = 'refused'; save(); renderDefisLists();
  showNotif('DÃ©fi refusÃ©.');
}

function ouvrirResultatDefi(id) {
  const d = defis.find(x=>x.id===id); if (!d) return;
  const fp=players.find(p=>p.id===d.from), tp=players.find(p=>p.id===d.to);
  document.getElementById('defi-result-id').value = id;
  document.getElementById('defi-result-info').innerHTML = `<strong>${fp?.pseudo}</strong> âš”ï¸ <strong>${tp?.pseudo}</strong> â€” ${d.game}${d.msg?` â€” <em>"${d.msg}"</em>`:''}`;
  document.getElementById('defi-result-p1-label').textContent = fp?.pseudo||'J1';
  document.getElementById('defi-result-p2-label').textContent = tp?.pseudo||'J2';
  document.getElementById('defi-result-s1').value = '';
  document.getElementById('defi-result-s2').value = '';
  document.getElementById('defi-result-modal').classList.add('active');
}

function validerDefi() {
  const id = parseInt(document.getElementById('defi-result-id').value);
  const s1 = parseInt(document.getElementById('defi-result-s1').value);
  const s2 = parseInt(document.getElementById('defi-result-s2').value);
  const d = defis.find(x=>x.id===id); if (!d) return;
  if (isNaN(s1)||isNaN(s2)) { showNotif('âš  Entrez les scores'); return; }
  d.result = { s1, s2 };
  d.status = 'done';
  // Enregistrer dans le classement
  addMatch(d.from, d.to, s1, s2);
  addAudit('âš”ï¸', `DÃ©fi terminÃ© : ${players.find(p=>p.id===d.from)?.pseudo} ${s1}-${s2} ${players.find(p=>p.id===d.to)?.pseudo}`);
  save(); closeModal('defi-result-modal'); renderDefisLists(); renderAll();
  showNotif('ğŸ† DÃ©fi terminÃ© et enregistrÃ© au classement !', 'success');
}

function supprimerDefi(id) {
  defis = defis.filter(d=>d.id!==id);
  save(); renderDefisLists();
  showNotif('âœ“ DÃ©fi supprimÃ©');
}

function renderDefisLists() {
  const actifs = document.getElementById('defis-actifs-list');
  const hist   = document.getElementById('defis-history-list');
  if (!actifs || !hist) return;

  const pending = defis.filter(d => d.status === 'pending' || d.status === 'accepted');
  const done    = defis.filter(d => d.status === 'done' || d.status === 'refused');

  if (!pending.length) actifs.innerHTML = '<div style="text-align:center;color:var(--muted);padding:1.5rem;font-size:0.82rem">Aucun dÃ©fi en cours â€” lancez-en un !</div>';
  else actifs.innerHTML = pending.map(d => {
    const fp=players.find(p=>p.id===d.from), tp=players.find(p=>p.id===d.to);
    return `<div class="defi-card ${d.status}" style="margin-bottom:0.6rem">
      <div class="defi-icon">âš”ï¸</div>
      <div class="defi-info">
        <div class="defi-title">${fp?.pseudo||'?'} dÃ©fie ${tp?.pseudo||'?'}</div>
        <div class="defi-meta">${d.game} Â· ${d.date}${d.msg?` Â· <em>"${d.msg}"</em>`:''}</div>
      </div>
      <span class="defi-badge ${d.status}">${d.status==='pending'?'En attente':'AcceptÃ©'}</span>
      <div class="defi-actions">
        ${d.status==='pending'?`<button class="btn btn-sm" style="background:var(--green-bg);color:var(--green);border:1px solid rgba(52,212,123,.3)" onclick="accepterDefi(${d.id})">âœ“ Accepter</button><button class="btn btn-sm btn-secondary" onclick="refuserDefi(${d.id})">âœ•</button>`:''}
        ${d.status==='accepted'?`<button class="btn btn-sm btn-primary" onclick="ouvrirResultatDefi(${d.id})">ğŸ“Š RÃ©sultat</button>`:''}
        <button class="btn btn-sm btn-secondary" onclick="supprimerDefi(${d.id})" style="font-size:0.65rem;padding:0.2rem 0.5rem">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');

  if (!done.length) hist.innerHTML = '<div style="text-align:center;color:var(--muted);padding:1rem;font-size:0.75rem">Aucun dÃ©fi terminÃ©</div>';
  else hist.innerHTML = [...done].reverse().slice(0,15).map(d => {
    const fp=players.find(p=>p.id===d.from), tp=players.find(p=>p.id===d.to);
    const winner = d.result ? (d.result.s1>d.result.s2?fp:tp) : null;
    return `<div class="defi-card ${d.status}" style="margin-bottom:0.5rem">
      <div class="defi-icon">${d.status==='done'?'ğŸ†':'âŒ'}</div>
      <div class="defi-info">
        <div class="defi-title">${fp?.pseudo||'?'} vs ${tp?.pseudo||'?'}</div>
        <div class="defi-meta">${d.game} Â· ${d.date}${d.result?` Â· ${d.result.s1}â€“${d.result.s2}`:''}</div>
      </div>
      <span class="defi-badge ${d.status}">${d.status==='done'?(winner?`ğŸ† ${winner.pseudo}`:'TerminÃ©'):'RefusÃ©'}</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RADAR CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let radarChartInstance = null;

function renderRadarChart() {
  const pid = parseInt(document.getElementById('radar-player-select')?.value);
  const canvas = document.getElementById('radar-chart');
  if (!canvas) return;

  if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }
  if (!pid) { canvas.style.display='none'; return; }

  const p = players.find(x=>x.id===pid);
  const stats = getStats();
  const s = stats[pid]||{wins:0,losses:0,matches:0,avg3d:0,checkoutPct:0};

  // Build radar axes: PrÃ©cision, Doubles, RÃ©gularitÃ©, Forme, ActivitÃ©, ELO
  const allPcts = players.map(pl=>stats[pl.id]?.matches?Math.round(stats[pl.id].wins/stats[pl.id].matches*100):0);
  const maxPct = Math.max(...allPcts, 1);
  const allAvg = players.map(pl=>stats[pl.id]?.avg3d||0);
  const maxAvg = Math.max(...allAvg, 1);
  const allCo  = players.map(pl=>stats[pl.id]?.checkoutPct||0);
  const maxCo  = Math.max(...allCo, 1);
  const maxElo  = Math.max(...players.map(pl=>pl.elo||1000), 1001);
  const minElo  = Math.min(...players.map(pl=>pl.elo||1000), 999);
  const allM   = players.map(pl=>stats[pl.id]?.matches||0);
  const maxM   = Math.max(...allM, 1);
  const recent5 = getRecentForm ? getRecentForm(pid,5)||[] : [];
  const formScore = recent5.filter(r=>r==='W').length / Math.max(recent5.length,1) * 100;

  const pctVic   = s.matches ? Math.round(s.wins/s.matches*100) : 0;
  const avgNorm  = maxAvg>0 ? Math.round(s.avg3d/maxAvg*100) : 0;
  const coNorm   = maxCo>0 ? Math.round(s.checkoutPct/maxCo*100) : 0;
  const eloNorm  = maxElo>minElo ? Math.round((p.elo-minElo)/(maxElo-minElo)*100) : 50;
  const actNorm  = maxM>0 ? Math.round((s.matches||0)/maxM*100) : 0;

  canvas.style.display='block';
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || 'var(--primary)';
  radarChartInstance = new Chart(canvas, {
    type: 'radar',
    data: {
      labels: ['% Victoires','Moy. 3D','Checkout','ELO','ActivitÃ©','Forme rÃ©cente'],
      datasets: [{
        label: p.pseudo,
        data: [pctVic, avgNorm, coNorm, eloNorm, actNorm, Math.round(formScore)],
        borderColor: accent,
        backgroundColor: accent.replace('#','').length===6 ? `rgba(${parseInt(accent.slice(1,3),16)},${parseInt(accent.slice(3,5),16)},${parseInt(accent.slice(5,7),16)},0.15)` : 'rgba(230, 57, 70, 0.15)',
        pointBackgroundColor: accent,
        pointRadius: 4,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: { r: { min:0, max:100, ticks:{ stepSize:25, color:'#606a80', font:{size:9} }, grid:{ color:'#252e40' }, pointLabels:{ color:'#9aa3b5', font:{size:11} }, angleLines:{ color:'#252e40' } } },
      plugins: { legend:{ labels:{ color:'#e8ecf3', font:{size:12} } } }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTAGE CLASSEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function partagerClassement() {
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b)=>b.elo-a.elo);
  const shareData = {
    club: clubSettings.name || 'FlÃ©chettes Club',
    date: new Date().toLocaleDateString('fr-FR'),
    classement: sorted.map((p,i)=>{
      const s = stats[p.id]||{wins:0,losses:0,matches:0};
      return { rank:i+1, pseudo:p.pseudo, elo:p.elo, wins:s.wins, losses:s.losses, matches:s.matches };
    })
  };
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(shareData))));
  const url = `${window.location.href.split('?')[0]}?share=${encoded}`;
  const modal = document.getElementById('share-classement-modal');
  const ta = document.getElementById('share-url-text');
  if (ta) ta.value = url;
  // Build preview
  const prev = document.getElementById('share-preview');
  if (prev) {
    prev.innerHTML = `<div style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:0.6rem">AperÃ§u</div>` +
      sorted.slice(0,8).map((p,i) => {
        const s=stats[p.id]||{wins:0,losses:0,matches:0};
        return `<div style="display:flex;align-items:center;gap:0.5rem;padding:4px 0;border-bottom:1px solid var(--border)">
          <span style="width:20px;text-align:center;font-weight:700;font-size:0.72rem;color:var(--accent)">${i+1}</span>
          <span style="flex:1;font-weight:600">${p.pseudo}</span>
          <span style="font-family:'DM Mono',monospace;color:var(--accent)">${p.elo}</span>
          <span style="font-size:0.65rem;color:var(--muted)">${s.wins}V ${s.losses}D</span>
        </div>`;
      }).join('');
  }
  modal.classList.add('active');
}

function copyShareUrl() {
  const ta = document.getElementById('share-url-text');
  if (!ta) return;
  ta.select();
  document.execCommand('copy');
  showNotif('âœ“ Lien copiÃ© !', 'success');
}

// Check for shared classement on load
function checkSharedClassement() {
  const params = new URLSearchParams(window.location.search);
  const share = params.get('share');
  if (!share) return;
  try {
    const data = JSON.parse(decodeURIComponent(escape(atob(share))));
    // Show read-only classement overlay
    showSharedClassement(data);
  } catch(e) { console.warn('Invalid share param'); }
}

function showSharedClassement(data) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:var(--bg);z-index:9999;overflow-y:auto;padding:2rem 1rem';
  overlay.innerHTML = `
    <div style="max-width:600px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
        <div>
          <div style="font-family:'Bebas Neue', sans-serif;font-size:1.5rem;font-weight:700">${data.club} ğŸ¯</div>
          <div style="font-size:0.72rem;color:var(--muted)">Classement partagÃ© le ${data.date}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;color:var(--text-dim);cursor:pointer">âœ• Fermer</button>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:var(--surface2)"><th style="padding:0.6rem 1rem;text-align:left;font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase">#</th><th style="padding:0.6rem 1rem;text-align:left;font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase">Joueur</th><th style="padding:0.6rem 1rem;text-align:left;font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase">ELO</th><th style="padding:0.6rem 1rem;text-align:left;font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase">V/D</th></tr></thead>
          <tbody>${data.classement.map(r=>`<tr style="border-top:1px solid var(--border)"><td style="padding:0.7rem 1rem;font-weight:700;color:var(--accent)">${r.rank===1?'ğŸ¥‡':r.rank===2?'ğŸ¥ˆ':r.rank===3?'ğŸ¥‰':r.rank}</td><td style="padding:0.7rem 1rem;font-weight:600">${r.pseudo}</td><td style="padding:0.7rem 1rem;font-family:'DM Mono',monospace;font-weight:700;color:var(--accent)">${r.elo}</td><td style="padding:0.7rem 1rem;font-size:0.75rem"><span style="color:var(--green)">${r.wins}V</span> / <span style="color:var(--red)">${r.losses}D</span></td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF / FEUILLE DE MATCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateMatchSheet() {
  const modal = document.getElementById('match-sheet-modal');
  const opts = '<option value="">-- Choisir --</option>' + players.map(p=>`<option value="${p.id}">${p.pseudo}</option>`).join('');
  ['sheet-p1','sheet-p2'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
  const dateEl = document.getElementById('sheet-date');
  if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
  document.getElementById('match-sheet-preview').innerHTML='';
  modal.classList.add('active');
}

function getMatchSheetHTML(preview=false) {
  const p1id = parseInt(document.getElementById('sheet-p1')?.value);
  const p2id = parseInt(document.getElementById('sheet-p2')?.value);
  const fmt  = document.getElementById('sheet-format')?.value || '501';
  const date = document.getElementById('sheet-date')?.value || '';
  const p1 = players.find(p=>p.id===p1id)||{pseudo:'Joueur 1', elo:1000};
  const p2 = players.find(p=>p.id===p2id)||{pseudo:'Joueur 2', elo:1000};
  const stats = getStats();
  const s1=stats[p1id]||{wins:0,losses:0,matches:0,avg3d:0,checkoutPct:0};
  const s2=stats[p2id]||{wins:0,losses:0,matches:0,avg3d:0,checkoutPct:0};
  const h2h = matches.filter(m=>(m.p1===p1id&&m.p2===p2id)||(m.p1===p2id&&m.p2===p1id));
  const h2h_p1 = h2h.filter(m=>m.winner===p1id).length;
  const h2h_p2 = h2h.filter(m=>m.winner===p2id).length;
  const rows = Array.from({length:10},(_,i)=>`<tr style="height:32px"><td style="border:1px solid #ccc;padding:4px 8px;text-align:center;font-size:0.9rem">${i+1}</td><td style="border:1px solid #ccc;padding:4px"></td><td style="border:1px solid #ccc;padding:4px"></td><td style="border:1px solid #ccc;padding:4px"></td><td style="border:1px solid #ccc;padding:4px"></td><td style="border:1px solid #ccc;padding:4px"></td></tr>`).join('');
  return `<div style="font-family:Arial,sans-serif;color:#000;padding:${preview?'0':'2rem'};max-width:700px;margin:0 auto">
    <div style="text-align:center;border-bottom:3px solid #000;padding-bottom:1rem;margin-bottom:1rem">
      <div style="font-size:2rem;font-weight:900">ğŸ¯ FEUILLE DE MATCH</div>
      <div style="font-size:0.9rem;color:#555">${clubSettings.name||'Club FlÃ©chettes'} Â· ${date} Â· Format : ${fmt}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;margin-bottom:1rem;align-items:start">
      <div style="border:2px solid #000;border-radius:8px;padding:1rem;text-align:center">
        <div style="font-size:1.5rem;font-weight:800">${p1.pseudo}</div>
        <div style="font-size:0.8rem;color:#555">ELO: ${p1.elo} Â· ${s1.wins}V/${s1.losses}D Â· ${s1.avg3d||'â€”'} moy.</div>
      </div>
      <div style="font-size:2.5rem;font-weight:900;text-align:center;padding-top:0.8rem">VS</div>
      <div style="border:2px solid #000;border-radius:8px;padding:1rem;text-align:center">
        <div style="font-size:1.5rem;font-weight:800">${p2.pseudo}</div>
        <div style="font-size:0.8rem;color:#555">ELO: ${p2.elo} Â· ${s2.wins}V/${s2.losses}D Â· ${s2.avg3d||'â€”'} moy.</div>
      </div>
    </div>
    ${h2h.length?`<div style="text-align:center;margin-bottom:1rem;font-size:0.8rem;border:1px solid #ccc;border-radius:6px;padding:0.5rem">H2H : <strong>${p1.pseudo} ${h2h_p1} â€“ ${h2h_p2} ${p2.pseudo}</strong> (${h2h.length} matchs)</div>`:''}
    <table style="width:100%;border-collapse:collapse;margin-bottom:1rem">
      <thead><tr style="background:#f0f0f0">
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">#</th>
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">Legs J1</th>
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">Score J1</th>
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">Score J2</th>
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">Legs J2</th>
        <th style="border:1px solid #ccc;padding:6px 8px;font-size:0.8rem">Notes</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
      <div style="border:1px solid #ccc;border-radius:6px;padding:0.8rem">
        <div style="font-weight:700;margin-bottom:0.5rem">RÃ©sultat final</div>
        <div style="font-size:1.8rem;font-weight:900;text-align:center">__ â€“ __</div>
        <div style="margin-top:0.5rem;font-size:0.8rem">Vainqueur : ____________________</div>
      </div>
      <div style="border:1px solid #ccc;border-radius:6px;padding:0.8rem">
        <div style="font-weight:700;margin-bottom:0.5rem">Statistiques</div>
        <div style="font-size:0.8rem;line-height:2">
          Moy. 3D J1 : _________ | J2 : _________<br>
          Checkouts : J1 ___/___  | J2 : ___/___<br>
          Signature : ____________________
        </div>
      </div>
    </div>
  </div>`;
}

function previewMatchSheet() {
  const prev = document.getElementById('match-sheet-preview');
  if (prev) prev.innerHTML = '<div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-top:0.5rem;background:#fff;color:#000">' + getMatchSheetHTML(true) + '</div>';
}

function printMatchSheet() {
  const html = getMatchSheetHTML(false);
  const w = window.open('','_blank');
  w.document.write(`<html><head><title>Feuille de match</title><style>@page{margin:1.5cm}body{margin:0}</style></head><body>${html}</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(()=>{ w.print(); }, 300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE LIGUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderLigue() {
  renderLiguePlayerSelect();
  renderLigueList();
}

function renderLiguePlayerSelect() {
  const container = document.getElementById('ligue-players-select');
  if (!container) return;
  container.innerHTML = players.map(p=>`
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background .1s" onmouseover="this.style.background='var(--surface3)'" onmouseout="this.style.background='transparent'">
      <input type="checkbox" class="ligue-player-check" value="${p.id}" style="accent-color:var(--accent);width:15px;height:15px">
      <span style="font-size:0.8rem;font-weight:500">${p.pseudo}</span>
    </label>`).join('');
}

function creerLigue() {
  const name = document.getElementById('ligue-name-input')?.value?.trim();
  const nbJ  = parseInt(document.getElementById('ligue-journees-input')?.value)||10;
  const checks = document.querySelectorAll('.ligue-player-check:checked');
  const playerIds = [...checks].map(c=>parseInt(c.value));
  if (!name) { showNotif('âš  Donne un nom Ã  la ligue'); return; }
  if (playerIds.length < 2) { showNotif('âš  Minimum 2 joueurs'); return; }
  const schedule = genLigueSchedule(playerIds, nbJ);
  const ligue = {
    id: Date.now(), name, playerIds, nbJournees: nbJ,
    journees: schedule, status: 'active',
    created: new Date().toISOString().slice(0,10)
  };
  ligues.push(ligue);
  document.getElementById('ligue-name-input').value = '';
  // Uncheck all
  document.querySelectorAll('.ligue-player-check').forEach(c=>c.checked=false);
  save(); renderLigueList();
  showNotif(`ğŸ… Ligue "${name}" crÃ©Ã©e avec ${schedule.length} journÃ©es !`, 'success');
}

function genLigueSchedule(pids, nbJournees) {
  // Standard round-robin: keep index 0 fixed, rotate the rest
  const ids = pids.length % 2 === 0 ? [...pids] : [...pids, null]; // pad odd with bye
  const nRounds = ids.length - 1; // one full round-robin = n-1 rounds
  const baseRounds = [];

  for (let r = 0; r < nRounds; r++) {
    const journee = { num: r + 1, matches: [], completed: false };
    for (let i = 0; i < ids.length / 2; i++) {
      const home = ids[i];
      const away = ids[ids.length - 1 - i];
      if (home !== null && away !== null) {
        journee.matches.push({ p1: home, p2: away, s1: null, s2: null, done: false, recorded: false });
      }
    }
    baseRounds.push(journee);
    // Rotate: keep ids[0] fixed, rotate ids[1..n-1]
    const last = ids.pop();
    ids.splice(1, 0, last);
  }

  const allRounds = [...baseRounds];
  // Generate return-leg rounds (swap home/away) until we have enough
  let leg = 2;
  while (allRounds.length < nbJournees) {
    const src = baseRounds[(allRounds.length - baseRounds.length) % baseRounds.length];
    const next = JSON.parse(JSON.stringify(src));
    next.num = allRounds.length + 1;
    if (leg % 2 === 0) next.matches.forEach(m => { const t=m.p1; m.p1=m.p2; m.p2=t; });
    if ((allRounds.length % baseRounds.length) === 0) leg++;
    allRounds.push(next);
  }
  return allRounds.slice(0, nbJournees);
}

function getLigueStandings(ligue) {
  const s = {};
  ligue.playerIds.forEach(id => s[id] = { wins:0, draws:0, losses:0, played:0, gf:0, ga:0, pts:0 });
  ligue.journees.forEach(j => j.matches.forEach(m => {
    if (!m.done || m.s1 === null || m.s2 === null) return;
    if (!s[m.p1]) s[m.p1] = { wins:0,draws:0,losses:0,played:0,gf:0,ga:0,pts:0 };
    if (!s[m.p2]) s[m.p2] = { wins:0,draws:0,losses:0,played:0,gf:0,ga:0,pts:0 };
    s[m.p1].played++; s[m.p2].played++;
    s[m.p1].gf += m.s1; s[m.p1].ga += m.s2;
    s[m.p2].gf += m.s2; s[m.p2].ga += m.s1;
    if (m.s1 > m.s2)      { s[m.p1].wins++; s[m.p1].pts+=3; s[m.p2].losses++; }
    else if (m.s1 < m.s2) { s[m.p2].wins++; s[m.p2].pts+=3; s[m.p1].losses++; }
    else                   { s[m.p1].draws++; s[m.p2].draws++; s[m.p1].pts+=1; s[m.p2].pts+=1; }
  }));
  return Object.entries(s)
    .map(([id,st])=>({pid:parseInt(id),...st}))
    .sort((a,b) => (b.pts-a.pts) || ((b.gf-b.ga)-(a.gf-a.ga)) || (b.gf-a.gf));
}

function renderLigueList() {
  const el = document.getElementById('ligue-list-section');
  if (!el) return;
  if (!ligues.length) {
    el.innerHTML = `<div style="text-align:center;color:var(--muted);padding:3rem 1rem">
      <div style="font-size:2.5rem;margin-bottom:0.8rem">ğŸ…</div>
      <div style="font-weight:600;margin-bottom:0.3rem">Aucune ligue pour l'instant</div>
      <div style="font-size:0.78rem">CrÃ©ez votre premiÃ¨re ligue avec le formulaire ci-dessus</div>
    </div>`;
    return;
  }
  el.innerHTML = ligues.map(ligue => {
    const standings = getLigueStandings(ligue);
    const totalDone = ligue.journees.reduce((s,j)=>s+j.matches.filter(m=>m.done).length,0);
    const totalM    = ligue.journees.reduce((s,j)=>s+j.matches.length,0);
    const pct = totalM ? Math.round(totalDone/totalM*100) : 0;
    const promoLine = standings.length >= 4 ? 1 : 0;
    const relegLine = standings.length >= 4 ? standings.length - 1 : standings.length;

    const rows = standings.map((st,i) => {
      const p = players.find(x=>x.id===st.pid);
      const isPromo = i < promoLine;
      const isReleg = i >= relegLine;
      const diff = st.gf - st.ga;
      const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':null;
      const rowCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
      const color = p?.avatarColor || 'var(--accent)';
      const avatarMini = p?.avatarPhoto
        ? `<div style="width:26px;height:26px;border-radius:6px;overflow:hidden;flex-shrink:0"><img src="${p.avatarPhoto}" style="width:100%;height:100%;object-fit:cover"></div>`
        : `<div style="width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,${color},${color}88);display:flex;align-items:center;justify-content:center;font-size:0.62rem;font-weight:800;color:#0d0f14;flex-shrink:0">${p?.avatarEmoji||getInitials(p?.name||'?')}</div>`;
      return `<tr class="${rowCls}" style="${isPromo?'background:rgba(52,212,123,0.04)':isReleg?'background:rgba(240,83,74,0.04)':''}">
        <td style="border-left:3px solid ${isPromo?'var(--green)':isReleg?'var(--red)':'transparent'};text-align:center">
          ${medal ? `<span style="font-size:1rem">${medal}</span>` : `<span style="font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--gray)">${i+1}</span>`}
        </td>
        <td>
          <div style="display:flex;align-items:center;gap:0.5rem">
            ${avatarMini}
            <span style="font-weight:${i<3?700:500};font-size:0.84rem">${p?.pseudo||'?'}</span>
          </div>
        </td>
        <td style="text-align:center"><span style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--accent)">${st.pts}</span></td>
        <td style="text-align:center;color:var(--muted)">${st.played}</td>
        <td style="text-align:center;color:var(--green);font-weight:700">${st.wins}</td>
        <td style="text-align:center;color:var(--muted)">${st.draws}</td>
        <td style="text-align:center;color:var(--red)">${st.losses}</td>
        <td style="text-align:center;font-size:0.72rem;font-family:'DM Mono',monospace">${st.gf}:${st.ga}</td>
        <td style="text-align:center;font-weight:700;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--muted)'}">${diff>0?'+':''}${diff}</td>
      </tr>`;
    }).join('');

    const nextJ = ligue.journees.find(j=>!j.completed);
    const nextJourneeNum = nextJ ? nextJ.num : null;
    const isFinished = !nextJ;

    // JournÃ©e pills
    const jPills = ligue.journees.map(j => {
      const done = j.completed;
      const partial = !done && j.matches.some(m=>m.done);
      const isCurrent = j.num === nextJourneeNum;
      let bg, border, color, label;
      if (done)         { bg='var(--green-bg)';   border='rgba(52,212,123,.4)'; color='var(--green)';  label=`J${j.num} âœ“`; }
      else if (partial) { bg='rgba(230, 57, 70, .1)';border='rgba(230, 57, 70, .4)'; color='var(--accent)'; label=`J${j.num} â€¦`; }
      else if(isCurrent){ bg='var(--accent)';      border='var(--accent)';        color='#000';          label=`J${j.num} â–¶`; }
      else              { bg='var(--surface2)';    border='var(--border)';        color='var(--muted)';  label=`J${j.num}`; }
      return `<button onclick="openLigueJournee(${ligue.id},${j.num})" style="padding:4px 12px;border-radius:20px;border:1px solid ${border};background:${bg};color:${color};font-size:0.68rem;cursor:pointer;font-weight:700;transition:all .1s">${label}</button>`;
    }).join('');

    return `<div class="card" style="margin-bottom:1.4rem;padding:0;overflow:hidden;border:1px solid var(--border2)">
      <!-- Header -->
      <div style="padding:1rem 1.2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;background:rgba(28,35,51,0.5)">
        <div>
          <div style="font-weight:800;font-size:1rem;display:flex;align-items:center;gap:0.5rem">ğŸ… ${ligue.name}</div>
          <div style="font-size:0.63rem;color:var(--muted);margin-top:2px">${ligue.created} Â· ${ligue.playerIds.length} joueurs Â· ${ligue.nbJournees} journÃ©es Â· ${totalDone}/${totalM} matchs</div>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center">
          ${isFinished
            ? `<span style="font-size:0.72rem;font-weight:700;color:var(--green);background:var(--green-bg);border:1px solid rgba(52,212,123,.3);border-radius:20px;padding:3px 10px">ğŸ† TerminÃ©e</span>`
            : `<button class="btn btn-primary btn-sm" onclick="openLigueJournee(${ligue.id},${nextJourneeNum})">ğŸ“‹ J${nextJourneeNum} â†’</button>`}
          <button class="btn btn-secondary btn-sm" onclick="deleteLigue(${ligue.id})" style="color:var(--red);padding:4px 8px" title="Supprimer">ğŸ—‘</button>
        </div>
      </div>
      <!-- Progress bar -->
      <div style="height:3px;background:var(--dark-hover)"><div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--green));width:${pct}%;transition:width .5s"></div></div>
      <!-- Standings table -->
      <div style="overflow-x:auto">
        <table class="ligue-table" style="min-width:420px">
          <thead>
            <tr>
              <th style="text-align:center;width:38px">#</th>
              <th>Joueur</th>
              <th style="color:var(--accent)">Pts</th>
              <th>J</th>
              <th style="color:var(--green)">V</th>
              <th>N</th>
              <th style="color:var(--red)">D</th>
              <th>Sets</th>
              <th>+/-</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      ${standings.length >= 4 ? `<div style="padding:0.4rem 1.2rem;font-size:0.6rem;color:var(--muted);border-top:1px solid var(--border)"><span style="color:var(--green)">â– </span> MontÃ©e &nbsp; <span style="color:var(--red)">â– </span> RelÃ©gation</div>` : ''}
      <!-- JournÃ©e pills -->
      <div style="padding:0.8rem 1.2rem;border-top:1px solid var(--border)">
        <div style="font-size:0.58rem;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:0.5rem">JournÃ©es</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px">${jPills}</div>
      </div>
    </div>`;
  }).join('');
}
let _activeLigueJournee = null;

function openLigueJournee(ligueId, jNum) {
  const ligue = ligues.find(l=>l.id===ligueId);
  if (!ligue) return;
  const j = ligue.journees.find(x=>x.num===jNum);
  if (!j) return;
  _activeLigueJournee = { ligueId, jNum };
  const el = document.getElementById('ligue-journee-matches');
  if (!el) return;

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
      <div>
        <div style="font-weight:800;font-size:0.95rem">ğŸ… ${ligue.name}</div>
        <div style="font-size:0.7rem;color:var(--muted)">JournÃ©e ${jNum} / ${ligue.nbJournees}</div>
      </div>
      ${j.completed ? '<span style="font-size:0.7rem;font-weight:700;color:var(--green);background:var(--green-bg);border:1px solid rgba(52,212,123,.3);border-radius:12px;padding:3px 10px">âœ“ JournÃ©e complÃ¨te</span>' : ''}
    </div>` +
    j.matches.map((m, i) => {
      const p1 = players.find(p=>p.id===m.p1);
      const p2 = players.find(p=>p.id===m.p2);
      const winnerIs = m.done ? (m.s1 > m.s2 ? 1 : m.s1 < m.s2 ? 2 : 0) : null;
      return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:0.7rem 0.9rem;margin-bottom:0.6rem">
        <div style="display:flex;align-items:center;gap:0.6rem">
          <span style="flex:1;text-align:right;font-weight:700;font-size:0.85rem;color:${winnerIs===1?'var(--green)':winnerIs===2?'var(--text-dim)':'var(--text)'}">${p1?.pseudo||'?'}</span>
          <div style="display:flex;align-items:center;gap:4px">
            <input type="number" id="lj-s1-${i}" value="${m.s1 !== null ? m.s1 : ''}" min="0" max="99" placeholder="â€“"
              style="width:52px;text-align:center;font-family:'DM Mono',monospace;font-weight:800;font-size:1.1rem;background:var(--surface);border:1px solid ${winnerIs===1?'var(--green)':'var(--border)'};border-radius:8px;padding:6px 4px;color:${winnerIs===1?'var(--green)':'var(--text)'}">
            <span style="font-weight:700;color:var(--border);font-size:1rem">:</span>
            <input type="number" id="lj-s2-${i}" value="${m.s2 !== null ? m.s2 : ''}" min="0" max="99" placeholder="â€“"
              style="width:52px;text-align:center;font-family:'DM Mono',monospace;font-weight:800;font-size:1.1rem;background:var(--surface);border:1px solid ${winnerIs===2?'var(--green)':'var(--border)'};border-radius:8px;padding:6px 4px;color:${winnerIs===2?'var(--green)':'var(--text)'}">
          </div>
          <span style="flex:1;font-weight:700;font-size:0.85rem;color:${winnerIs===2?'var(--green)':winnerIs===1?'var(--text-dim)':'var(--text)'}">${p2?.pseudo||'?'}</span>
          ${m.done ? '<span style="color:var(--green);font-size:0.85rem;flex-shrink:0">âœ“</span>' : '<span style="color:var(--border);font-size:0.85rem;flex-shrink:0">â—‹</span>'}
        </div>
      </div>`;
    }).join('');

  document.getElementById('ligue-journee-modal').classList.add('active');
}

function saveLigueJournee() {
  if (!_activeLigueJournee) return;
  const { ligueId, jNum } = _activeLigueJournee;
  const ligue = ligues.find(l=>l.id===ligueId);
  if (!ligue) return;
  const j = ligue.journees.find(x=>x.num===jNum);
  if (!j) return;

  let savedCount = 0;
  j.matches.forEach((m, i) => {
    const s1el = document.getElementById(`lj-s1-${i}`);
    const s2el = document.getElementById(`lj-s2-${i}`);
    const s1 = s1el && s1el.value !== '' ? parseInt(s1el.value) : null;
    const s2 = s2el && s2el.value !== '' ? parseInt(s2el.value) : null;
    if (s1 !== null && s2 !== null && !isNaN(s1) && !isNaN(s2)) {
      const wasAlreadyDone = m.done && m.s1 === s1 && m.s2 === s2;
      m.s1 = s1; m.s2 = s2; m.done = true;
      // Only record in rankings if not already recorded, or if score changed
      if (!m.recorded || !wasAlreadyDone) {
        // Remove old ranking entry if score changed and was previously recorded
        if (m.recorded && !wasAlreadyDone) {
          const key = `Ligue ${ligue.name} J${jNum}`;
          matches = matches.filter(x => !(x.source === 'ligue' && x.ligueKey === key && x.p1 === m.p1 && x.p2 === m.p2));
        }
        const matchKey = `Ligue ${ligue.name} J${jNum}`;
        const id = Date.now() + Math.random();
        const newMatch = {
          id, p1: m.p1, p2: m.p2, s1, s2,
          winner: s1 > s2 ? m.p1 : s2 > s1 ? m.p2 : null,
          date: new Date().toISOString().slice(0,10),
          format: 'sets', source: 'ligue', tournamentName: matchKey, ligueKey: matchKey,
          eloChange1: 0, eloChange2: 0
        };
        matches.push(newMatch);
        m.recorded = true;
        m.matchId = id;
        savedCount++;
      }
    }
  });

  // Mark journÃ©e completed if all matches are done
  j.completed = j.matches.every(m => m.done);

  recomputeElo();
  save();
  closeModal('ligue-journee-modal');
  renderLigueList();
  renderAll();
  showNotif(`âœ“ JournÃ©e ${jNum} : ${savedCount > 0 ? savedCount + ' rÃ©sultat(s) enregistrÃ©(s)' : 'mise Ã  jour'}`, 'success');
}

function deleteLigue(id) {
  if (!confirm('Supprimer cette ligue et ses matchs du classement ?')) return;
  const ligue = ligues.find(l=>l.id===id);
  if (ligue) {
    // Remove associated ranking matches
    const keys = new Set(ligue.journees.map((j,ji)=>`Ligue ${ligue.name} J${j.num}`));
    matches = matches.filter(m => !(m.source === 'ligue' && keys.has(m.ligueKey)));
  }
  ligues = ligues.filter(l=>l.id!==id);
  recomputeElo(); save(); renderLigueList(); renderAll();
  showNotif('âœ“ Ligue supprimÃ©e');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRAMME D'ENTRAÃNEMENT MULTI-SEMAINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TRAINING_PROGRAMS_DEF = [
  {
    id: 'prog_debutant',
    icon: 'ğŸŸ¢',
    title: 'Programme DÃ©butant',
    subtitle: '4 semaines â€” Les bases',
    level: 'debutant',
    weeks: [
      { label: 'Semaine 1 â€” Prise en main', days: [
        { label: 'PrÃ©cision gÃ©nÃ©rale', exId: 'around_clock', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Points faibles', exId: 'weak_numbers', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Tour de l\'horloge x2', exId: 'atclock_train', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'RÃ©cap semaine', exId: 'around_clock', rest: false },
      ]},
      { label: 'Semaine 2 â€” RÃ©gularitÃ©', days: [
        { label: 'Around the Clock', exId: 'atclock_train', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Points faibles', exId: 'weak_numbers', rest: false },
        { label: 'Bob\'s 27 (initiation)', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 3 â€” Doubles', days: [
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Doubles x2', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 4 â€” Consolidation', days: [
        { label: 'Around the Clock', exId: 'around_clock', rest: false },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bilan et test', exId: 'weak_numbers', rest: false },
      ]},
    ]
  },
  {
    id: 'prog_intermediaire',
    icon: 'ğŸŸ¡',
    title: 'Programme IntermÃ©diaire',
    subtitle: '6 semaines â€” Progression ciblÃ©e',
    level: 'intermediaire',
    weeks: [
      { label: 'Semaine 1 â€” Triples', days: [
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Shanghai Express', exId: 'shanghai', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 2 â€” Doubles & Finish', days: [
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Doubles x2', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 3 â€” PrÃ©cision Bull', days: [
        { label: 'Bullseye Challenge', exId: 'bull_training', rest: false },
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Shanghai Express', exId: 'shanghai', rest: false },
        { label: 'Bullseye x2', exId: 'bull_training', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bilan mi-programme', exId: 'bobs27', rest: false },
      ]},
      { label: 'Semaine 4 â€” IntensitÃ©', days: [
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Shanghai Express', exId: 'shanghai', rest: false },
      ]},
      { label: 'Semaine 5 â€” Mental', days: [
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 6 â€” Bilan final', days: [
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bullseye Challenge', exId: 'bull_training', rest: false },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Test final â€” Bob\'s 27', exId: 'bobs27', rest: false },
      ]},
    ]
  },
  {
    id: 'prog_avance',
    icon: 'ğŸ”´',
    title: 'Programme AvancÃ©',
    subtitle: '8 semaines â€” Niveau compÃ©tition',
    level: 'avance',
    weeks: [
      { label: 'Semaine 1 â€” IntensitÃ© T20', days: [
        { label: '100 flÃ©chettes T20 x2', exId: '100fleches_t20', rest: false },
        { label: 'Shanghai Express', exId: 'shanghai', rest: false },
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Countdown 170 x2', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 2 â€” Doubles Pro', days: [
        { label: 'Circuit Doubles x2', exId: 'doubles_circuit', rest: false },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Bob\'s 27 (objectif 80+)', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Doubles x2', exId: 'doubles_circuit', rest: false },
        { label: 'Countdown 170', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 3 â€” Bull & Shanghai', days: [
        { label: 'Bullseye Challenge x2', exId: 'bull_training', rest: false },
        { label: 'Shanghai x2', exId: 'shanghai', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bullseye', exId: 'bull_training', rest: false },
        { label: 'Shanghai', exId: 'shanghai', rest: false },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 4 â€” Mi-programme', days: [
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Bob\'s 27 (record)', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Countdown 170 x2', exId: 'countdown_170', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
      ]},
      { label: 'Semaine 5 â€” Endurance', days: [
        { label: '100 flÃ©chettes T20 x2', exId: '100fleches_t20', rest: false },
        { label: 'Bullseye x2', exId: 'bull_training', rest: false },
        { label: 'Bob\'s 27', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Shanghai', exId: 'shanghai', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 6 â€” Pression compet.', days: [
        { label: 'Jeu de Pression x2', exId: 'pressure_game', rest: false },
        { label: 'Circuit Doubles', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Countdown 170 x2', exId: 'countdown_170', rest: false },
        { label: 'Jeu de Pression', exId: 'pressure_game', rest: false },
        { label: 'Bob\'s 27 (record)', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
      ]},
      { label: 'Semaine 7 â€” Peaking', days: [
        { label: '100 flÃ©chettes T20', exId: '100fleches_t20', rest: false },
        { label: 'Circuit Doubles x2', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Bullseye', exId: 'bull_training', rest: false },
        { label: 'Shanghai x2', exId: 'shanghai', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Repos actif', exId: null, rest: true },
      ]},
      { label: 'Semaine 8 â€” Ã‰valuation', days: [
        { label: 'Bob\'s 27 â€” test final', exId: 'bobs27', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'Circuit Doubles â€” test', exId: 'doubles_circuit', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: '100 flÃ©chettes T20 â€” test', exId: '100fleches_t20', rest: false },
        { label: 'Repos', exId: null, rest: true },
        { label: 'ğŸ¯ Bilan programme complet', exId: 'pressure_game', rest: false },
      ]},
    ]
  }
];

function renderTrainingPrograms(pid) {
  const grid = document.getElementById('training-programs-grid');
  if (!grid) return;

  const activeProg = pid ? trainingPrograms.find(tp => tp.playerId == pid && tp.active) : null;
  const lvColor = { debutant:'var(--green)', intermediaire:'var(--accent)', avance:'var(--red)' };
  const lvLabel = { debutant:'DÃ‰BUTANT', intermediaire:'INTERMÃ‰DIAIRE', avance:'AVANCÃ‰' };

  grid.innerHTML = TRAINING_PROGRAMS_DEF.map(prog => {
    const isActive = activeProg && activeProg.progId === prog.id;
    const userProg = pid ? trainingPrograms.find(tp => tp.playerId == pid && tp.progId === prog.id) : null;
    const doneDays = userProg ? (userProg.doneDays||[]).length : 0;
    const totalDays = prog.weeks.reduce((s,w)=>s+w.days.filter(d=>!d.rest).length, 0);
    const pct = Math.round(doneDays / Math.max(totalDays, 1) * 100);

    // Build dot map: all days flattened
    const allDots = prog.weeks.flatMap((w, wi) =>
      w.days.map((d, di) => {
        const key = `${prog.id}_w${wi}_d${di}`;
        const done = userProg && (userProg.doneDays||[]).includes(key);
        if (d.rest) return `<div class="prog-dot rest" title="Repos"></div>`;
        if (done)   return `<div class="prog-dot done" title="${d.label} âœ“"></div>`;
        if (isActive && !done) return `<div class="prog-dot active-day" title="${d.label}"></div>`;
        return `<div class="prog-dot pending" title="${d.label}"></div>`;
      })
    );

    return `<div class="prog-card ${isActive?'active-prog':''}" onclick="expandProgramDetail('${prog.id}','${pid||''}')">
      <div class="prog-header">
        <div class="prog-icon-wrap lv-${prog.level}">${prog.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:0.55rem;font-weight:700;letter-spacing:1.5px;color:${lvColor[prog.level]};text-transform:uppercase;margin-bottom:2px">${lvLabel[prog.level]}</div>
          <div class="prog-title">${prog.title}</div>
          <div class="prog-subtitle">${prog.subtitle}</div>
          ${isActive ? '<div class="prog-active-badge">â— ACTIF</div>' : ''}
        </div>
        <div style="flex-shrink:0;text-align:right">
          <div style="font-family:'DM Mono',monospace;font-weight:800;font-size:1.2rem;color:${pct>0?'var(--accent)':'var(--muted)'}">${pct}%</div>
          <div style="font-size:0.6rem;color:var(--muted)">${doneDays}/${totalDays}</div>
        </div>
      </div>
      <div class="prog-body">
        <div class="prog-progress"><div class="prog-progress-fill" style="width:${pct}%"></div></div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;margin-top:0.2rem">
          <div style="font-size:0.6rem;color:var(--muted)">${prog.weeks.length} semaines Â· ${totalDays} sessions</div>
        </div>
        <div class="prog-dots-row">${allDots.join('')}</div>
        <button class="btn ${isActive?'btn-secondary':'btn-primary'} btn-sm" style="width:100%;margin-top:0.7rem;font-size:0.72rem"
          onclick="event.stopPropagation();${isActive?`deactivateProgram('${prog.id}','${pid||''}')`:`activateProgram('${prog.id}','${pid||''}')`}">
          ${isActive ? 'â¸ Mettre en pause' : 'â–¶ DÃ©marrer ce programme'}
        </button>
      </div>
    </div>`;
  }).join('');

  // Render active program detail
  renderActiveProgramDetail(pid, activeProg);
}

function expandProgramDetail(progId, pid) {
  // Scroll to and expand active detail
  const detail = document.getElementById('active-program-detail');
  if (detail) detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderActiveProgramDetail(pid, activeProg) {
  const detail = document.getElementById('active-program-detail');
  if (!detail) return;
  if (!activeProg || !pid) { detail.innerHTML = ''; return; }
  const progDef = TRAINING_PROGRAMS_DEF.find(p=>p.id===activeProg.progId);
  if (!progDef) return;

  const doneDays = activeProg.doneDays || [];
  const totalDays = progDef.weeks.reduce((s,w)=>s+w.days.filter(d=>!d.rest).length, 0);
  const pct = Math.round(doneDays.length / Math.max(totalDays,1) * 100);
  const lvColor = { debutant:'var(--green)', intermediaire:'var(--accent)', avance:'var(--red)' };

  // Find next pending session
  let nextPending = null;
  outer: for (let wi=0; wi<progDef.weeks.length; wi++) {
    for (let di=0; di<progDef.weeks[wi].days.length; di++) {
      const d = progDef.weeks[wi].days[di];
      const key = `${progDef.id}_w${wi}_d${di}`;
      if (!d.rest && !doneDays.includes(key)) { nextPending = key; break outer; }
    }
  }

  detail.innerHTML = `<div class="prog-detail-card">
    <div class="prog-detail-header">
      <div style="display:flex;align-items:center;gap:0.8rem">
        <div class="prog-icon-wrap lv-${progDef.level}" style="width:40px;height:40px;font-size:1.3rem">${progDef.icon}</div>
        <div>
          <div style="font-size:0.6rem;font-weight:700;letter-spacing:1.5px;color:${lvColor[progDef.level]};text-transform:uppercase">${progDef.title}</div>
          <div style="font-size:0.72rem;color:var(--muted)">${progDef.subtitle} Â· dÃ©marrÃ© le ${activeProg.startDate||'?'}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-family:'DM Mono',monospace;font-weight:800;font-size:1.4rem;color:var(--accent)">${pct}%</div>
        <div style="font-size:0.62rem;color:var(--muted)">${doneDays.length}/${totalDays} sessions</div>
      </div>
    </div>
    <div style="padding:0.7rem 1.2rem;background:var(--surface2);border-bottom:1px solid var(--border)">
      <div style="height:6px;background:var(--surface3);border-radius:3px;overflow:hidden">
        <div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:3px;width:${pct}%;transition:width .4s"></div>
      </div>
    </div>

    ${progDef.weeks.map((w, wi) => {
      const weekDone = w.days.every((d,di) => d.rest || doneDays.includes(`${progDef.id}_w${wi}_d${di}`));
      const weekDoneCount = w.days.filter((d,di) => !d.rest && doneDays.includes(`${progDef.id}_w${wi}_d${di}`)).length;
      const weekTotal = w.days.filter(d=>!d.rest).length;

      return `<div class="prog-week-section">
        <div class="prog-week-title">
          <span>S${wi+1} â€” ${w.label}</span>
          ${weekDone ? '<span class="prog-week-done-tag">âœ“ ComplÃ¨te</span>' : `<span style="font-size:0.6rem;color:var(--muted);font-weight:400">${weekDoneCount}/${weekTotal}</span>`}
        </div>
        ${w.days.map((d, di) => {
          const key = `${progDef.id}_w${wi}_d${di}`;
          const done = doneDays.includes(key);
          const isRest = d.rest;
          const isNext = key === nextPending;

          if (isRest) return `<div class="prog-day-row prog-day-row-rest">
            <div class="prog-day-circle rest">â€”</div>
            <div class="prog-day-label" style="color:var(--muted);font-style:italic;font-size:0.72rem">Jour ${di+1} Â· Repos</div>
          </div>`;

          return `<div class="prog-day-row${isRest?' prog-day-row-rest':''}" onclick="${pid?`toggleProgDay('${progDef.id}','${pid}','${key}')`:''}" style="border:1px solid ${isNext?'rgba(230, 57, 70, 0.35)':'transparent'};background:${isNext?'rgba(230, 57, 70, 0.04)':'transparent'}">
            <div class="prog-day-circle ${done?'done':'pending'}">${wi*7+di+1}</div>
            <div style="flex:1">
              <div class="prog-day-label ${done?'done-text':''}">Jour ${di+1} Â· ${d.label}</div>
              ${isNext ? '<div style="font-size:0.6rem;color:var(--accent);font-weight:700;letter-spacing:0.5px">â–¶ Prochaine session</div>' : ''}
            </div>
            ${d.exId ? `<button class="btn btn-sm btn-secondary" style="font-size:0.62rem;padding:3px 8px;flex-shrink:0" onclick="event.stopPropagation();openExercise('${d.exId}')">â–¶ Lancer</button>` : ''}
            <div class="prog-day-check ${done?'done':''}">
              ${done ? 'âœ“' : ''}
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }).join('')}
  </div>`;
}

function activateProgram(progId, pid) {
  if (!pid) { showNotif('âš  SÃ©lectionnez un joueur d\'abord'); return; }
  trainingPrograms.forEach(tp=>{ if(tp.playerId==pid) tp.active=false; });
  const existing = trainingPrograms.find(tp=>tp.playerId==pid&&tp.progId===progId);
  if (existing) { existing.active=true; }
  else { trainingPrograms.push({ playerId:parseInt(pid), progId, active:true, doneDays:[], startDate:new Date().toISOString().slice(0,10) }); }
  localStorage.setItem('darts_train_programs', JSON.stringify(trainingPrograms));
  renderTrainingPrograms(pid);
  setTimeout(()=>{const d=document.getElementById('active-program-detail');if(d)d.scrollIntoView({behavior:'smooth',block:'start'});}, 100);
  showNotif('â–¶ Programme dÃ©marrÃ© !', 'success');
}

function deactivateProgram(progId, pid) {
  const tp = trainingPrograms.find(x=>x.playerId==pid&&x.progId===progId);
  if (tp) tp.active = false;
  localStorage.setItem('darts_train_programs', JSON.stringify(trainingPrograms));
  renderTrainingPrograms(pid);
  showNotif('â¸ Programme mis en pause');
}

function toggleProgDay(progId, pid, key) {
  const tp = trainingPrograms.find(x=>x.playerId==pid&&x.progId===progId);
  if (!tp) return;
  const idx = (tp.doneDays||[]).indexOf(key);
  if (idx>=0) tp.doneDays.splice(idx,1); else { tp.doneDays = tp.doneDays||[]; tp.doneDays.push(key); }
  localStorage.setItem('darts_train_programs', JSON.stringify(trainingPrograms));
  renderTrainingPrograms(pid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRAÃNEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let trainingSessions = JSON.parse(localStorage.getItem('darts_training') || '[]');
let activeTrainingSession = null;
let trainStepIndex = 0;


const EXERCISES = [
  {
    id: 'around_clock',
    icon: 'ğŸ•',
    title: 'Tour de l\'horloge',
    subtitle: 'Around the Clock',
    cat: 'warmup',
    catLabel: 'Ã‰chauffement',
    diff: 'easy',
    diffLabel: 'Facile',
    levels: ['debutant','intermediaire','avance'],
    desc: 'Visez chaque segment de 1 Ã  20 dans l\'ordre. 3 flÃ©chettes par numÃ©ro. IdÃ©al pour l\'Ã©chauffement et la mÃ©moire musculaire.',
    target: 'Toucher les 20 segments',
    targetUnit: '20 segments',
    maxScore: 20,
    duration: '10 min',
    steps: [
      { label: 'Hits sur 20 segments (1 flÃ©chette par numÃ©ro max)', max: 20, unit: 'segments' }
    ],
    tips: 'Gardez la mÃªme posture Ã  chaque lancer. Ne changez pas votre position entre les numÃ©ros.'
  },
  {
    id: 'bobs27',
    icon: 'ğŸ’¥',
    title: "Bob's 27",
    subtitle: 'Le classique pro des doubles',
    cat: 'doubles',
    catLabel: 'Doubles',
    diff: 'medium',
    diffLabel: 'IntermÃ©diaire',
    levels: ['debutant','intermediaire','avance'],
    desc: "Commencez avec 27 points. Tentez chaque double D1â†’D20 puis Bull (3 flÃ©chettes par double). Si vous touchez = +valeur du double. Si vous ratez = -valeur du double. Si vous tombez Ã  0 ou moins, c'est fini. Objectif : finir avec le plus de points ! Record mondial : +150+",
    target: 'Score final : 27+ (dÃ©b.) / 60+ (int.) / 100+ (avancÃ©)',
    targetUnit: 'points finaux',
    maxScore: 200,
    duration: '15 min',
    steps: [
      { label: 'Score final Bob\'s 27 (entrez 0 si vous avez perdu avant la fin)', max: 200, unit: 'pts' }
    ],
    tips: 'Concentrez-vous sur les gros doubles : D20 (+40), D18 (+36), D16 (+32). Un miss coÃ»te cher en fin de parcours !'
  },
  {
    id: 'atclock_train',
    icon: 'ğŸ•',
    title: 'Around the Clock',
    subtitle: '1 Ã  20 dans l\'ordre, en temps',
    cat: 'precision',
    catLabel: 'PrÃ©cision',
    diff: 'easy',
    diffLabel: 'Facile',
    levels: ['debutant','intermediaire'],
    desc: 'Touchez les numÃ©ros 1 Ã  20 dans l\'ordre, puis le Bull. 3 flÃ©chettes par numÃ©ro, passez au suivant dÃ¨s que touchÃ©. ChronomÃ©trez votre temps. Un warm-up universel utilisÃ© par tous les pros avant une session.',
    target: 'Temps cible : < 5 min (intermÃ©diaire)',
    targetUnit: 'numÃ©ros complÃ©tÃ©s',
    maxScore: 21,
    duration: '5 Ã  10 min',
    steps: [
      { label: 'NumÃ©ros complÃ©tÃ©s (sur 21 : 1â†’20 + Bull)', max: 21, unit: 'numÃ©ros' }
    ],
    tips: 'Ne vous prÃ©cipitez pas sur les premiers numÃ©ros. Installez votre routine dÃ¨s le 1, elle sera lÃ  au 20.'
  },
  {
    id: '100fleches_t20',
    icon: 'ğŸ¯',
    title: '100 flÃ©chettes T20',
    subtitle: 'PrÃ©cision sur Triple 20',
    cat: 'triples',
    catLabel: 'Triples',
    diff: 'medium',
    diffLabel: 'IntermÃ©diaire',
    levels: ['intermediaire','avance'],
    desc: 'Lancez 100 flÃ©chettes sur le Triple 20. Comptez les hits (T20 = 3pts, simple 20 = 1pt, ratÃ© = 0pt). Un classique des pros.',
    target: 'Score cible : 80+ pts (dÃ©butant) / 120+ (intermÃ©diaire)',
    targetUnit: '/ 300 pts max',
    maxScore: 300,
    duration: '15 min',
    steps: [
      { label: 'T20 touchÃ©s (sur 100 lancers)', max: 100, unit: 'T20' },
      { label: 'Singles 20 touchÃ©s', max: 100, unit: 'S20' }
    ],
    tips: 'Visualisez le T20 avant chaque lancer. Respirez avant de relÃ¢cher.'
  },
  {
    id: 'doubles_circuit',
    icon: 'ğŸ²',
    title: 'Circuit des Doubles',
    subtitle: 'D1 â†’ D20 + Bull',
    cat: 'doubles',
    catLabel: 'Doubles',
    diff: 'hard',
    diffLabel: 'AvancÃ©',
    levels: ['intermediaire','avance'],
    desc: 'Tentez chaque double de D1 Ã  D20, puis le Bull. 3 flÃ©chettes par double. Comptez le nombre total de doubles rÃ©ussis. Exercice clÃ© pour finir les parties.',
    target: 'Score cible : 7/21 (dÃ©b.) / 12/21 (int.) / 17/21 (avancÃ©)',
    targetUnit: '/ 21 doubles',
    maxScore: 21,
    duration: '20 min',
    steps: [
      { label: 'Doubles rÃ©ussis sur 21 tentatives (D1â†’D20 + Bull)', max: 21, unit: 'doubles' }
    ],
    tips: 'Concentrez-vous sur D16, D20 et D8 â€” les plus utilisÃ©s en fin de partie.'
  },
  {
    id: 'shanghai',
    icon: 'ğŸ¥¢',
    title: 'Shanghai Express',
    subtitle: 'Simple, Double, Triple',
    cat: 'precision',
    catLabel: 'PrÃ©cision',
    diff: 'medium',
    diffLabel: 'IntermÃ©diaire',
    levels: ['debutant','intermediaire','avance'],
    desc: 'Choisissez un numÃ©ro (ex: 20). RÃ©ussir un Shanghai = toucher le simple, le double ET le triple avec 3 flÃ©chettes. Scoring: Simple=1pt, Double=2pts, Triple=3pts, Shanghai=+5pts bonus.',
    target: 'Shanghai sur T20, T19, T18, T17',
    targetUnit: 'Shanghai bonus',
    maxScore: 30,
    duration: '12 min',
    steps: [
      { label: 'Score total (sur T20, T19, T18, T17 â€” 3 flÃ©chettes chacun)', max: 30, unit: 'pts' }
    ],
    tips: 'Commencez par le simple pour mettre en confiance, puis visez progressivement le double et le triple.'
  },
  {
    id: 'bull_training',
    icon: 'ğŸ±',
    title: 'Bullseye Challenge',
    subtitle: 'Bull & Bull\'s Eye',
    cat: 'precision',
    catLabel: 'PrÃ©cision',
    diff: 'hard',
    diffLabel: 'AvancÃ©',
    levels: ['intermediaire','avance'],
    desc: 'Lancez 30 flÃ©chettes sur le Bull. Bull\'s Eye (rouge) = 3pts, Bull (vert) = 1pt, ratÃ© = 0. Exercice redoutable pour la prÃ©cision absolue.',
    target: 'Score cible : 15+ pts / 90 max',
    targetUnit: '/ 90 pts max',
    maxScore: 90,
    duration: '10 min',
    steps: [
      { label: 'Bull\'s Eye touchÃ©s (sur 30 lancers)', max: 30, unit: 'Bull\'s Eye' },
      { label: 'Bull (zone verte) touchÃ©s', max: 30, unit: 'Bull' }
    ],
    tips: 'Le bull se vise avec un angle lÃ©gÃ¨rement descendant. Gardez le coude fixe.'
  },
  {
    id: 'countdown_170',
    icon: 'â¬‡ï¸',
    title: 'Countdown 170',
    subtitle: 'Version courte du 501',
    cat: 'mental',
    catLabel: 'Mental & Jeu',
    diff: 'medium',
    diffLabel: 'IntermÃ©diaire',
    levels: ['debutant','intermediaire','avance'],
    desc: 'Partez de 170 et descendez Ã  0 en double out. Comptez le nombre de flÃ©chettes utilisÃ©es. Moins c\'est d\'flÃ©chettes, mieux c\'est ! Objectif : finir en 9 flÃ©chettes max.',
    target: 'Objectif : â‰¤ 9 flÃ©chettes',
    targetUnit: 'flÃ©chettes utilisÃ©es',
    maxScore: 30,
    duration: '10 min',
    steps: [
      { label: 'Nombre de flÃ©chettes pour finir (entrez 30 si DNF)', max: 30, unit: 'flÃ©chettes', inverted: true }
    ],
    tips: '170 = T20 + T20 + Bull. Apprenez les finishes classiques par cÅ“ur.'
  },
  {
    id: 'weak_numbers',
    icon: 'ğŸ”',
    title: 'Chasse aux Points Faibles',
    subtitle: 'Identifier et corriger',
    cat: 'precision',
    catLabel: 'PrÃ©cision',
    diff: 'easy',
    diffLabel: 'Facile',
    levels: ['debutant','intermediaire'],
    desc: 'Lancez 3 flÃ©chettes sur chaque numÃ©ro de 1 Ã  20. Notez les numÃ©ros oÃ¹ vous ratez rÃ©guliÃ¨rement. Puis refaites 10 lancers sur vos 3 pires numÃ©ros.',
    target: 'Couvrir les 20 numÃ©ros',
    targetUnit: '/ 20 numÃ©ros',
    maxScore: 20,
    duration: '15 min',
    steps: [
      { label: 'NumÃ©ros touchÃ©s (au moins 1 flÃ©chette sur 3)', max: 20, unit: 'numÃ©ros' }
    ],
    tips: 'Notez vos rÃ©sultats pour comparer d\'une session Ã  l\'autre. L\'amÃ©lioration vient de la rÃ©gularitÃ©.'
  },
  {
    id: 'pressure_game',
    icon: 'ğŸ’¥',
    title: 'Jeu de Pression',
    subtitle: 'Simuler la compÃ©tition',
    cat: 'mental',
    catLabel: 'Mental & Jeu',
    diff: 'hard',
    diffLabel: 'AvancÃ©',
    levels: ['avance'],
    desc: 'Partez de 25 points. Visez le Double 1. Hit = +valeur, ratÃ© = -valeur. Progressez D1â†’D20. Un des exercices les plus efficaces pour s\'entraÃ®ner sous pression.',
    target: 'Finir avec le score le plus Ã©levÃ©',
    targetUnit: 'pts finaux',
    maxScore: 100,
    duration: '20 min',
    steps: [
      { label: 'Score final aprÃ¨s D1â†’D20', max: 100, unit: 'pts' }
    ],
    tips: 'Cet exercice reproduit fidÃ¨lement la pression des matchs. Ne changez pas votre style de lancer sous stress.'
  }
];

function renderTrainingPage() {
  // Populate player select
  const sel = document.getElementById('train-player-select');
  if (!sel) return;
  const currentVal = sel.value;
  sel.innerHTML = '<option value="">-- Choisir un joueur --</option>' +
    players.map(p => `<option value="${p.id}" ${p.id == currentVal ? 'selected':''}>
      ${p.pseudo}${p.name ? ' ('+p.name+')':''}</option>`).join('');

  const level = document.getElementById('train-level')?.value || 'intermediaire';
  const pid = sel.value;

  // Stats row
  const statsRow = document.getElementById('train-stats-row');
  if (pid) {
    const pSessions = trainingSessions.filter(s => s.playerId == pid);
    const totalSessions = pSessions.length;
    const uniqueExercises = new Set(pSessions.map(s => s.exerciseId)).size;
    const lastSession = pSessions.slice(-1)[0];
    const lastDate = lastSession ? new Date(lastSession.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}) : 'â€”';
    statsRow.innerHTML = `
      <div class="stat-block">
        <div class="stat-label">Sessions</div>
        <div class="stat-value" style="font-size:1.6rem">${totalSessions}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">Exercices pratiquÃ©s</div>
        <div class="stat-value" style="font-size:1.6rem">${uniqueExercises}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">DerniÃ¨re session</div>
        <div class="stat-value" style="font-size:1.1rem;margin-top:4px">${lastDate}</div>
      </div>
    `;
  } else {
    statsRow.innerHTML = '';
  }

  // Exercises grid
  const grid = document.getElementById('train-exercises-grid');
  const filtered = EXERCISES.filter(ex => ex.levels.includes(level));
  grid.innerHTML = filtered.map(ex => {
    const pRecord = pid ? trainingSessions.filter(s => s.playerId == pid && s.exerciseId === ex.id) : [];
    const bestScore = pRecord.length > 0 ? Math.max(...pRecord.map(s => s.score)) : null;
    const completedClass = pRecord.length > 0 ? 'completed' : '';
    const prHtml = bestScore !== null ? `<span class="ex-pr">ğŸ… Record: ${bestScore} ${ex.steps[0].unit}</span>` : '';
    return `
    <div class="exercise-card cat-${ex.cat} ${completedClass}" onclick="openExercise('${ex.id}')">
      <div class="ex-header">
        <div class="ex-icon">${ex.icon}</div>
        <div>
          <div class="ex-title">${ex.title}</div>
          <div class="ex-subtitle">${ex.subtitle}</div>
        </div>
      </div>
      <div class="ex-badges">
        <span class="ex-badge diff-${ex.diff === 'Facile' ? 'easy' : ex.diff === 'AvancÃ©' ? 'hard' : 'medium'} diff-${ex.diff === 'easy' ? 'easy' : ex.diff === 'hard' ? 'hard' : 'medium'}">${ex.diffLabel}</span>
        <span class="ex-badge cat-label">${ex.catLabel}</span>
        <span class="ex-badge cat-label">â± ${ex.duration}</span>
      </div>
      <div class="ex-desc">${ex.desc}</div>
      <div class="ex-target">
        <span class="ex-target-label">ğŸ¯ Objectif</span>
        <span class="ex-target-val">${ex.targetUnit}</span>
      </div>
      <div class="ex-footer">
        ${prHtml}
        <button class="btn btn-primary" style="margin-left:auto;font-size:0.7rem" onclick="event.stopPropagation();openExercise('${ex.id}')">â–¶ Lancer</button>
      </div>
    </div>`;
  }).join('');

  // Weekly goal
  renderWeeklyGoal(pid);
  // Progress chart
  renderExerciseProgressChart(pid);
  // History
  renderTrainingHistory(pid);
  // Multi-week programs
  renderTrainingPrograms(pid);
}

function renderTrainingHistory(pid) {
  const histList = document.getElementById('train-history-list');
  let sessions = pid
    ? trainingSessions.filter(s => s.playerId == pid)
    : trainingSessions;
  sessions = sessions.slice().reverse().slice(0, 20);

  if (sessions.length === 0) {
    histList.innerHTML = `<div style="color:var(--muted);font-size:0.8rem;padding:1rem;text-align:center">Aucune session enregistrÃ©e â€” lancez un exercice !</div>`;
    return;
  }

  histList.innerHTML = sessions.map(s => {
    const ex = EXERCISES.find(e => e.id === s.exerciseId);
    const p = players.find(pp => pp.id == s.playerId);
    const date = new Date(s.date).toLocaleDateString('fr-FR', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
    const pct = ex ? Math.min(100, Math.round(s.score / ex.maxScore * 100)) : 0;
    const medal = pct >= 90 ? 'ğŸ¥‡' : pct >= 70 ? 'ğŸ¥ˆ' : pct >= 50 ? 'ğŸ¥‰' : 'ğŸ“‹';
    return `<div class="train-hist-item">
      <span class="train-hist-medal">${ex ? ex.icon : 'ğŸ¯'}</span>
      <div class="train-hist-ex">
        ${ex ? ex.title : s.exerciseId}
        ${p ? `<span style="font-size:0.65rem;color:var(--muted);margin-left:0.4rem">â€” ${p.pseudo}</span>` : ''}
      </div>
      <span class="train-hist-score">${s.score} ${ex ? ex.steps[0].unit : 'pts'}</span>
      <span class="train-hist-medal">${medal}</span>
      <span class="train-hist-date">${date}</span>
    </div>`;
  }).join('');
}

function openExercise(exerciseId) {
  const pid = document.getElementById('train-player-select')?.value;
  const ex = EXERCISES.find(e => e.id === exerciseId);
  if (!ex) return;

  activeTrainingSession = { exerciseId, playerId: pid, stepScores: [], date: new Date().toISOString() };
  trainStepIndex = 0;
  document.getElementById('train-modal-title').textContent = ex.icon + ' ' + ex.title;
  renderTrainingStep();
  document.getElementById('train-session-modal').classList.add('active');
}

function renderTrainingStep() {
  const ex = EXERCISES.find(e => e.id === activeTrainingSession.exerciseId);
  if (!ex) return;
  const body = document.getElementById('train-modal-body');

  if (trainStepIndex >= ex.steps.length) {
    renderTrainingResult(ex);
    return;
  }

  const step = ex.steps[trainStepIndex];
  const currentVal = activeTrainingSession.stepScores[trainStepIndex] || 0;
  const pct = Math.min(100, Math.round(currentVal / step.max * 100));
  const stepProgress = `${trainStepIndex + 1} / ${ex.steps.length}`;

  // Determine if this exercise can use interactive dart entry (per-throw)
  const interactiveExs = ['triple20_100', '100fleches_t20', 'bobs27', 'doubles_circuit', 'bull_training', 'pressure_game', 'shanghai', 'around_clock', 'atclock_train', 'weak_numbers'];
  const useInteractive = interactiveExs.includes(ex.id);

  // Init throw history if not present
  if (!activeTrainingSession._throwLog) activeTrainingSession._throwLog = [];

  const throwLog = activeTrainingSession._throwLog;
  const throwLogHtml = throwLog.length > 0
    ? `<div style="margin-bottom:0.8rem"><div style="font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Derniers lancers</div><div style="display:flex;flex-wrap:wrap;gap:4px">${throwLog.slice(-9).map(t => `<span style="background:var(--surface3);border:1px solid var(--border);border-radius:5px;padding:2px 7px;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--accent)">${t}</span>`).join('')}</div></div>`
    : '';

  body.innerHTML = `
    <div style="margin-bottom:1rem;padding:0.6rem 1rem;background:var(--accent-dim);border:1px solid rgba(230, 57, 70, 0.3);border-radius:8px;font-size:0.75rem;color:var(--text-dim);line-height:1.5">
      ğŸ’¡ <strong>Astuce :</strong> ${ex.tips}
    </div>
    ${ex.steps.length > 1 ? `<div style="font-size:0.62rem;color:var(--muted);text-align:right;margin-bottom:0.5rem">Ã‰tape ${stepProgress}</div>` : ''}
    <div class="train-step">
      <div class="train-step-title">
        <span>${ex.icon}</span>
        <span>${step.label}</span>
      </div>
      <!-- Score display -->
      <div style="display:flex;align-items:center;gap:0.8rem;margin:0.8rem 0">
        <div style="flex:1;text-align:center;background:var(--surface2);border-radius:8px;padding:0.8rem">
          <div style="font-size:0.6rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase">Score actuel</div>
          <div id="train-count-display" style="font-family:'Bebas Neue', sans-serif;font-size:2.5rem;font-weight:800;color:var(--accent)">${currentVal}</div>
          <div style="font-size:0.65rem;color:var(--muted)">/ ${step.max} ${step.unit}</div>
        </div>
      </div>
      <div class="train-score-bar"><div class="train-score-fill" id="train-score-fill" style="width:${pct}%"></div></div>
      <div style="text-align:right;font-size:0.62rem;color:var(--muted);margin-top:3px">${pct}%</div>
    </div>

    ${throwLogHtml}

    ${useInteractive ? `
    <!-- Interactive dart entry -->
    <div style="margin-bottom:0.8rem">
      <div style="font-size:0.62rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:6px">ğŸ¯ Entrer les flÃ©chettes</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:6px">
        ${[1,2,3,4,5,6,7,8,9,10].map(n=>`<div class="sc-key" style="min-height:38px;font-size:0.8rem;padding:4px" onclick="trainThrow(${n})">${n}</div>`).join('')}
        ${[11,12,13,14,15,16,17,18,19,20].map(n=>`<div class="sc-key" style="min-height:38px;font-size:0.8rem;padding:4px" onclick="trainThrow(${n})">${n}</div>`).join('')}
        <div class="sc-key bull span2" style="min-height:38px;font-size:0.75rem;padding:4px" onclick="trainThrow(25)">Bull 25</div>
        <div class="sc-key bull span2" style="min-height:38px;font-size:0.75rem;padding:4px;background:rgba(240,83,74,0.15);border-color:rgba(240,83,74,0.4);color:var(--red)" onclick="trainThrow(50)">ğŸ¯ Bull 50</div>
        <div class="sc-key miss span1" style="min-height:38px;font-size:0.75rem;padding:4px" onclick="trainThrow(0)">âœ•</div>
      </div>
    </div>
    ` : ''}

    <!-- Manual +/- and direct input -->
    <div style="margin-bottom:1rem">
      <div style="font-size:0.62rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:6px">${useInteractive ? 'âœï¸ Ajustement manuel' : 'ğŸ“Š Saisie du score'}</div>
      <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap">
        <button class="train-count-btn" onclick="adjustTrainCount(-5)" style="font-size:0.7rem">âˆ’5</button>
        <button class="train-count-btn" onclick="adjustTrainCount(-1)">âˆ’</button>
        <input type="number" id="train-manual-input" min="0" max="${step.max}" value="${currentVal}"
          style="max-width:90px;font-size:1.1rem;text-align:center;font-family:'DM Mono',monospace;font-weight:700;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.3rem;color:var(--text)"
          oninput="syncTrainInput(this.value)">
        <button class="train-count-btn" onclick="adjustTrainCount(1)">+</button>
        <button class="train-count-btn" onclick="adjustTrainCount(5)" style="font-size:0.7rem">+5</button>
      </div>
    </div>

    <div style="display:flex;gap:0.6rem;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="closeTrainingSession()">Annuler</button>
      <button class="btn btn-primary" style="flex:1" onclick="nextTrainStep()">
        ${trainStepIndex < ex.steps.length - 1 ? 'Ã‰tape suivante â†’' : 'âœ“ Terminer l\'exercice'}
      </button>
    </div>
  `;
}

function adjustTrainCount(delta) {
  const ex = EXERCISES.find(e => e.id === activeTrainingSession.exerciseId);
  const step = ex.steps[trainStepIndex];
  const current = activeTrainingSession.stepScores[trainStepIndex] || 0;
  const newVal = Math.max(0, Math.min(step.max, current + delta));
  activeTrainingSession.stepScores[trainStepIndex] = newVal;
  const displayEl = document.getElementById('train-count-display');
  if (displayEl) displayEl.textContent = newVal;
  const manualEl = document.getElementById('train-manual-input');
  if (manualEl) manualEl.value = newVal;
  const pct = Math.min(100, Math.round(newVal / step.max * 100));
  const fillEl = document.getElementById('train-score-fill');
  if (fillEl) fillEl.style.width = pct + '%';
}

function trainThrow(score) {
  // Add a throw to the throw log and update score accordingly
  if (!activeTrainingSession._throwLog) activeTrainingSession._throwLog = [];
  activeTrainingSession._throwLog.push(score);
  const ex = EXERCISES.find(e => e.id === activeTrainingSession.exerciseId);
  const step = ex.steps[trainStepIndex];
  // For most exercises, each hit=1 (or score value). Adjust logic per exercise type.
  let increment = 1;
  if (['bobs27','pressure_game','bull_training','100fleches_t20','shanghai','halfit'].includes(ex.id)) {
    increment = score > 0 ? 1 : 0;
  } else if (ex.id === 'around_clock' || ex.id === 'atclock_train' || ex.id === 'weak_numbers' || ex.id === 'doubles_circuit') {
    increment = score > 0 ? 1 : 0;
  }
  const current = activeTrainingSession.stepScores[trainStepIndex] || 0;
  const newVal = Math.min(step.max, current + increment);
  activeTrainingSession.stepScores[trainStepIndex] = newVal;
  // Re-render step to show updated throw log and score
  renderTrainingStep();
}

function syncTrainInput(val) {
  const ex = EXERCISES.find(e => e.id === activeTrainingSession.exerciseId);
  const step = ex.steps[trainStepIndex];
  const newVal = Math.max(0, Math.min(step.max, parseInt(val) || 0));
  activeTrainingSession.stepScores[trainStepIndex] = newVal;
  document.getElementById('train-count-display').textContent = newVal;
  const pct = Math.min(100, Math.round(newVal / step.max * 100));
  document.getElementById('train-score-fill').style.width = pct + '%';
}

function nextTrainStep() {
  const ex = EXERCISES.find(e => e.id === activeTrainingSession.exerciseId);
  if (activeTrainingSession.stepScores[trainStepIndex] === undefined) {
    activeTrainingSession.stepScores[trainStepIndex] = 0;
  }
  trainStepIndex++;
  if (trainStepIndex >= ex.steps.length) {
    // Calculate final score
    let totalScore = 0;
    ex.steps.forEach((step, i) => {
      const val = activeTrainingSession.stepScores[i] || 0;
      if (i === 0) totalScore += val; // main step counts
      // For multi-step like T20: T20 hits * 3 + S20 hits * 1
      if (ex.id === 'triple20_100' && i === 1) totalScore += val;
      if (ex.id === 'bull_training' && i === 1) totalScore += val;
    });
    if (ex.id === 'triple20_100') {
      totalScore = (activeTrainingSession.stepScores[0] || 0) * 3 + (activeTrainingSession.stepScores[1] || 0);
    }
    if (ex.id === 'bull_training') {
      totalScore = (activeTrainingSession.stepScores[0] || 0) * 3 + (activeTrainingSession.stepScores[1] || 0);
    }
    if (ex.id === 'countdown_170') {
      // inverted: fewer darts = better. Score = max - actual
      const darts = activeTrainingSession.stepScores[0] || 30;
      totalScore = Math.max(0, 31 - darts); // 30 darts â†’ score 1, 9 darts â†’ score 22
    }
    activeTrainingSession.score = totalScore;
    saveTrainingSession();
    renderTrainingResult(ex);
  } else {
    renderTrainingStep();
  }
}

function saveTrainingSession() {
  trainingSessions.push(activeTrainingSession);
  localStorage.setItem('darts_training', JSON.stringify(trainingSessions));
}

function renderTrainingResult(ex) {
  const score = activeTrainingSession.score;
  const pct = Math.min(100, Math.round(score / ex.maxScore * 100));
  const medal = pct >= 90 ? { icon: 'ğŸ¥‡', msg: 'Performance exceptionnelle ! Vous Ãªtes au niveau des pros.' }
    : pct >= 70 ? { icon: 'ğŸ¥ˆ', msg: 'TrÃ¨s bon rÃ©sultat ! Continuez sur cette lancÃ©e.' }
    : pct >= 50 ? { icon: 'ğŸ¥‰', msg: 'Bon exercice ! RÃ©pÃ©tez rÃ©guliÃ¨rement pour progresser.' }
    : { icon: 'ğŸ“‹', msg: 'Bon dÃ©but. La rÃ©gularitÃ© est la clÃ©. Revenez demain !' };

  // Check personal record
  const pid = activeTrainingSession.playerId;
  const prevSessions = trainingSessions.slice(0, -1).filter(s => s.playerId == pid && s.exerciseId === ex.id);
  const prevBest = prevSessions.length > 0 ? Math.max(...prevSessions.map(s => s.score)) : -1;
  const isPR = score > prevBest;

  document.getElementById('train-modal-body').innerHTML = `
    <div class="train-result">
      <div class="train-result-medal">${medal.icon}${isPR && prevBest >= 0 ? ' ğŸ†•' : ''}</div>
      <div class="train-result-score">${score}</div>
      <div class="train-result-label">${ex.steps[0].unit} ${ex.id === 'countdown_170' ? '(score ajustÃ©)' : ''}</div>
      ${isPR && prevBest >= 0 ? '<div style="font-size:0.72rem;font-weight:700;color:var(--gold);letter-spacing:1px;margin-top:4px">ğŸ… NOUVEAU RECORD PERSONNEL !</div>' : ''}
      <div class="train-score-bar" style="max-width:300px;margin:1rem auto">
        <div class="train-score-fill" style="width:${pct}%"></div>
      </div>
      <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.5rem">${pct}% de l'objectif maximum</div>
      <div class="train-result-msg">${medal.msg}</div>
    </div>
    ${prevSessions.length > 0 ? `
    <div style="margin-bottom:1.2rem;background:var(--surface2);border-radius:8px;padding:0.9rem 1rem">
      <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:0.8rem">ğŸ“ˆ Progression (${Math.min(prevSessions.length+1,10)} derniÃ¨res sessions)</div>
      ${renderExerciseResultChart([...prevSessions.slice(-9), activeTrainingSession], ex)}
      <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:var(--muted);margin-top:4px">
        <span>Record : <strong style="color:var(--gold)">${Math.max(score, prevBest)}</strong></span>
        <span>Moy : <strong style="color:var(--accent)">${Math.round(([...prevSessions.slice(-9), activeTrainingSession].reduce((a,s)=>a+s.score,0) / Math.min(prevSessions.length+1,10)))}</strong></span>
      </div>
    </div>` : ''}
    <div style="background:var(--surface2);border-radius:8px;padding:0.8rem 1rem;font-size:0.76rem;color:var(--text-dim);margin-bottom:1.2rem;line-height:1.6">
      <strong>ğŸ’¡ Prochaine Ã©tape :</strong> ${getNextTip(ex, pct)}
    </div>
    <div style="display:flex;gap:0.6rem">
      <button class="btn btn-secondary" style="flex:1" onclick="closeTrainingSession()">Fermer</button>
      <button class="btn btn-primary" style="flex:1" onclick="closeTrainingSession();openExercise('${ex.id}')">ğŸ”„ Refaire</button>
    </div>
  `;
}

function renderExerciseResultChart(sessions, ex) {
  if (!sessions || sessions.length < 2) return '';
  const scores = sessions.map(s => s.score || 0);
  const maxScore = Math.max(...scores, 1);
  const lastScore = scores[scores.length - 1];
  const firstScore = scores[0];
  const trend = lastScore >= firstScore ? '#34d47b' : '#f0534a';
  // Mini bar chart
  const bars = scores.map((s, i) => {
    const h = Math.max(4, Math.round(s / maxScore * 48));
    const isLast = i === scores.length - 1;
    const col = isLast ? 'var(--accent)' : (s === Math.max(...scores) ? '#34d47b' : 'var(--border2)');
    const date = sessions[i].date ? new Date(sessions[i].date).toLocaleDateString('fr-FR', {day:'numeric',month:'short'}) : '';
    return `<div title="${date}: ${s} ${ex.steps[0].unit}" style="flex:1;min-width:10px;height:${h}px;background:${col};border-radius:3px 3px 0 0;cursor:default;transition:height 0.3s"></div>`;
  }).join('');
  return `<div style="display:flex;align-items:flex-end;gap:3px;height:52px;padding:0 0.2rem">${bars}</div>`;
}

function getNextTip(ex, pct) {
  if (ex.id === 'bobs27') return pct >= 50 ? "Essayez de ne jamais tomber en dessous de 0 sur les gros doubles. Allez sur D20 en premier !" : "Commencez par mÃ©moriser les valeurs : D20=40, D19=38, D18=36. Planifiez avant de lancer.";
  if (ex.id === 'atclock_train') return pct >= 90 ? 'Essayez de complÃ©ter Around the Clock en visant uniquement les doubles pour un dÃ©fi supplÃ©mentaire !' : 'RÃ©pÃ©tez tous les jours comme warm-up : 10 minutes avant chaque session de jeu.';
  if (ex.id === 'around_clock') return pct >= 80 ? 'Essayez de toucher chaque segment en une seule flÃ©chette !' : 'Travaillez votre cohÃ©rence en rÃ©pÃ©tant 2x par semaine.';
  if (ex.id === 'triple20_100') return pct >= 60 ? 'Visez maintenant 140+ points. Concentrez-vous sur le groupement.' : 'Travaillez votre posture et la stabilitÃ© du coude.';
  if (ex.id === 'doubles_circuit') return pct >= 70 ? 'EntraÃ®nez-vous sur les doubles sous pression (jeu des 25 points).' : 'Pratiquez D16, D20, D8 â€” les 3 doubles les plus utilisÃ©s en compÃ©tition.';
  if (ex.id === 'bull_training') return pct >= 50 ? 'Essayez de maintenir votre angle de lancer constant.' : 'Descendez lÃ©gÃ¨rement votre point de visÃ©e, le bull se lance avec un angle plus plat.';
  return 'RÃ©pÃ©tez cet exercice 3x par semaine pour progresser rapidement.';
}

function startTrainingSession() {
  const pid = document.getElementById('train-player-select')?.value;
  if (!pid) { showNotif('âš  SÃ©lectionnez un joueur d\'abord'); return; }
  // Scroll to exercises
  document.getElementById('train-exercises-grid')?.scrollIntoView({behavior:'smooth'});
  showNotif('ğŸ‘Š Choisissez un exercice pour dÃ©marrer !', 'success');
}

function closeTrainingSession() {
  document.getElementById('train-session-modal').classList.remove('active');
  activeTrainingSession = null;
  trainStepIndex = 0;
  // Refresh page
  const pid = document.getElementById('train-player-select')?.value;
  renderTrainingHistory(pid);
  renderTrainingPage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPTEUR DE POINTS â€” SCORE COUNTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SC_CHECKOUT_TABLE = {
  170:['T20','T20','Bull'],
  167:['T20','T19','Bull'],168:['T20','T20','D14'],
  164:['T20','T18','Bull'],161:['T20','T17','Bull'],
  160:['T20','T20','D20'],158:['T20','T20','D19'],
  157:['T20','T19','D20'],156:['T20','T20','D18'],
  155:['T20','T19','D19'],154:['T20','T18','D20'],
  153:['T20','T19','D18'],152:['T20','T20','D16'],
  151:['T20','T17','D20'],150:['T20','T18','D18'],
  149:['T20','T19','D16'],148:['T20','T20','D14'],
  147:['T20','T17','D18'],146:['T20','T18','D16'],
  145:['T20','T19','D14'],144:['T20','T20','D12'],
  143:['T20','T17','D16'],142:['T20','T18','D14'],
  141:['T20','T19','D12'],140:['T20','T20','D10'],
  139:['T20','T13','D20'],138:['T20','T18','D12'],
  137:['T20','T19','D10'],136:['T20','T20','D8'],
  135:['T20','T17','D12'],134:['T20','T14','D16'],
  133:['T20','T19','D8'],132:['T20','T16','D12'],
  131:['T20','T13','D16'],130:['T20','T18','D8'],
  129:['T19','T16','D12'],128:['T20','T16','D10'],
  127:['T20','T17','D8'],126:['T19','T19','D6'],
  125:['T20','T19','D4'],124:['T20','T16','D8'],
  123:['T19','T16','D9'],122:['T18','T18','D7'],
  121:['T20','T11','D14'],120:['T20','S20','D20'],
  119:['T19','T12','D13'],118:['T20','S18','D20'],
  117:['T20','S17','D20'],116:['T20','S16','D20'],
  115:['T19','S18','D20'],114:['T20','S14','D20'],
  113:['T19','S16','D20'],112:['T20','S12','D20'],
  111:['T19','S14','D20'],110:['T20','S10','D20'],
  109:['T19','S12','D20'],108:['T20','S8','D20'],
  107:['T19','S10','D20'],106:['T20','S6','D20'],
  105:['T19','S8','D20'],104:['T18','S18','D16'],
  103:['T19','S6','D20'],102:['T20','S2','D20'],
  101:['T17','S10','D20'],100:['T20','D20'],
  99:['T19','S10','D16'],98:['T20','D19'],
  97:['T19','D20'],96:['T20','D18'],
  95:['T19','D19'],94:['T18','D20'],
  93:['T19','D18'],92:['T20','D16'],
  91:['T17','D20'],90:['T18','D18'],
  89:['T19','D16'],88:['T20','D14'],
  87:['T17','D18'],86:['T18','D16'],
  85:['T15','D20'],84:['T20','D12'],
  83:['T17','D16'],82:['T14','D20'],
  81:['T19','D12'],80:['T20','D10'],
  79:['T13','D20'],78:['T18','D12'],
  77:['T19','D10'],76:['T20','D8'],
  75:['T17','D12'],74:['T14','D16'],
  73:['T19','D8'],72:['T16','D12'],
  71:['T13','D16'],70:['T18','D8'],
  69:['T19','D6'],68:['T20','D4'],
  67:['T17','D8'],66:['T10','D18'],
  65:['T19','D4'],64:['T16','D8'],
  63:['T17','D6'],62:['T10','D16'],
  61:['T15','D8'],60:['S20','D20'],
  59:['S19','D20'],58:['S18','D20'],
  57:['S17','D20'],56:['S16','D20'],
  55:['S15','D20'],54:['S14','D20'],
  53:['S13','D20'],52:['S12','D20'],
  51:['S11','D20'],50:['Bull'],
  49:['S9','D20'],48:['S8','D20'],
  47:['S7','D20'],46:['S6','D20'],
  45:['S5','D20'],44:['S4','D20'],
  43:['S3','D20'],42:['S2','D20'],
  41:['S1','D20'],40:['D20'],
  38:['D19'],36:['D18'],34:['D17'],
  32:['D16'],30:['D15'],28:['D14'],
  26:['D13'],24:['D12'],22:['D11'],
  20:['D10'],18:['D9'],16:['D8'],
  14:['D7'],12:['D6'],10:['D5'],
  8:['D4'],6:['D3'],4:['D2'],2:['D1']
};

const HALFIT_TARGETS = ['15','16','17','18','19','20','Bull','Double','Triple'];
const SHANGHAI_ROUNDS = [1,2,3,4,5,6,7];
const CRICKET_NUMS = [20,19,18,17,16,15,'B'];
const CRICKET_NUM_LABELS = ['20','19','18','17','16','15','Bull'];

let scState = {
  game: '501',
  players: [],
  currentPlayer: 0,
  darts: [],           // current volÃ©e darts [{val,mult}]
  history: [],         // [{playerIdx, darts, score, type}]
  multiplier: 1,
  options: {},
  round: 1,
  gameStarted: false,
  winner: null
};

function openScoreCounter() {
  document.getElementById('sc-overlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  scInitSetup();
}

function closeScoreCounter() {
  scState.gameStarted = false;
  document.getElementById('sc-overlay').classList.remove('active');
  document.body.style.overflow = '';
}

function scInitSetup() {
  // Pre-fill with app players if available â€” keep existing state if already set up
  if (!scState.gameStarted) {
    scState.players = [];
    if (players && players.length >= 2) {
      // Default: first 2 app players, fully linked
      scState.players = players.slice(0, 2).map(function(p) {
        return { name: p.pseudo || p.name || 'Joueur', id: p.id };
      });
    } else if (players && players.length === 1) {
      scState.players = [
        { name: players[0].pseudo, id: players[0].id },
        { name: 'Joueur 2', id: null }
      ];
    } else {
      scState.players = [{ name: 'Joueur 1', id: null }, { name: 'Joueur 2', id: null }];
    }
  }
  scRenderSetupPlayers();
  scSelectGame(scState.game, document.querySelector('.sc-game-card.selected'));
  document.getElementById('sc-setup-screen').style.display = 'flex';
  document.getElementById('sc-game-screen').style.display = 'none';
  document.getElementById('sc-undo-btn').style.display = 'none';
  document.getElementById('sc-game-name-display').textContent = 'Compteur';
}

function scSelectGame(game, el) {
  document.querySelectorAll('.sc-game-card').forEach(c => c.classList.remove('selected'));
  if (el) el.classList.add('selected');
  scState.game = game;
  scRenderOptions();
}

function scRenderOptions() {
  const el = document.getElementById('sc-options-content');
  const game = scState.game;
  let html = '';

  if (['501','301','701'].includes(game)) {
    const legs = scState.options.legs || 1;
    html += `<div style="margin-bottom:0.8rem">
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">Nombre de manches (legs)</div>
      <div class="sc-options-grid">
        ${[1,2,3,5].map(n => `<div class="sc-opt-chip ${legs==n?'selected':''}" onclick="scSetOpt('legs',${n},this)">${n} ${n>1?'legs':'leg'}</div>`).join('')}
      </div>
    </div>`;
    const checkout = scState.options.checkout || 'double';
    html += `<div style="margin-bottom:0.8rem">
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">RÃ¨gle de fermeture</div>
      <div class="sc-options-grid">
        <div class="sc-opt-chip ${checkout==='straight'?'selected':''}" onclick="scSetOpt('checkout','straight',this)">Straight (libre)</div>
        <div class="sc-opt-chip ${checkout==='double'?'selected':''}" onclick="scSetOpt('checkout','double',this)">Double Out</div>
        <div class="sc-opt-chip ${checkout==='master'?'selected':''}" onclick="scSetOpt('checkout','master',this)">Master (D ou T)</div>
      </div>
    </div>`;
    const dblin = scState.options.doubleIn || false;
    html += `<div>
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">Ouverture</div>
      <div class="sc-options-grid">
        <div class="sc-opt-chip ${!dblin?'selected':''}" onclick="scSetOpt('doubleIn',false,this)">Libre</div>
        <div class="sc-opt-chip ${dblin?'selected':''}" onclick="scSetOpt('doubleIn',true,this)">Double In obligatoire</div>
      </div>
    </div>`;
  } else if (game === 'countup') {
    const rounds = scState.options.rounds || 10;
    html += `<div>
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">Nombre de volÃ©es par joueur</div>
      <div class="sc-options-grid">
        ${[5,8,10,15,20].map(n => `<div class="sc-opt-chip ${rounds==n?'selected':''}" onclick="scSetOpt('rounds',${n},this)">${n} volÃ©es</div>`).join('')}
      </div>
    </div>`;
  } else if (game === 'killer') {
    const lives = scState.options.lives || 3;
    html += `<div>
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">Nombre de vies</div>
      <div class="sc-options-grid">
        ${[3,5].map(n => `<div class="sc-opt-chip ${lives==n?'selected':''}" onclick="scSetOpt('lives',${n},this)">${n} vies</div>`).join('')}
      </div>
    </div>`;
  } else if (game === 'cricket') {
    const cutthroat = scState.options.cutthroat || false;
    html += `<div>
      <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem">Variante</div>
      <div class="sc-options-grid">
        <div class="sc-opt-chip ${!cutthroat?'selected':''}" onclick="scSetOpt('cutthroat',false,this)">Standard</div>
        <div class="sc-opt-chip ${cutthroat?'selected':''}" onclick="scSetOpt('cutthroat',true,this)">Cut-throat (points pour adversaires)</div>
      </div>
    </div>`;
  } else {
    html = '<div style="font-size:0.75rem;color:var(--muted)">Pas d\'options supplÃ©mentaires pour ce jeu.</div>';
  }
  el.innerHTML = html;
}

function scSetOpt(key, val, el) {
  scState.options[key] = val;
  // Deselect siblings
  el.closest('.sc-options-grid')?.querySelectorAll('.sc-opt-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function scRenderSetupPlayers() {
  var list = document.getElementById('sc-players-setup');
  if (!list) return;

  // Build options string once
  var appOptsFull = players.map(function(ap) {
    return '<option value="' + ap.id + '">' + ap.pseudo + '</option>';
  }).join('');

  list.innerHTML = '';

  scState.players.forEach(function(p, i) {
    var isLinked = !!(p.id && players.find(function(ap) { return ap.id === p.id; }));

    var row = document.createElement('div');
    row.id = 'sc-prow-' + i;
    row.style.cssText = 'display:flex;align-items:flex-start;gap:0.5rem;flex-wrap:wrap;padding:0.6rem 0;border-bottom:1px solid var(--border)';

    var num = document.createElement('div');
    num.className = 'sc-player-num';
    num.textContent = i + 1;
    row.appendChild(num);

    var col = document.createElement('div');
    col.style.cssText = 'display:flex;flex-direction:column;flex:1;gap:0.4rem;min-width:160px';

    // Row 1: name input + linked badge
    var inputRow = document.createElement('div');
    inputRow.style.cssText = 'display:flex;align-items:center;gap:0.4rem';

    var inp = document.createElement('input');
    inp.type = 'text';
    inp.value = p.name;
    inp.placeholder = 'Joueur ' + (i + 1);
    inp.maxLength = 20;
    inp.style.flex = '1';
    inp.addEventListener('input', function() {
      scState.players[i].name = inp.value;
      scState.players[i].id = null; // unlink if typing manually
      // Update badge
      var badge = row.querySelector('.sc-link-badge');
      if (badge) badge.style.display = 'none';
      // Reset dropdown
      var sel = row.querySelector('select');
      if (sel) sel.value = '';
    });
    inputRow.appendChild(inp);

    if (isLinked) {
      var badge = document.createElement('span');
      badge.className = 'sc-link-badge';
      badge.style.cssText = 'font-size:0.62rem;color:var(--green);background:var(--green-bg);border-radius:4px;padding:1px 6px;white-space:nowrap;font-weight:600';
      badge.textContent = 'âœ“ LiÃ©';
      inputRow.appendChild(badge);
    }
    col.appendChild(inputRow);

    // Row 2: dropdown to link to app player (only if app has players)
    if (players.length > 0) {
      var selWrap = document.createElement('div');
      selWrap.style.cssText = 'display:flex;align-items:center;gap:0.4rem';

      var lbl = document.createElement('span');
      lbl.style.cssText = 'font-size:0.65rem;color:var(--muted);white-space:nowrap';
      lbl.textContent = 'ğŸ”— Lier Ã  :';
      selWrap.appendChild(lbl);

      var sel = document.createElement('select');
      sel.style.cssText = 'font-size:0.75rem;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:0.25rem 0.5rem;cursor:pointer;flex:1;font-family:\'DM Sans\',sans-serif';
      sel.innerHTML = '<option value="">â€” Aucun lien â€”</option>' + appOptsFull;

      // Pre-select if linked
      if (p.id) sel.value = p.id;

      sel.addEventListener('change', function() {
        var appId = parseInt(sel.value);
        if (!appId) {
          scState.players[i].id = null;
          // Remove badge
          var b = row.querySelector('.sc-link-badge');
          if (b) b.remove();
          inp.style.borderColor = '';
        } else {
          var ap = players.find(function(x) { return x.id === appId; });
          if (ap) {
            scState.players[i].id = ap.id;
            scState.players[i].name = ap.pseudo;
            inp.value = ap.pseudo;
            inp.style.borderColor = 'var(--green)';
            // Add/update badge
            var b = row.querySelector('.sc-link-badge');
            if (!b) {
              b = document.createElement('span');
              b.className = 'sc-link-badge';
              b.style.cssText = 'font-size:0.62rem;color:var(--green);background:var(--green-bg);border-radius:4px;padding:1px 6px;white-space:nowrap;font-weight:600';
              inputRow.appendChild(b);
            }
            b.textContent = 'âœ“ ' + ap.pseudo;
            b.style.display = '';
          }
        }
      });

      // Visual indication if already linked
      if (p.id) inp.style.borderColor = 'var(--green)';

      selWrap.appendChild(sel);
      col.appendChild(selWrap);
    }

    row.appendChild(col);

    // Remove button
    if (scState.players.length > 1) {
      var rmBtn = document.createElement('button');
      rmBtn.className = 'sc-remove-player';
      rmBtn.textContent = 'âœ•';
      rmBtn.style.marginTop = '2px';
      rmBtn.addEventListener('click', function() { scRemovePlayer(i); });
      row.appendChild(rmBtn);
    }

    list.appendChild(row);
  });

  // Summary: show how many players are linked
  var linkedCount = scState.players.filter(function(p) { return p.id && players.find(function(ap) { return ap.id === p.id; }); }).length;
  var summary = list.querySelector('.sc-link-summary');
  if (summary) summary.remove();
  if (players.length > 0) {
    var sumEl = document.createElement('div');
    sumEl.className = 'sc-link-summary';
    sumEl.style.cssText = 'margin-top:0.7rem;font-size:0.72rem;padding:0.5rem 0.7rem;border-radius:7px;' +
      (linkedCount === scState.players.length
        ? 'background:var(--green-bg);color:var(--green);border:1px solid rgba(52,212,123,0.3)'
        : 'background:var(--surface2);color:var(--muted);border:1px solid var(--border)');
    sumEl.innerHTML = linkedCount === scState.players.length
      ? 'âœ“ Les <strong>' + linkedCount + '</strong> joueurs sont liÃ©s â€” le rÃ©sultat sera enregistrÃ© au classement automatiquement.'
      : 'âš  <strong>' + linkedCount + ' / ' + scState.players.length + '</strong> joueur(s) liÃ©(s) â€” liez tous les joueurs pour enregistrer au classement.';
    list.appendChild(sumEl);
  }
}

function scAddPlayer() {
  if (scState.players.length >= 8) return;
  scState.players.push({name:`Joueur ${scState.players.length+1}`});
  scRenderSetupPlayers();
}

function scRemovePlayer(i) {
  scState.players.splice(i, 1);
  scRenderSetupPlayers();
}

function scBackToSetup() {
  scState.gameStarted = false;
  document.getElementById('sc-setup-screen').style.display = 'flex';
  document.getElementById('sc-game-screen').style.display = 'none';
  document.getElementById('sc-undo-btn').style.display = 'none';
  document.getElementById('sc-game-name-display').textContent = 'Compteur';
}

function scStartGame() {
  // Sync player names from inputs (IDs already set via dropdown events)
  var setupList = document.getElementById('sc-players-setup');
  if (setupList) {
    setupList.querySelectorAll('input[type="text"]').forEach(function(inp, i) {
      if (scState.players[i] && inp.value.trim()) scState.players[i].name = inp.value.trim();
    });
  }
  scState.gameStarted = true;

  const game = scState.game;
  const opts = scState.options;
  const numPlayers = scState.players.length;

  // Init player game data
  scState.players.forEach((p, i) => {
    if (['501','301','701'].includes(game)) {
      const start = parseInt(game);
      p.score = start; p.startScore = start;
      p.legsWon = 0; p.totalLegs = opts.legs || 1;
      p.dartsThrown = 0; p.rounds = 0;
      p.entered = opts.doubleIn ? false : true; // has entered with double?
      p.history = [];
      p.count180 = 0; p.bestVisit = 0; p.checkoutAttempts = 0; p.checkoutHits = 0;
    } else if (game === 'cricket') {
      p.score = 0; p.marks = {};
      CRICKET_NUMS.forEach(n => { p.marks[n] = 0; });
      p.history = [];
    } else if (game === 'countup') {
      p.score = 0; p.roundsLeft = opts.rounds || 10;
      p.history = [];
    } else if (game === 'atclock') {
      p.target = 1; p.finished = false;
      p.history = [];
    } else if (game === 'killer') {
      p.lives = opts.lives || 3;
      p.score = 0;
      p.eliminated = false;
      p.history = [];
    } else if (game === 'shanghai') {
      p.score = 0; p.history = [];
    } else if (game === 'halfit') {
      p.score = 40; p.targetIdx = 0;
      p.history = [];
    }
  });

  scState.currentPlayer = 0;
  scState.darts = [];
  scState.history = [];
  scState.multiplier = 1;
  scState.round = 1;
  scState.gameStarted = true;
  scState.winner = null;

  const gameNames = {
    '501':'501','301':'301','701':'701',
    'cricket':'Cricket','countup':'Count Up',
    'atclock':'Around the Clock','killer':'Killer',
    'shanghai':'Shanghai','halfit':'Half-It'
  };
  document.getElementById('sc-game-name-display').textContent = gameNames[game] || game;

  document.getElementById('sc-setup-screen').style.display = 'none';
  document.getElementById('sc-game-screen').style.display = 'flex';
  document.getElementById('sc-winner-screen').style.display = 'none';
  document.getElementById('sc-input-zone').style.display = 'flex';
  document.getElementById('sc-undo-btn').style.display = 'inline-flex';
  // Show voice btn for X01 games
  const vBtn = document.getElementById('sc-voice-btn');
  if (vBtn) vBtn.style.display = (['501','301','701'].includes(game)) ? 'inline-flex' : 'none';
  scState._voiceMode = false;
  updateVoiceBtn();
  // Show keyboard hints for X01 games
  const kbHints = document.getElementById('sc-keyboard-hints');
  if (kbHints) kbHints.style.display = (['501','301','701'].includes(game)) ? 'block' : 'none';

  scRenderGame();
}

function scRenderGame() {
  const game = scState.game;
  // Show/init live stats
  var liveStatsEl = document.getElementById('sc-live-stats');
  if (liveStatsEl) liveStatsEl.style.display = ['501','301','701'].includes(game) ? 'flex' : 'none';
  scUpdateLiveStats();
  scRenderPlayersZone();
  scRenderCheckoutHint();

  // Cricket board
  const cricketWrap = document.getElementById('sc-cricket-board-wrap');
  if (game === 'cricket') {
    cricketWrap.style.display = 'block';
    scRenderCricketBoard();
  } else {
    cricketWrap.style.display = 'none';
  }

  scRenderKeypad();
  scRenderDartDisplay();
  scRenderHistoryStrip();

  // Show/hide multiplier
  const multEl = document.getElementById('sc-multiplier');
  multEl.style.display = ['501','301','701','cricket','killer','shanghai'].includes(game) ? 'flex' : 'none';

  // Dart display
  const dartDisp = document.getElementById('sc-dart-display');
  dartDisp.style.display = ['501','301','701'].includes(game) ? 'flex' : 'none';

  scSetMult(1);
}

function scRenderPlayersZone() {
  const game = scState.game;
  const zone = document.getElementById('sc-players-zone');
  zone.innerHTML = scState.players.map((p, i) => {
    const isActive = i === scState.currentPlayer;
    const isBust = p.bust || false;

    let scoreHtml = '';
    let subHtml = '';
    let legsHtml = '';
    let liveStatsHtml = '';

    if (['501','301','701'].includes(game)) {
      // Preview score after current darts
      const dartTotal = scState.darts.reduce((s,d) => {
        const v = d.val === 'bull' ? 25 : (d.val||0);
        const m = (d.val==='bull'&&d.mult===2)?2:d.mult;
        return s + v*m;
      }, 0);
      const previewScore = isActive && dartTotal > 0 ? p.score - dartTotal : null;
      const previewValid = previewScore !== null && previewScore >= 0;

      scoreHtml = `<div class="sc-score-main">${p.score}</div>`;
      if (isActive && dartTotal > 0) {
        scoreHtml += `<div class="sc-score-preview" style="color:${previewValid?'rgba(52,212,123,0.7)':'rgba(240,83,74,0.7)'}">${previewValid ? 'â†’ ' + previewScore : 'ğŸ’¥ BUST'}</div>`;
      }
      const avg = p.dartsThrown > 0 ? (((p.startScore - p.score) / p.dartsThrown) * 3).toFixed(1) : 'â€”';
      subHtml = `<div class="sc-score-sub">Moy: ${avg}</div>`;
      const totalLegs = p.totalLegs || 1;
      const dots = Array.from({length: totalLegs}, (_,k) => `<div class="sc-leg-dot ${k<(p.legsWon||0)?'won':''}"></div>`).join('');
      legsHtml = `<div class="sc-legs-dots">${dots}</div>`;
      subHtml += `<div class="sc-darts-thrown">${p.dartsThrown||0} ğŸ¯</div>`;
      const best = p.bestVisit||0, c180 = p.count180||0, coHits = p.checkoutHits||0;
      liveStatsHtml = `<div style="display:flex;gap:0.3rem;justify-content:center;margin-top:4px;flex-wrap:wrap">
        ${best>0?`<span style="font-size:0.56rem;background:rgba(245,197,24,0.1);color:var(--gold);border-radius:4px;padding:1px 5px;font-weight:800" title="Meilleure volÃ©e">âš¡${best}</span>`:''}
        ${c180>0?`<span style="font-size:0.56rem;background:rgba(74,158,255,0.1);color:var(--blue);border-radius:4px;padding:1px 5px;font-weight:800">ğŸ’¯${c180}</span>`:''}
        ${coHits>0?`<span style="font-size:0.56rem;background:rgba(52,212,123,0.1);color:var(--green);border-radius:4px;padding:1px 5px;font-weight:800">ğŸ¯${coHits}</span>`:''}
      </div>`;
    } else if (game === 'cricket') {
      scoreHtml = `<div class="sc-score-main" style="font-size:2rem">${p.score}</div>`;
      subHtml = `<div class="sc-score-sub">pts</div>`;
    } else if (game === 'countup') {
      scoreHtml = `<div class="sc-score-main">${p.score}</div>`;
      subHtml = `<div class="sc-score-sub">${p.roundsLeft||0} volÃ©es restantes</div>`;
    } else if (game === 'atclock') {
      scoreHtml = `<div class="sc-score-main" style="font-size:2rem">${p.target > 20 ? 'âœ“' : p.target}</div>`;
      subHtml = `<div class="sc-score-sub">${p.target > 20 ? 'TerminÃ©!' : 'Prochaine cible'}</div>`;
    } else if (game === 'killer') {
      const hearts = Array.from({length: p.lives||0}, () => 'â¤ï¸').join('')
        + Array.from({length: (scState.options.lives||3) - (p.lives||0)}, () => 'ğŸ–¤').join('');
      scoreHtml = `<div style="font-size:1.1rem;letter-spacing:-2px">${hearts}</div>`;
      subHtml = `<div class="sc-score-sub">Score: ${p.score||0}</div>`;
      if (p.eliminated) subHtml = `<div class="sc-score-sub" style="color:var(--red)">Ã‰LIMINÃ‰</div>`;
    } else if (game === 'shanghai') {
      scoreHtml = `<div class="sc-score-main">${p.score}</div>`;
      subHtml = `<div class="sc-score-sub">Round ${scState.round}/7</div>`;
    } else if (game === 'halfit') {
      const tgt = HALFIT_TARGETS[p.targetIdx] || 'â€”';
      scoreHtml = `<div class="sc-score-main">${p.score}</div>`;
      subHtml = `<div class="sc-score-sub">Cible: ${tgt}</div>`;
    }

    const panelClass = `sc-player-panel ${isActive ? 'active-turn' : ''} ${isBust ? 'bust' : ''}`;
    return `<div class="${panelClass}" id="sc-pp-${i}" onclick="scPlayerPanelClick(${i})">
      <div class="sc-pname">${p.name}</div>
      ${scoreHtml}
      ${subHtml}
      ${legsHtml}
      ${liveStatsHtml}
    </div>`;
  }).join('');
}

function scRenderCheckoutHint() {
  const hint = document.getElementById('sc-checkout-hint');
  if (!['501','301','701'].includes(scState.game)) { hint.classList.remove('visible'); return; }
  const p = scState.players[scState.currentPlayer];
  const score = p.score;
  if (score >= 2 && score <= 170 && SC_CHECKOUT_TABLE[score] && score !== 169 && score !== 168 && score !== 166 && score !== 165 && score !== 163 && score !== 162 && score !== 159) {
    const checkout = SC_CHECKOUT_TABLE[score];
    if (Array.isArray(checkout)) {
      hint.textContent = `âœ“ Finish: ${checkout.join(' â†’ ')}`;
    } else {
      hint.textContent = `âœ“ Finish: ${checkout}`;
    }
    hint.classList.add('visible');
  } else if (score === 0) {
    hint.textContent = '';
    hint.classList.remove('visible');
  } else {
    hint.classList.remove('visible');
  }
}

function scRenderKeypad() {
  const game = scState.game;
  const keypad = document.getElementById('sc-keypad');

  if (['501','301','701'].includes(game)) {
    // Mode toggle: dart-by-dart vs total direct
    const mode = scState._x01InputMode || 'darts';
    const modeToggle = `<div style="display:flex;gap:4px;margin-bottom:6px;width:100%">
      <button style="flex:1;padding:0.3rem;border-radius:6px;border:1px solid ${mode==='darts'?'var(--accent)':'var(--border)'};background:${mode==='darts'?'var(--accent-dim)':'var(--surface2)'};color:${mode==='darts'?'var(--accent)':'var(--muted)'};font-size:0.68rem;font-weight:600;cursor:pointer;font-family:'Work Sans',sans-serif" onclick="scSetX01Mode('darts')">ğŸ¯ FlÃ©chette par flÃ©chette</button>
      <button style="flex:1;padding:0.3rem;border-radius:6px;border:1px solid ${mode==='total'?'var(--accent)':'var(--border)'};background:${mode==='total'?'var(--accent-dim)':'var(--surface2)'};color:${mode==='total'?'var(--accent)':'var(--muted)'};font-size:0.68rem;font-weight:600;cursor:pointer;font-family:'Work Sans',sans-serif" onclick="scSetX01Mode('total')">ğŸ“Š Total 3 flÃ©chettes</button>
    </div>`;

    if (mode === 'total') {
      // Direct total input mode
      if (scState._x01TotalInput === undefined) scState._x01TotalInput = '';
      const displayVal = scState._x01TotalInput || '0';
      const dartDisp = document.getElementById('sc-dart-display');
      dartDisp.style.display = 'flex';
      dartDisp.innerHTML = `<div style="flex:1;text-align:center;padding:0.5rem 0">
        <div style="font-size:0.65rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Total de la volÃ©e</div>
        <div id="sc-x01-total-display" style="font-family:'Bebas Neue', sans-serif;font-size:3rem;font-weight:800;color:var(--accent)">${displayVal}</div>
      </div>`;
      let html = modeToggle;
      html += [1,2,3,4,5,6,7,8,9,0].map(n => `<div class="sc-key" onclick="scX01TotalDigit(${n})">${n}</div>`).join('');
      html += `<div class="sc-key undo" onclick="scX01TotalDigit(-1)">âŒ«</div>`;
      html += `<div class="sc-key confirm span5" onclick="scConfirmX01Total()">âœ“ Valider le total (${displayVal} pts)</div>`;
      keypad.innerHTML = html;
    } else {
      // Standard number keypad 1-20 + Bull + Miss
      const nums = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
      let html = modeToggle;
      html += nums.map(n => `<div class="sc-key" onclick="scAddDart(${n})">${n}</div>`).join('');
      html += `<div class="sc-key bull" onclick="scAddDart('bull')">ğŸŸ¡ Bull 25</div>`;
      html += `<div class="sc-key bull" style="background:rgba(240,83,74,0.12);border-color:rgba(240,83,74,0.45);color:var(--red)" onclick="scAddDoubleBull()">ğŸ¯ Bull 50</div>`;
      html += `<div class="sc-key miss" onclick="scAddDart(0)">âœ• RatÃ©</div>`;
      html += `<div class="sc-key undo span2" onclick="scRemoveLastDart()">âŒ«</div>`;
      html += `<div class="sc-key confirm span5" onclick="scConfirmTurn()">âœ“ Confirmer la volÃ©e</div>`;
      keypad.innerHTML = html;
    }
  } else if (game === 'cricket') {
    let html = CRICKET_NUMS.map((n, i) => {
      const label = n === 'B' ? 'ğŸ¯ Bull' : String(n);
      const cls = 'sc-key';
      return `<div class="${cls}" onclick="scCricketHit('${n}')">${label}</div>`;
    }).join('');
    html += `<div class="sc-key miss span2" onclick="scCricketMiss()">âœ• RatÃ©</div>`;
    html += `<div class="sc-key undo" onclick="scUndo()">âŒ«</div>`;
    html += `<div class="sc-key confirm span5" onclick="scConfirmTurn()">âœ“ Fin de volÃ©e</div>`;
    keypad.innerHTML = html;
  } else if (game === 'countup') {
    // Simple numeric input
    let html = `
      <div class="sc-key span5" style="font-size:0.7rem;color:var(--muted);background:none;border:none;min-height:auto;padding:0">
        Score de la volÃ©e (3 flÃ©chettes)
      </div>`;
    html += [0,1,2,3,4,5,6,7,8,9].map(n => `<div class="sc-key" onclick="scCountUpDigit(${n})">${n}</div>`).join('');
    html += `<div class="sc-key undo" onclick="scCountUpDigit(-1)">âŒ«</div>`;
    html += `<div class="sc-key confirm span5" onclick="scConfirmCountUp()">âœ“ Valider le score</div>`;
    keypad.innerHTML = html;
    scState._countUpInput = '';
    // Show current input area
    const dartDisp = document.getElementById('sc-dart-display');
    dartDisp.style.display = 'flex';
    dartDisp.innerHTML = `
      <div style="flex:1;text-align:center">
        <div style="font-size:0.65rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Score volÃ©e</div>
        <div id="sc-countup-display" style="font-family:'Bebas Neue', sans-serif;font-size:3rem;font-weight:800;color:var(--accent)">0</div>
      </div>`;
  } else if (game === 'atclock') {
    const p = scState.players[scState.currentPlayer];
    const target = p.target;
    let html = `<div class="sc-key span5" style="font-size:0.7rem;color:var(--muted);background:none;border:none;min-height:auto;padding:0.2rem">Ciblez le numÃ©ro <strong style="color:var(--accent)">${target > 20 ? 'TERMINÃ‰' : target}</strong></div>`;
    html += `<div class="sc-key confirm span3" onclick="scAtClockHit(true)">âœ“ TouchÃ© ! ${target}</div>`;
    html += `<div class="sc-key miss span2" onclick="scAtClockHit(false)">âœ• RatÃ©</div>`;
    keypad.innerHTML = html;
  } else if (game === 'killer') {
    let html = `<div class="sc-key span5" style="font-size:0.7rem;color:var(--muted);background:none;border:none;min-height:auto;padding:0.2rem">Touches sur les cibles adverses</div>`;
    scState.players.forEach((p, i) => {
      if (i !== scState.currentPlayer && !p.eliminated) {
        html += `<div class="sc-key span5" onclick="scKillerHit(${i})" style="color:var(--red);border-color:rgba(240,83,74,0.3)">ğŸ’€ Toucher ${p.name} (${p.lives} vies)</div>`;
      }
    });
    html += `<div class="sc-key confirm span5" onclick="scConfirmTurn()">âœ“ Fin de tour</div>`;
    keypad.innerHTML = html;
  } else if (game === 'shanghai') {
    const round = scState.round;
    let html = `<div class="sc-key span5" style="font-size:0.7rem;color:var(--muted);background:none;border:none;min-height:auto;padding:0.2rem">Round ${round} â€” Ciblez le <strong style="color:var(--accent)">${round}</strong></div>`;
    const score = scState._shanghaiInput || 0;
    html += `<div class="sc-key" onclick="scShanghaiScore(round,1)">S${round} <br><small>+${round}</small></div>`;
    html += `<div class="sc-key" onclick="scShanghaiScore(round,2)">D${round} <br><small>+${round*2}</small></div>`;
    html += `<div class="sc-key" onclick="scShanghaiScore(round,3)">T${round} <br><small>+${round*3}</small></div>`;
    html += `<div class="sc-key miss span2" onclick="scShanghaiScore(0,0)">âœ• RatÃ©</div>`;
    html += `<div class="sc-key undo span2" onclick="scUndo()">âŒ«</div>`;
    html += `<div class="sc-key confirm span3" onclick="scConfirmShanghai()">âœ“ Fin de volÃ©e</div>`;
    keypad.innerHTML = html.replace(/round/g, round);
  } else if (game === 'halfit') {
    const p = scState.players[scState.currentPlayer];
    const tgt = HALFIT_TARGETS[p.targetIdx] || 'â€”';
    let html = `<div class="sc-key span5" style="font-size:0.7rem;color:var(--muted);background:none;border:none;min-height:auto;padding:0.2rem">Ciblez <strong style="color:var(--accent)">${tgt}</strong> (ratÃ© = score Ã·2)</div>`;
    html += [0,1,2,3,4,5,6,7,8,9].map(n => `<div class="sc-key" onclick="scHalfItDigit(${n})">${n}</div>`).join('');
    html += `<div class="sc-key undo" onclick="scHalfItDigit(-1)">âŒ«</div>`;
    html += `<div class="sc-key confirm span5" onclick="scConfirmHalfIt()">âœ“ Valider</div>`;
    keypad.innerHTML = html;
    scState._halfItInput = '';
    const dartDisp = document.getElementById('sc-dart-display');
    dartDisp.style.display = 'flex';
    dartDisp.innerHTML = `<div style="flex:1;text-align:center">
      <div style="font-size:0.65rem;color:var(--muted);letter-spacing:1px">Score sur ${tgt}</div>
      <div id="sc-halfit-display" style="font-family:'Bebas Neue', sans-serif;font-size:3rem;font-weight:800;color:var(--accent)">0</div>
    </div>`;
  }
}

function scRenderDartDisplay() {
  const game = scState.game;
  if (!['501','301','701'].includes(game)) return;
  const darts = scState.darts;
  for (let i = 0; i < 3; i++) {
    const el = document.getElementById(`sc-dart-${i+1}`);
    if (!el) continue;
    if (i < darts.length) {
      const d = darts[i];
      const label = d.val === 0 ? 'âœ•' : d.val === 'bull' ? 'ğŸ¯' : (d.mult > 1 ? (d.mult === 2 ? 'D':'T') : '') + d.val;
      el.textContent = label;
      el.className = 'sc-dart-val filled';
    } else {
      el.textContent = 'â€”';
      el.className = 'sc-dart-val';
    }
  }
  const total = darts.reduce((s, d) => {
    const v = d.val === 'bull' ? 25 : (d.val || 0);
    return s + v * (d.val === 'bull' && d.mult === 2 ? 1 : d.mult); // bull outer=25, bull inner(mult2)=50
  }, 0);
  const totalEl = document.getElementById('sc-dart-total');
  if (totalEl) totalEl.textContent = total;
}

function scRenderHistoryStrip() {
  const strip = document.getElementById('sc-history-strip');
  const hist = scState.history.slice(-14).reverse();
  strip.innerHTML = hist.map((h, i) => {
    const p = scState.players[h.playerIdx];
    const cls = h.type === '180' ? 'entry-180' : i === 0 ? 'last' : h.type === 'bust' ? 'bust' : '';
    const prefix = h.type === '180' ? 'ğŸ’¯ ' : '';
    return `<div class="sc-hist-entry ${cls}">${p?.name}: ${prefix}${h.display}</div>`;
  }).join('');
}

function scRenderCricketBoard() {
  const board = document.getElementById('sc-cricket-board');
  const numPlayers = scState.players.length;

  // Check which numbers are closed by all players
  const allClosed = {};
  CRICKET_NUMS.forEach(n => {
    allClosed[n] = scState.players.every(p => p.marks[n] >= 3);
  });

  // Numbers column
  let html = `<div class="sc-cricket-col nums-col">
    <div class="sc-cricket-header">Cible</div>
    ${CRICKET_NUM_LABELS.map(n => `<div class="sc-cricket-cell num-label">${n}</div>`).join('')}
    <div class="sc-cricket-cell num-label" style="font-size:0.7rem">Score</div>
  </div>`;

  // Player columns
  scState.players.forEach((p, i) => {
    const isActive = i === scState.currentPlayer;
    html += `<div class="sc-cricket-col">
      <div class="sc-cricket-header ${isActive ? 'active-turn' : ''}">${p.name}</div>
      ${CRICKET_NUMS.map((n, ni) => {
        const marks = p.marks[n] || 0;
        const isClosed = allClosed[n];
        const marksStr = marks >= 3 ? 'âœ•' : marks === 2 ? 'âœ• /' : marks === 1 ? '/' : '';
        return `<div class="sc-cricket-cell ${marks >= 3 ? 'closed-num' : marks > 0 ? 'open-num' : ''}">
          ${marksStr}
        </div>`;
      }).join('')}
      <div class="sc-cricket-cell" style="color:var(--accent);font-weight:800">${p.score}</div>
    </div>`;
  });

  board.innerHTML = html;
}

// â”€â”€ X01 GAME LOGIC â”€â”€
function scAddDoubleBull() {
  // Double bull = Bull with mult 2 = 50 pts
  if (scState.darts.length >= 3) return;
  scState.darts.push({val: 'bull', mult: 2});
  scRenderDartDisplay();
  scSetMult(1);
}

function scAddDart(val) {
  if (scState.darts.length >= 3) return;
  const mult = scState.multiplier;
  const actualMult = val === 'bull' ? (mult >= 2 ? 2 : 1) : mult;
  scState.darts.push({val, mult: actualMult});
  scRenderDartDisplay();
  scSetMult(1);
  // Refresh player panels for live score preview
  if (['501','301','701'].includes(scState.game)) scRenderPlayersZone();
  if (scState.darts.length === 3) scConfirmTurn();
}

function scRemoveLastDart() {
  if (scState.darts.length > 0) {
    scState.darts.pop();
    scRenderDartDisplay();
    if (['501','301','701'].includes(scState.game)) scRenderPlayersZone();
  }
}

function scConfirmTurn() {
  const game = scState.game;
  if (['501','301','701'].includes(game)) scConfirmX01();
  else if (game === 'cricket') scConfirmCricket();
  else if (game === 'killer') scNextPlayer();
}

function scConfirmX01() {
  const p = scState.players[scState.currentPlayer];
  const darts = scState.darts;
  if (darts.length === 0) return;

  let total = darts.reduce((s, d) => {
    const v = d.val === 'bull' ? 25 : (d.val || 0);
    const m = (d.val === 'bull' && d.mult === 2) ? 2 : d.mult;
    return s + v * m;
  }, 0);

  const opts = scState.options;
  const newScore = p.score - total;
  const checkout = opts.checkout || 'double';
  const lastDart = darts[darts.length - 1];
  const isFinish = newScore === 0;

  let isBust = false;
  if (newScore < 0) { isBust = true; }
  else if (newScore === 1 && checkout !== 'straight') { isBust = true; }
  else if (newScore === 0) {
    if (checkout === 'double') {
      const isDouble = lastDart.mult === 2 || (lastDart.val === 'bull' && lastDart.mult === 2);
      if (!isDouble) isBust = true;
    } else if (checkout === 'master') {
      if (lastDart.mult < 2) isBust = true;
    }
  }

  // Checkout attempt : vÃ©rifier sur le score AVANT la volÃ©e
  // Zone â‰¤ 170 (max thÃ©orique en double-out)
  const _scoreBeforeThrow = p.score;
  if (_scoreBeforeThrow <= 170 && _scoreBeforeThrow > 1) {
    p.checkoutAttempts = (p.checkoutAttempts || 0) + 1;
  }

  p.dartsThrown = (p.dartsThrown || 0) + darts.length;
  p.cumulativeDarts = (p.cumulativeDarts || 0) + darts.length;

  if (isBust) {
    p.bust = true;
    const dartStrs = darts.map(d => {
      const v = d.val === 'bull' ? 'ğŸ¯' : d.val === 0 ? 'âœ•' : (d.mult>1?(d.mult===2?'D':'T'):'')+d.val;
      return v;
    }).join(' ');
    scState.history.push({playerIdx:scState.currentPlayer, display:`BUST (${dartStrs})`, type:'bust'});
    showNotif('ğŸ’¥ BUST ! Score restituÃ©', 'error');
    // Animate bust
    const pp = document.getElementById(`sc-pp-${scState.currentPlayer}`);
    if (pp) { pp.classList.add('sc-bust-anim'); setTimeout(() => pp.classList.remove('sc-bust-anim'), 500); }
    setTimeout(() => {
      p.bust = false;
      scState.darts = [];
      scNextPlayer();
    }, 600);
    scRenderPlayersZone();
    scRenderHistoryStrip();
    return;
  }

  p.score = newScore;
  // Cumuler le score rÃ©duit (pour moyenne multi-legs)
  p.cumulativeReduced = (p.cumulativeReduced || 0) + total;

  // Pulse the score display
  setTimeout(() => {
    const pp = document.getElementById(`sc-pp-${scState.currentPlayer}`);
    if (pp) { const sm = pp.querySelector('.sc-score-main'); if(sm){sm.classList.add('sc-score-pulse');setTimeout(()=>sm.classList.remove('sc-score-pulse'),200);} }
  }, 10);

  // Track 180
  if (total === 180) {
    p.count180 = (p.count180||0) + 1;
    var badge180 = document.createElement('div');
    badge180.className = 'sc-180-badge';
    badge180.style.cssText = 'position:fixed;top:30%;left:50%;transform:translateX(-50%);font-size:2rem;z-index:999;padding:0.3rem 1rem;';
    badge180.textContent = 'ğŸ’¯ 180 !';
    document.body.appendChild(badge180);
    setTimeout(function(){ badge180.remove(); }, 1200);
    showNotif('ğŸ’¯ 180 ! VolÃ©e parfaite !');
  }
  // Track best visit
  if (!p.bestVisit || total > p.bestVisit) p.bestVisit = total;
  // (checkout attempt dÃ©jÃ  comptÃ© avant la mise Ã  jour du score)

  const dartStrs = darts.map(d => {
    const v = d.val === 'bull' ? 'ğŸ¯' : d.val === 0 ? 'âœ•' : (d.mult>1?(d.mult===2?'D':'T'):'')+d.val;
    return v;
  }).join(' ');
  scState.history.push({playerIdx:scState.currentPlayer, display:`${total} (${dartStrs})`, type: total===180?'180':'normal'});

  if (newScore === 0) {
    // Won this leg!
    p.checkoutHits = (p.checkoutHits||0) + 1;
    p.legsWon = (p.legsWon || 0) + 1;
    if (p.legsWon >= (p.totalLegs || 1)) {
      scEndGame(scState.currentPlayer);
      return;
    } else {
      // New leg
      const start = parseInt(scState.game);
      scState.players.forEach(pp2 => {
        pp2.score = start;
        pp2.dartsThrown = 0; // reset pour ce leg uniquement
        // cumulativeDarts et cumulativeReduced persistent entre les legs
        pp2.entered = opts.doubleIn ? false : true;
      });
      showNotif(`ğŸ† ${p.name} remporte ce leg !`, 'win');
    }
  }

  scState.darts = [];
  scUpdateLiveStats();
  scNextPlayer();
}

// â”€â”€ CRICKET LOGIC â”€â”€
function scCricketHit(num) {
  const p = scState.players[scState.currentPlayer];
  const opts = scState.options;
  const cutthroat = opts.cutthroat || false;
  const mult = scState.multiplier;
  const marks = Math.min(3, mult); // 1, 2 or 3 marks at once

  const allClosed = scState.players.every(pl => pl.marks[num] >= 3);

  if (p.marks[num] < 3) {
    const before = p.marks[num];
    p.marks[num] = Math.min(3, p.marks[num] + mult);
    const overflow = (before + mult) - 3;

    if (!cutthroat && overflow > 0 && !allClosed) {
      // Scoring for player: points overflow
      p.score += overflow * (num === 'B' ? 25 : num);
    }
  } else {
    // Already closed by this player
    const pts = mult * (num === 'B' ? 25 : num);
    if (!cutthroat) {
      // Points if not all closed
      if (!allClosed) p.score += pts;
    } else {
      // Cut-throat: add to opponents not closed
      scState.players.forEach((pl, i) => {
        if (i !== scState.currentPlayer && pl.marks[num] < 3) {
          pl.score += pts;
        }
      });
    }
  }

  scState.history.push({
    playerIdx: scState.currentPlayer,
    display: `${mult > 1 ? (mult===2?'D':'T') : 'S'}${num === 'B' ? 'Bull' : num}`,
    type: 'normal'
  });

  scRenderCricketBoard();
  scRenderPlayersZone();
  scRenderHistoryStrip();
  scSetMult(1);

  // Check cricket win
  scCheckCricketWin();
}

function scCricketMiss() {
  scState.history.push({playerIdx:scState.currentPlayer, display:'âœ•', type:'normal'});
  scRenderHistoryStrip();
  scSetMult(1);
}

function scCheckCricketWin() {
  // Win: all nums closed by player AND highest score (or cutthroat: lowest)
  const opts = scState.options;
  const cutthroat = opts.cutthroat || false;
  scState.players.forEach((p, i) => {
    const allClosed = CRICKET_NUMS.every(n => p.marks[n] >= 3);
    if (allClosed) {
      const isWinner = cutthroat
        ? scState.players.every((pl, j) => j === i || pl.score >= p.score)
        : scState.players.every((pl, j) => j === i || p.score >= pl.score);
      if (isWinner) { scEndGame(i); return; }
    }
  });
}

function scConfirmCricket() {
  scNextPlayer();
  scRenderCricketBoard();
}

// â”€â”€ COUNT UP â”€â”€
function scCountUpDigit(d) {
  if (d === -1) {
    scState._countUpInput = scState._countUpInput.slice(0,-1);
  } else {
    if (scState._countUpInput.length >= 3) return;
    scState._countUpInput += d;
  }
  const val = parseInt(scState._countUpInput || '0');
  const el = document.getElementById('sc-countup-display');
  if (el) el.textContent = val;
}

function scConfirmCountUp() {
  const p = scState.players[scState.currentPlayer];
  const val = parseInt(scState._countUpInput || '0');
  p.score += val;
  p.roundsLeft = (p.roundsLeft || 0) - 1;
  scState.history.push({playerIdx:scState.currentPlayer, display:`+${val}`, type:'normal'});
  scState._countUpInput = '';
  scRenderPlayersZone();
  scRenderHistoryStrip();
  const el = document.getElementById('sc-countup-display');
  if (el) el.textContent = '0';

  // Check if all players done
  if (scState.players.every(pl => (pl.roundsLeft||0) <= 0)) {
    const winner = scState.players.reduce((best, pl, i) => pl.score > scState.players[best].score ? i : best, 0);
    scEndGame(winner);
    return;
  }
  scNextPlayer();
}

// â”€â”€ AROUND THE CLOCK â”€â”€
function scAtClockHit(hit) {
  const p = scState.players[scState.currentPlayer];
  if (hit) {
    scState.history.push({playerIdx:scState.currentPlayer, display:`âœ“ ${p.target}`, type:'normal'});
    p.target += 1;
    scRenderPlayersZone();
    scRenderHistoryStrip();
    if (p.target > 20) {
      scEndGame(scState.currentPlayer);
      return;
    }
    scRenderKeypad(); // update target display
  } else {
    scState.history.push({playerIdx:scState.currentPlayer, display:`âœ• ${p.target}`, type:'normal'});
    scRenderHistoryStrip();
    scNextPlayer();
  }
}

// â”€â”€ KILLER â”€â”€
function scKillerHit(targetIdx) {
  const p = scState.players[targetIdx];
  const mult = scState.multiplier;
  p.lives = Math.max(0, (p.lives || 0) - mult);
  scState.history.push({playerIdx:scState.currentPlayer, display:`ğŸ’€ ${p.name} -${mult}â™¥`, type:'normal'});
  if (p.lives <= 0) {
    p.eliminated = true;
    showNotif(`ğŸ’€ ${p.name} Ã©liminÃ© !`, 'error');
  }
  scRenderPlayersZone();
  scRenderHistoryStrip();
  scSetMult(1);
  // Check win: only 1 player left
  const alive = scState.players.filter(pl => !pl.eliminated);
  if (alive.length === 1) {
    const winnerIdx = scState.players.findIndex(pl => !pl.eliminated);
    scEndGame(winnerIdx);
  }
}

// â”€â”€ SHANGHAI â”€â”€
function scShanghaiScore(round, mult) {
  const p = scState.players[scState.currentPlayer];
  const pts = mult * round;
  scState._shanghaiInput = (scState._shanghaiInput || 0) + pts;
  scState.history.push({playerIdx:scState.currentPlayer, display:`${mult>1?(mult===2?'D':'T'):'S'}${round}=+${pts}`, type:'normal'});
  scRenderPlayersZone();
  scRenderHistoryStrip();
}

function scConfirmShanghai() {
  const p = scState.players[scState.currentPlayer];
  p.score += (scState._shanghaiInput || 0);
  scState._shanghaiInput = 0;
  scNextPlayer();
  // After all players did this round
  if (scState.currentPlayer === 0) {
    scState.round += 1;
    if (scState.round > 7) {
      const winner = scState.players.reduce((best, pl, i) => pl.score > scState.players[best].score ? i : best, 0);
      scEndGame(winner);
      return;
    }
  }
  scRenderKeypad();
}

// â”€â”€ HALF IT â”€â”€
function scHalfItDigit(d) {
  if (d === -1) {
    scState._halfItInput = scState._halfItInput.slice(0,-1);
  } else {
    if (scState._halfItInput.length >= 3) return;
    scState._halfItInput += d;
  }
  const val = parseInt(scState._halfItInput || '0');
  const el = document.getElementById('sc-halfit-display');
  if (el) el.textContent = val;
}

function scConfirmHalfIt() {
  const p = scState.players[scState.currentPlayer];
  const val = parseInt(scState._halfItInput || '0');
  const tgt = HALFIT_TARGETS[p.targetIdx];

  if (val === 0) {
    // Missed â€” halve the score
    const before = p.score;
    p.score = Math.floor(p.score / 2);
    scState.history.push({playerIdx:scState.currentPlayer, display:`âœ•${tgt} â†’ ${before}Ã·2=${p.score}`, type:'bust'});
  } else {
    p.score += val;
    scState.history.push({playerIdx:scState.currentPlayer, display:`${tgt}:+${val}`, type:'normal'});
  }
  p.targetIdx = (p.targetIdx || 0) + 1;
  scState._halfItInput = '';

  scRenderPlayersZone();
  scRenderHistoryStrip();

  // Check if all done (each player goes through all targets)
  if (p.targetIdx >= HALFIT_TARGETS.length) {
    // Check if all players done
    if (scState.players.every(pl => (pl.targetIdx||0) >= HALFIT_TARGETS.length)) {
      const winner = scState.players.reduce((best, pl, i) => pl.score > scState.players[best].score ? i : best, 0);
      scEndGame(winner);
      return;
    }
    scNextPlayer();
    scRenderKeypad();
    return;
  }
  scNextPlayer();
  scRenderKeypad();
}

// â”€â”€ GENERAL HELPERS â”€â”€
function scSetX01Mode(mode) {
  scState._x01InputMode = mode;
  if (mode === 'total') scState._x01TotalInput = '';
  scRenderKeypad();
}

function scX01TotalDigit(d) {
  if (d === -1) {
    scState._x01TotalInput = (scState._x01TotalInput || '').slice(0, -1);
  } else {
    const cur = (scState._x01TotalInput || '') + d;
    if (parseInt(cur) <= 180) scState._x01TotalInput = cur;
  }
  const val = scState._x01TotalInput || '0';
  const disp = document.getElementById('sc-x01-total-display');
  if (disp) disp.textContent = val;
  // update confirm button text
  const keypad = document.getElementById('sc-keypad');
  const confirmBtn = keypad ? keypad.querySelector('.sc-key.confirm') : null;
  if (confirmBtn) confirmBtn.textContent = `âœ“ Valider le total (${val} pts)`;
}

function scConfirmX01Total() {
  const total = parseInt(scState._x01TotalInput) || 0;
  if (total < 0 || total > 180) { showNotif('âš  Score invalide (0â€“180)'); return; }
  // Apply total as a single volÃ©e to current player
  const p = scState.players[scState.currentPlayer];
  const game = scState.game;
  const startScore = ['501','301','701'].includes(game) ? parseInt(game) : 501;
  const newScore = p.score - total;
  if (newScore < 0) { showNotif('âš  Score trop Ã©levÃ©, dÃ©passe 0'); return; }
  if (newScore === 0) {
    // Winning â€” treat as checkout
    p.score = 0;
    p.history = p.history || [];
    p.history.push(total);
    p.darts = (p.darts || 0) + 3;
    p.dartsThrown = (p.dartsThrown || 0) + 3;
    scState._x01TotalInput = '';
    scState.darts = [];
    scEndGame(scState.currentPlayer);
    return;
  }
  if (newScore === 1) { showNotif('âš  Impossible, reste 1 point (pas de double possible)'); return; }
  // Checkout attempt en mode total
  if (p.score <= 170 && p.score > 1) {
    p.checkoutAttempts = (p.checkoutAttempts || 0) + 1;
  }
  p.score = newScore;
  p.cumulativeReduced = (p.cumulativeReduced || 0) + total;
  p.cumulativeDarts = (p.cumulativeDarts || 0) + 3;
  p.dartsThrown = (p.dartsThrown || 0) + 3;
  // Track 180 et meilleure volÃ©e en mode total
  if (total === 180) {
    p.count180 = (p.count180 || 0) + 1;
    showNotif('ğŸ’¯ 180 ! VolÃ©e parfaite !');
  }
  if (!p.bestVisit || total > p.bestVisit) p.bestVisit = total;
  p.history = p.history || [];
  p.history.push(total);
  scState._x01TotalInput = '';
  scState.darts = [];
  scUpdateLiveStats();
  scNextPlayer();
  scRenderGame();
}

function scSetMult(n) {
  scState.multiplier = n;
  document.getElementById('sc-mult-1')?.classList.toggle('active', n===1);
  document.getElementById('sc-mult-2')?.classList.toggle('active', n===2);
  document.getElementById('sc-mult-3')?.classList.toggle('active', n===3);
}

function scNextPlayer() {
  const n = scState.players.length;
  let next = (scState.currentPlayer + 1) % n;
  // Skip eliminated players
  let tries = 0;
  while (scState.players[next]?.eliminated && tries < n) { next = (next+1)%n; tries++; }
  scState.currentPlayer = next;
  scState.darts = [];
  scRenderPlayersZone();
  scRenderCheckoutHint();
  scRenderDartDisplay();
  scRenderHistoryStrip();
  if (scState.game === 'killer') scRenderKeypad();
  if (scState.game === 'atclock') scRenderKeypad();
  if (scState.game === 'halfit') scRenderKeypad();
}

function scUndo() {
  if (scState.history.length === 0) return;
  const last = scState.history.pop();
  const p = scState.players[last.playerIdx];
  // Simple revert: go back to that player
  scState.currentPlayer = last.playerIdx;
  showNotif('â†© Annulation', 'success');
  // For X01 we'd need stored prev score - handled by re-computing
  // Best effort: show notification
  scRenderPlayersZone();
  scRenderHistoryStrip();
  scRenderCheckoutHint();
}

function scReset() {
  if (!confirm('Recommencer la partie ?')) return;
  scStartGame();
}

function scPlayerPanelClick(i) {
  // Quick shortcut to set current player (for manual correction)
  scState.currentPlayer = i;
  scRenderPlayersZone();
  scRenderCheckoutHint();
  scRenderDartDisplay();
}

function scEndGame(winnerIdx) {
  scState.winner = winnerIdx;
  scState.matchSaved = false;
  const p = scState.players[winnerIdx];

  document.getElementById('sc-input-zone').style.display = 'none';
  document.getElementById('sc-winner-screen').style.display = 'flex';
  document.getElementById('sc-cricket-board-wrap').style.display = 'none';
  document.getElementById('sc-checkout-hint').classList.remove('visible');

  document.getElementById('sc-winner-name').textContent = p.name;

  // Stats
  const game = scState.game;
  let statsHtml = '';
  if (['501','301','701'].includes(game)) {
    const _wd = p.cumulativeDarts || p.dartsThrown || 0;
    const _wr = p.cumulativeReduced || (p.startScore - p.score);
    const avg = _wd > 0 ? (_wr / _wd * 3).toFixed(1) : 'â€”';
    statsHtml = `
      <div class="sc-wstat"><div class="sc-wstat-val">${_wd}</div><div class="sc-wstat-lbl">FlÃ©chettes</div></div>
      <div class="sc-wstat"><div class="sc-wstat-val">${avg}</div><div class="sc-wstat-lbl">Moyenne</div></div>
      <div class="sc-wstat"><div class="sc-wstat-val">${p.legsWon||1}</div><div class="sc-wstat-lbl">Legs gagnÃ©s</div></div>
    `;
  } else if (game === 'cricket') {
    statsHtml = `<div class="sc-wstat"><div class="sc-wstat-val">${p.score}</div><div class="sc-wstat-lbl">Score final</div></div>`;
  } else {
    statsHtml = `<div class="sc-wstat"><div class="sc-wstat-val">${p.score||0}</div><div class="sc-wstat-lbl">Score final</div></div>`;
  }
  document.getElementById('sc-winner-stats').innerHTML = statsHtml;

  // Build full recap
  scBuildRecap();
  // Propose saving to ranking if players are linked
  scCheckSavePanel();

  // Confetti!
  for (let i = 0; i < 40; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti-piece';
      c.style.left = Math.random()*100+'vw';
      c.style.top = '-10px';
      c.style.background = ['var(--primary)','#4a9eff','#34d47b','#f0534a','#a67cf7'][Math.floor(Math.random()*5)];
      c.style.animationDuration = (1+Math.random()*1.5)+'s';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 2500);
    }, i * 60);
  }
}

function scCheckSavePanel() {
  var panel = document.getElementById('sc-save-panel');
  var saveOk = document.getElementById('sc-save-ok');
  var saveBtn = document.getElementById('sc-save-btn');
  saveOk.style.display = 'none';
  if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'âœ“ Enregistrer au classement'; }

  if (scState.players.length < 2) { panel.style.display = 'none'; return; }

  var p0 = scState.players[0], p1 = scState.players[1];
  var ap0 = p0.id ? players.find(function(ap) { return ap.id === p0.id; }) : null;
  var ap1 = p1.id ? players.find(function(ap) { return ap.id === p1.id; }) : null;

  // If no app players at all, hide panel
  if (players.length === 0) { panel.style.display = 'none'; return; }

  var gameNames = { '501':'501','301':'301','701':'701','cricket':'Cricket','countup':'Count Up','atclock':'Around the Clock','killer':'Killer','shanghai':'Shanghai','halfit':'Half-It' };
  var gameName = gameNames[scState.game] || scState.game;
  var winnerPlayer = scState.players[scState.winner];

  var infoEl = document.getElementById('sc-save-info');

  if (!ap0 || !ap1) {
    // Not all players linked â€” show warning with link prompt
    var unlinked = [];
    if (!ap0) unlinked.push('"' + p0.name + '"');
    if (!ap1) unlinked.push('"' + p1.name + '"');
    infoEl.innerHTML = '<span style="color:var(--red);font-size:0.75rem">âš  ' + unlinked.join(' et ') + ' ne sont pas liÃ©s Ã  un profil.</span>'
      + '<div style="color:var(--muted);font-size:0.7rem;margin-top:4px">Fermez le compteur, liez les joueurs dans la configuration, puis relancez.</div>';
    panel.style.display = 'block';
    if (saveBtn) { saveBtn.disabled = true; saveBtn.style.opacity = '0.5'; }
    return;
  }

  // Both linked â€” show save panel
  if (saveBtn) saveBtn.style.opacity = '1';

  var eloInfo = '';
  if (ap0.elo && ap1.elo) {
    var expectedW = 1 / (1 + Math.pow(10, (ap1.elo - ap0.elo) / 400));
    var eloGain = Math.round(32 * (scState.winner === 0 ? (1 - expectedW) : (0 - expectedW)));
    eloInfo = '<span style="color:var(--muted);font-size:0.68rem;display:block;margin-top:3px">'
      + 'ELO estimÃ© : <span style="color:' + (scState.winner === 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:700">'
      + (eloGain >= 0 ? '+' : '') + eloGain + '</span> pts pour ' + winnerPlayer.name
      + '</span>';
  }

  infoEl.innerHTML = '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem">'
    + '<span style="font-weight:700;color:var(--text)">' + ap0.pseudo + '</span>'
    + '<span style="color:var(--muted);font-size:0.8rem">vs</span>'
    + '<span style="font-weight:700;color:var(--text)">' + ap1.pseudo + '</span>'
    + '</div>'
    + '<span style="font-size:0.72rem;color:var(--accent);font-weight:600">ğŸ† Vainqueur : ' + winnerPlayer.name + '</span>'
    + '<span style="color:var(--muted);font-size:0.7rem;display:block;margin-top:2px">Jeu : ' + gameName + '</span>'
    + eloInfo;

  scState._saveRef = { p0id: ap0.id, p1id: ap1.id, isP0Win: scState.winner === 0, gameName: gameName };
  panel.style.display = 'block';
}

function scSaveMatch() {
  if (!scState._saveRef || scState.matchSaved) return;
  var ref = scState._saveRef;
  var s0 = ref.isP0Win ? 1 : 0, s1 = ref.isP0Win ? 0 : 1;
  var winner = ref.isP0Win ? ref.p0id : ref.p1id;

  var matchRecord = {
    id: Date.now(),
    p1: ref.p0id, p2: ref.p1id,
    s1: s0, s2: s1, winner: winner,
    format: 'sets',
    date: new Date().toLocaleDateString('fr-FR'),
    eloChange1: 0, eloChange2: 0,
    source: 'compteur',
    game: ref.gameName
  };

  // Extra stats for X01
  if (['501','301','701'].includes(scState.game)) {
    var wp = scState.players[scState.winner];
    if (wp.dartsThrown > 0) {
      matchRecord.winnerAvg = (((wp.startScore - wp.score) / wp.dartsThrown) * 3).toFixed(1);
      matchRecord.darts = wp.dartsThrown;
    }
  }

  matches.unshift(matchRecord);
  recomputeElo();
  checkAchievements();
  save();
  renderAll();

  // Save 180s and checkout stats to player profiles
  if (['501','301','701'].includes(scState.game)) {
    scState.players.forEach(function(sp) {
      if (sp.id) {
        var ap = players.find(function(x){ return x.id === sp.id; });
        if (ap) {
          ap.total180s = (ap.total180s||0) + (sp.count180||0);
          ap.totalCheckouts = (ap.totalCheckouts||0) + (sp.checkoutHits||0);
          ap.bestVisit = ap.bestVisit ? Math.max(ap.bestVisit, sp.bestVisit||0) : (sp.bestVisit||0);
        }
      }
    });
    save();
  }
  addAudit('ğŸ¯', '[Compteur] ' + ref.gameName + ' : ' + pName(ref.p0id) + ' ' + s0 + '-' + s1 + ' ' + pName(ref.p1id) + ' (ğŸ† ' + pName(winner) + ')');
  scState.matchSaved = true;

  var btn = document.getElementById('sc-save-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'âœ“ EnregistrÃ©'; }
  document.getElementById('sc-save-ok').style.display = 'block';
  showNotif('ğŸ† ' + pName(winner) + ' â€” Match enregistrÃ© au classement !');
  confetti();
}

function scPlayAgain() {
  scState.matchSaved = false;
  document.getElementById('sc-save-panel').style.display = 'none';
  scStartGame();
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTÃˆME D'IMPRESSION PROFESSIONNEL
// Chaque fonction ouvre une fenÃªtre propre et dÃ©diÃ©e
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CSS partagÃ© pour toutes les fenÃªtres d'impression â”€â”€
function _printBaseCSS(accentColor) {
  accentColor = accentColor || '#c0392b';
  return `
    @page { size: A4; margin: 1.2cm 1.5cm; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; font-size: 10pt; color: #1a1a1a; background: #fff; }
    h1 { font-size: 18pt; font-weight: 900; color: ${accentColor}; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
    h2 { font-size: 11pt; font-weight: 700; color: ${accentColor}; text-transform: uppercase; letter-spacing: 1px; margin: 14px 0 6px; padding-bottom: 4px; border-bottom: 2px solid ${accentColor}; }
    h3 { font-size: 9pt; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 1px; margin: 10px 0 4px; }
    .header { display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:3px solid ${accentColor}; margin-bottom:14px; }
    .header-left h1 { margin-bottom:0; }
    .header-meta { font-size:8pt; color:#888; margin-top:3px; }
    .header-right { text-align:right; font-size:8pt; color:#666; }
    .logo-box { background:${accentColor}; color:#fff; font-size:18pt; width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; margin-right:10px; }
    table { width:100%; border-collapse:collapse; font-size:9pt; margin-bottom:12px; }
    thead tr { background:${accentColor}; color:#fff; }
    thead th { padding:6px 8px; text-align:left; font-weight:700; font-size:8pt; text-transform:uppercase; letter-spacing:0.5px; }
    thead th.center { text-align:center; }
    tbody tr:nth-child(odd) { background:#f8f8f8; }
    tbody tr:nth-child(even) { background:#fff; }
    tbody td { padding:5px 8px; border-bottom:1px solid #e5e5e5; vertical-align:middle; }
    tbody td.center { text-align:center; }
    tbody td.mono { font-family:'Courier New',monospace; font-weight:700; }
    tbody td.bold { font-weight:700; }
    .rank-1 td { background:#fef9ec !important; font-weight:700; }
    .rank-2 td { background:#f5f5f5 !important; }
    .rank-3 td { background:#fdf5ef !important; }
    .badge { display:inline-block; padding:2px 7px; border-radius:20px; font-size:7.5pt; font-weight:700; }
    .badge-win  { background:#d5f5e3; color:#1e8449; }
    .badge-loss { background:#fadbd8; color:#922b21; }
    .badge-draw { background:#eee; color:#666; }
    .win { color:#1e8449; font-weight:700; }
    .loss { color:#c0392b; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:12px; }
    .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px; }
    .stat-box { border:1px solid #e0e0e0; border-radius:6px; padding:10px 12px; text-align:center; }
    .stat-box .num { font-size:22pt; font-weight:900; color:${accentColor}; line-height:1; }
    .stat-box .lbl { font-size:7.5pt; color:#888; text-transform:uppercase; letter-spacing:1px; margin-top:3px; }
    .podium { display:flex; align-items:flex-end; justify-content:center; gap:16px; margin:16px 0; }
    .pod-step { text-align:center; }
    .pod-name { font-weight:700; font-size:9pt; }
    .pod-elo { font-size:8pt; color:#888; }
    .pod-bar { margin-top:6px; border-radius:4px 4px 0 0; display:flex; align-items:center; justify-content:center; font-size:14pt; font-weight:900; }
    .pod-1 .pod-bar { height:70px; background:#fef3cd; border:2px solid #d4ac0d; color:#d4ac0d; width:80px; }
    .pod-2 .pod-bar { height:50px; background:#f0f0f0; border:2px solid #95a5a6; color:#7f8c8d; width:70px; }
    .pod-3 .pod-bar { height:36px; background:#fdebd0; border:2px solid #ca8a49; color:#ca8a49; width:70px; }
    .match-row { display:flex; align-items:center; padding:5px 8px; border-bottom:1px solid #eee; font-size:9pt; }
    .match-row:nth-child(odd) { background:#f9f9f9; }
    .match-winner { font-weight:700; }
    .match-score { font-family:'Courier New',monospace; font-weight:700; color:${accentColor}; min-width:34px; text-align:center; margin:0 8px; }
    .match-date { margin-left:auto; font-size:8pt; color:#aaa; }
    .footer { margin-top:16px; padding-top:8px; border-top:1px solid #ddd; font-size:7.5pt; color:#aaa; display:flex; justify-content:space-between; }
    .page-break { page-break-before:always; }
    @media print { .no-print { display:none; } }
  `;
}

// â”€â”€ FenÃªtre d'impression gÃ©nÃ©rique â”€â”€
function _openPrintWindow(title, bodyHTML, extraCSS) {
  const clubName = (localStorage.getItem('darts_club_name') || 'FlÃ©chettes Club') ;
  const clubEmoji = localStorage.getItem('darts_club_logo') || 'ğŸ¯';
  const accentColor = localStorage.getItem('darts_club_color') || '#c0392b';
  const dateStr = new Date().toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });

  const w = window.open('', '_blank', 'width=820,height=950');
  w.document.write(`<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <title>${clubName} â€” ${title}</title>
    <style>${_printBaseCSS(accentColor)}${extraCSS||''}</style>
  </head><body>
    <div class="header">
      <div style="display:flex;align-items:center">
        <div class="logo-box">${clubEmoji}</div>
        <div class="header-left">
          <h1>${clubName}</h1>
          <div class="header-meta">${title} Â· ${dateStr}</div>
        </div>
      </div>
      <div class="header-right">
        <div style="font-size:10pt;font-weight:700">Saison ${(localStorage.getItem('darts_seasons') ? JSON.parse(localStorage.getItem('darts_seasons')).find(s=>s.active)?.name || 'Saison 1' : 'Saison 1')}</div>
        <div style="margin-top:2px">${players.length} joueur${players.length>1?'s':''} Â· ${matches.length} match${matches.length>1?'s':''}</div>
      </div>
    </div>
    ${bodyHTML}
    <div class="footer">
      <span>${clubName} â€” ${title}</span>
      <span>ImprimÃ© le ${dateStr}</span>
    </div>
    <div class="no-print" style="text-align:center;margin:20px 0">
      <button onclick="window.print()" style="padding:10px 28px;background:${accentColor};color:#fff;border:none;border-radius:6px;font-size:11pt;font-weight:700;cursor:pointer;margin-right:8px">ğŸ–¨ï¸ Imprimer</button>
      <button onclick="window.close()" style="padding:10px 20px;background:#eee;color:#333;border:none;border-radius:6px;font-size:11pt;cursor:pointer">âœ• Fermer</button>
    </div>
  </body></html>`);
  w.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. CLASSEMENT COMPLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printClassement() {
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b) => (b.elo||0)-(a.elo||0));
  if (!sorted.length) { showNotif('âš  Aucun joueur Ã  imprimer.'); return; }

  // Stats globales
  const totalMatchs = matches.length;
  const avgElo = sorted.length ? Math.round(sorted.reduce((s,p)=>s+(p.elo||0),0)/sorted.length) : 0;
  const topElo = sorted[0];

  let summaryHtml = `<div class="grid-3">
    <div class="stat-box"><div class="num">${sorted.length}</div><div class="lbl">Joueurs</div></div>
    <div class="stat-box"><div class="num">${totalMatchs}</div><div class="lbl">Matchs jouÃ©s</div></div>
    <div class="stat-box"><div class="num">${avgElo}</div><div class="lbl">ELO moyen</div></div>
  </div>`;

  // Tableau classement
  let tableHtml = `<h2>ğŸ† Classement GÃ©nÃ©ral</h2>
  <table>
    <thead><tr>
      <th class="center">#</th>
      <th>Joueur</th>
      <th class="center">ELO</th>
      <th class="center">J</th>
      <th class="center">V</th>
      <th class="center">D</th>
      <th class="center">N</th>
      <th class="center">% Vic.</th>
      <th class="center">Diff. Sets</th>
    </tr></thead><tbody>`;

  sorted.forEach((p, i) => {
    const s = stats[p.id] || { wins:0, losses:0, draws:0, matches:0, setsFor:0, setsAgainst:0 };
    const pct = s.matches > 0 ? Math.round(s.wins / s.matches * 100) : 0;
    const setsDiff = (s.setsFor||0) - (s.setsAgainst||0);
    const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
    const rowCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
    tableHtml += `<tr class="${rowCls}">
      <td class="center bold">${medal}</td>
      <td class="bold">${p.pseudo}${p.name&&p.name!==p.pseudo?'<br><span style="font-size:8pt;font-weight:400;color:#888">'+p.name+'</span>':''}</td>
      <td class="center mono" style="color:${i===0?'#c0392b':'inherit'}">${p.elo||1000}</td>
      <td class="center">${s.matches}</td>
      <td class="center win">${s.wins}</td>
      <td class="center loss">${s.losses}</td>
      <td class="center">${s.draws||0}</td>
      <td class="center">${pct}%</td>
      <td class="center" style="color:${setsDiff>0?'#1e8449':setsDiff<0?'#c0392b':'#888'}">${setsDiff>0?'+':''}${setsDiff}</td>
    </tr>`;
  });
  tableHtml += '</tbody></table>';

  _openPrintWindow('Classement', summaryHtml + tableHtml);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. PODIUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printPodium() {
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b)=>(b.elo||0)-(a.elo||0)).slice(0,3);
  if (sorted.length < 1) { showNotif('âš  Aucun joueur.'); return; }

  const [p1,p2,p3] = [sorted[0],sorted[1],sorted[2]];
  const s = (p) => stats[p?.id] || {wins:0,losses:0,matches:0};

  let podHtml = `<h2>ğŸ† Podium</h2>
  <div class="podium">
    ${p2?`<div class="pod-step pod-2">
      <div class="pod-name">${p2.pseudo}</div>
      <div class="pod-elo">${p2.elo} pts</div>
      <div class="pod-bar">2</div>
    </div>`:''}
    ${p1?`<div class="pod-step pod-1">
      <div class="pod-name">${p1.pseudo}</div>
      <div class="pod-elo">${p1.elo} pts</div>
      <div class="pod-bar">1</div>
    </div>`:''}
    ${p3?`<div class="pod-step pod-3">
      <div class="pod-name">${p3.pseudo}</div>
      <div class="pod-elo">${p3.elo} pts</div>
      <div class="pod-bar">3</div>
    </div>`:''}
  </div>`;

  // Stats top 3
  podHtml += `<h2>ğŸ“Š Statistiques Top 3</h2><table>
    <thead><tr><th>Joueur</th><th class="center">ELO</th><th class="center">Matchs</th><th class="center">Victoires</th><th class="center">DÃ©faites</th><th class="center">% Vic.</th></tr></thead><tbody>`;
  sorted.forEach((p,i) => {
    const st = s(p);
    const pct = st.matches > 0 ? Math.round(st.wins/st.matches*100) : 0;
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    podHtml += `<tr class="rank-${i+1}">
      <td class="bold">${medals[i]} ${p.pseudo}</td>
      <td class="center mono">${p.elo}</td>
      <td class="center">${st.matches}</td>
      <td class="center win">${st.wins}</td>
      <td class="center loss">${st.losses}</td>
      <td class="center">${pct}%</td>
    </tr>`;
  });
  podHtml += '</tbody></table>';

  _openPrintWindow('Podium', podHtml);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. HISTORIQUE DES MATCHS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printHistorique() {
  if (!matches.length) { showNotif('âš  Aucun match Ã  imprimer.'); return; }

  // RÃ©cupÃ©rer le filtre joueur actif
  const filterId = parseInt(document.getElementById('hist-player-filter')?.value || '');
  const filterSearch = document.getElementById('hist-search-input')?.value?.trim() || '';
  const filterFormat = document.getElementById('hist-format-filter')?.value || '';

  let filtered = [...matches];
  if (filterId) filtered = filtered.filter(m => m.p1===filterId || m.p2===filterId);
  if (filterFormat) filtered = filtered.filter(m => (m.format||'').includes(filterFormat));
  if (filterSearch) {
    const q = filterSearch.toLowerCase();
    filtered = filtered.filter(m => {
      const p1 = pById(m.p1), p2 = pById(m.p2);
      return (p1&&p1.pseudo.toLowerCase().includes(q)) || (p2&&p2.pseudo.toLowerCase().includes(q));
    });
  }

  const filterLabel = filterId ? `Filtre : ${pName(filterId)}` : 'Tous les joueurs';
  const total = filtered.length;
  const totalWins = filtered.filter(m=>m.winner).length;

  let summaryHtml = `<div class="grid-3">
    <div class="stat-box"><div class="num">${total}</div><div class="lbl">Matchs</div></div>
    <div class="stat-box"><div class="num">${totalWins}</div><div class="lbl">Avec vainqueur</div></div>
    <div class="stat-box"><div class="num">${total-totalWins}</div><div class="lbl">Nuls / Sans rÃ©sultat</div></div>
  </div>`;

  let tableHtml = `<h2>ğŸ“‹ Historique â€” ${filterLabel}</h2>
  <table>
    <thead><tr>
      <th>Date</th>
      <th>Joueur 1</th>
      <th class="center">Score</th>
      <th>Joueur 2</th>
      <th class="center">RÃ©sultat</th>
      <th class="center">Format</th>
    </tr></thead><tbody>`;

  filtered.slice().reverse().forEach(m => {
    const p1 = pById(m.p1), p2 = pById(m.p2);
    const isP1Win = m.winner===m.p1;
    const isP2Win = m.winner===m.p2;
    const isDraw = !m.winner;
    tableHtml += `<tr>
      <td style="color:#888;font-size:8pt;white-space:nowrap">${m.date||'â€”'}</td>
      <td class="${isP1Win?'win bold':''}">${p1?p1.pseudo:'?'}</td>
      <td class="center mono">${m.s1??'â€”'} â€” ${m.s2??'â€”'}</td>
      <td class="${isP2Win?'win bold':''}">${p2?p2.pseudo:'?'}</td>
      <td class="center">
        ${isP1Win?`<span class="badge badge-win">V â€” ${p1?p1.pseudo:'?'}</span>`:
          isP2Win?`<span class="badge badge-win">V â€” ${p2?p2.pseudo:'?'}</span>`:
          '<span class="badge badge-draw">Nul</span>'}
      </td>
      <td class="center" style="font-size:8pt;color:#888">${m.format||m.source||'â€”'}</td>
    </tr>`;
  });
  tableHtml += '</tbody></table>';

  _openPrintWindow('Historique des matchs', summaryHtml + tableHtml);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. LISTE DES JOUEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printJoueurs() {
  if (!players.length) { showNotif('âš  Aucun joueur Ã  imprimer.'); return; }
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b)=>(b.elo||0)-(a.elo||0));

  let tableHtml = `<h2>ğŸ‘¥ Liste des Joueurs</h2>
  <table>
    <thead><tr>
      <th class="center">#</th>
      <th>Pseudo</th>
      <th>Nom complet</th>
      <th class="center">ELO</th>
      <th class="center">Matchs</th>
      <th class="center">V</th>
      <th class="center">D</th>
      <th class="center">% Vic.</th>
      <th>TrophÃ©es</th>
    </tr></thead><tbody>`;

  sorted.forEach((p,i) => {
    const s = stats[p.id] || {wins:0,losses:0,matches:0};
    const pct = s.matches > 0 ? Math.round(s.wins/s.matches*100) : 0;
    const trophies = (p.achievements||[]).length;
    tableHtml += `<tr>
      <td class="center bold">${i+1}</td>
      <td class="bold">${p.pseudo}</td>
      <td style="color:#666">${p.name&&p.name!==p.pseudo?p.name:'â€”'}</td>
      <td class="center mono">${p.elo||1000}</td>
      <td class="center">${s.matches}</td>
      <td class="center win">${s.wins}</td>
      <td class="center loss">${s.losses}</td>
      <td class="center">${pct}%</td>
      <td style="font-size:9pt">${trophies>0?'â˜…'.repeat(Math.min(trophies,5))+' ('+trophies+')':'â€”'}</td>
    </tr>`;
  });
  tableHtml += '</tbody></table>';

  _openPrintWindow('Liste des joueurs', tableHtml);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. RAPPORT STATISTIQUES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printStats() {
  if (!players.length) { showNotif('âš  Aucune donnÃ©e Ã  imprimer.'); return; }
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b)=>(b.elo||0)-(a.elo||0));

  // Calculer des stats globales
  const totalMatchs = matches.length;
  const avgElo = sorted.length ? Math.round(sorted.reduce((s,p)=>s+(p.elo||0),0)/sorted.length) : 0;
  const topWinner = sorted.reduce((best,p) => {
    const s = stats[p.id]||{wins:0};
    return (s.wins > (stats[best?.id]||{wins:0}).wins) ? p : best;
  }, sorted[0]);
  const topPct = sorted.filter(p=>(stats[p.id]||{matches:0}).matches>=3).sort((a,b)=>{
    const sa=stats[a.id]||{wins:0,matches:0}, sb=stats[b.id]||{wins:0,matches:0};
    return (sb.wins/Math.max(sb.matches,1)) - (sa.wins/Math.max(sa.matches,1));
  })[0];

  let html = `<div class="grid-3">
    <div class="stat-box"><div class="num">${sorted.length}</div><div class="lbl">Joueurs actifs</div></div>
    <div class="stat-box"><div class="num">${totalMatchs}</div><div class="lbl">Matchs jouÃ©s</div></div>
    <div class="stat-box"><div class="num">${avgElo}</div><div class="lbl">ELO moyen</div></div>
  </div>`;

  // Table performances complÃ¨tes
  html += `<h2>ğŸ“Š Performances complÃ¨tes</h2>
  <table>
    <thead><tr>
      <th class="center">#</th>
      <th>Joueur</th>
      <th class="center">ELO</th>
      <th class="center">Peak</th>
      <th class="center">J</th>
      <th class="center">V</th>
      <th class="center">D</th>
      <th class="center">N</th>
      <th class="center">% Vic.</th>
      <th class="center">Sets P/C</th>
    </tr></thead><tbody>`;

  sorted.forEach((p,i) => {
    const s = stats[p.id] || {wins:0,losses:0,draws:0,matches:0,setsFor:0,setsAgainst:0};
    const pct = s.matches > 0 ? Math.round(s.wins/s.matches*100) : 0;
    const rowCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
    html += `<tr class="${rowCls}">
      <td class="center bold">${i+1}</td>
      <td class="bold">${p.pseudo}</td>
      <td class="center mono">${p.elo||1000}</td>
      <td class="center" style="font-size:8pt;color:#888">${p.peak||1000}</td>
      <td class="center">${s.matches}</td>
      <td class="center win">${s.wins}</td>
      <td class="center loss">${s.losses}</td>
      <td class="center">${s.draws||0}</td>
      <td class="center bold">${pct}%</td>
      <td class="center" style="font-size:8pt">${s.setsFor||0} / ${s.setsAgainst||0}</td>
    </tr>`;
  });
  html += '</tbody></table>';

  // Head-to-head heatmap textuelle
  if (sorted.length >= 2) {
    html += `<h2>ğŸ”¥ Face-Ã -Face (victoires)</h2>
    <table style="font-size:8pt">
      <thead><tr><th>â†“ vs â†’</th>`;
    sorted.forEach(p => { html += `<th class="center">${p.pseudo.substring(0,8)}</th>`; });
    html += '</tr></thead><tbody>';
    sorted.forEach(p1 => {
      html += `<tr><td class="bold">${p1.pseudo.substring(0,10)}</td>`;
      sorted.forEach(p2 => {
        if (p1.id === p2.id) {
          html += '<td class="center" style="background:#f0f0f0;color:#ccc">â€”</td>';
        } else {
          const wins = matches.filter(m => m.p1===p1.id&&m.p2===p2.id&&m.winner===p1.id || m.p1===p2.id&&m.p2===p1.id&&m.winner===p1.id).length;
          const total = matches.filter(m => (m.p1===p1.id&&m.p2===p2.id)||(m.p1===p2.id&&m.p2===p1.id)).length;
          const style = wins > 0 ? 'color:#1e8449;font-weight:700' : total>0 ? 'color:#c0392b' : 'color:#bbb';
          html += `<td class="center" style="${style}">${total>0?wins:'â€”'}</td>`;
        }
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
  }

  _openPrintWindow('Rapport Statistiques', html);
}

// â”€â”€ Mise Ã  jour de l'ancienne fonction exportPDF â”€â”€
function exportPDF() {
  printClassement();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT EXCEL / CSV â€” joueurs sans doublons
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _importRows = [];       // parsed rows [{nom, pseudo}]
let _importCols = [];       // column headers from sheet

function openImportExcelModal() {
  openModal('import-excel-modal');
  importReset();
}

function closeImportModal() {
  closeModal('import-excel-modal');
  importReset();
}

function importReset() {
  _importRows = [];
  _importCols = [];
  document.getElementById('import-file-input').value = '';
  document.getElementById('import-col-map-wrap').style.display = 'none';
  document.getElementById('import-summary-wrap').style.display = 'none';
  document.getElementById('import-preview-wrap').style.display = 'none';
  document.getElementById('import-confirm-btn').disabled = true;
  document.getElementById('import-confirm-label').textContent = 'Importer';
  document.getElementById('import-dropzone').classList.remove('drag-over');
}

/* â”€â”€ Drag & drop â”€â”€ */
function importDragOver(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.add('drag-over');
}
function importDragLeave(e) {
  document.getElementById('import-dropzone').classList.remove('drag-over');
}
function importDrop(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) importParseFile(file);
}
function importFileChosen(e) {
  const file = e.target.files[0];
  if (file) importParseFile(file);
}

/* â”€â”€ Parse file with SheetJS â”€â”€ */
function importParseFile(file) {
  if (typeof XLSX === 'undefined') {
    showNotif('âš  BibliothÃ¨que SheetJS non chargÃ©e. VÃ©rifiez la connexion internet.'); return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      if (!json.length) { showNotif('âš  Fichier vide ou non lisible.'); return; }

      // First row = headers
      _importCols = json[0].map(c => String(c).trim());
      _importRows = json.slice(1).filter(row => row.some(c => String(c).trim() !== ''));

      importBuildColSelects();
      importPreview();
    } catch (err) {
      showNotif('âš  Erreur de lecture : ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

/* â”€â”€ Build column selectors â”€â”€ */
function importBuildColSelects() {
  const opts = '<option value="-1">â€” aucune â€”</option>' +
    _importCols.map((c, i) => `<option value="${i}">${c || '(col. ' + (i+1) + ')'}</option>`).join('');
  document.getElementById('import-col-nom').innerHTML = opts;
  document.getElementById('import-col-pseudo').innerHTML = opts;

  // Auto-detect best columns
  const nomKeywords    = ['nom', 'name', 'prÃ©nom', 'prenom', 'firstname', 'lastname', 'joueur', 'player'];
  const pseudoKeywords = ['pseudo', 'nickname', 'alias', 'surnom', 'login', 'username'];
  const findCol = (keywords) => {
    for (let k of keywords) {
      const idx = _importCols.findIndex(c => c.toLowerCase().includes(k));
      if (idx >= 0) return idx;
    }
    return 0;
  };
  document.getElementById('import-col-nom').value    = findCol(nomKeywords);
  document.getElementById('import-col-pseudo').value = findCol(pseudoKeywords);

  document.getElementById('import-col-map-wrap').style.display = 'block';
}

/* â”€â”€ Build preview table â”€â”€ */
function importPreview() {
  const nomIdx    = parseInt(document.getElementById('import-col-nom').value);
  const pseudoIdx = parseInt(document.getElementById('import-col-pseudo').value);

  let newCount = 0, dupCount = 0;
  const tbody = document.getElementById('import-preview-tbody');
  let html = '';

  _importRows.forEach((row, i) => {
    const nom    = nomIdx    >= 0 ? String(row[nomIdx]    || '').trim() : '';
    const pseudo = pseudoIdx >= 0 ? String(row[pseudoIdx] || '').trim() : '';
    const displayName   = nom    || pseudo || '(vide)';
    const displayPseudo = pseudo || nom    || '(vide)';
    if (!nom && !pseudo) return; // skip truly empty rows

    // Duplicate check: match on pseudo (or nom if no pseudo col)
    const lookupKey = (displayPseudo).toLowerCase();
    const isDup = players.some(p => p.pseudo.toLowerCase() === lookupKey || p.name.toLowerCase() === lookupKey);

    if (isDup) dupCount++; else newCount++;

    const rowClass = isDup ? 'row-duplicate' : 'row-new';
    const statusHtml = isDup
      ? `<span class="status-badge"><i class="fas fa-ban" style="font-size:0.55rem"></i> DÃ©jÃ  inscrit</span>`
      : `<span class="status-badge"><i class="fas fa-plus" style="font-size:0.55rem"></i> Nouveau</span>`;
    const checkDisabled = isDup ? 'disabled' : '';
    const checkChecked  = isDup ? '' : 'checked';

    html += `<tr class="${rowClass}" data-row-idx="${i}" data-nom="${nom}" data-pseudo="${displayPseudo}" data-is-dup="${isDup}">
      <td><input type="checkbox" class="import-row-check" ${checkChecked} ${checkDisabled} style="width:auto;margin:0;cursor:pointer"></td>
      <td>${displayName || '<span style="color:var(--muted)">â€”</span>'}</td>
      <td style="font-weight:600;color:var(--text)">${displayPseudo || '<span style="color:var(--muted)">â€”</span>'}</td>
      <td>${statusHtml}</td>
    </tr>`;
  });

  tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:1rem">Aucune ligne lisible.</td></tr>';

  // Summary chips
  const total = newCount + dupCount;
  document.getElementById('import-summary').innerHTML =
    `<div class="import-summary-chip chip-total"><i class="fas fa-table"></i> ${total} ligne${total>1?'s':''} lues</div>` +
    `<div class="import-summary-chip chip-new"><i class="fas fa-user-plus"></i> ${newCount} nouveau${newCount>1?'x':''}</div>` +
    `<div class="import-summary-chip chip-dup"><i class="fas fa-ban"></i> ${dupCount} doublon${dupCount>1?'s':''}</div>`;

  document.getElementById('import-summary-wrap').style.display = 'block';
  document.getElementById('import-preview-wrap').style.display = 'block';

  importUpdateConfirmBtn();
}

/* â”€â”€ Select all / none checkboxes â”€â”€ */
function importSelectAll(checked) {
  document.querySelectorAll('.import-row-check:not(:disabled)').forEach(cb => cb.checked = checked);
  importUpdateConfirmBtn();
}

/* â”€â”€ Listen for checkbox changes â”€â”€ */
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('import-row-check')) importUpdateConfirmBtn();
});

function importUpdateConfirmBtn() {
  const selected = document.querySelectorAll('.import-row-check:not(:disabled):checked').length;
  const btn = document.getElementById('import-confirm-btn');
  const lbl = document.getElementById('import-confirm-label');
  btn.disabled = selected === 0;
  lbl.textContent = selected > 0
    ? `Importer ${selected} joueur${selected > 1 ? 's' : ''}`
    : 'Importer';
}

/* â”€â”€ Confirm import â”€â”€ */
function importConfirm() {
  const nomIdx    = parseInt(document.getElementById('import-col-nom').value);
  const pseudoIdx = parseInt(document.getElementById('import-col-pseudo').value);
  const checkedRows = document.querySelectorAll('.import-row-check:not(:disabled):checked');
  let added = 0;

  checkedRows.forEach(cb => {
    const tr = cb.closest('tr');
    if (!tr || tr.dataset.isDup === 'true') return;

    const nom    = tr.dataset.nom    || '';
    const pseudo = tr.dataset.pseudo || '';
    const nomFinal    = nom    || pseudo;
    const pseudoFinal = pseudo || nom;

    if (!pseudoFinal) return;

    // Final duplicate guard
    if (players.find(p => p.pseudo.toLowerCase() === pseudoFinal.toLowerCase())) return;

    const newPlayer = {
      id: Date.now() + added,
      name: nomFinal,
      pseudo: pseudoFinal,
      elo: ELO_START,
      eloHistory: [ELO_START],
      peak: ELO_START,
      trend: 0,
      achievements: []
    };
    players.push(newPlayer);
    addAudit('ğŸ“¥', `Import Excel : ${newPlayer.pseudo}`);
    added++;
  });

  if (added > 0) {
    save();
    renderPlayers();
    renderSelects();
    showNotif(`âœ“ ${added} joueur${added > 1 ? 's' : ''} importÃ©${added > 1 ? 's' : ''} !`, 'success');
  } else {
    showNotif('Aucun nouveau joueur Ã  importer.');
  }
  closeImportModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme() {
  const isLight = document.body.classList.toggle('light-mode');
  const btn = document.getElementById('theme-toggle-btn');
  if (btn) btn.innerHTML = isLight ? '<i class="fas fa-sun"></i> Clair' : '<i class="fas fa-moon"></i> Sombre';
  localStorage.setItem('darts_theme', isLight ? 'light' : 'dark');
}
(function initTheme() {
  const t = localStorage.getItem('darts_theme');
  if (t === 'light') {
    document.body.classList.add('light-mode');
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.innerHTML = '<i class="fas fa-sun"></i> Clair';
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function filterHistSearch(val) {
  const clear = document.getElementById('hist-search-clear');
  if (clear) clear.style.display = val ? 'block' : 'none';
  renderHistorique(val);
}
function clearHistSearch() {
  const inp = document.getElementById('hist-search-input');
  if (inp) inp.value = '';
  filterHistSearch('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENT UNLOCK ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAchievementUnlock(icon, name, desc) {
  const toast = document.createElement('div');
  toast.className = 'ach-unlock-toast';
  toast.innerHTML = '<span class="ach-unlock-icon">' + icon + '</span>'
    + '<div class="ach-unlock-label">ğŸ† TrophÃ©e dÃ©bloquÃ© !</div>'
    + '<div class="ach-unlock-name">' + name + '</div>'
    + '<div class="ach-unlock-desc">' + desc + '</div>';
  document.body.appendChild(toast);
  setTimeout(function() {
    toast.style.transition = 'all 0.4s ease';
    toast.style.transform = 'translate(-50%,-50%) scale(0)';
    toast.style.opacity = '0';
    setTimeout(function() { toast.remove(); }, 400);
  }, 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchProfileTab(tab, btn) {
  document.querySelectorAll('.profile-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.profile-tab-content').forEach(function(c) { c.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  var el = document.getElementById('profile-tab-' + tab);
  if (el) el.classList.add('active');
  if (tab === 'history') renderProfileMatchHistory();
  if (tab === 'achievements') renderProfileAchievements();
  if (tab === 'training') renderProfileTrainingTab();
}

function renderProfileMatchHistory() {
  var pid = _editingPlayerId;
  var el = document.getElementById('profile-match-history');
  if (!el || !pid) return;
  var pm = matches.filter(function(m) { return m.p1 === pid || m.p2 === pid; }).slice(0, 30);
  if (!pm.length) { el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:1rem;text-align:center">Aucun match jouÃ©.</div>'; return; }
  el.innerHTML = pm.map(function(m) {
    var isWin = m.winner === pid;
    var isDraw = !m.winner;
    var opp = m.p1 === pid ? pById(m.p2) : pById(m.p1);
    var myScore = m.p1 === pid ? m.s1 : m.s2;
    var oppScore = m.p1 === pid ? m.s2 : m.s1;
    var cls = isWin ? 'hm-win' : isDraw ? 'hm-draw' : '';
    var eloChange = m.p1 === pid ? (m.eloChange1||0) : (m.eloChange2||0);
    var eloStr = eloChange >= 0 ? '+' + eloChange : '' + eloChange;
    var gameTag = m.source === 'compteur' ? '<span style="font-size:0.62rem;color:var(--purple);background:rgba(166,124,247,0.1);border-radius:4px;padding:1px 5px;margin-left:4px">ğŸ¯ ' + (m.game||'Compteur') + '</span>' : '';
    return '<div class="hist-match-card ' + cls + '" style="margin-bottom:0.5rem">'
      + '<div style="font-size:0.7rem;font-weight:700;color:' + (isWin?'var(--green)':isDraw?'var(--muted)':'var(--red)') + ';flex-shrink:0;min-width:24px">' + (isWin?'V':isDraw?'=':'D') + '</div>'
      + '<div style="flex:1;font-size:0.8rem;font-weight:600">' + (opp ? opp.pseudo : '?') + gameTag + '</div>'
      + '<div style="font-size:0.82rem;font-family:\'DM Mono\',monospace">' + myScore + ' â€” ' + oppScore + '</div>'
      + '<div style="font-size:0.68rem;color:' + (eloChange>=0?'var(--green)':'var(--red)') + ';font-family:\'DM Mono\',monospace;min-width:36px;text-align:right">' + eloStr + '</div>'
      + '<div style="font-size:0.65rem;color:var(--muted);margin-left:0.4rem">' + m.date + '</div>'
      + '</div>';
  }).join('');
}

function renderProfileAchievements() {
  var pid = _editingPlayerId;
  var el = document.getElementById('profile-achievements-detail');
  if (!el || !pid) return;
  var p = pById(pid);
  if (!p) return;
  var stats = getStats();
  var s = stats[pid] || { wins:0, losses:0, draws:0, matches:0 };
  recomputeElo();

  // Progress toward next achievements
  var progressMap = {
    'ten_matches':   { label:'VÃ©tÃ©ran', current: s.matches, target: 10 },
    'twenty_matches':{ label:'Pilier du Club', current: s.matches, target: 20 },
    'elo1200':       { label:'En Progression', current: p.elo, target: 1200 },
    'elo1500':       { label:'Expert', current: p.elo, target: 1500 },
    'streak3':       { label:'En Feu', current: (getStreak(pid)||{count:0}).count, target: 3 },
    'streak5':       { label:'InarrÃªtable', current: (getStreak(pid)||{count:0}).count, target: 5 },
  };

  var unlocked = p.achievements || [];
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:0.6rem">';
  ACHIEVEMENTS.forEach(function(ach) {
    var isUnlocked = unlocked.includes(ach.id);
    var prog = progressMap[ach.id];
    var progHtml = '';
    if (!isUnlocked && prog) {
      var pct = Math.min(100, Math.round(prog.current / prog.target * 100));
      progHtml = '<div class="ach-progress-wrap">'
        + '<div class="ach-progress-label"><span>' + prog.current + ' / ' + prog.target + '</span><span>' + pct + '%</span></div>'
        + '<div class="ach-progress-bar"><div class="ach-progress-fill" style="width:' + pct + '%"></div></div>'
        + '</div>';
    }
    html += '<div style="background:var(--surface2);border:1px solid ' + (isUnlocked?'rgba(230, 57, 70, 0.4)':'var(--border)') + ';border-radius:8px;padding:0.7rem;opacity:' + (isUnlocked?'1':'0.6') + '">'
      + '<div style="font-size:1.6rem;margin-bottom:0.3rem">' + ach.icon + '</div>'
      + '<div style="font-size:0.75rem;font-weight:700;color:' + (isUnlocked?'var(--accent)':'var(--text-dim)') + '">' + ach.name + '</div>'
      + '<div style="font-size:0.65rem;color:var(--muted);margin-top:2px">' + ach.desc + '</div>'
      + (isUnlocked ? '<div style="font-size:0.62rem;color:var(--green);margin-top:4px;font-weight:600">âœ“ DÃ©bloquÃ©</div>' : progHtml)
      + '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

function renderProfileTrainingTab() {
  var pid = _editingPlayerId;
  var el = document.getElementById('profile-training-detail');
  if (!el || !pid) return;
  var sessions = typeof trainingSessions !== 'undefined' ? trainingSessions.filter(function(s) { return s.playerId == pid; }) : [];
  if (!sessions.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:1rem;text-align:center">Aucune session d\'entraÃ®nement enregistrÃ©e.</div>';
    return;
  }
  // Group by exercise
  var byEx = {};
  sessions.forEach(function(s) {
    if (!byEx[s.exerciseId]) byEx[s.exerciseId] = [];
    byEx[s.exerciseId].push(s);
  });
  var html = '';
  Object.keys(byEx).forEach(function(exId) {
    var ex = typeof EXERCISES !== 'undefined' ? EXERCISES.find(function(e) { return e.id === exId; }) : null;
    var exSessions = byEx[exId].slice().sort(function(a,b) { return a.date - b.date; });
    var best = Math.max.apply(null, exSessions.map(function(s) { return s.score; }));
    var last = exSessions[exSessions.length - 1].score;
    var trend = exSessions.length > 1 ? (last - exSessions[exSessions.length-2].score) : 0;
    var maxH = 50;
    var maxScore = Math.max(best, 1);
    var bars = exSessions.slice(-10).map(function(s) {
      var h = Math.max(4, Math.round(s.score / maxScore * maxH));
      return '<div class="train-prog-bar" title="' + s.score + '" style="height:' + h + 'px"></div>';
    }).join('');
    html += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.7rem">'
      + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem">'
      + '<span style="font-size:0.8rem;font-weight:700">' + (ex ? ex.icon + ' ' + ex.title : exId) + '</span>'
      + '<span style="font-size:0.68rem;color:var(--muted)">' + exSessions.length + ' session' + (exSessions.length>1?'s':'') + '</span>'
      + '</div>'
      + '<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem">'
      + '<div style="font-size:0.7rem;color:var(--muted)">Record <span style="color:var(--accent);font-weight:700;font-family:\'DM Mono\',monospace">' + best + '</span></div>'
      + '<div style="font-size:0.7rem;color:var(--muted)">Dernier <span style="color:var(--text);font-weight:700;font-family:\'DM Mono\',monospace">' + last + '</span></div>'
      + '<div style="font-size:0.7rem;color:' + (trend>0?'var(--green)':trend<0?'var(--red)':'var(--muted)') + ';font-weight:700">' + (trend>0?'â†‘+':trend<0?'â†“':'â†’') + (trend!==0?Math.abs(trend):'') + '</div>'
      + '</div>'
      + '<div class="train-prog-chart">' + bars + '</div>'
      + '</div>';
  });
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORE COUNTER LIVE STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scUpdateLiveStats() {
  var game = scState.game;
  var strip = document.getElementById('sc-live-stats');
  if (!strip) return;
  if (!['501','301','701'].includes(game)) { strip.style.display = 'none'; return; }
  strip.style.display = 'flex';
  var p = scState.players[scState.currentPlayer];
  // Moyenne cumulÃ©e multi-legs : score total rÃ©duit / flÃ©chettes totales * 3
  var _totalDarts = (p.cumulativeDarts || 0) + (p.dartsThrown || 0);
  var _totalReduced = (p.cumulativeReduced || 0);
  // Ajouter ce qui est en cours (score de dÃ©part du leg - score actuel)
  var _legReduced = p.startScore - p.score;
  var avg = _totalDarts > 0 ? ((_totalReduced + (_legReduced > 0 ? _legReduced : 0)) / _totalDarts * 3).toFixed(1) : 'â€”';
  var best = p.bestVisit || 'â€”';
  var count180 = p.count180 || 0;
  var checkAttempts = p.checkoutAttempts || 0;
  var checkHits = p.checkoutHits || 0;
  var coStr = checkAttempts > 0 ? Math.round(checkHits / checkAttempts * 100) + '%' : 'â€”';

  var avgEl = document.getElementById('sc-ls-avg');
  var bestEl = document.getElementById('sc-ls-best');
  var el180 = document.getElementById('sc-ls-180');
  var wrap180 = document.getElementById('sc-ls-180-wrap');
  var coEl = document.getElementById('sc-ls-co');
  var coWrap = document.getElementById('sc-ls-co-wrap');

  if (avgEl) avgEl.textContent = avg;
  if (bestEl) bestEl.textContent = best;
  if (el180) el180.textContent = count180;
  if (wrap180) wrap180.style.display = 'flex';
  if (coEl) coEl.textContent = coStr;
  if (coWrap) coWrap.style.display = checkAttempts > 0 ? 'flex' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORE COUNTER FULL RECAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scBuildRecap() {
  var game = scState.game;
  var recapGrid = document.getElementById('sc-recap-grid');
  if (!recapGrid || !['501','301','701'].includes(game)) { if(recapGrid) recapGrid.style.display='none'; return; }
  recapGrid.style.display = 'grid';
  recapGrid.innerHTML = scState.players.map(function(p, i) {
    var _td = p.cumulativeDarts || p.dartsThrown || 0;
    var _tr = p.cumulativeReduced || (p.startScore - p.score);
    var avg = _td > 0 ? (_tr / _td * 3).toFixed(1) : 'â€”';
    var isWinner = i === scState.winner;
    var coStr = (p.checkoutAttempts||0) > 0 ? Math.round((p.checkoutHits||0)/(p.checkoutAttempts||1)*100) + '%' : 'â€”';
    return '<div class="sc-recap-card ' + (isWinner?'winner-card':'') + '">'
      + '<div class="sc-recap-pname">' + (isWinner?'ğŸ† ':'') + p.name + '</div>'
      + '<div class="sc-recap-stat-row"><span class="sc-recap-stat-lbl">FlÃ©chettes</span><span class="sc-recap-stat-val">' + (p.dartsThrown||0) + '</span></div>'
      + '<div class="sc-recap-stat-row"><span class="sc-recap-stat-lbl">Moyenne</span><span class="sc-recap-stat-val">' + avg + '</span></div>'
      + '<div class="sc-recap-stat-row"><span class="sc-recap-stat-lbl">Meilleure volÃ©e</span><span class="sc-recap-stat-val">' + (p.bestVisit||'â€”') + '</span></div>'
      + '<div class="sc-recap-stat-row"><span class="sc-recap-stat-lbl">Ã— 180</span><span class="sc-recap-stat-val">' + (p.count180||0) + '</span></div>'
      + '<div class="sc-recap-stat-row"><span class="sc-recap-stat-lbl">Checkout %</span><span class="sc-recap-stat-val">' + coStr + '</span></div>'
      + '</div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HALL OF FAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHallOfFame() {
  const el = document.getElementById('dash-hall-of-fame');
  if (!el || !players.length) { if(el) el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem">Pas encore de records â€” commencez Ã  jouer !</div>'; return; }
  const stats = getStats();

  // Records Ã  calculer
  const records = [];

  // #1 ELO
  const topElo = [...players].sort((a,b)=>b.elo-a.elo)[0];
  records.push({ icon:'ğŸ‘‘', label:'Meilleur ELO', name: topElo.pseudo, value: topElo.elo + ' pts', color:'var(--gold)' });

  // Most wins
  const topWins = [...players].sort((a,b)=>(stats[b.id]?.wins||0)-(stats[a.id]?.wins||0))[0];
  const wins = stats[topWins.id]?.wins||0;
  if (wins > 0) records.push({ icon:'ğŸ†', label:'Plus de Victoires', name: topWins.pseudo, value: wins + ' victoires', color:'var(--accent)' });

  // Best win rate (min 5 matchs)
  const eligible = players.filter(p => (stats[p.id]?.matches||0) >= 5);
  if (eligible.length) {
    const topRate = eligible.sort((a,b) => (stats[b.id]?.wins||0)/(stats[b.id]?.matches||1) - (stats[a.id]?.wins||0)/(stats[a.id]?.matches||1))[0];
    const rate = Math.round((stats[topRate.id]?.wins||0)/(stats[topRate.id]?.matches||1)*100);
    records.push({ icon:'ğŸ¯', label:'Meilleur % Victoires', name: topRate.pseudo, value: rate + '%', color:'var(--green)' });
  }

  // Best streak
  let bestStreakP = null, bestStreakCount = 0;
  players.forEach(p => {
    const s = getStreak(p.id);
    if (s && s.type === 'W' && s.count > bestStreakCount) { bestStreakCount = s.count; bestStreakP = p; }
  });
  if (bestStreakP) records.push({ icon:'ğŸ”¥', label:'Plus Grande SÃ©rie', name: bestStreakP.pseudo, value: bestStreakCount + ' victoires', color:'#ff6348' });

  // Peak ELO
  const topPeak = [...players].sort((a,b)=>(b.peak||b.elo)-(a.peak||a.elo))[0];
  records.push({ icon:'ğŸš€', label:'Peak ELO Historique', name: topPeak.pseudo, value: (topPeak.peak||topPeak.elo) + ' pts', color:'var(--purple)' });

  // Most 180s
  const top180 = [...players].sort((a,b)=>(b.total180s||0)-(a.total180s||0))[0];
  if ((top180.total180s||0) > 0) records.push({ icon:'ğŸ’¯', label:'Plus de 180', name: top180.pseudo, value: top180.total180s + ' Ã— 180', color:'var(--blue)' });

  // Best avg
  const topAvg = [...players].filter(p => (stats[p.id]?.avg3d||0)>0).sort((a,b)=>(stats[b.id]?.avg3d||0)-(stats[a.id]?.avg3d||0))[0];
  if (topAvg) records.push({ icon:'âš¡', label:'Meilleure Moy. 3D', name: topAvg.pseudo, value: stats[topAvg.id].avg3d, color:'var(--purple)' });

  // Most checkouts
  const topCo = [...players].sort((a,b)=>(b.totalCheckouts||0)-(a.totalCheckouts||0))[0];
  if ((topCo.totalCheckouts||0) > 0) records.push({ icon:'ğŸª', label:'Roi du Checkout', name: topCo.pseudo, value: topCo.totalCheckouts + ' checkouts', color:'var(--green)' });

  // Most matches
  const topMatchs = [...players].sort((a,b)=>(stats[b.id]?.matches||0)-(stats[a.id]?.matches||0))[0];
  if ((stats[topMatchs.id]?.matches||0) >= 5) records.push({ icon:'ğŸ³', label:'Plus Actif', name: topMatchs.pseudo, value: (stats[topMatchs.id]?.matches||0) + ' matchs', color:'var(--silver)' });

  el.innerHTML = records.map(r => `
    <div class="hof-card" style="border-top-color:${r.color}">
      <div class="hof-icon">${r.icon}</div>
      <div class="hof-label">${r.label}</div>
      <div class="hof-name">${r.name}</div>
      <div class="hof-value" style="color:${r.color}">${r.value}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD ACTIVITY CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dashActivityChart = null;
function renderDashActivityChart() {
  const canvas = document.getElementById('dash-activity-chart');
  if (!canvas) return;
  if (dashActivityChart) { dashActivityChart.destroy(); dashActivityChart = null; }

  // Build 12 months of data
  const now = new Date();
  const labels = [], data = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const month = d.toLocaleString('fr-FR', { month: 'short' });
    const year = d.getFullYear();
    labels.push(month);
    const count = matches.filter(m => {
      if (!m.date) return false;
      const parts = m.date.split('/');
      if (parts.length < 3) return false;
      const md = new Date(parseInt(parts[2]), parseInt(parts[1])-1, parseInt(parts[0]));
      return md.getMonth() === d.getMonth() && md.getFullYear() === year;
    }).length;
    data.push(count);
  }

  dashActivityChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: data.map((v,i) => i === 11 ? 'var(--accent)' : 'rgba(230,57,70,0.35)'),
        borderRadius: 5,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y} match${ctx.parsed.y>1?'s':''}` } } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#606a80', font: { size: 11 } } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#606a80', font: { size: 11 }, stepSize: 1 }, beginAtZero: true }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// H2H COMPARISON DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateH2HSelects() {
  ['h2h-p1','h2h-p2'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">-- Choisir --</option>' + players.map(p => `<option value="${p.id}" ${p.id==cur?'selected':''}>${p.pseudo}</option>`).join('');
  });
}

function renderH2HDetail() {
  const p1id = parseInt(document.getElementById('h2h-p1')?.value);
  const p2id = parseInt(document.getElementById('h2h-p2')?.value);
  const el = document.getElementById('h2h-detail-result');
  if (!el) return;
  if (!p1id || !p2id || p1id === p2id) { el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0">SÃ©lectionnez deux joueurs diffÃ©rents</div>'; return; }

  const p1 = pById(p1id), p2 = pById(p2id);
  if (!p1 || !p2) return;
  const h2h = matches.filter(m => (m.p1===p1id&&m.p2===p2id)||(m.p1===p2id&&m.p2===p1id));

  if (!h2h.length) { el.innerHTML = `<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0">Aucun match entre <strong>${p1.pseudo}</strong> et <strong>${p2.pseudo}</strong></div>`; return; }

  const stats = getStats();
  let w1=0,w2=0,d=0, sets1=0,sets2=0;
  let avg1s=[], avg2s=[];
  h2h.forEach(m => {
    const isP1first = m.p1===p1id;
    const ms1 = isP1first ? m.s1 : m.s2;
    const ms2 = isP1first ? m.s2 : m.s1;
    sets1 += ms1; sets2 += ms2;
    if (m.winner===p1id) w1++;
    else if (m.winner===p2id) w2++;
    else d++;
    if (isP1first) { if(m.avg1) avg1s.push(m.avg1); if(m.avg2) avg2s.push(m.avg2); }
    else { if(m.avg2) avg1s.push(m.avg2); if(m.avg1) avg2s.push(m.avg1); }
  });
  const total = w1+w2+d;
  const avg1 = avg1s.length ? (avg1s.reduce((a,b)=>a+b,0)/avg1s.length).toFixed(1) : null;
  const avg2 = avg2s.length ? (avg2s.reduce((a,b)=>a+b,0)/avg2s.length).toFixed(1) : null;
  const leader = w1>w2?p1:w2>w1?p2:null;

  const c1 = 'var(--accent)', c2 = 'var(--blue)';

  const barSection = (lbl, val1, val2, fmt) => {
    const tot = val1+val2; if(!tot) return '';
    const pct1 = Math.round(val1/tot*100);
    return `<div class="h2h-bar-wrap">
      <div class="h2h-bar-label">${fmt(val1)}</div>
      <div class="h2h-bar-track">
        <div class="h2h-bar-fill1" style="width:${pct1}%;background:${c1}"></div>
        <div class="h2h-bar-fill2" style="width:${100-pct1}%;background:${c2}"></div>
      </div>
      <div class="h2h-bar-label right">${fmt(val2)}</div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--muted);margin:-4px 0 8px;padding:0 70px">${lbl}</div>`;
  };

  el.innerHTML = `
    <div class="h2h-vs-row">
      <div class="h2h-player-col">
        <div class="h2h-player-name" style="color:${c1}">${p1.pseudo}</div>
        <div class="h2h-player-score" style="color:${c1}">${w1}</div>
        <div style="font-size:0.62rem;color:var(--muted)">${Math.round(w1/total*100)}% victoires</div>
      </div>
      <div class="h2h-vs-badge">VS<br><span style="font-size:0.6rem;color:var(--muted);display:block;font-weight:400">${total} matchs${d?' Â· '+d+' nul':''}</span>${leader?`<div style="font-size:0.62rem;color:var(--gold);margin-top:4px">ğŸ‘‘ ${leader.pseudo} mÃ¨ne</div>`:''}</div>
      <div class="h2h-player-col">
        <div class="h2h-player-name" style="color:${c2}">${p2.pseudo}</div>
        <div class="h2h-player-score" style="color:${c2}">${w2}</div>
        <div style="font-size:0.62rem;color:var(--muted)">${Math.round(w2/total*100)}% victoires</div>
      </div>
    </div>
    ${barSection('Victoires', w1, w2, v=>`${v} V`)}
    ${barSection('Sets gagnÃ©s', sets1, sets2, v=>`${v}`)}
    ${(avg1&&avg2)?barSection('Moy. 3D', parseFloat(avg1), parseFloat(avg2), v=>`${v}`):''}
    <div style="margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid var(--border)">
      <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:0.5rem">5 derniers matchs</div>
      <div style="display:flex;gap:0.4rem;flex-wrap:wrap">
        ${h2h.slice(0,5).map(m => {
          const p1wins = m.winner===p1id;
          const s1 = m.p1===p1id?m.s1:m.s2, s2 = m.p1===p1id?m.s2:m.s1;
          return `<div style="background:${p1wins?'rgba(230,57,70,0.12)':'rgba(74,158,255,0.12)'};border:1px solid ${p1wins?'rgba(230,57,70,0.3)':'rgba(74,158,255,0.3)'};border-radius:6px;padding:4px 10px;font-size:0.72rem;font-family:'DM Mono',monospace">
            <span style="color:${p1wins?c1:c2};font-weight:700">${s1}â€“${s2}</span>
            <span style="color:var(--muted);font-size:0.6rem;margin-left:4px">${m.date||''}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONTHLY ACTIVITY CHART (page stats)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let monthlyActivityChart = null;
function renderMonthlyActivityChart() {
  const canvas = document.getElementById('monthly-activity-chart');
  if (!canvas) return;
  if (monthlyActivityChart) { monthlyActivityChart.destroy(); monthlyActivityChart = null; }
  const now = new Date();
  const labels = [], data = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    labels.push(d.toLocaleString('fr-FR',{month:'short', year:'2-digit'}));
    const cnt = matches.filter(m => {
      if (!m.date) return false;
      const parts = m.date.split('/'); if(parts.length<3) return false;
      const md = new Date(parseInt(parts[2]),parseInt(parts[1])-1,parseInt(parts[0]));
      return md.getMonth()===d.getMonth()&&md.getFullYear()===d.getFullYear();
    }).length;
    data.push(cnt);
  }
  monthlyActivityChart = new Chart(canvas,{
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:data.map((_,i)=>i===11?'var(--accent)':'rgba(230,57,70,0.4)'),borderRadius:4,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#606a80',font:{size:10}}},y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#606a80',font:{size:10},stepSize:1},beginAtZero:true}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE SWIPE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initSwipe() {
  const pages = ['dashboard','joueurs','matchs','classement','stats'];
  let touchStartX = 0, touchStartY = 0;
  document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: true });
  document.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    if (Math.abs(dx) < 60 || Math.abs(dy) > Math.abs(dx) * 0.8) return; // not enough horizontal
    // Don't swipe if inside score counter or modal
    if (document.getElementById('sc-overlay')?.classList.contains('active')) return;
    if (document.querySelector('.modal-overlay.active')) return;
    const activePage = document.querySelector('.page.active')?.id?.replace('page-','');
    const idx = pages.indexOf(activePage);
    if (idx === -1) return;
    if (dx < -60 && idx < pages.length-1) {
      const btn = document.querySelector(`.nav-btn[onclick*="${pages[idx+1]}"]`);
      showPage(pages[idx+1], btn);
    } else if (dx > 60 && idx > 0) {
      const btn = document.querySelector(`.nav-btn[onclick*="${pages[idx-1]}"]`);
      showPage(pages[idx-1], btn);
    }
  }, { passive: true });
})();
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeeklyGoal(pid) {
  var el = document.getElementById('train-weekly-goal');
  if (!el) return;
  if (!pid) { el.innerHTML = ''; return; }
  var now = new Date();
  var weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  weekStart.setHours(0,0,0,0);
  var sessions = typeof trainingSessions !== 'undefined'
    ? trainingSessions.filter(function(s) { return s.playerId == pid && new Date(s.date) >= weekStart; })
    : [];
  var goal = 3; // sessions per week
  var done = sessions.length;
  var pct = Math.min(100, Math.round(done / goal * 100));
  var fillColor = pct >= 100 ? 'var(--green)' : pct >= 50 ? 'var(--accent)' : 'var(--blue)';
  el.innerHTML = '<div class="weekly-goal-wrap">'
    + '<div class="weekly-goal-top">'
    + '<span style="font-weight:600;font-size:0.82rem">ğŸ¯ Objectif semaine</span>'
    + '<span style="font-size:0.78rem;color:var(--muted)">' + done + ' / ' + goal + ' sessions</span>'
    + '</div>'
    + '<div class="weekly-goal-bar"><div class="weekly-goal-fill" style="width:' + pct + '%;background:' + fillColor + '"></div></div>'
    + (pct >= 100 ? '<div style="font-size:0.72rem;color:var(--green);margin-top:4px;font-weight:600">âœ“ Objectif atteint cette semaine !</div>' : '')
    + '</div>';
}

function renderExerciseProgressChart(pid) {
  var el = document.getElementById('train-progress-chart-wrap');
  if (!el) return;
  if (!pid || typeof trainingSessions === 'undefined' || typeof EXERCISES === 'undefined') { el.innerHTML=''; return; }
  var sessions = trainingSessions.filter(function(s) { return s.playerId == pid; });
  if (!sessions.length) { el.innerHTML=''; return; }
  var byEx = {};
  sessions.forEach(function(s) {
    if (!byEx[s.exerciseId]) byEx[s.exerciseId] = [];
    byEx[s.exerciseId].push(s);
  });
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.8rem">';
  Object.keys(byEx).slice(0,6).forEach(function(exId) {
    var ex = EXERCISES.find(function(e) { return e.id===exId; });
    var exS = byEx[exId].slice().sort(function(a,b){ return a.date-b.date; }).slice(-8);
    var maxScore = Math.max.apply(null, exS.map(function(s){ return s.score; })) || 1;
    var bars = exS.map(function(s) {
      var h = Math.max(4, Math.round(s.score/maxScore*50));
      return '<div class="train-prog-bar" title="Score: ' + s.score + '" style="height:' + h + 'px;flex:1"></div>';
    }).join('');
    var trend = exS.length > 1 ? exS[exS.length-1].score - exS[0].score : 0;
    html += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.8rem">'
      + '<div style="font-size:0.72rem;font-weight:700;margin-bottom:0.4rem;color:var(--text-dim)">' + (ex?ex.icon+' '+ex.title:exId) + '</div>'
      + '<div class="train-prog-chart">' + bars + '</div>'
      + '<div style="font-size:0.65rem;color:' + (trend>0?'var(--green)':trend<0?'var(--red)':'var(--muted)') + ';margin-top:3px;font-weight:600">'
      + (trend>0?'â†‘ +':trend<0?'â†“ ':' ') + (trend!==0?Math.abs(trend)+' pts sur ' + exS.length + ' sessions':'Stable')
      + '</div></div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') return;
    if (e.ctrlKey || e.metaKey) return;
    switch(e.key) {
      case '1': showPage('dashboard', null); break;
      case '2': showPage('classement', null); break;
      case '3': showPage('joueurs', null); break;
      case '4': showPage('matchs', null); break;
      case '5': showPage('tournois', null); break;
      case '6': showPage('stats', null); break;
      case '7': showPage('historique', null); break;
      case 'c': case 'C': openScoreCounter(); break;
      case '/': e.preventDefault(); var inp = document.getElementById('hist-search-input'); if(inp) { showPage('historique',null); setTimeout(function(){ inp.focus(); }, 200); } break;
      case '?': openModal('keyboard-help-modal'); break;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOIREE MVP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSoireeMVP(soireeId) {
  var soiree = soirees.find(function(s){ return s.id === soireeId; });
  if (!soiree || !soiree.attendees || !soiree.attendees.length) return null;
  var stats = getStats();
  // MVP = most wins on that day
  var soireeDate = soiree.date;
  var dayMatches = matches.filter(function(m){ return m.date === soireeDate; });
  if (!dayMatches.length) return null;
  var winsMap = {};
  dayMatches.forEach(function(m) {
    if (m.winner) winsMap[m.winner] = (winsMap[m.winner]||0) + 1;
  });
  var topId = Object.keys(winsMap).reduce(function(a,b){ return winsMap[a] > winsMap[b] ? a : b; }, null);
  if (!topId) return null;
  return { player: pById(parseInt(topId)), wins: winsMap[topId], matches: dayMatches.length };
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE NAVIGATION (mobile)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initSwipe() {
  var pages = ['dashboard','classement','joueurs','matchs','tournois','calendrier','entrainement','stats','historique'];
  var touchStartX = 0, touchStartY = 0;
  document.addEventListener('touchstart', function(e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, { passive: true });
  document.addEventListener('touchend', function(e) {
    var dx = e.changedTouches[0].clientX - touchStartX;
    var dy = e.changedTouches[0].clientY - touchStartY;
    if (Math.abs(dx) < 60 || Math.abs(dy) > Math.abs(dx)) return;
    // Don't swipe if overlay is open
    if (document.getElementById('sc-overlay').classList.contains('active')) return;
    if (document.getElementById('tv-overlay')?.classList.contains('active')) return;
    var activePage = document.querySelector('.page.active');
    if (!activePage) return;
    var currentId = activePage.id.replace('page-','');
    var idx = pages.indexOf(currentId);
    if (idx === -1) return;
    if (dx < 0 && idx < pages.length - 1) showPage(pages[idx+1], null);
    else if (dx > 0 && idx > 0) showPage(pages[idx-1], null);
  }, { passive: true });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Data integrity: ensure required fields on all players
players.forEach(p => {
  if (!p.elo) p.elo = 1000;
  if (!p.achievements) p.achievements = [];
  if (!p.eloHistory) p.eloHistory = [p.elo];
});
// Data integrity: remove matches with missing players
const validPids = new Set(players.map(p => p.id));
const invalidMatches = matches.filter(m => !validPids.has(m.p1) || !validPids.has(m.p2));
if (invalidMatches.length > 0) {
  matches = matches.filter(m => validPids.has(m.p1) && validPids.has(m.p2));
  console.warn(`[Darts] ${invalidMatches.length} match(es) ignorÃ©(s) car joueur introuvable.`);
}
updateSeasonBadge();
applyClubSettings();
renderAll();
checkSharedClassement();
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
// â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
// â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
// â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _currentUser = null; // { id, pseudo, name }
let _isGuest = false;
let _loginSelectedId = null; // joueur sÃ©lectionnÃ© Ã  l'Ã©tape 1

// â”€â”€ Hachage simple (sha-256 via SubtleCrypto, fallback djb2 sur file://) â”€â”€
async function _hashPwd(pwd) {
  const salted = pwd + '_darts_salt';
  // crypto.subtle nÃ©cessite HTTPS ou localhost â€” fallback sur file://
  if (window.isSecureContext && crypto && crypto.subtle) {
    try {
      const enc = new TextEncoder().encode(salted);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    } catch(e) { /* fallback */ }
  }
  // Fallback : hachage djb2 (suffisant pour usage local)
  let h = 5381;
  for (let i = 0; i < salted.length; i++) h = ((h << 5) + h) ^ salted.charCodeAt(i);
  return 'local_' + (h >>> 0).toString(16).padStart(8,'0');
}

function openLoginModal() {
  renderLoginPlayers();
  _showLoginStep(1);
  document.getElementById('login-overlay').style.display = 'flex';
}

function _showLoginStep(n) {
  document.getElementById('login-step-1').classList.toggle('active', n === 1);
  document.getElementById('login-step-2').classList.toggle('active', n === 2);
}

function renderLoginPlayers() {
  const grid = document.getElementById('login-players-grid');
  if (!players.length) {
    grid.innerHTML = `<div class="login-empty" style="grid-column:1/-1">
      Aucun joueur encore.<br><span style="font-size:0.72rem;color:var(--gray)">Entrez en tant que visiteur pour ajouter des joueurs.</span>
    </div>`;
    // Mettre le bouton visiteur en Ã©vidence quand la liste est vide
    const guestBtn = document.querySelector('#login-step-1 button[onclick*="loginAsGuest"]');
    if (guestBtn) {
      guestBtn.style.color = 'var(--primary)';
      guestBtn.style.fontWeight = '700';
      guestBtn.style.fontSize = '0.82rem';
    }
    return;
  }
  grid.innerHTML = players.map(p => {
    const initials = (p.emoji || (p.pseudo || p.name || '?').slice(0, 2).toUpperCase());
    const colors = ['#e63946','#457bf7','#2dc653','#f5c518','#a67cf7','#ff6b74','#34d47b'];
    const col = colors[p.id % colors.length] || '#e63946';
    const hasPwd = !!p.pwdHash;
    return `<div class="login-player-btn" data-id="${p.id}" onclick="selectLoginPlayer(this)">
      <div class="login-player-avatar" style="background:${col}">${initials}</div>
      <div class="login-player-name">${p.pseudo}</div>
      ${hasPwd ? '<div style="font-size:0.55rem;color:var(--green);margin-top:2px"><i class="fas fa-lock"></i></div>' : '<div style="font-size:0.55rem;color:var(--gray);margin-top:2px"><i class="fas fa-lock-open"></i></div>'}
    </div>`;
  }).join('');
}

function selectLoginPlayer(el) {
  document.querySelectorAll('.login-player-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  _loginSelectedId = parseInt(el.dataset.id);
  document.getElementById('login-confirm-btn').disabled = false;
}

function goToPasswordStep() {
  const p = players.find(x => x.id === _loginSelectedId);
  if (!p) return;
  // Remplir les infos Ã©tape 2
  const colors = ['#e63946','#457bf7','#2dc653','#f5c518','#a67cf7','#ff6b74','#34d47b'];
  const col = colors[p.id % colors.length] || '#e63946';
  const initials = (p.emoji || (p.pseudo || '?').slice(0,2).toUpperCase());
  document.getElementById('login-selected-avatar').textContent = initials;
  document.getElementById('login-selected-avatar').style.background = col;
  document.getElementById('login-selected-name').textContent = p.pseudo;
  document.getElementById('login-pwd-input').value = '';
  document.getElementById('login-pwd-error').style.display = 'none';
  // Si pas de mot de passe dÃ©fini â€” afficher le lien direct
  const hint = document.getElementById('login-no-pwd-hint');
  hint.style.display = p.pwdHash ? 'none' : 'block';
  _showLoginStep(2);
  setTimeout(() => document.getElementById('login-pwd-input').focus(), 100);
}

function backToPlayerSelect() {
  _showLoginStep(1);
  document.getElementById('login-pwd-error').style.display = 'none';
}

function togglePwdVisibility() {
  const inp = document.getElementById('login-pwd-input');
  const icon = document.getElementById('pwd-eye-icon');
  if (inp.type === 'password') {
    inp.type = 'text'; icon.className = 'fas fa-eye-slash';
  } else {
    inp.type = 'password'; icon.className = 'fas fa-eye';
  }
}

async function confirmLogin() {
  const p = players.find(x => x.id === _loginSelectedId);
  if (!p) return;
  const pwd = document.getElementById('login-pwd-input').value;
  if (!p.pwdHash) {
    // Pas de mot de passe â†’ connexion directe
    _doLogin(p);
    return;
  }
  if (!pwd) {
    document.getElementById('login-pwd-error').style.display = 'block';
    document.getElementById('login-pwd-error').innerHTML = '<i class="fas fa-times-circle"></i> Entrez votre mot de passe';
    return;
  }
  try {
    const hash = await _hashPwd(pwd);
    // Comparer les deux hash (mÃªme format, ou local fallback)
    const isMatch = hash === p.pwdHash ||
      // Si le mdp a Ã©tÃ© dÃ©fini en HTTPS mais qu'on est en file://, tenter un fallback
      (hash.startsWith('local_') && p.pwdHash.length === 64 && !window.isSecureContext);
    if (!isMatch) {
      document.getElementById('login-pwd-error').style.display = 'block';
      document.getElementById('login-pwd-error').innerHTML = '<i class="fas fa-times-circle"></i> Mot de passe incorrect';
      document.getElementById('login-pwd-input').value = '';
      document.getElementById('login-pwd-input').focus();
      return;
    }
    _doLogin(p);
  } catch(e) {
    console.error('[Login] Erreur hash:', e);
    // En cas d'erreur crypto, connexion sans vÃ©rification (mode dÃ©gradÃ©)
    _doLogin(p);
  }
}

function confirmLoginNoPwd() {
  const p = players.find(x => x.id === _loginSelectedId);
  if (p) _doLogin(p);
}

function _doLogin(p) {
  try {
    _currentUser = { id: p.id, pseudo: p.pseudo, name: p.name };
    _isGuest = false;
    try { localStorage.setItem('darts_current_user', JSON.stringify(_currentUser)); } catch(e) {}
    document.getElementById('login-overlay').style.display = 'none';
    try { _updateUserBadge(); } catch(e) {}
    try { showNotif(`ğŸ‘‹ Bienvenue ${p.pseudo} !`, 'success'); } catch(e) {}
    // Proposer de crÃ©er un mot de passe si pas encore dÃ©fini
    if (!p.pwdHash) {
      setTimeout(() => {
        try {
          if (confirm(`ğŸ‘‹ ${p.pseudo}, vous n'avez pas encore de mot de passe.\n\nVoulez-vous en crÃ©er un maintenant ?`)) {
            promptSetOwnPassword();
          }
        } catch(e) {}
      }, 800);
    }
  } catch(e) {
    console.error('[_doLogin] Erreur:', e);
    document.getElementById('login-overlay').style.display = 'none';
  }
}

function loginAsGuest() {
  try {
    _currentUser = null;
    _isGuest = true;
    try { localStorage.setItem('darts_current_user', 'guest'); } catch(e) {}
    document.getElementById('login-overlay').style.display = 'none';
    try { _updateUserBadge(); } catch(e) {}
    try { showNotif('ğŸ‘ Mode visiteur â€” lecture seule', 'info'); } catch(e) {}
  } catch(e) {
    // Failsafe absolu
    document.getElementById('login-overlay').style.display = 'none';
  }
}

function logoutUser() {
  _currentUser = null;
  _isGuest = false;
  try { localStorage.removeItem('darts_current_user'); } catch(e) {}
  try { _updateUserBadge(); } catch(e) {}
  // Reafficher le login
  try { renderLoginPlayers(); } catch(e) {}
  try { _showLoginStep(1); } catch(e) {}
  document.getElementById('login-overlay').style.display = 'flex';
}

function _updateUserBadge() {
  const badge = document.getElementById('current-user-badge');
  const nameEl = document.getElementById('current-user-name');
  const logoutBtn = document.getElementById('logout-btn');
  if (_currentUser) {
    badge.style.display = 'flex';
    badge.style.background = '';
    badge.style.borderColor = '';
    nameEl.textContent = _currentUser.pseudo;
    const dot = badge.querySelector('.current-user-dot');
    if (dot) { dot.style.background = ''; dot.style.boxShadow = ''; }
    if (logoutBtn) logoutBtn.style.display = 'flex';
  } else if (_isGuest) {
    badge.style.display = 'flex';
    nameEl.textContent = 'Visiteur';
    badge.style.background = 'rgba(96,106,128,0.15)';
    badge.style.borderColor = 'var(--border)';
    const dot = badge.querySelector('.current-user-dot');
    if (dot) { dot.style.background = 'var(--gray)'; dot.style.boxShadow = 'none'; }
    if (logoutBtn) logoutBtn.style.display = 'flex';
  } else {
    badge.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'none';
  }
}

function initLogin() {
  try {
    const stored = localStorage.getItem('darts_current_user');
    if (!stored) {
      // Pas d'utilisateur stockÃ© â†’ afficher le login
      renderLoginPlayers();
      _showLoginStep(1);
      document.getElementById('login-overlay').style.display = 'flex';
    } else if (stored === 'guest') {
      _isGuest = true;
      document.getElementById('login-overlay').style.display = 'none';
      try { _updateUserBadge(); } catch(e) {}
    } else {
      try {
        const u = JSON.parse(stored);
        const p = players.find(x => x.id === u.id);
        if (p) {
          _currentUser = { id: p.id, pseudo: p.pseudo, name: p.name };
          document.getElementById('login-overlay').style.display = 'none';
          try { _updateUserBadge(); } catch(e) {}
        } else {
          localStorage.removeItem('darts_current_user');
          renderLoginPlayers();
          _showLoginStep(1);
          document.getElementById('login-overlay').style.display = 'flex';
        }
      } catch(e) {
        localStorage.removeItem('darts_current_user');
        renderLoginPlayers();
        _showLoginStep(1);
        document.getElementById('login-overlay').style.display = 'flex';
      }
    }
  } catch(e) {
    console.error('[initLogin] Erreur:', e);
    // Failsafe: afficher quand mÃªme le login
    try {
      renderLoginPlayers();
      document.getElementById('login-overlay').style.display = 'flex';
    } catch(e2) {}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION MOTS DE PASSE â€” joueur change le sien
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function promptSetOwnPassword() {
  if (!_currentUser) { showNotif('âš  Connectez-vous d\'abord.', 'error'); return; }
  const pwd1 = prompt(`ğŸ” DÃ©finir un mot de passe pour ${_currentUser.pseudo}\n\nNouvel mot de passe :`);
  if (!pwd1) return;
  if (pwd1.length < 3) { alert('Le mot de passe doit faire au moins 3 caractÃ¨res.'); return; }
  const pwd2 = prompt('Confirmez le mot de passe :');
  if (pwd1 !== pwd2) { alert('âŒ Les mots de passe ne correspondent pas.'); return; }
  _hashPwd(pwd1).then(hash => {
    const p = players.find(x => x.id === _currentUser.id);
    if (!p) return;
    p.pwdHash = hash;
    save();
    showNotif('ğŸ” Mot de passe dÃ©fini !', 'success');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION MOTS DE PASSE â€” admin (dans ParamÃ¨tres)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPasswordManagement() {
  const container = document.getElementById('pwd-mgmt-container');
  if (!container) return;
  if (!players.length) {
    container.innerHTML = '<div style="color:var(--text-dim);font-size:0.82rem">Aucun joueur</div>';
    return;
  }
  container.innerHTML = `<div class="pwd-mgmt-grid">
    ${players.map(p => {
      const hasPwd = !!p.pwdHash;
      return `<div class="pwd-player-card">
        <div style="width:36px;height:36px;border-radius:8px;background:var(--primary);color:#fff;font-size:0.75rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          ${(p.pseudo||'?').slice(0,2).toUpperCase()}
        </div>
        <div class="pwd-player-info">
          <div class="pwd-player-pseudo">${p.pseudo}</div>
          <div class="pwd-player-status ${hasPwd?'set':''}">${hasPwd ? 'ğŸ”’ Mot de passe dÃ©fini' : 'ğŸ”“ Aucun mot de passe'}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.3rem">
          <button class="pwd-action-btn" onclick="adminSetPassword(${p.id})" title="DÃ©finir un nouveau mot de passe">
            ${hasPwd ? 'ğŸ”„' : 'ğŸ”'} ${hasPwd ? 'RÃ©initialiser' : 'DÃ©finir'}
          </button>
          ${hasPwd ? `<button class="pwd-action-btn danger" onclick="adminRemovePassword(${p.id})" title="Supprimer le mot de passe">ğŸ—‘ Supprimer</button>` : ''}
        </div>
      </div>`;
    }).join('')}
  </div>`;
}

async function adminSetPassword(playerId) {
  const p = players.find(x => x.id === playerId);
  if (!p) return;
  const pwd = prompt(`ğŸ” DÃ©finir le mot de passe pour ${p.pseudo} :\n\n(Minimum 3 caractÃ¨res)`);
  if (!pwd) return;
  if (pwd.length < 3) { alert('Minimum 3 caractÃ¨res.'); return; }
  const hash = await _hashPwd(pwd);
  p.pwdHash = hash;
  save();
  showNotif(`ğŸ” Mot de passe dÃ©fini pour ${p.pseudo}`, 'success');
  renderPasswordManagement();
}

function adminRemovePassword(playerId) {
  const p = players.find(x => x.id === playerId);
  if (!p) return;
  if (!confirm(`Supprimer le mot de passe de ${p.pseudo} ?`)) return;
  delete p.pwdHash;
  save();
  showNotif(`ğŸ”“ Mot de passe supprimÃ© pour ${p.pseudo}`, 'info');
  renderPasswordManagement();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
// â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
// â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
// â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
// â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _chatOpen = false;
let _chatUnread = 0;
let _chatLastCount = 0;
let _chatUnsubscribe = null;

function toggleChat() {
  _chatOpen = !_chatOpen;
  const panel = document.getElementById('chat-panel');
  if (_chatOpen) {
    panel.classList.add('open');
    _chatUnread = 0;
    _updateChatBadge();
    setTimeout(() => {
      const msgs = document.getElementById('chat-messages');
      msgs.scrollTop = msgs.scrollHeight;
      document.getElementById('chat-input').focus();
    }, 100);
  } else {
    panel.classList.remove('open');
  }
}

function _updateChatBadge() {
  const dot = document.getElementById('chat-notif-dot');
  if (_chatUnread > 0 && !_chatOpen) {
    dot.style.display = 'flex';
    dot.textContent = _chatUnread > 9 ? '9+' : _chatUnread;
  } else {
    dot.style.display = 'none';
  }
}

function sendChatMessage() {
  if (!FIREBASE_ENABLED || !_db) {
    showNotif('âš  Firebase requis pour le chat.', 'error'); return;
  }
  if (!_currentUser) {
    showNotif('âš  Connectez-vous pour envoyer un message.', 'error'); return;
  }
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  _db.collection('clubs').doc(FB_CLUB_ID).collection('chat').add({
    text,
    userId: _currentUser.id,
    pseudo: _currentUser.pseudo,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(e => {
    showNotif('âš  Erreur envoi message', 'error');
    input.value = text;
  });
}

function initChat() {
  if (!FIREBASE_ENABLED || !_db) return;
  _chatUnsubscribe = _db.collection('clubs').doc(FB_CLUB_ID).collection('chat')
    .orderBy('ts', 'asc').limitToLast(60)
    .onSnapshot(snapshot => {
      const msgs = document.getElementById('chat-messages');
      const allMsgs = [];
      snapshot.forEach(doc => allMsgs.push({ id: doc.id, ...doc.data() }));
      if (!allMsgs.length) {
        msgs.innerHTML = `<div class="chat-empty">Soyez le premier Ã  Ã©crire ğŸ’¬</div>`;
        return;
      }
      msgs.innerHTML = allMsgs.map(m => {
        const isMine = _currentUser && m.userId === _currentUser.id;
        const initials = (m.pseudo || '?').slice(0,2).toUpperCase();
        const time = m.ts?.toDate ? m.ts.toDate().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : '';
        return `<div class="chat-msg ${isMine ? 'mine' : ''}">
          <div class="chat-avatar">${initials}</div>
          <div>
            ${!isMine ? `<div class="chat-name">${m.pseudo}</div>` : ''}
            <div class="chat-bubble">${m.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
            <div class="chat-time">${time}</div>
          </div>
        </div>`;
      }).join('');
      // Scroll en bas
      msgs.scrollTop = msgs.scrollHeight;
      // Compteur non-lu
      const newCount = allMsgs.length;
      if (_chatLastCount > 0 && newCount > _chatLastCount && !_chatOpen) {
        const lastMsg = allMsgs[allMsgs.length - 1];
        if (!_currentUser || lastMsg.userId !== _currentUser.id) {
          _chatUnread++;
          _updateChatBadge();
          showNotif(`ğŸ’¬ ${lastMsg.pseudo}: ${lastMsg.text.slice(0, 40)}`, 'info');
        }
      }
      _chatLastCount = newCount;
    }, err => console.error('[Chat]', err));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS MATCH EN TEMPS RÃ‰EL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastMatchCount = 0;

function _checkNewMatches(data) {
  if (!data || !Array.isArray(data.matches)) return;
  const newCount = data.matches.length;
  if (_lastMatchCount > 0 && newCount > _lastMatchCount) {
    const latest = data.matches[0]; // matches[0] = le plus rÃ©cent
    const p1 = data.players?.find(p => p.id === latest?.p1);
    const p2 = data.players?.find(p => p.id === latest?.p2);
    const winner = latest?.winner === latest?.p1 ? p1 : p2;
    if (p1 && p2) {
      const msg = `ğŸ¯ Nouveau match : ${p1.pseudo} ${latest.s1}-${latest.s2} ${p2.pseudo}`;
      showNotif(msg, 'success');
      // Notification navigateur si permission accordÃ©e
      if (Notification.permission === 'granted') {
        new Notification('FlÃ©chettes Club', {
          body: msg.replace('ğŸ¯ ', ''),
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¯</text></svg>'
        });
      }
    }
  }
  _lastMatchCount = newCount;
}

function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') showNotif('ğŸ”” Notifications activÃ©es !', 'success');
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAPPELS SOIRÃ‰E
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _reminders = JSON.parse(localStorage.getItem('darts_reminders') || '{}');
let _reminderTimeouts = {};

function isReminderSet(soireeId) {
  return !!_reminders[soireeId];
}

function toggleReminder(soireeId) {
  if (_reminders[soireeId]) {
    // DÃ©sactiver
    delete _reminders[soireeId];
    clearTimeout(_reminderTimeouts[soireeId]);
    delete _reminderTimeouts[soireeId];
    localStorage.setItem('darts_reminders', JSON.stringify(_reminders));
    showNotif('ğŸ”• Rappel supprimÃ©', 'info');
  } else {
    // Activer â€” demander permission notif
    requestNotifPermission();
    const soiree = soirees.find(s => s.id === soireeId);
    if (!soiree) return;
    _reminders[soireeId] = true;
    localStorage.setItem('darts_reminders', JSON.stringify(_reminders));
    _scheduleReminder(soiree);
    showNotif(`ğŸ”” Rappel activÃ© pour "${soiree.title}"`, 'success');
  }
  // Refresh bouton
  const btn = document.getElementById(`reminder-btn-${soireeId}`);
  if (btn) {
    btn.className = `reminder-btn ${_reminders[soireeId]?'set':''}`;
    btn.innerHTML = `<i class="fas fa-bell"></i> ${_reminders[soireeId]?'Rappel activÃ©':'Rappel'}`;
  }
}

function _scheduleReminder(soiree) {
  if (!soiree.date) return;
  const soireeDate = new Date(soiree.date);
  if (soiree.time) {
    const [h, m] = soiree.time.split(':');
    soireeDate.setHours(parseInt(h)||20, parseInt(m)||0, 0, 0);
  } else {
    soireeDate.setHours(20, 0, 0, 0);
  }
  // Rappel 1h avant
  const reminderTime = new Date(soireeDate.getTime() - 60 * 60 * 1000);
  const msUntil = reminderTime.getTime() - Date.now();
  if (msUntil > 0 && msUntil < 7 * 24 * 60 * 60 * 1000) {
    _reminderTimeouts[soiree.id] = setTimeout(() => {
      if (Notification.permission === 'granted') {
        new Notification('ğŸ¯ SoirÃ©e dans 1h !', {
          body: `"${soiree.title}" commence dans 1 heure. PrÃ©parez vos flÃ©chettes !`,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¯</text></svg>'
        });
      }
      showNotif(`â° Rappel : "${soiree.title}" dans 1 heure !`, 'win');
      delete _reminders[soiree.id];
      localStorage.setItem('darts_reminders', JSON.stringify(_reminders));
    }, msUntil);
  }
}

function initReminders() {
  // Reprogrammer tous les rappels actifs
  Object.keys(_reminders).forEach(id => {
    const soiree = soirees.find(s => s.id === parseInt(id));
    if (soiree) _scheduleReminder(soiree);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA â€” INSTALLATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pwaPrompt = null;

// GÃ©nÃ©rer et injecter le manifest dynamiquement
(function injectPWAManifest() {
  const manifest = {
    name: 'FlÃ©chettes Club Pro',
    short_name: 'FlÃ©chettes',
    description: 'Application de gestion de club de flÃ©chettes',
    start_url: './',
    display: 'standalone',
    background_color: '#0d0f14',
    theme_color: '#e63946',
    orientation: 'any',
    icons: [
      { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%23e63946"/><text y=".9em" font-size="75" x="12">ğŸ¯</text></svg>', sizes: '192x192', type: 'image/svg+xml' },
      { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%23e63946"/><text y=".9em" font-size="75" x="12">ğŸ¯</text></svg>', sizes: '512x512', type: 'image/svg+xml' }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const url = URL.createObjectURL(blob);
  const link = document.getElementById('pwa-manifest-link');
  if (link) link.href = url;
})();

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaPrompt = e;
  if (!localStorage.getItem('pwa_dismissed')) {
    document.getElementById('pwa-install-banner').classList.add('show');
  }
});

function installPWA() {
  if (!_pwaPrompt) return;
  _pwaPrompt.prompt();
  _pwaPrompt.userChoice.then(r => {
    if (r.outcome === 'accepted') showNotif('ğŸ“² Application installÃ©e !', 'success');
    _pwaPrompt = null;
    document.getElementById('pwa-install-banner').classList.remove('show');
  });
}

function dismissPWA() {
  localStorage.setItem('pwa_dismissed', '1');
  document.getElementById('pwa-install-banner').classList.remove('show');
}

window.addEventListener('appinstalled', () => {
  showNotif('ğŸ“² Application installÃ©e avec succÃ¨s !', 'success');
  document.getElementById('pwa-install-banner').classList.remove('show');
});

// _checkNewMatches intÃ©grÃ© dans onSnapshot

// â”€â”€ Initialisation de toutes les nouvelles fonctionnalitÃ©s â”€â”€
(function initNewFeatures() {
  // Firebase â€” toujours activÃ© si la config est remplie
  initFirebase();
  // initLogin est maintenant dÃ©clenchÃ© par le 1er snapshot Firebase (voir initFirebase)
  // Filet de sÃ©curitÃ© : si Firebase tarde trop (rÃ©seau lent), on lance quand mÃªme initLogin
  // avec les donnÃ©es locales aprÃ¨s 3 secondes max
  setTimeout(() => {
    if (!_loginInitDone) {
      _loginInitDone = true;
      console.warn('[initLogin] Fallback timeout â€” Firebase trop lent, utilisation des donnÃ©es locales.');
      try { initLogin(); } catch(e) {}
    }
  }, 3000);
  // Chat â€” aprÃ¨s Firebase
  setTimeout(initChat, 1500);
  // Rappels
  initReminders();
  // Compteur initial de matchs
  _lastMatchCount = matches.length;
})();


// Set default date for calendrier
const today = new Date();
const dateInput = document.getElementById('soiree-cal-date');
if (dateInput) dateInput.valueAsDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
// TV logo text init
const tvlt = document.getElementById('tv-logo-text');
// (handled by applyClubSettings on TV open)


// Scroll to top button
(function() {
  const btn = document.getElementById('scroll-top-btn');
  if (btn) {
    window.addEventListener('scroll', function() {
      btn.style.display = window.scrollY > 400 ? 'flex' : 'none';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
    });
  }
})();

initKeyboardShortcuts();

// Keyboard shortcut: Escape to close TV mode or any open modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('tv-overlay')?.classList.contains('active')) { closeTvMode(); return; }
    if (document.getElementById('sc-overlay').classList.contains('active')) { closeScoreCounter(); return; }
    // Close any open modal overlay
    const openModal = document.querySelector('.modal-overlay.active');
    if (openModal) { openModal.classList.remove('active'); return; }
    // Close mobile more menu
    closeMobileMore();
  }
  // F key = open TV mode
  if (e.key === 'F' && !e.ctrlKey && !e.metaKey && !e.shiftKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT') {
    const tv = document.getElementById('tv-overlay');
    if (tv.classList.contains('active')) closeTvMode(); else openTvMode();
  }
});

// H2H font fix  
document.querySelectorAll('.h2h-vs').forEach(el => { el.style.fontFamily = "'Bebas Neue', sans-serif"; });

// Fix Libre Baskerville references to use Bebas Neue
document.querySelectorAll('[style*="Libre Baskerville"]').forEach(el => {
  el.style.fontFamily = "'Bebas Neue', sans-serif";
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ NOUVELLES FONCTIONNALITÃ‰S v3.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ 1. PRÃ‰DICTION DE MATCH (ELO Win Probability) â”€â”€â”€â”€â”€â”€
function getEloPrediction(elo1, elo2) {
  const prob1 = 1 / (1 + Math.pow(10, (elo2 - elo1) / 400));
  return Math.round(prob1 * 100);
}

function renderH2HPrediction() {
  const id1 = parseInt(document.getElementById('h2h-p1').value);
  const id2 = parseInt(document.getElementById('h2h-p2').value);
  const box = document.getElementById('h2h-prediction');
  if (!box) return;
  if (!id1 || !id2 || id1 === id2) { box.innerHTML = ''; return; }
  const p1 = pById(id1), p2 = pById(id2);
  if (!p1 || !p2) return;
  recomputeElo();
  const prob1 = getEloPrediction(p1.elo, p2.elo);
  const prob2 = 100 - prob1;
  const fav = prob1 > prob2 ? p1 : p2;
  const favProb = Math.max(prob1, prob2);
  const eloDiff = Math.abs(p1.elo - p2.elo);
  const confidence = eloDiff > 200 ? 'Forte' : eloDiff > 100 ? 'ModÃ©rÃ©e' : 'Faible';
  const confColor = eloDiff > 200 ? 'var(--green)' : eloDiff > 100 ? 'var(--gold)' : 'var(--muted)';
  box.innerHTML = `
    <div style="background:linear-gradient(135deg,rgba(230,57,70,0.06),rgba(230,57,70,0.02));border:1px solid rgba(230,57,70,0.2);border-radius:12px;padding:1rem 1.2rem">
      <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:0.8rem">ğŸ“Š PrÃ©diction ELO</div>
      <div style="display:flex;align-items:center;gap:0.8rem;margin-bottom:0.7rem">
        <div style="flex:1;text-align:right">
          <div style="font-weight:800;font-size:0.9rem">${p1.pseudo}</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--accent)">${prob1}%</div>
        </div>
        <div style="flex:2">
          <div style="height:12px;background:var(--dark-card);border-radius:6px;overflow:hidden;border:1px solid var(--border)">
            <div style="width:${prob1}%;height:100%;background:linear-gradient(90deg,var(--accent),#ff6b74);border-radius:6px;transition:width 0.5s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--muted);margin-top:3px">
            <span>${p1.elo} ELO</span>
            <span>${p2.elo} ELO</span>
          </div>
        </div>
        <div style="flex:1;text-align:left">
          <div style="font-weight:800;font-size:0.9rem">${p2.pseudo}</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--silver)">${prob2}%</div>
        </div>
      </div>
      <div style="display:flex;gap:0.5rem;font-size:0.7rem;color:var(--muted)">
        <span>ğŸ† Favori : <strong style="color:var(--gold)">${fav.pseudo} (${favProb}%)</strong></span>
        <span style="margin:0 4px;color:var(--border)">Â·</span>
        <span>Confiance : <strong style="color:${confColor}">${confidence}</strong> (Î” ${eloDiff} ELO)</span>
      </div>
    </div>`;
}

// â”€â”€ 2. FILTRES DE PÃ‰RIODE POUR GRAPHE ELO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _eloPeriod = 'all';

function setEloPeriod(period, btn) {
  _eloPeriod = period;
  document.querySelectorAll('.elo-period-btn').forEach(b => {
    b.style.background = 'var(--dark-card)';
    b.style.color = 'var(--muted)';
  });
  if (btn) { btn.style.background = 'var(--accent)'; btn.style.color = '#fff'; }
  renderEloChart();
}

// Override renderEloChart to support period filter
const _origRenderEloChart = renderEloChart;
renderEloChart = function() {
  const ctx = document.getElementById('elo-chart');
  if (!ctx) return;
  if (eloChart) { eloChart.destroy(); eloChart = null; }
  if (!players.length) return;

  let maxPoints = 999999;
  if (_eloPeriod === '10') maxPoints = 10;
  else if (_eloPeriod === '20') maxPoints = 20;
  else if (_eloPeriod === 'season') {
    const activeSeason = seasons.find(s => s.active);
    if (activeSeason && activeSeason.start) {
      const seasonMatchCount = matches.filter(m => m.date >= activeSeason.start).length;
      maxPoints = seasonMatchCount + 1;
    }
  }

  const datasets = players.map((p, i) => {
    const history = maxPoints < p.eloHistory.length
      ? p.eloHistory.slice(-maxPoints)
      : p.eloHistory;
    return {
      label: p.pseudo,
      data: history,
      borderColor: pColor(i),
      backgroundColor: pColor(i) + '22',
      borderWidth: 2.5,
      pointRadius: history.length < 20 ? 4 : 2,
      pointHoverRadius: 7,
      tension: 0.35,
      fill: false,
    };
  });
  const maxLen = Math.max(...datasets.map(d => d.data.length));
  eloChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({ length: maxLen }, (_, i) => i === 0 ? 'DÃ©part' : `M${i}`),
      datasets
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(10,12,18,0.95)',
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1,
          titleColor: '#f0f4fc',
          bodyColor: '#a0aabb',
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${ctx.raw} ELO`
          }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#606a80', maxTicksLimit: 8 } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#606a80' } }
      }
    }
  });
  // Render legend
  const legend = document.getElementById('elo-chart-legend');
  if (legend) {
    legend.innerHTML = players.map((p, i) =>
      `<div style="display:flex;align-items:center;gap:4px;font-size:0.65rem;cursor:pointer" onclick="toggleEloDataset(${i})">
        <div style="width:12px;height:3px;background:${pColor(i)};border-radius:2px"></div>
        <span style="color:var(--muted)">${p.pseudo}</span>
      </div>`).join('');
  }
};

function toggleEloDataset(i) {
  if (!eloChart) return;
  const meta = eloChart.getDatasetMeta(i);
  meta.hidden = !meta.hidden;
  eloChart.update();
}

// â”€â”€ 3. HIGHLIGHTS / COMMENTAIRES SUR MATCHS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MATCH_HIGHLIGHTS = [
  { id: 'match_siecle', icon: 'ğŸŒŸ', label: 'Match du siÃ¨cle' },
  { id: 'comeback', icon: 'ğŸ”„', label: 'Comeback' },
  { id: 'h180', icon: 'ğŸ’¯', label: '180 lÃ©gendaire' },
  { id: 'upset', icon: 'âš¡', label: 'Upset' },
  { id: 'thriller', icon: 'ğŸ”¥', label: 'Thriller' },
  { id: 'perfect', icon: 'ğŸ‘‘', label: 'Game parfait' },
];

function openMatchHighlightModal(matchId) {
  const m = matches.find(x => x.id == matchId);
  if (!m) return;
  const existing = m.tags || [];
  const comment = m.comment || '';
  const tagsHtml = MATCH_HIGHLIGHTS.map(h =>
    `<div class="hl-tag ${existing.includes(h.id)?'hl-tag-active':''}" 
         onclick="this.classList.toggle('hl-tag-active')" 
         data-id="${h.id}"
         style="cursor:pointer;padding:0.4rem 0.8rem;border-radius:20px;border:1px solid ${existing.includes(h.id)?'var(--accent)':'var(--border)'};background:${existing.includes(h.id)?'var(--accent-dim)':'var(--dark-card)'};font-size:0.72rem;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:4px">
         ${h.icon} ${h.label}
    </div>`).join('');
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.id = 'highlight-modal-temp';
  modal.innerHTML = `<div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">â­ Highlights du match</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.2rem">
      <div style="font-size:0.75rem;font-weight:700;color:var(--muted);margin-bottom:0.7rem;letter-spacing:1px;text-transform:uppercase">Ã‰tiquettes</div>
      <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1.2rem" id="hl-tags-wrap">${tagsHtml}</div>
      <div style="font-size:0.75rem;font-weight:700;color:var(--muted);margin-bottom:0.4rem;letter-spacing:1px;text-transform:uppercase">Commentaire</div>
      <textarea id="hl-comment" placeholder="DÃ©cris ce match mÃ©morable..." style="width:100%;height:80px;resize:vertical">${comment}</textarea>
    </div>
    <div style="display:flex;gap:0.6rem;justify-content:flex-end;padding:1rem 1.2rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Annuler</button>
      <button class="btn btn-primary" onclick="saveMatchHighlight(${matchId})">âœ“ Enregistrer</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

function saveMatchHighlight(matchId) {
  const m = matches.find(x => x.id == matchId);
  if (!m) return;
  const tags = [...document.querySelectorAll('.hl-tag-active')].map(el => el.dataset.id);
  const comment = document.getElementById('hl-comment').value.trim();
  m.tags = tags;
  m.comment = comment;
  save();
  renderMatches();
  renderHistorique();
  document.getElementById('highlight-modal-temp')?.remove();
  showNotif('âœ“ Highlights enregistrÃ©s !', 'success');
}

// â”€â”€ 4. OBJECTIFS PERSONNELS JOUEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPlayerGoalsModal(pid) {
  const p = pById(pid);
  if (!p) return;
  p.goals = p.goals || { targetElo: '', targetWinPct: '', targetMatches: '', customGoal: '' };
  const g = p.goals;
  const recomputeElo2 = () => recomputeElo();
  recomputeElo2();
  const stats = getStats();
  const ps = stats[pid] || { wins:0, matches:0 };
  const currentPct = ps.matches ? Math.round(ps.wins/ps.matches*100) : 0;
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.id = 'goals-modal-temp';
  modal.innerHTML = `<div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">ğŸ¯ Objectifs â€” ${p.pseudo}</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.2rem">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div class="form-field">
          <div class="form-label">ELO cible</div>
          <input type="number" id="goal-elo" value="${g.targetElo||''}" placeholder="${p.elo + 100}" min="${p.elo}">
          <div style="font-size:0.62rem;color:var(--muted);margin-top:2px">Actuel : ${p.elo}</div>
        </div>
        <div class="form-field">
          <div class="form-label">% Victoires cible</div>
          <input type="number" id="goal-pct" value="${g.targetWinPct||''}" placeholder="60" min="0" max="100">
          <div style="font-size:0.62rem;color:var(--muted);margin-top:2px">Actuel : ${currentPct}%</div>
        </div>
        <div class="form-field">
          <div class="form-label">Matchs cumulÃ©s</div>
          <input type="number" id="goal-matches" value="${g.targetMatches||''}" placeholder="${ps.matches+20}" min="${ps.matches}">
          <div style="font-size:0.62rem;color:var(--muted);margin-top:2px">Actuel : ${ps.matches}</div>
        </div>
        <div class="form-field">
          <div class="form-label">Objectif perso</div>
          <input type="text" id="goal-custom" value="${g.customGoal||''}" placeholder="Ex: Atteindre le Top 3" maxlength="50">
        </div>
      </div>
      ${g.targetElo && p.elo < g.targetElo ? `
      <div style="background:var(--green-bg);border:1px solid rgba(52,212,123,0.3);border-radius:8px;padding:0.8rem;font-size:0.78rem;color:var(--green);margin-top:0.5rem">
        ğŸ“ˆ Il te faut environ <strong>${Math.ceil((g.targetElo - p.elo) / 16)} victoires nettes</strong> pour atteindre ${g.targetElo} ELO.
      </div>` : ''}
    </div>
    <div style="display:flex;gap:0.6rem;justify-content:flex-end;padding:1rem 1.2rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Annuler</button>
      <button class="btn btn-primary" onclick="savePlayerGoals(${pid})">âœ“ Sauvegarder</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

function savePlayerGoals(pid) {
  const p = pById(pid);
  if (!p) return;
  p.goals = {
    targetElo: parseInt(document.getElementById('goal-elo').value) || '',
    targetWinPct: parseInt(document.getElementById('goal-pct').value) || '',
    targetMatches: parseInt(document.getElementById('goal-matches').value) || '',
    customGoal: document.getElementById('goal-custom').value.trim()
  };
  save();
  document.getElementById('goals-modal-temp')?.remove();
  showNotif('âœ“ Objectifs enregistrÃ©s !', 'success');
  renderPlayers();
}

function renderPlayerGoalProgress(p) {
  if (!p.goals || (!p.goals.targetElo && !p.goals.targetWinPct && !p.goals.targetMatches && !p.goals.customGoal)) return '';
  recomputeElo();
  const stats = getStats();
  const ps = stats[p.id] || { wins:0, matches:0 };
  const currentPct = ps.matches ? Math.round(ps.wins/ps.matches*100) : 0;
  const g = p.goals;
  let items = [];
  if (g.targetElo) {
    const pct = Math.min(100, Math.round(((p.elo - 1000) / (g.targetElo - 1000)) * 100));
    const done = p.elo >= g.targetElo;
    items.push(`<div style="margin-bottom:0.4rem">
      <div style="display:flex;justify-content:space-between;font-size:0.65rem;margin-bottom:2px">
        <span style="color:var(--muted)">ğŸ¯ ELO ${g.targetElo}</span>
        <span style="color:${done?'var(--green)':'var(--text-dim)'};">${done?'âœ“ Atteint!':p.elo+'/'+g.targetElo}</span>
      </div>
      <div style="height:5px;background:var(--dark-card);border-radius:3px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${done?'var(--green)':'var(--accent)'};border-radius:3px"></div>
      </div>
    </div>`);
  }
  if (g.targetWinPct) {
    const done = currentPct >= g.targetWinPct;
    const pct = Math.min(100, Math.round(currentPct/g.targetWinPct*100));
    items.push(`<div style="margin-bottom:0.4rem">
      <div style="display:flex;justify-content:space-between;font-size:0.65rem;margin-bottom:2px">
        <span style="color:var(--muted)">ğŸ† ${g.targetWinPct}% victoires</span>
        <span style="color:${done?'var(--green)':'var(--text-dim)'}">${done?'âœ“ Atteint!':currentPct+'%'}</span>
      </div>
      <div style="height:5px;background:var(--dark-card);border-radius:3px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${done?'var(--green)':'var(--blue)'};border-radius:3px"></div>
      </div>
    </div>`);
  }
  if (g.targetMatches) {
    const done = ps.matches >= g.targetMatches;
    const pct = Math.min(100, Math.round(ps.matches/g.targetMatches*100));
    items.push(`<div style="margin-bottom:0.4rem">
      <div style="display:flex;justify-content:space-between;font-size:0.65rem;margin-bottom:2px">
        <span style="color:var(--muted)">ğŸ“Š ${g.targetMatches} matchs</span>
        <span style="color:${done?'var(--green)':'var(--text-dim)'}">${done?'âœ“ Atteint!':ps.matches+'/'+g.targetMatches}</span>
      </div>
      <div style="height:5px;background:var(--dark-card);border-radius:3px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${done?'var(--green)':'var(--purple)'};border-radius:3px"></div>
      </div>
    </div>`);
  }
  if (g.customGoal) items.push(`<div style="font-size:0.65rem;color:var(--muted);font-style:italic;padding:0.3rem 0">ğŸ“ ${g.customGoal}</div>`);
  if (!items.length) return '';
  return `<div style="margin-top:0.5rem;padding:0.6rem;background:rgba(230,57,70,0.04);border:1px solid rgba(230,57,70,0.15);border-radius:8px">
    <div style="font-size:0.58rem;font-weight:700;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:0.5rem">Objectifs</div>
    ${items.join('')}
  </div>`;
}

// â”€â”€ 5. RECONNAISSANCE VOCALE COMPTEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _voiceRecognition = null;
let _voiceActive = false;

async function requestMicPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop()); // on ferme aussitÃ´t, on voulait juste la permission
    return true;
  } catch(e) {
    showNotif('âš  Permission micro refusÃ©e : ' + e.message, 'error');
    return false;
  }
}

function initVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return false;
  _voiceRecognition = new SpeechRecognition();
  _voiceRecognition.lang = 'fr-FR';
  _voiceRecognition.continuous = true;   // â† Ã©vite le problÃ¨me de geste mobile
  _voiceRecognition.interimResults = false;
  _voiceRecognition.maxAlternatives = 1;
  _voiceRecognition.onresult = function(e) {
    const transcript = e.results[e.results.length - 1][0].transcript.toLowerCase().trim();
    handleVoiceScore(transcript);
  };
  _voiceRecognition.onend = function() {
    // En mode continu, onend ne se dÃ©clenche que si on a explicitement arrÃªtÃ©
    // ou si le navigateur a coupÃ© (ex: timeout iOS)
    _voiceActive = false;
    updateVoiceBtn();
    // RedÃ©marrage seulement si le mode vocal est toujours actif
    if (scState.gameStarted && !scState.winner && scState._voiceMode) {
      setTimeout(() => {
        if (scState._voiceMode && !_voiceActive) startVoiceListening();
      }, 500);
    }
  };
  _voiceRecognition.onerror = function(e) {
    _voiceActive = false;
    updateVoiceBtn();
    if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
      showNotif('âš  AccÃ¨s micro refusÃ©. Autorisez le micro dans les paramÃ¨tres du navigateur.', 'error');
      scState._voiceMode = false;
    } else if (e.error === 'no-speech') {
      // Silence â€” pas d'erreur Ã  afficher, on relance
    } else if (e.error === 'aborted') {
      // ArrÃªt volontaire â€” ne rien faire
    } else {
      showNotif('âš  Erreur micro: ' + e.error, 'error');
    }
  };
  return true;
}

function handleVoiceScore(text) {
  showNotif(`ğŸ¤ Entendu: "${text}"`, 'success');
  const game = scState.game;
  
  // Number extraction
  const numMap = {
    'zÃ©ro':0,'un':1,'deux':2,'trois':3,'quatre':4,'cinq':5,'six':6,
    'sept':7,'huit':8,'neuf':9,'dix':10,'onze':11,'douze':12,'treize':13,
    'quatorze':14,'quinze':15,'seize':16,'dix-sept':17,'dix-huit':18,
    'dix-neuf':19,'vingt':20,'bull':25,'bullseye':50,'cent':100,
    'cent vingt':120,'cent quarante':140,'cent cinquante':150,'cent soixante':160,
    'cent quatre-vingts':180,'cent quatre vingts':180
  };
  
  let value = null;
  // Try direct number
  const directNum = parseInt(text.replace(/[^0-9]/g,''));
  if (!isNaN(directNum) && text.match(/\d+/)) value = directNum;
  // Try word
  if (value === null) {
    for (const [word, num] of Object.entries(numMap)) {
      if (text.includes(word)) { value = num; break; }
    }
  }
  
  if (value === null) { showNotif('âš  Score non reconnu. RÃ©pÃ©tez le chiffre.', 'error'); return; }
  
  if (['501','301','701'].includes(game)) {
    const mode = scState._x01InputMode || 'darts';
    if (mode === 'total') {
      if (value >= 0 && value <= 180) {
        scState._x01TotalInput = String(value);
        setTimeout(() => scConfirmX01Total(), 500);
      }
    } else {
      const mult = scState.multiplier || 1;
      const actualVal = value === 50 ? 'bullseye' : value === 25 ? 'bull' : value;
      scAddDart(actualVal);
    }
  } else if (game === 'countup' || game === 'cricket') {
    // For these games, trigger direct score
    if (value >= 0 && value <= 180) {
      scState._x01TotalInput = String(value);
      if (game === 'countup') scCountupDigit(value);
    }
  }
}

async function toggleVoiceMode() {
  if (!_voiceRecognition && !initVoiceRecognition()) {
    showNotif('âš  Reconnaissance vocale non supportÃ©e sur ce navigateur (essayez Chrome).', 'error');
    return;
  }
  scState._voiceMode = !scState._voiceMode;
  if (scState._voiceMode) {
    // Demander la permission micro avant de dÃ©marrer
    const ok = await requestMicPermission();
    if (!ok) { scState._voiceMode = false; updateVoiceBtn(); return; }
    startVoiceListening();
    showNotif('ğŸ¤ Mode vocal activÃ© â€” Dites vos scores !', 'success');
  } else {
    stopVoiceListening();
    showNotif('ğŸ”‡ Mode vocal dÃ©sactivÃ©', '');
  }
  updateVoiceBtn();
}

function startVoiceListening() {
  if (!_voiceRecognition || _voiceActive) return;
  try { _voiceRecognition.start(); _voiceActive = true; updateVoiceBtn(); } catch(e) {}
}

function stopVoiceListening() {
  if (_voiceRecognition) { try { _voiceRecognition.stop(); } catch(e) {} }
  _voiceActive = false;
  updateVoiceBtn();
}

function updateVoiceBtn() {
  const btn = document.getElementById('sc-voice-btn');
  if (!btn) return;
  const active = scState._voiceMode;
  btn.style.background = active ? 'rgba(52,212,123,0.15)' : 'var(--dark-card)';
  btn.style.borderColor = active ? 'rgba(52,212,123,0.5)' : 'var(--border)';
  btn.style.color = active ? 'var(--green)' : 'var(--muted)';
  btn.innerHTML = active ? (_voiceActive ? '<i class="fas fa-microphone" style="animation:pulse 1s infinite"></i> En Ã©coute...' : '<i class="fas fa-microphone"></i> Vocal ON') : '<i class="fas fa-microphone-slash"></i> Vocal OFF';
}

// â”€â”€ 6. RACCOURCIS CLAVIER DANS LE COMPTEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', function(e) {
  if (!scState.gameStarted || scState.winner) return;
  const overlay = document.getElementById('sc-overlay');
  if (!overlay || !overlay.classList.contains('active')) return;
  if (e.ctrlKey || e.metaKey || e.altKey) return;
  const tag = document.activeElement.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

  const game = scState.game;
  if (['501','301','701'].includes(game)) {
    const mode = scState._x01InputMode || 'darts';
    if (mode === 'total') {
      if (e.key >= '0' && e.key <= '9') { e.preventDefault(); scX01TotalDigit(parseInt(e.key)); }
      if (e.key === 'Backspace' || e.key === 'Delete') { e.preventDefault(); scX01TotalDigit(-1); }
      if (e.key === 'Enter') { e.preventDefault(); scConfirmX01Total(); }
    } else {
      // 1-20, Bull shortcuts
      if (e.key >= '1' && e.key <= '9' && !e.shiftKey) { e.preventDefault(); scAddDart(parseInt(e.key)); }
      if (e.key === 'Enter') { e.preventDefault(); scConfirmTurn(); }
      if (e.key === 'Backspace') { e.preventDefault(); scRemoveLastDart(); }
      if (e.key === 'b' || e.key === 'B') { e.preventDefault(); scAddDart('bull'); }
      if (e.key === 'u' || e.key === 'U') { e.preventDefault(); scUndo(); }
      if (e.key === 'm' || e.key === 'M') { e.preventDefault(); scAddDart(0); } // miss
      // Double/Triple multipliers
      if (e.key === 'd' || e.key === 'D') { e.preventDefault(); scSetMult(scState.multiplier === 2 ? 1 : 2); }
      if (e.key === 't' || e.key === 'T') { e.preventDefault(); scSetMult(scState.multiplier === 3 ? 1 : 3); }
    }
  }
});

// â”€â”€ 7. NOTIFICATIONS SOIRÃ‰ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (requestNotifPermission dÃ©finie plus haut)

function scheduleUpcomingNotifs() {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const now = new Date();
  soirees.forEach(s => {
    if (!s.date) return;
    const soireeDate = new Date(s.date + (s.time ? 'T' + s.time : 'T20:00'));
    const msUntil = soireeDate - now;
    const msUntilReminder = msUntil - 60 * 60 * 1000; // 1h avant
    if (msUntilReminder > 0 && msUntilReminder < 24 * 60 * 60 * 1000) {
      setTimeout(() => {
        new Notification('ğŸ¯ FlÃ©chettes Club â€” Rappel soirÃ©e', {
          body: `${s.title} commence dans 1 heure !${s.lieu ? '\nğŸ“ ' + s.lieu : ''}`,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¯</text></svg>'
        });
      }, Math.max(0, msUntilReminder));
    }
  });
}

// â”€â”€ 8. RAPPORT DE SOIRÃ‰E AUTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateSessionReport(matchIds) {
  // Matches played in last session (from score counter or current soirÃ©e)
  const sessionMatches = matchIds
    ? matches.filter(m => matchIds.includes(m.id))
    : matches.slice(0, Math.min(10, matches.length));
  
  if (!sessionMatches.length) { showNotif('âš  Aucun match Ã  reporter'); return; }
  
  recomputeElo();
  const stats = {};
  const playerIds = new Set();
  sessionMatches.forEach(m => { playerIds.add(m.p1); playerIds.add(m.p2); });
  
  playerIds.forEach(pid => {
    const p = pById(pid);
    if (!p) return;
    const pm = sessionMatches.filter(m => m.p1===pid||m.p2===pid);
    stats[pid] = {
      wins: pm.filter(m => m.winner===pid).length,
      losses: pm.filter(m => m.winner && m.winner!==pid).length,
      draws: pm.filter(m => !m.winner).length,
      matches: pm.length
    };
  });

  const sorted = [...playerIds].map(pid => ({ pid, p: pById(pid), ...stats[pid] }))
    .filter(x => x.p)
    .sort((a, b) => b.wins - a.wins || a.losses - b.losses);
  
  const mvp = sorted[0];
  const total180s = sessionMatches.reduce((a, m) => a + (m.sc180s||0), 0);
  const bestAvg = sessionMatches.reduce((best, m) => {
    const a1 = m.avg1||0, a2 = m.avg2||0;
    return Math.max(best, a1, a2);
  }, 0);

  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `<div class="modal" style="max-width:580px">
    <div class="modal-header">
      <div class="modal-title" style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:2px">ğŸ“‹ RAPPORT DE SOIRÃ‰E</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.2rem">
      <!-- Sommaire -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:0.7rem;margin-bottom:1.2rem">
        <div style="text-align:center;background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:0.8rem">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--accent)">${sessionMatches.length}</div>
          <div style="font-size:0.62rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase">Matchs</div>
        </div>
        <div style="text-align:center;background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:0.8rem">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--purple)">${playerIds.size}</div>
          <div style="font-size:0.62rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase">Joueurs</div>
        </div>
        ${total180s > 0 ? `<div style="text-align:center;background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:0.8rem">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold)">${total180s}</div>
          <div style="font-size:0.62rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase">180 !</div>
        </div>` : ''}
        ${bestAvg > 0 ? `<div style="text-align:center;background:var(--dark-card);border:1px solid var(--border);border-radius:10px;padding:0.8rem">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--green)">${bestAvg}</div>
          <div style="font-size:0.62rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase">Moy. Max</div>
        </div>` : ''}
      </div>
      
      ${mvp ? `<div style="background:linear-gradient(135deg,rgba(245,197,24,0.1),rgba(245,197,24,0.03));border:1px solid rgba(245,197,24,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;display:flex;align-items:center;gap:1rem">
        <div style="font-size:2.5rem">ğŸ†</div>
        <div>
          <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--gold);text-transform:uppercase">MVP de la soirÃ©e</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:2px;color:var(--light)">${mvp.p.pseudo}</div>
          <div style="font-size:0.72rem;color:var(--muted)">${mvp.wins}V / ${mvp.losses}D sur ${mvp.matches} matchs</div>
        </div>
      </div>` : ''}
      
      <!-- Classement soirÃ©e -->
      <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:0.6rem">Classement de la soirÃ©e</div>
      ${sorted.map((row, i) => `
        <div style="display:flex;align-items:center;gap:0.8rem;padding:0.5rem 0.7rem;background:${i===0?'rgba(245,197,24,0.06)':'var(--dark-card)'};border-radius:8px;margin-bottom:4px;border:1px solid ${i===0?'rgba(245,197,24,0.2)':'var(--border)'}">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:${i===0?'var(--gold)':i===1?'var(--silver)':i===2?'var(--bronze)':'var(--muted)'};width:24px;text-align:center">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</div>
          <div style="flex:1;font-weight:700">${row.p.pseudo}</div>
          <div style="font-size:0.72rem;color:var(--green);font-weight:700">${row.wins}V</div>
          <div style="font-size:0.7rem;color:var(--muted)">${row.draws>0?row.draws+'N ':''}${row.losses}D</div>
        </div>`).join('')}
      
      <!-- RÃ©sultats -->
      <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:0.8rem 0 0.5rem">RÃ©sultats</div>
      ${sessionMatches.map(m => `<div class="recent-match">
        <span class="${m.winner===m.p1?'rm-winner':'rm-loser'}">${pName(m.p1)}</span>
        <span class="rm-score">${m.s1}â€“${m.s2}</span>
        <span class="${m.winner===m.p2?'rm-winner':'rm-loser'}">${pName(m.p2)}</span>
        ${m.tags&&m.tags.length?`<span style="margin-left:4px">${m.tags.map(t=>MATCH_HIGHLIGHTS.find(h=>h.id===t)?.icon||'').join('')}</span>`:''}
      </div>`).join('')}
    </div>
    <div style="padding:1rem 1.2rem;border-top:1px solid var(--border);display:flex;gap:0.6rem;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="printSessionReport(this.closest('.modal-overlay').querySelector('.modal-body'))">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">âœ“ Fermer</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

function printSessionReport(el) {
  const w = window.open('', '', 'width=700,height=900');
  w.document.write(`<!DOCTYPE html><html><head><style>
    body{font-family:Arial,sans-serif;padding:2rem;background:#fff;color:#333}
    h1{font-size:1.8rem;margin-bottom:1rem} 
    .grid{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .stat-box{border:1px solid #ddd;border-radius:8px;padding:0.8rem 1.2rem;text-align:center}
    .val{font-size:1.8rem;font-weight:900;color:#e63946}
    .lbl{font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:1px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:0.5rem;border-bottom:1px solid #eee;text-align:left}
    th{font-size:0.7rem;text-transform:uppercase;color:#888}
  </style></head><body>
    <h1>ğŸ¯ Rapport de SoirÃ©e</h1>
    ${el.innerHTML}
  </body></html>`);
  w.print();
}

// â”€â”€ 9. PLANNING AUTO DE SOIRÃ‰E â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateAutoPlanning(soireeId) {
  const soiree = soirees.find(s => s.id === soireeId);
  if (!soiree || !soiree.attendees || soiree.attendees.length < 2) {
    showNotif('âš  SÃ©lectionnez au moins 2 joueurs pour cette soirÃ©e', 'error'); return;
  }
  const present = soiree.attendees.map(id => pById(id)).filter(Boolean);
  const n = present.length;
  const schedule = [];
  
  // Round-robin schedule using circle method
  let ids = [...present.map(p => p.id)];
  if (ids.length % 2 !== 0) ids.push(null); // bye
  const rounds = ids.length - 1;
  for (let r = 0; r < rounds; r++) {
    const round = { num: r + 1, matches: [] };
    for (let i = 0; i < ids.length / 2; i++) {
      const h = ids[i], a = ids[ids.length - 1 - i];
      if (h !== null && a !== null) {
        round.matches.push({ p1: h, p2: a });
      }
    }
    schedule.push(round);
    // Rotate keeping first element fixed
    const last = ids.pop();
    ids.splice(1, 0, last);
  }
  
  soiree.schedule = schedule;
  save();
  renderCalendrier();
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `<div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“‹ Planning â€” ${soiree.title}</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1.2rem;max-height:70vh;overflow-y:auto">
      <div style="font-size:0.72rem;color:var(--muted);margin-bottom:1rem">${present.length} joueurs Â· ${schedule.reduce((a,r)=>a+r.matches.length,0)} matchs Â· ${schedule.length} tours</div>
      ${schedule.map(round => `
        <div style="margin-bottom:0.8rem">
          <div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:0.4rem">Tour ${round.num}</div>
          ${round.matches.map(m => `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.4rem 0.6rem;background:var(--dark-card);border-radius:7px;margin-bottom:3px;border:1px solid var(--border)">
            <span style="font-weight:600;flex:1;text-align:right">${pName(m.p1)}</span>
            <span style="font-size:0.65rem;color:var(--muted);font-weight:700;padding:2px 8px;background:var(--dark-hover);border-radius:4px">VS</span>
            <span style="font-weight:600;flex:1">${pName(m.p2)}</span>
          </div>`).join('')}
        </div>`).join('')}
    </div>
    <div style="padding:1rem 1.2rem;border-top:1px solid var(--border);display:flex;gap:0.6rem;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Fermer</button>
      <button class="btn btn-primary" onclick="applyPlanningToMatchs(${soireeId});this.closest('.modal-overlay').remove()">â–¶ DÃ©marrer avec ce planning</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  showNotif('âœ“ Planning gÃ©nÃ©rÃ© â€” ' + schedule.length + ' tours !', 'success');
}

function applyPlanningToMatchs(soireeId) {
  const soiree = soirees.find(s => s.id === soireeId);
  if (!soiree?.schedule) return;
  // Open the soirÃ©e mode with pre-filled schedule
  showPage('matchs', null);
  showNotif('âœ“ Planning chargÃ© dans la section matchs !', 'success');
}

// â”€â”€ 10. CHECKOUT STATS PAR JOUEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlayerDoubleStats(pid) {
  // Analyse which doubles the player hit/missed from compteur data
  const pm = matches.filter(m => (m.p1===pid||m.p2===pid) && m.source==='compteur');
  const doubleHits = {}, doubleMisses = {};
  for (let i = 1; i <= 20; i++) { doubleHits[i] = 0; doubleMisses[i] = 0; }
  doubleHits['bull'] = 0; doubleMisses['bull'] = 0;
  pm.forEach(m => {
    const isP1 = m.p1 === pid;
    const doubleLog = isP1 ? m.doubleLog1 : m.doubleLog2;
    if (!doubleLog) return;
    doubleLog.forEach(entry => {
      const d = entry.double;
      if (entry.hit) doubleHits[d] = (doubleHits[d]||0) + 1;
      else doubleMisses[d] = (doubleMisses[d]||0) + 1;
    });
  });
  return { hits: doubleHits, misses: doubleMisses };
}

function renderDoubleStatsModal(pid) {
  const p = pById(pid);
  if (!p) return;
  const { hits, misses } = getPlayerDoubleStats(pid);
  const doubles = [20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,'bull'];
  const hasData = doubles.some(d => (hits[d]||0) + (misses[d]||0) > 0);
  
  let content = '';
  if (!hasData) {
    content = `<div style="text-align:center;padding:2rem;color:var(--muted)">
      <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ¯</div>
      <div>Aucune donnÃ©e de checkout disponible.<br>
      <small>Les stats se remplissent automatiquement via le compteur de score.</small></div>
    </div>`;
  } else {
    const rows = doubles.map(d => {
      const h = hits[d]||0, m2 = misses[d]||0;
      const total = h + m2;
      if (total === 0) return '';
      const pct = Math.round(h/total*100);
      const color = pct >= 70 ? 'var(--green)' : pct >= 40 ? 'var(--gold)' : 'var(--red)';
      return `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.35rem 0.5rem;background:var(--dark-card);border-radius:6px;margin-bottom:3px;border:1px solid var(--border)">
        <div style="width:38px;text-align:center;font-family:'DM Mono',monospace;font-weight:700;font-size:0.82rem;color:var(--accent)">D${d}</div>
        <div style="flex:1">
          <div style="height:7px;background:var(--dark-hover);border-radius:4px;overflow:hidden">
            <div style="width:${pct}%;height:100%;background:${color};border-radius:4px;transition:width .3s"></div>
          </div>
        </div>
        <div style="font-size:0.65rem;font-family:'DM Mono',monospace;color:${color};font-weight:700;min-width:34px;text-align:right">${pct}%</div>
        <div style="font-size:0.62rem;color:var(--muted);min-width:50px;text-align:right">${h}/${total}</div>
      </div>`;
    }).filter(Boolean).join('');
    content = `<div style="max-height:400px;overflow-y:auto">${rows}</div>`;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `<div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">ğŸ¯ Checkouts â€” ${p.pseudo}</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:1rem">${content}</div>
  </div>`;
  document.body.appendChild(modal);
}

// â”€â”€ 11. DIVISIONS AUTOMATIQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDivisionHistory(pid) {
  const p = pById(pid);
  if (!p) return [];
  return (p.divisionHistory || []);
}

function checkAndUpdateDivisions() {
  recomputeElo();
  players.forEach(p => {
    if (!p.divisionHistory) p.divisionHistory = [];
    const currentDiv = divisionBadge(p.elo);
    const lastEntry = p.divisionHistory.slice(-1)[0];
    const lastDivName = lastEntry ? lastEntry.div : null;
    // Extract division name from badge HTML
    const divMatch = currentDiv.match(/>(.*?)</);
    const divName = divMatch ? divMatch[1] : '';
    if (lastDivName && lastDivName !== divName && divName) {
      const wasHigher = ['Diamant','Platine','Or'].includes(divName) && 
                        ['Bronze','Argent'].includes(lastDivName);
      p.divisionHistory.push({
        date: new Date().toLocaleDateString('fr-FR'),
        div: divName,
        elo: p.elo,
        type: wasHigher ? 'promotion' : 'relegation'
      });
      showNotif(wasHigher
        ? `ğŸ‰ ${p.pseudo} promu en ${divName} !`
        : `ğŸ“‰ ${p.pseudo} rÃ©trogradÃ© en ${divName}`, wasHigher ? 'success' : 'error');
    } else if (!lastDivName && divName) {
      p.divisionHistory.push({ date: new Date().toLocaleDateString('fr-FR'), div: divName, elo: p.elo, type: 'initial' });
    }
  });
}

// â”€â”€ 12. AMÃ‰LIORATIONS MOBILES SCORE COUNTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function addMobileScoreCSS() {
  const style = document.createElement('style');
  style.textContent = `
    @media (max-width: 480px) {
      .sc-key { min-height: 52px !important; font-size: 1.1rem !important; border-radius: 10px !important; }
      .sc-key.confirm { min-height: 58px !important; font-size: 1rem !important; }
      .sc-score-main { font-size: 3.5rem !important; }
      .sc-player-panel { padding: 1rem !important; }
      .sc-pname { font-size: 0.85rem !important; }
      #sc-keypad { gap: 6px !important; }
      .sc-multiplier { gap: 8px !important; }
      .sc-mult-btn { min-width: 52px !important; min-height: 42px !important; font-size: 0.85rem !important; }
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .elo-period-btn { transition: background .15s, color .15s; }
    .hl-tag.hl-tag-active { border-color: var(--accent) !important; background: var(--accent-dim) !important; color: var(--accent) !important; }
  `;
  document.head.appendChild(style);
})();

// â”€â”€ INIT: Appeler les nouvelles fonctions au dÃ©marrage â”€â”€
requestNotifPermission();
scheduleUpcomingNotifs();
checkAndUpdateDivisions();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–¼ï¸ IMAGE CLUB & FOND D'APPLICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function uploadClubImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 500 * 1024) {
    showNotif('âš  Image trop lourde (max 500 Ko). Compressez-la d\'abord.', 'error');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    clubSettings.clubImage = e.target.result;
    save();
    applyClubSettings();
    // Update preview
    const wrap = document.getElementById('club-img-preview-wrap');
    const img  = document.getElementById('club-img-preview');
    if (wrap) wrap.style.display = 'flex';
    if (img)  img.src = e.target.result;
    showNotif('âœ“ Image du club mise Ã  jour !', 'success');
  };
  reader.readAsDataURL(file);
  // Reset input so same file can be re-selected
  event.target.value = '';
}

function removeClubImage() {
  delete clubSettings.clubImage;
  save();
  applyClubSettings();
  const wrap = document.getElementById('club-img-preview-wrap');
  const img  = document.getElementById('club-img-preview');
  if (wrap) wrap.style.display = 'none';
  if (img)  img.src = '';
  showNotif('âœ“ Image du club retirÃ©e', 'success');
}

function uploadBgImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 1024 * 1024) {
    showNotif('âš  Image trop lourde (max 1 Mo). Compressez-la d\'abord.', 'error');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    clubSettings.bgImage  = e.target.result;
    if (clubSettings.bgOpacity == null) clubSettings.bgOpacity = 8;
    save();
    applyClubSettings();
    // Update preview
    const wrap = document.getElementById('bg-img-preview-wrap');
    const img  = document.getElementById('bg-img-preview');
    const slider = document.getElementById('bg-opacity-slider');
    if (wrap)   wrap.style.display = 'flex';
    if (img)    img.src = e.target.result;
    if (slider) slider.value = clubSettings.bgOpacity;
    showNotif('âœ“ Image de fond appliquÃ©e !', 'success');
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function removeBgImage() {
  delete clubSettings.bgImage;
  save();
  applyClubSettings();
  const wrap = document.getElementById('bg-img-preview-wrap');
  const img  = document.getElementById('bg-img-preview');
  if (wrap) wrap.style.display = 'none';
  if (img)  img.src = '';
  showNotif('âœ“ Image de fond retirÃ©e', 'success');
}

function setBgOpacity(val) {
  clubSettings.bgOpacity = parseInt(val);
  save();
  applyBgImage();
}

function applyBgImage() {
  const overlay = document.getElementById('app-bg-overlay');
  if (!overlay) return;
  if (clubSettings.bgImage) {
    const opacity = ((clubSettings.bgOpacity != null ? clubSettings.bgOpacity : 8) / 20).toFixed(2);
    overlay.style.backgroundImage = `url('${clubSettings.bgImage}')`;
    overlay.style.opacity = opacity;
    document.body.classList.add('has-bg-image');
  } else {
    overlay.style.backgroundImage = '';
    overlay.style.opacity = '0';
    document.body.classList.remove('has-bg-image');
  }
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV GROUPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _PAGE_TO_GROUP = {
  classement:'navg-palmares', joueurs:'navg-palmares', historique:'navg-palmares',
  matchs:'navg-competition', equipes:'navg-competition', tournois:'navg-competition',
  ligue:'navg-competition', entrainement:'navg-competition',
  stats:'navg-stats'
};

function toggleNavGroup(groupId, evt) {
  if (evt) evt.stopPropagation();
  const g = document.getElementById(groupId);
  if (!g) return;
  const wasOpen = g.classList.contains('open');
  document.querySelectorAll('.nav-group.open').forEach(x => x.classList.remove('open'));
  if (!wasOpen) g.classList.add('open');
}

function navDropGo(page, groupId) {
  document.querySelectorAll('.nav-group').forEach(g => g.classList.remove('open','has-active'));
  document.querySelectorAll('.nav-drop-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.nav-btn:not(.nav-group-trigger)').forEach(b => b.classList.remove('active'));
  const g = document.getElementById(groupId);
  if (g) {
    g.classList.add('has-active');
    g.querySelectorAll('.nav-drop-item').forEach(item => {
      if ((item.getAttribute('onclick')||'').includes("'"+page+"'")) item.classList.add('active');
    });
  }
  showPage(page, null);
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.nav-group')) {
    document.querySelectorAll('.nav-group.open').forEach(g => g.classList.remove('open'));
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS PUSH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PUSH_NOTIF = {
  async request() {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission === 'denied') return false;
    const r = await Notification.requestPermission();
    return r === 'granted';
  },
  send(title, body) {
    if (Notification.permission !== 'granted') return;
    try {
      new Notification(title, { body,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%23e63946"/><text y=".9em" font-size="75" x="12">ğŸ¯</text></svg>'
      });
    } catch(e) {}
  }
};

async function requestNotifPermFromBanner() {
  const granted = await PUSH_NOTIF.request();
  const bar = document.getElementById('notif-perm-bar');
  if (bar) bar.classList.remove('show');
  if (granted) showNotif('ğŸ”” Notifications activÃ©es !', 'success');
}

function showNotifPermBanner() {
  if (!('Notification' in window) || Notification.permission !== 'default') return;
  const bar = document.getElementById('notif-perm-bar');
  if (bar) bar.classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIVISION â€” vÃ©rification changements
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _prevDivisions = {};

function checkDivisionChanges() {
  players.forEach(p => {
    const cur = getDivision(p.elo || 1000).name;
    const prev = _prevDivisions[p.id];
    if (prev && prev !== cur) {
      const d = getDivision(p.elo);
      showNotif('ğŸ– ' + p.pseudo + ' passe en ' + d.icon + ' ' + d.name + ' !', 'success');
      PUSH_NOTIF.send(d.icon + ' Division ' + d.name + ' !', p.pseudo + ' a atteint ' + d.name + ' (' + p.elo + ' ELO)');
    }
    _prevDivisions[p.id] = cur;
  });
}

function initDivisions() {
  players.forEach(p => { _prevDivisions[p.id] = getDivision(p.elo || 1000).name; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOUEUR INDIVIDUEL â€” modal complet
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlayerFull(pid) {
  const p = pById(pid);
  if (!p) return;
  let modal = document.getElementById('player-full-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'player-full-modal';
    modal.innerHTML = '<div class="modal" style="max-width:680px;padding:0;overflow:hidden"><div id="player-full-content"></div></div>';
    modal.addEventListener('click', function(e){ if(e.target===this) closeModal('player-full-modal'); });
    document.body.appendChild(modal);
  }
  const el = document.getElementById('player-full-content');
  const color = p.avatarColor || 'var(--accent)';
  const avatar = p.avatarPhoto
    ? '<img src="'+p.avatarPhoto+'" style="width:100%;height:100%;object-fit:cover;border-radius:16px">'
    : (p.avatarEmoji || getInitials(p.name));

  el.innerHTML = '<div>'
    + '<div class="player-full-header" style="background:linear-gradient(135deg,'+color+'18,transparent)">'
    + '<button class="modal-close" style="position:absolute;top:1rem;right:1rem;z-index:2" onclick="closeModal(\'player-full-modal\')">âœ•</button>'
    + '<div class="player-full-avatar" style="background:linear-gradient(135deg,'+color+','+color+'99);color:#0d0f14">'+avatar+'</div>'
    + '<div style="flex:1">'
    + '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.8rem;letter-spacing:1px;line-height:1">'+p.pseudo+' '+divisionBadge(p.elo||1000)+'</div>'
    + '<div style="font-size:.78rem;color:var(--muted)">'+p.name+(p.surnom?' Â· <em style="color:var(--accent)">'+p.surnom+'</em>':'')+'</div>'
    + '<div style="margin-top:.4rem">'+divisionProgressBar(p.elo||1000)+'</div>'
    + '</div>'
    + '<div style="text-align:right;flex-shrink:0">'
    + '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:2.2rem;color:var(--accent);line-height:1">'+(p.elo||1000)+'</div>'
    + '<div style="font-size:.6rem;color:var(--muted)">ELO Â· Peak '+(p.peak||p.elo||1000)+'</div>'
    + '</div></div>'
    + '<div class="player-full-tabs">'
    + '<button class="player-full-tab active" onclick="switchPlayerTab(\'overview\','+pid+',this)">ğŸ“Š Stats</button>'
    + '<button class="player-full-tab" onclick="switchPlayerTab(\'history\','+pid+',this)">ğŸ“‹ Matchs</button>'
    + '<button class="player-full-tab" onclick="switchPlayerTab(\'h2h\','+pid+',this)">âš”ï¸ H2H</button>'
    + '<button class="player-full-tab" onclick="switchPlayerTab(\'trophies\','+pid+',this)">ğŸ† TrophÃ©es</button>'
    + '</div>'
    + '<div class="player-full-body" id="pfb-'+pid+'"></div>'
    + '</div>';

  switchPlayerTab('overview', pid, el.querySelector('.player-full-tab'));
  openModal('player-full-modal');
}

function switchPlayerTab(tab, pid, btn) {
  const p = pById(pid);
  const body = document.getElementById('pfb-'+pid);
  if (!p || !body) return;
  document.querySelectorAll('.player-full-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  const stats = getStats();
  const s = stats[pid] || {wins:0,losses:0,draws:0,matches:0};
  const pct = s.matches ? Math.round(s.wins/s.matches*100) : 0;
  const myMatches = matches.filter(m => m.p1===pid || m.p2===pid);

  if (tab === 'overview') {
    const total180 = myMatches.reduce((a,m)=>a+(m.p1===pid?(m.v180p1||0):(m.v180p2||0)),0);
    const streak = getStreak(pid);
    const form = getRecentForm(pid, 8);
    const avgData = myMatches.reduce((acc,m) => {
      const v = m.p1===pid ? m.avg1 : m.avg2;
      return v ? {sum:acc.sum+v, cnt:acc.cnt+1} : acc;
    }, {sum:0,cnt:0});
    const avg = avgData.cnt ? avgData.sum/avgData.cnt : 0;

    body.innerHTML = '<div class="pf-stat-grid">'
      + '<div class="pf-stat"><div class="pf-stat-val">'+s.matches+'</div><div class="pf-stat-lbl">Matchs</div></div>'
      + '<div class="pf-stat"><div class="pf-stat-val" style="color:var(--green)">'+s.wins+'</div><div class="pf-stat-lbl">Victoires</div></div>'
      + '<div class="pf-stat"><div class="pf-stat-val" style="color:var(--red)">'+s.losses+'</div><div class="pf-stat-lbl">DÃ©faites</div></div>'
      + '<div class="pf-stat"><div class="pf-stat-val">'+pct+'%</div><div class="pf-stat-lbl">Win Rate</div></div>'
      + (avg ? '<div class="pf-stat"><div class="pf-stat-val">'+avg.toFixed(1)+'</div><div class="pf-stat-lbl">Moy./volÃ©e</div></div>' : '')
      + '<div class="pf-stat"><div class="pf-stat-val" style="color:var(--gold)">'+total180+'</div><div class="pf-stat-lbl">180s</div></div>'
      + '<div class="pf-stat"><div class="pf-stat-val">'+(p.elo||1000)+'</div><div class="pf-stat-lbl">ELO</div></div>'
      + '<div class="pf-stat"><div class="pf-stat-val">'+(p.peak||p.elo||1000)+'</div><div class="pf-stat-lbl">Peak</div></div>'
      + '</div>'
      + (form.length ? '<div class="section-label" style="margin-bottom:.3rem">Forme rÃ©cente</div><div>'+formDots(form)+'</div>' : '')
      + (streak ? '<div style="margin-top:.6rem;display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .7rem;background:var(--dark-card);border-radius:8px;font-size:.75rem"><span>'+(streak.type==='W'?'ğŸ”¥':'ğŸ’€')+'</span><span style="color:'+(streak.type==='W'?'var(--green)':'var(--red)')+'">'+streak.count+' '+(streak.type==='W'?'victoires':'dÃ©faites')+' de suite</span></div>' : '')
      + '<div style="margin-top:.8rem"><div class="section-label" style="margin-bottom:.3rem">Ã‰volution ELO</div>'
      + '<div>'+sparkline(p.eloHistory||[1000],350,40)+'</div></div>'
      + '<div style="margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--border)">'
      + '<button class="btn btn-secondary btn-sm" onclick="exportPlayerPDF('+pid+')"><i class="fas fa-file-pdf"></i> Exporter fiche</button>'
      + '</div>';

  } else if (tab === 'history') {
    body.innerHTML = myMatches.length === 0
      ? '<div class="empty"><div class="empty-text">Aucun match.</div></div>'
      : '<div>'+myMatches.slice(0,25).map(m => {
          const opp = pById(m.p1===pid ? m.p2 : m.p1);
          const ms = m.p1===pid ? m.s1 : m.s2;
          const os = m.p1===pid ? m.s2 : m.s1;
          const ec = m.p1===pid ? (m.eloChange1||0) : (m.eloChange2||0);
          const won = m.winner===pid;
          return '<div class="pf-match-row">'
            + '<span style="color:var(--muted);font-size:.6rem">'+m.date+'</span>'
            + '<span style="font-weight:600;flex:1">vs '+((opp&&opp.pseudo)||'?')+'</span>'
            + '<span style="font-family:\'DM Mono\',monospace;font-weight:800">'+ms+'â€“'+os+'</span>'
            + '<span style="color:'+(won?'var(--green)':'var(--red)')+';font-weight:700">'+(won?'V':'D')+'</span>'
            + '<span style="font-size:.62rem;color:'+(ec>=0?'var(--green)':'var(--red)')+'">'+(ec>=0?'+':'')+ec+'</span>'
            + '</div>';
        }).join('')+'</div>';

  } else if (tab === 'h2h') {
    const opps = {};
    myMatches.forEach(m => {
      const oid = m.p1===pid ? m.p2 : m.p1;
      if (!opps[oid]) opps[oid] = {w:0,l:0};
      if (m.winner===pid) opps[oid].w++;
      else if (m.winner) opps[oid].l++;
    });
    const rows = Object.entries(opps).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
    body.innerHTML = rows.length === 0
      ? '<div class="empty"><div class="empty-text">Aucun adversaire.</div></div>'
      : '<div>'+rows.map(([oid,r]) => {
          const opp = pById(parseInt(oid));
          const tot = r.w+r.l;
          return '<div class="pf-h2h-row">'
            + '<span style="font-weight:600;flex:1">'+((opp&&opp.pseudo)||'?')+'</span>'
            + '<span style="color:var(--green);font-weight:700">'+r.w+'V</span>'
            + '<span style="color:var(--red);font-weight:700">'+r.l+'D</span>'
            + '<span style="color:var(--muted);font-size:.65rem">'+(tot?Math.round(r.w/tot*100):0)+'%</span>'
            + '</div>';
        }).join('')+'</div>';

  } else if (tab === 'trophies') {
    const achs = (p.achievements||[]).map(id => ACHIEVEMENTS.find(x=>x.id===id)).filter(Boolean);
    const locked = ACHIEVEMENTS.filter(a => !(p.achievements||[]).includes(a.id));
    body.innerHTML = (achs.length ? '<div class="section-label" style="margin-bottom:.4rem">DÃ©bloquÃ©s ('+achs.length+')</div>'
      + '<div style="display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.8rem">'
      + achs.map(a => '<div style="display:flex;align-items:center;gap:.4rem;background:var(--accent-dim);border:1px solid rgba(230,57,70,.3);border-radius:8px;padding:.3rem .6rem;font-size:.72rem"><span>'+a.icon+'</span><span style="font-weight:700;color:var(--light)">'+a.name+'</span></div>').join('')
      + '</div>' : '')
      + (locked.length ? '<div class="section-label" style="margin-bottom:.4rem;opacity:.6">Ã€ dÃ©bloquer</div>'
      + '<div style="display:flex;flex-wrap:wrap;gap:.4rem">'
      + locked.slice(0,8).map(a => '<div style="display:flex;align-items:center;gap:.4rem;background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:.3rem .6rem;font-size:.72rem;opacity:.4"><span>ğŸ”’</span><span style="color:var(--muted)">'+a.name+'</span></div>').join('')
      + '</div>' : '');
  }
}

function exportPlayerPDF(pid) {
  const p = pById(pid);
  if (!p) return;
  const stats = getStats();
  const s = stats[pid] || {wins:0,losses:0,draws:0,matches:0};
  const d = getDivision(p.elo||1000);
  const myMatches = matches.filter(m => m.p1===pid || m.p2===pid).slice(0,10);
  const pw = window.open('','','width=800,height=900');
  pw.document.write('<!DOCTYPE html><html><head><title>Fiche '+p.pseudo+'</title>'
    +'<style>body{font-family:Arial,sans-serif;padding:2rem;color:#1a1a2e;max-width:700px;margin:0 auto}'
    +'h1{color:#e63946}table{width:100%;border-collapse:collapse;font-size:.85rem}'
    +'th{background:#e63946;color:#fff;padding:.4rem .6rem}td{padding:.35rem .6rem;border-bottom:1px solid #eee}'
    +'.stats{display:flex;gap:1rem;flex-wrap:wrap;margin:1.2rem 0}'
    +'.stat{background:#f5f5f5;border-radius:8px;padding:.6rem 1rem;text-align:center;min-width:80px}'
    +'.sv{font-size:1.8rem;font-weight:900;color:#e63946;line-height:1}'
    +'.sl{font-size:.65rem;color:#888;text-transform:uppercase}'
    +'</style></head><body>'
    +'<h1>ğŸ¯ '+p.pseudo+'</h1><div>'+p.name+(p.surnom?' Â· '+p.surnom:'')+'</div>'
    +'<div style="display:inline-block;background:#fee2e2;color:#e63946;border-radius:4px;padding:2px 8px;font-size:.8rem;font-weight:700;margin:.5rem 0">'+d.icon+' '+d.name+'</div>'
    +'<div class="stats">'
    +'<div class="stat"><div class="sv">'+(p.elo||1000)+'</div><div class="sl">ELO</div></div>'
    +'<div class="stat"><div class="sv">'+s.matches+'</div><div class="sl">Matchs</div></div>'
    +'<div class="stat"><div class="sv">'+s.wins+'</div><div class="sl">Victoires</div></div>'
    +'<div class="stat"><div class="sv">'+(s.matches?Math.round(s.wins/s.matches*100):0)+'%</div><div class="sl">Win Rate</div></div>'
    +'</div>'
    +'<h3>Derniers matchs</h3>'
    +'<table><tr><th>Date</th><th>Adversaire</th><th>Score</th><th>RÃ©sultat</th></tr>'
    +myMatches.map(m=>{const opp=pById(m.p1===pid?m.p2:m.p1);const won=m.winner===pid;
      return '<tr><td>'+m.date+'</td><td>'+((opp&&opp.pseudo)||'?')+'</td>'
      +'<td><b>'+(m.p1===pid?m.s1:m.s2)+'â€“'+(m.p1===pid?m.s2:m.s1)+'</b></td>'
      +'<td style="color:'+(won?'#22c55e':'#ef4444')+';font-weight:700">'+(won?'Victoire':'DÃ©faite')+'</td></tr>';}).join('')
    +'</table>'
    +'<p style="margin-top:2rem;font-size:.7rem;color:#999">FlÃ©chettes Club Pro Â· '+new Date().toLocaleDateString('fr-FR')+'</p>'
    +'</body></html>');
  pw.document.close();
  setTimeout(() => pw.print(), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOIRÃ‰E RAPPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSoireeRapport(soireeId) {
  const s = soirees.find(x => x.id === soireeId);
  if (!s) return;

  let modal = document.getElementById('soiree-rapport-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'soiree-rapport-modal';
    modal.innerHTML = '<div class="modal" style="max-width:600px"><div class="modal-title">ğŸ“‹ Rapport de SoirÃ©e <button class="modal-close" onclick="closeModal(\'soiree-rapport-modal\')">âœ•</button></div><div id="soiree-rapport-content"></div></div>';
    modal.addEventListener('click', function(e){ if(e.target===this) closeModal('soiree-rapport-modal'); });
    document.body.appendChild(modal);
  }

  const d = new Date(s.date);
  const soireeDate = d.toLocaleDateString('fr-FR');
  const sm = matches.filter(m => m.date === soireeDate);
  const pids = new Set([...sm.map(m=>m.p1),...sm.map(m=>m.p2)]);
  const eloMap = {};
  sm.forEach(m => {
    eloMap[m.p1] = (eloMap[m.p1]||0) + (m.eloChange1||0);
    eloMap[m.p2] = (eloMap[m.p2]||0) + (m.eloChange2||0);
  });
  const wins = {};
  sm.forEach(m => { if(m.winner) wins[m.winner] = (wins[m.winner]||0)+1; });
  const mvpId = Object.keys(wins).sort((a,b)=>wins[b]-wins[a])[0];
  const mvp = mvpId ? pById(parseInt(mvpId)) : null;
  const topGainId = Object.keys(eloMap).sort((a,b)=>eloMap[b]-eloMap[a])[0];
  const topGain = topGainId ? pById(parseInt(topGainId)) : null;

  document.getElementById('soiree-rapport-content').innerHTML =
    '<div style="background:var(--dark-card);border-radius:10px;padding:1rem;margin-bottom:.8rem;border-left:3px solid var(--accent)">'
    +'<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.4rem;color:var(--light)">'+s.title+'</div>'
    +'<div style="font-size:.72rem;color:var(--muted)">'+d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})+(s.lieu?' Â· '+s.lieu:'')+'</div>'
    +'</div>'
    +'<div class="soiree-rapport-kpis">'
    +'<div class="soiree-kpi"><div class="soiree-kpi-val">'+sm.length+'</div><div class="soiree-kpi-lbl">Matchs</div></div>'
    +'<div class="soiree-kpi"><div class="soiree-kpi-val">'+pids.size+'</div><div class="soiree-kpi-lbl">Joueurs</div></div>'
    +'</div>'
    +(mvp ? '<div style="margin-bottom:.8rem"><div class="section-label" style="margin-bottom:.4rem">ğŸ† MVP</div>'
    +'<div class="soiree-mvp-chip"><span style="font-size:1.1rem">'+(mvp.avatarEmoji||'ğŸ¯')+'</span><div><div style="font-weight:700;color:var(--light)">'+mvp.pseudo+'</div><div style="font-size:.65rem;color:var(--muted)">'+wins[mvpId]+' victoire'+(wins[mvpId]>1?'s':'')+'</div></div></div></div>' : '')
    +(topGain && eloMap[topGainId]>0 ? '<div style="margin-bottom:.8rem"><div class="section-label" style="margin-bottom:.4rem">ğŸ“ˆ Meilleure progression</div>'
    +'<div class="soiree-mvp-chip" style="background:rgba(52,212,123,.1);border-color:rgba(52,212,123,.3)"><span style="font-size:1.1rem">ğŸ“ˆ</span><div><div style="font-weight:700;color:var(--green)">'+topGain.pseudo+'</div><div style="font-size:.65rem;color:var(--muted)">+'+eloMap[topGainId]+' ELO</div></div></div></div>' : '')
    +(sm.length ? '<div class="section-label" style="margin-bottom:.4rem">ğŸ“‹ RÃ©sultats</div><div>'
    +sm.slice(0,15).map(m=>{
      const p1=pById(m.p1),p2=pById(m.p2);
      const e1=m.eloChange1||0,e2=m.eloChange2||0;
      return '<div style="display:flex;align-items:center;justify-content:space-between;padding:.3rem .5rem;border-radius:6px;background:var(--dark);margin-bottom:.2rem;font-size:.72rem">'
        +'<span style="font-weight:700;color:'+(m.winner===m.p1?'var(--green)':'var(--muted)')+'">'+(p1&&p1.pseudo||'?')+'</span>'
        +'<span style="font-family:\'DM Mono\',monospace;font-weight:800">'+m.s1+'â€“'+m.s2+'</span>'
        +'<span style="font-weight:700;color:'+(m.winner===m.p2?'var(--green)':'var(--muted)')+'">'+(p2&&p2.pseudo||'?')+'</span>'
        +'<span style="font-size:.6rem;color:var(--muted)">'+(e1>=0?'+':'')+e1+' / '+(e2>=0?'+':'')+e2+'</span>'
        +'</div>';}).join('')+'</div>' : '<div style="color:var(--muted);font-size:.8rem">Aucun match ce soir-lÃ .</div>')
    +'<div style="display:flex;gap:.5rem;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">'
    +'<button class="btn btn-secondary btn-sm" onclick="exportSoireeRapportPDF('+soireeId+')"><i class="fas fa-file-pdf"></i> PDF</button>'
    +'<button class="btn btn-secondary btn-sm" onclick="closeModal(\'soiree-rapport-modal\')">Fermer</button>'
    +'</div>';

  openModal('soiree-rapport-modal');
}

function exportSoireeRapportPDF(soireeId) {
  const s = soirees.find(x => x.id === soireeId);
  if (!s) return;
  const d = new Date(s.date);
  const sm = matches.filter(m => m.date === d.toLocaleDateString('fr-FR'));
  const pw = window.open('','','width=800,height=900');
  pw.document.write('<!DOCTYPE html><html><head><title>Rapport '+s.title+'</title>'
    +'<style>body{font-family:Arial,sans-serif;padding:2rem;color:#1a1a2e}h1{color:#e63946}'
    +'table{width:100%;border-collapse:collapse}th{background:#e63946;color:#fff;padding:.4rem .6rem}'
    +'td{padding:.35rem .6rem;border-bottom:1px solid #eee}.win{color:#22c55e;font-weight:700}'
    +'</style></head><body>'
    +'<h1>ğŸ¯ '+s.title+'</h1>'
    +'<div style="color:#666;font-size:.85rem;margin-bottom:1.5rem">'+d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})+(s.lieu?' Â· '+s.lieu:'')+'</div>'
    +'<table><tr><th>J1</th><th>Score</th><th>J2</th><th>ELO</th></tr>'
    +sm.map(m=>{const p1=pById(m.p1),p2=pById(m.p2);const e1=m.eloChange1||0,e2=m.eloChange2||0;
      return '<tr><td class="'+(m.winner===m.p1?'win':'')+'">'+(p1&&p1.pseudo||'?')+'</td>'
        +'<td><b>'+m.s1+'â€“'+m.s2+'</b></td>'
        +'<td class="'+(m.winner===m.p2?'win':'')+'">'+(p2&&p2.pseudo||'?')+'</td>'
        +'<td style="font-size:.75rem;color:#666">'+(e1>=0?'+':'')+e1+' / '+(e2>=0?'+':'')+e2+'</td></tr>';}).join('')
    +'</table></body></html>');
  pw.document.close();
  setTimeout(() => pw.print(), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT PDF CLASSEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDFClassement() {
  recomputeElo();
  const stats = getStats();
  const sorted = [...players].sort((a,b) => (b.elo||1000)-(a.elo||1000));
  const pw = window.open('','','width=900,height=900');
  pw.document.write('<!DOCTYPE html><html><head><title>Classement</title>'
    +'<style>body{font-family:Arial,sans-serif;padding:2rem;color:#1a1a2e}h1{color:#e63946}'
    +'table{width:100%;border-collapse:collapse}th{background:#e63946;color:#fff;padding:.5rem .7rem;text-align:left;font-size:.78rem}'
    +'td{padding:.4rem .7rem;border-bottom:1px solid #eee;font-size:.82rem}'
    +'tr:nth-child(even) td{background:#fafafa}'
    +'</style></head><body>'
    +'<h1>ğŸ¯ Classement '+((typeof clubSettings!=='undefined'&&clubSettings.name)||'Club')+'</h1>'
    +'<p style="color:#666;font-size:.8rem">'+new Date().toLocaleDateString('fr-FR')+' Â· '+sorted.length+' joueurs</p>'
    +'<table><tr><th>#</th><th>Joueur</th><th>Division</th><th>ELO</th><th>Matchs</th><th>V</th><th>D</th><th>%</th></tr>'
    +sorted.map((p,i)=>{const s=stats[p.id]||{wins:0,losses:0,draws:0,matches:0};const dv=getDivision(p.elo||1000);
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'#'+(i+1);
      return '<tr><td><b>'+medal+'</b></td><td><b>'+p.pseudo+'</b></td>'
        +'<td>'+dv.icon+' '+dv.name+'</td><td><b>'+(p.elo||1000)+'</b></td>'
        +'<td>'+s.matches+'</td><td style="color:#22c55e;font-weight:700">'+s.wins+'</td>'
        +'<td style="color:#ef4444;font-weight:700">'+s.losses+'</td>'
        +'<td>'+(s.matches?Math.round(s.wins/s.matches*100):0)+'%</td></tr>';}).join('')
    +'</table></body></html>');
  pw.document.close();
  setTimeout(() => pw.print(), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTIJOUEUR COMPTEUR â€” via Firebase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window._scMultiRoom = null;
window._scMultiIsHost = false;
let _scMultiUnsub = null;
// Identifiant unique par appareil/session pour Ã©viter de s'ignorer soi-mÃªme
const _scDeviceId = 'dev_' + Math.random().toString(36).slice(2) + '_' + Date.now();

function scMultiCreate() {
  if (typeof _db === 'undefined' || !_db) {
    showNotif('âš  Firebase requis pour le multijoueur', 'error'); return;
  }
  const code = String(Math.floor(1000 + Math.random() * 9000));
  window._scMultiRoom = code;
  window._scMultiIsHost = true;
  const ref = _db.collection('clubs').doc(typeof FB_CLUB_ID !== 'undefined' ? FB_CLUB_ID : 'default').collection('liveMatches').doc(code);
  ref.set({ ...JSON.parse(JSON.stringify(scState)), code, host: (typeof _currentUser !== 'undefined' && _currentUser) ? _currentUser.pseudo : 'HÃ´te', createdAt: Date.now() })
    .then(() => {
      document.getElementById('sc-multi-code').textContent = code;
      document.getElementById('sc-multi-code').style.display = 'block';
      document.getElementById('sc-multi-modal-title').textContent = 'ğŸ® Code de la partie';
      document.getElementById('sc-multi-status').textContent = 'Partagez ce code avec votre adversaire';
      _scMultiSubscribe(code);
      showNotif('ğŸ® Partie crÃ©Ã©e ! Code: ' + code, 'success');
    }).catch(e => showNotif('âš  Erreur: ' + e.message, 'error'));
}

function scMultiJoin() {
  if (typeof _db === 'undefined' || !_db) {
    showNotif('âš  Firebase requis', 'error'); return;
  }
  const code = (document.getElementById('sc-multi-code-input').value || '').trim();
  if (code.length !== 4) { showNotif('âš  Code Ã  4 chiffres requis', 'error'); return; }
  window._scMultiRoom = code;
  window._scMultiIsHost = false;
  const ref = _db.collection('clubs').doc(typeof FB_CLUB_ID !== 'undefined' ? FB_CLUB_ID : 'default').collection('liveMatches').doc(code);
  ref.get().then(doc => {
    if (!doc.exists) { showNotif('âš  Partie introuvable', 'error'); return; }
    const data = doc.data();
    Object.assign(scState, data);
    try { scRenderPlayersZone(); } catch(e) {}
    _scMultiSubscribe(code);
    closeModal('sc-multi-modal');
    if (!document.getElementById('sc-overlay').classList.contains('active')) openScoreCounter();
    showNotif('ğŸ® ConnectÃ© Ã  la partie ' + code, 'success');
    _scMultiShowBadge(true);
  }).catch(e => showNotif('âš  Erreur: ' + e.message, 'error'));
}

function _scMultiSubscribe(code) {
  if (_scMultiUnsub) _scMultiUnsub();
  const ref = _db.collection('clubs').doc(typeof FB_CLUB_ID !== 'undefined' ? FB_CLUB_ID : 'default').collection('liveMatches').doc(code);
  _scMultiUnsub = ref.onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data();
    if (data.updatedBy === _scDeviceId) return;
    Object.assign(scState, data);
    try { scRenderPlayersZone(); } catch(e) {}
    _scMultiShowBadge(true);
  });
  closeModal('sc-multi-modal');
  _scMultiShowBadge(true);
  const btn = document.getElementById('sc-multi-btn');
  if (btn) btn.style.display = 'flex';
}

function scMultiSync() {
  if (!window._scMultiRoom || typeof _db === 'undefined' || !_db) return;
  const ref = _db.collection('clubs').doc(typeof FB_CLUB_ID !== 'undefined' ? FB_CLUB_ID : 'default').collection('liveMatches').doc(window._scMultiRoom);
  try {
    const payload = { ...JSON.parse(JSON.stringify(scState)), updatedAt: Date.now(), updatedBy: _scDeviceId };
    ref.set(payload); // set complet volontaire : l'Ã©tat du jeu doit Ãªtre atomique
  } catch(e) {}
}

function scMultiLeave() {
  if (_scMultiUnsub) { _scMultiUnsub(); _scMultiUnsub = null; }
  if (window._scMultiRoom && window._scMultiIsHost && typeof _db !== 'undefined' && _db) {
    _db.collection('clubs').doc(typeof FB_CLUB_ID !== 'undefined' ? FB_CLUB_ID : 'default').collection('liveMatches').doc(window._scMultiRoom).delete().catch(()=>{});
  }
  window._scMultiRoom = null;
  _scMultiShowBadge(false);
}

function _scMultiShowBadge(show) {
  const b = document.getElementById('sc-multi-live-badge');
  if (b) b.style.display = show ? 'inline-flex' : 'none';
}

// Sync aprÃ¨s chaque tour â€” patch scNextPlayer directement
const _scNextPlayer_orig = scNextPlayer;
scNextPlayer = function() {
  _scNextPlayer_orig.apply(this, arguments);
  if (window._scMultiRoom) setTimeout(scMultiSync, 80);
};

// Sync aprÃ¨s annulation
const _scUndo_orig = scUndo;
scUndo = function() {
  _scUndo_orig.apply(this, arguments);
  if (window._scMultiRoom) setTimeout(scMultiSync, 80);
};

// Sync aprÃ¨s chaque flÃ©chette saisie (mise Ã  jour live pendant la volÃ©e)
const _scAddDart_orig = scAddDart;
scAddDart = function() {
  _scAddDart_orig.apply(this, arguments);
  if (window._scMultiRoom) setTimeout(scMultiSync, 80);
};

// Bouton Multi visible aprÃ¨s dÃ©marrage partie
const _scStartGame_orig = scStartGame;
scStartGame = function() {
  _scStartGame_orig.apply(this, arguments);
  const btn = document.getElementById('sc-multi-btn');
  if (btn) btn.style.display = 'flex';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MON COMPTE â€” fonctions complÃ¨tes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPageCompte(el) {
  if (typeof _currentUser === 'undefined' || !_currentUser) {
    showNotif('âš  Connectez-vous d\'abord.', 'error');
    if (typeof openLoginModal === 'function') openLoginModal();
    return;
  }
  // Ouvre le profil complet du joueur connectÃ©
  openPlayerFull(_currentUser.id);
  // Met en Ã©vidence le bouton nav
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
}

function _updateCompteNavBtn() {
  const btn = document.getElementById('nav-btn-compte');
  const show = typeof _currentUser !== 'undefined' && _currentUser && !_isGuest;
  if (btn) btn.style.display = show ? 'flex' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setTimeout(() => {
  initDivisions();
  showNotifPermBanner();
  _updateCompteNavBtn();
}, 1500);

// Notif banner HTML (injectÃ© dynamiquement si absent)
(function injectNotifBar() {
  if (document.getElementById('notif-perm-bar')) return;
  const bar = document.createElement('div');
  bar.id = 'notif-perm-bar';
  bar.className = 'notif-perm-bar';
  bar.innerHTML = '<span>ğŸ””</span><span style="flex:1">Activez les notifications pour les alertes de division et nouveaux matchs</span><button onclick="requestNotifPermFromBanner()">Activer</button><span style="cursor:pointer;color:var(--muted);margin-left:.5rem" onclick="this.parentElement.classList.remove(\'show\')">âœ•</span>';
  const dash = document.getElementById('page-dashboard');
  if (dash) dash.insertBefore(bar, dash.firstChild);
})();


</script>
</body>
</html>
